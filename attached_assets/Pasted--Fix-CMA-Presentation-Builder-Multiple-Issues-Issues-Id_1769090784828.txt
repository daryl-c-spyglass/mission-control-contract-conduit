# Fix: CMA Presentation Builder Multiple Issues

## Issues Identified

| # | Issue | Location | Screenshot |
|---|-------|----------|------------|
| 1 | Remove "Generate with AI" button | Listing Brochure section | 1st |
| 2 | Cover Letter not syncing from Settings | Cover Letter section | 2nd |
| 3 | Map missing Mapbox, markers | Map of All Listings | 2nd |
| 4 | Property addresses showing "Unknown" | Property Details | 3rd |
| 5 | Chart X-axis showing "Comp 1, Comp 2" instead of addresses | Average Price Per Sq. Ft. | 4th |

---

## Issue 1: Remove "Generate with AI" Button

### Current (Wrong)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Listing Brochure                            â”‚
â”‚ Upload or generate a property brochure...   â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ Upload Brochure                  â”‚   â”‚
â”‚  â”‚    PDF, JPG, PNG up to 10MB         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚                   OR                        â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ¨ Generate with AI                 â”‚   â”‚  â† REMOVE THIS
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fixed
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Listing Brochure                            â”‚
â”‚ Upload a property brochure for the...       â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ Upload Brochure                  â”‚   â”‚
â”‚  â”‚    PDF, JPG, PNG up to 10MB         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Fix
```tsx
// Find and remove the "Generate with AI" button and "OR" divider
// In the Listing Brochure content section

// REMOVE THIS:
{/* <div className="text-center text-muted-foreground text-sm">OR</div>
<Button variant="outline" className="w-full">
  <Sparkles className="w-4 h-4 mr-2" />
  Generate with AI
</Button> */}
```

---

## Issue 2: Cover Letter Sync from Settings

### Problem
Cover Letter shows placeholder text instead of pulling from user's Default Cover Letter in Settings.

### Current
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ‰ï¸ Cover Letter                             â”‚
â”‚                                             â”‚
â”‚ Your personalized cover letter will         â”‚
â”‚ appear here...                              â”‚  â† Placeholder
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fixed
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ‰ï¸ Cover Letter                             â”‚
â”‚                                             â”‚
â”‚ Dear [Client Name],                         â”‚
â”‚                                             â”‚
â”‚ Thank you for the opportunity to present    â”‚
â”‚ this Comparative Market Analysis for your   â”‚
â”‚ property. Based on my research of recent    â”‚
â”‚ sales and current listings in your area...  â”‚  â† From Settings
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Fix
```tsx
// Fetch user settings to get default cover letter
const { data: userSettings } = useQuery({
  queryKey: ['/api/user/settings'],
});

// In Cover Letter section
const defaultCoverLetter = userSettings?.defaultCoverLetter || '';

// Use it in the preview and content
<div className="cover-letter-content">
  {coverLetterContent || defaultCoverLetter || (
    <span className="text-muted-foreground italic">
      No cover letter set. Add one in Settings â†’ Default Cover Letter
    </span>
  )}
</div>
```

---

## Issue 3: Map Missing Mapbox and Markers

### Problem
"Map of All Listings" section shows placeholder text instead of actual Mapbox map with subject and comparable markers.

### Current (Broken)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—ºï¸ Map of All Listings                      â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                     â”‚   â”‚
â”‚  â”‚    Map Preview (10 comparables +    â”‚   â”‚  â† Just text!
â”‚  â”‚    Subject)                         â”‚   â”‚
â”‚  â”‚                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  â— Subject  â— Active  â— Under Contract  â— Sold â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fixed (With Actual Map)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—ºï¸ Map of All Listings                      â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     ğŸ—ºï¸ ACTUAL MAPBOX MAP            â”‚   â”‚
â”‚  â”‚                                     â”‚   â”‚
â”‚  â”‚        ğŸ”µ (Subject)                 â”‚   â”‚
â”‚  â”‚    ğŸŸ¢       ğŸŸ¢                      â”‚   â”‚
â”‚  â”‚        ğŸ”´       ğŸŸ¢                  â”‚   â”‚
â”‚  â”‚    ğŸŸ¡           ğŸ”´                  â”‚   â”‚
â”‚  â”‚                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  ğŸ”µ Subject  ğŸŸ¢ Active  ğŸŸ¡ Under Contract  ğŸ”´ Sold â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Fix
```tsx
import Map, { Marker } from 'react-map-gl';

// Get coordinates from subject property and comparables
const subjectProperty = transaction.mlsData;
const comparables = cmaData?.comparables || [];

// Subject coordinates
const subjectLat = subjectProperty?.latitude || subjectProperty?.coordinates?.lat;
const subjectLng = subjectProperty?.longitude || subjectProperty?.coordinates?.lng;

// Map component for the preview
function MapOfAllListings({ subject, comparables }) {
  const [viewport, setViewport] = useState({
    latitude: subject.latitude,
    longitude: subject.longitude,
    zoom: 12,
  });

  // Status color mapping
  const getMarkerColor = (status: string) => {
    switch (status?.toLowerCase()) {
      case 'active': return '#22c55e';      // Green
      case 'closed':
      case 'sold': return '#ef4444';        // Red
      case 'pending':
      case 'under contract': return '#eab308'; // Yellow
      default: return '#6b7280';            // Gray
    }
  };

  return (
    <div className="h-64 rounded-lg overflow-hidden">
      <Map
        {...viewport}
        onMove={evt => setViewport(evt.viewState)}
        mapStyle="mapbox://styles/mapbox/streets-v12"
        mapboxAccessToken={process.env.MAPBOX_TOKEN}
      >
        {/* Subject Property Marker - Blue */}
        <Marker
          latitude={subject.latitude}
          longitude={subject.longitude}
        >
          <div className="w-6 h-6 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center">
            <Home className="w-3 h-3 text-white" />
          </div>
        </Marker>

        {/* Comparable Property Markers */}
        {comparables.map((comp, index) => (
          <Marker
            key={comp.mlsNumber || index}
            latitude={comp.latitude}
            longitude={comp.longitude}
          >
            <div 
              className="w-5 h-5 rounded-full border-2 border-white shadow"
              style={{ backgroundColor: getMarkerColor(comp.status) }}
            />
          </Marker>
        ))}
      </Map>

      {/* Legend */}
      <div className="flex items-center gap-4 mt-2 text-xs">
        <span className="flex items-center gap-1">
          <div className="w-3 h-3 rounded-full bg-blue-500" /> Subject
        </span>
        <span className="flex items-center gap-1">
          <div className="w-3 h-3 rounded-full bg-green-500" /> Active
        </span>
        <span className="flex items-center gap-1">
          <div className="w-3 h-3 rounded-full bg-yellow-500" /> Under Contract
        </span>
        <span className="flex items-center gap-1">
          <div className="w-3 h-3 rounded-full bg-red-500" /> Sold
        </span>
      </div>
    </div>
  );
}
```

---

## Issue 4: Property Details Showing "Unknown"

### Problem
Property addresses showing as "Unknown" instead of actual addresses.

### Current (Broken)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Property Details                         â”‚
â”‚                                             â”‚
â”‚ Unknown                              Active â”‚
â”‚ $629,000 Â· 2 bd Â· 0 ba Â· 1,538 sqft        â”‚
â”‚                                             â”‚
â”‚ Unknown                              Closed â”‚
â”‚ $1,199,000 Â· 4 bd Â· 0 ba Â· 2,396 sqft      â”‚
â”‚                                             â”‚
â”‚ Unknown                              Active â”‚
â”‚ $380,000 Â· 2 bd Â· 0 ba Â· 1,081 sqft        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fixed
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Property Details                         â”‚
â”‚                                             â”‚
â”‚ 1234 Oak Street, Austin, TX          Active â”‚
â”‚ $629,000 Â· 2 bd Â· 2 ba Â· 1,538 sqft        â”‚
â”‚                                             â”‚
â”‚ 5678 Maple Ave, Austin, TX           Closed â”‚
â”‚ $1,199,000 Â· 4 bd Â· 3 ba Â· 2,396 sqft      â”‚
â”‚                                             â”‚
â”‚ 9012 Pine Lane, Austin, TX           Active â”‚
â”‚ $380,000 Â· 2 bd Â· 2 ba Â· 1,081 sqft        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Fix
```tsx
// Check how comparable data is being accessed
// The address might be in different fields depending on API response

// Common field names to check:
const getPropertyAddress = (comp: any) => {
  return comp.address ||
         comp.streetAddress ||
         comp.fullAddress ||
         comp.location?.address ||
         comp.unparsedAddress ||
         `${comp.streetNumber} ${comp.streetName}, ${comp.city}` ||
         'Address unavailable';
};

const getBathrooms = (comp: any) => {
  return comp.bathrooms ||
         comp.bathroomsTotalInteger ||
         comp.bathsFull + (comp.bathsHalf * 0.5) ||
         0;
};

// In the Property Details section
{comparables.map((comp, index) => (
  <div key={index} className="flex items-center justify-between py-2 border-b">
    <div>
      <p className="font-medium">{getPropertyAddress(comp)}</p>
      <p className="text-sm text-muted-foreground">
        ${comp.listPrice?.toLocaleString()} Â· 
        {comp.bedrooms || comp.bedroomsTotal} bd Â· 
        {getBathrooms(comp)} ba Â· 
        {comp.squareFeet?.toLocaleString() || comp.livingArea?.toLocaleString()} sqft
      </p>
    </div>
    <Badge variant={comp.status === 'Active' ? 'success' : 'destructive'}>
      {comp.status}
    </Badge>
  </div>
))}
```

---

## Issue 5: Chart X-Axis Showing Generic Labels

### Problem
"Average Price Per Sq. Ft." chart shows "Comp 1, Comp 2, Comp 3..." instead of actual property addresses.

### Current (Broken)
```
Average Price Per Sq. Ft.

$1200 |                                    â–ˆâ–ˆâ–ˆâ–ˆ
$900  |          â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆâ–ˆ
$600  |    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
$300  |    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
$0    |____________________________________
       Comp 1 Comp 2 Comp 3 Comp 4 Comp 5 ...
                        â†‘
              Generic labels - BAD!
```

### Fixed
```
Average Price Per Sq. Ft.

$1200 |                                    â–ˆâ–ˆâ–ˆâ–ˆ
$900  |          â–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆâ–ˆ
$600  |    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
$300  |    â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
$0    |____________________________________
       1234    5678   9012   ...   
       Oak St  Maple  Pine
                â†‘
        Actual street addresses!
```

### Code Fix
```tsx
// When preparing chart data, use actual addresses

const getShortAddress = (address: string) => {
  // Extract just the street number and name, truncate if needed
  if (!address || address === 'Unknown') return 'N/A';
  
  // "1234 Oak Street, Austin, TX" â†’ "1234 Oak St"
  const parts = address.split(',')[0]; // Remove city, state
  const words = parts.split(' ');
  
  if (words.length > 3) {
    // Truncate: "1234 Oak Street Lane" â†’ "1234 Oak..."
    return `${words[0]} ${words[1]}...`;
  }
  
  return parts;
};

// Chart data preparation
const chartData = comparables.map((comp, index) => ({
  // Use actual address instead of "Comp 1"
  name: getShortAddress(getPropertyAddress(comp)),
  pricePerSqft: comp.pricePerSquareFoot || 
                Math.round((comp.listPrice || comp.closePrice) / comp.squareFeet),
  fullAddress: getPropertyAddress(comp), // For tooltip
}));

// In the chart component (Recharts example)
<BarChart data={chartData}>
  <XAxis 
    dataKey="name"
    tick={{ fontSize: 10 }}
    angle={-45}
    textAnchor="end"
    height={60}
  />
  <YAxis 
    tickFormatter={(value) => `$${value}`}
  />
  <Tooltip 
    formatter={(value) => [`$${value}/sqft`, 'Price per Sq Ft']}
    labelFormatter={(label, payload) => payload?.[0]?.payload?.fullAddress || label}
  />
  <Bar dataKey="pricePerSqft" fill="#f97316" radius={[4, 4, 0, 0]} />
</BarChart>
```

---

## Summary of Changes

| Issue | File(s) to Modify | Change |
|-------|------------------|--------|
| 1. Remove AI button | Content tab / Listing Brochure section | Delete "Generate with AI" button and "OR" divider |
| 2. Cover Letter sync | Content tab + Preview | Fetch from `/api/user/settings` â†’ `defaultCoverLetter` |
| 3. Map markers | Map of All Listings preview | Add actual Mapbox map with subject (blue) and comp markers |
| 4. Property addresses | Property Details section | Fix data access - use correct field for address |
| 5. Chart labels | Average Price chart | Use `getShortAddress()` instead of "Comp N" |

---

## Verification Checklist

- [ ] "Generate with AI" button removed from Listing Brochure
- [ ] Cover Letter pulls from Settings default
- [ ] Map shows actual Mapbox with all markers
- [ ] Subject marker is blue, comps are colored by status
- [ ] Property Details shows actual addresses (not "Unknown")
- [ ] Bathrooms show correct count (not 0)
- [ ] Chart X-axis shows street addresses
- [ ] Chart tooltip shows full address
- [ ] All changes work in Preview modal
- [ ] All changes work in exported PDF