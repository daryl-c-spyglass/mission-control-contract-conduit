================================================================================
FILE: CMABuilder.tsx
COPY TO: client/src/components/CMABuilder.tsx
================================================================================\n
import { useState, useRef, useEffect, useCallback, useMemo } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { X, Plus, TrendingUp, Search, Loader2, AlertCircle, Home, MousePointerClick, RotateCcw, ChevronLeft, ChevronRight, Info, Map, ListFilter, Sparkles, LayoutGrid, List, Table2, Filter } from "lucide-react";
import { StatusFilterTabs } from "@/components/StatusFilterTabs";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import { cn } from "@/lib/utils";
import { PolygonMapSearch } from "@/components/PolygonMapSearch";
import VisualMatchPanel, { type ImageSearchItem } from "@/components/VisualMatchPanel";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import type { Property } from "@shared/schema";

interface AutocompleteInputProps {
  placeholder?: string;
  value: string;
  onChange: (value: string) => void;
  endpoint: string;
  testId?: string;
  className?: string;
  name?: string;
}

function AutocompleteInput({ placeholder, value, onChange, endpoint, testId, className, name }: AutocompleteInputProps) {
  const [inputValue, setInputValue] = useState(value || '');
  const [suggestions, setSuggestions] = useState<string[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    setInputValue(value || '');
  }, [value]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setShowSuggestions(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const fetchSuggestions = useCallback(async (query: string) => {
    if (query.length < 2) {
      setSuggestions([]);
      return;
    }
    setIsLoading(true);
    try {
      const res = await fetch(`${endpoint}?q=${encodeURIComponent(query)}`);
      const data = await res.json();
      // Handle both array response and { suggestions: [] } format
      if (Array.isArray(data)) {
        // API returns array of { value, count } objects
        setSuggestions(data.map((item: any) => typeof item === 'string' ? item : item.value));
      } else if (data.suggestions) {
        setSuggestions(data.suggestions);
      } else {
        setSuggestions([]);
      }
    } catch (error) {
      setSuggestions([]);
    } finally {
      setIsLoading(false);
    }
  }, [endpoint]);

  useEffect(() => {
    const debounceTimer = setTimeout(() => {
      fetchSuggestions(inputValue);
    }, 300);
    return () => clearTimeout(debounceTimer);
  }, [inputValue, fetchSuggestions]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setInputValue(newValue);
    setShowSuggestions(true);
    onChange(newValue);
  };

  const handleSuggestionClick = (suggestion: string) => {
    setInputValue(suggestion);
    onChange(suggestion);
    setShowSuggestions(false);
  };

  return (
    <div ref={containerRef} className="relative">
      <Input
        ref={inputRef}
        placeholder={placeholder}
        value={inputValue}
        onChange={handleInputChange}
        onFocus={() => setShowSuggestions(true)}
        data-testid={testId}
        name={name}
        autoComplete="off"
        className={cn("h-10", className)}
      />
      {showSuggestions && suggestions.length > 0 && (
        <div className="absolute z-50 w-full mt-1 bg-card border rounded-md shadow-lg max-h-48 overflow-y-auto">
          {suggestions.map((suggestion, index) => (
            <div
              key={index}
              className="px-3 py-2 cursor-pointer hover-elevate text-sm"
              onClick={() => handleSuggestionClick(suggestion)}
              data-testid={`suggestion-${testId}-${index}`}
            >
              {suggestion}
            </div>
          ))}
        </div>
      )}
      {isLoading && inputValue.length >= 2 && (
        <div className="absolute right-3 top-1/2 -translate-y-1/2">
          <div className="h-4 w-4 border-2 border-primary border-t-transparent rounded-full animate-spin" />
        </div>
      )}
    </div>
  );
}

interface UnifiedSearchResponse {
  properties: Property[];
  count: number;
  status: string;
  schoolFilterWarning?: string | null;
}

// Property type options for the dropdown - matches Repliers propertySubType values exactly
const PROPERTY_TYPES = [
  { value: 'Single Family Residence', label: 'Single Family Residence' },
  { value: 'Condominium', label: 'Condominium' },
  { value: 'Townhouse', label: 'Townhouse' },
  { value: 'Multi-Family', label: 'Multi-Family' },
  { value: 'Ranch', label: 'Ranch' },
  { value: 'Manufactured Home', label: 'Manufactured Home' },
  { value: 'Unimproved Land', label: 'Unimproved Land' },
  { value: 'Multiple Lots (Adjacent)', label: 'Multiple Lots' },
];

interface InitialCMAData {
  name?: string;
  searchCriteria?: {
    city?: string;
    subdivision?: string;
    zipCode?: string;
    schoolDistrict?: string;
    elementarySchool?: string;
    middleSchool?: string;
    highSchool?: string;
    minBeds?: string;
    maxBeds?: string;
    minPrice?: string;
    maxPrice?: string;
    minBaths?: string;
    maxBaths?: string;
    statuses?: string[];
    minSqft?: string;
    maxSqft?: string;
    minLotAcres?: string;
    maxLotAcres?: string;
    minYearBuilt?: string;
    maxYearBuilt?: string;
    stories?: string;
    garage?: string;
    propertyType?: string;
    soldDays?: string;
  };
  comparables?: Property[];
  subjectProperty?: Property | null;
}

interface CMABuilderProps {
  onCreateCMA: (data: {
    name: string;
    subjectPropertyId?: string;
    comparablePropertyIds: string[];
    propertiesData: any[];
    searchCriteria?: any;
  }) => void;
  initialData?: InitialCMAData;
}

export function CMABuilder({ onCreateCMA, initialData }: CMABuilderProps) {
  const { toast } = useToast();
  const sc = initialData?.searchCriteria || {};
  
  const [cmaName, setCmaName] = useState(initialData?.name || "");
  const [hasUserEditedName, setHasUserEditedName] = useState(!!initialData?.name);
  const [subjectProperty, setSubjectProperty] = useState<Property | null>(initialData?.subjectProperty || null);
  const [comparables, setComparables] = useState<Property[]>(initialData?.comparables || []);
  const searchSectionRef = useRef<HTMLDivElement>(null);
  
  const [manualSubjectAddress, setManualSubjectAddress] = useState("");
  const [manualSubjectCity, setManualSubjectCity] = useState("");
  const [manualSubjectState, setManualSubjectState] = useState("");
  const [manualSubjectZip, setManualSubjectZip] = useState("");
  const [manualSubjectListPrice, setManualSubjectListPrice] = useState("");
  const [manualSubjectBeds, setManualSubjectBeds] = useState("");
  const [manualSubjectBaths, setManualSubjectBaths] = useState("");
  const [manualSubjectSqft, setManualSubjectSqft] = useState("");
  
  const [searchCity, setSearchCity] = useState(sc.city || "");
  const [searchSubdivision, setSearchSubdivision] = useState(sc.subdivision || "");
  const [searchZipCode, setSearchZipCode] = useState(sc.zipCode || "");
  const [searchSchoolDistrict, setSearchSchoolDistrict] = useState(sc.schoolDistrict || "");
  const [searchElementarySchool, setSearchElementarySchool] = useState(sc.elementarySchool || "");
  const [searchMiddleSchool, setSearchMiddleSchool] = useState(sc.middleSchool || "");
  const [searchHighSchool, setSearchHighSchool] = useState(sc.highSchool || "");
  const [searchMinBeds, setSearchMinBeds] = useState(sc.minBeds || "");
  const [searchMaxBeds, setSearchMaxBeds] = useState(sc.maxBeds || "");
  const [searchMinPrice, setSearchMinPrice] = useState(sc.minPrice || "");
  const [searchMaxPrice, setSearchMaxPrice] = useState(sc.maxPrice || "");
  const [searchMinBaths, setSearchMinBaths] = useState(sc.minBaths || "");
  const [searchMaxBaths, setSearchMaxBaths] = useState(sc.maxBaths || "");
  const [searchStatuses, setSearchStatuses] = useState<string[]>(sc.statuses || ["active"]);
  const [searchEnabled, setSearchEnabled] = useState(!!initialData?.searchCriteria);

  // Generate default CMA name based on subdivision, status, and date/time
  const generateDefaultName = useCallback(() => {
    const parts: string[] = [];
    
    // Use subdivision if available, otherwise city
    if (searchSubdivision.trim()) {
      parts.push(searchSubdivision.trim());
    } else if (searchCity.trim()) {
      parts.push(searchCity.trim());
    }
    
    // Format status(es)
    if (searchStatuses.length > 0) {
      const statusMap: Record<string, string> = {
        'active': 'Active',
        'under_contract': 'Active Under Contract',
        'closed': 'Closed'
      };
      const formattedStatuses = searchStatuses.map(s => statusMap[s] || s).join('/');
      parts.push(formattedStatuses);
    }
    
    // Add current date/time
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
    const timeStr = now.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
    parts.push(`${dateStr} ${timeStr}`);
    
    return parts.join(' - ');
  }, [searchSubdivision, searchCity, searchStatuses]);

  // Auto-update CMA name when search criteria changes (unless user has manually edited)
  // Always generate a default name - even on initial load with just the default "active" status
  useEffect(() => {
    if (!hasUserEditedName) {
      setCmaName(generateDefaultName());
    }
  }, [searchSubdivision, searchCity, searchStatuses, hasUserEditedName, generateDefaultName]);

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setCmaName(e.target.value);
    setHasUserEditedName(true);
  };
  const [searchMinSqft, setSearchMinSqft] = useState(sc.minSqft || "");
  const [searchMaxSqft, setSearchMaxSqft] = useState(sc.maxSqft || "");
  const [searchMinLotAcres, setSearchMinLotAcres] = useState(sc.minLotAcres || "");
  const [searchMaxLotAcres, setSearchMaxLotAcres] = useState(sc.maxLotAcres || "");
  const [searchStories, setSearchStories] = useState(sc.stories || "");
  const [searchMinYearBuilt, setSearchMinYearBuilt] = useState(sc.minYearBuilt || "");
  const [searchMaxYearBuilt, setSearchMaxYearBuilt] = useState(sc.maxYearBuilt || "");
  const [searchSoldDays, setSearchSoldDays] = useState(sc.soldDays || "365");
  const [searchPropertyType, setSearchPropertyType] = useState(sc.propertyType || "");
  
  // Search mode state
  const [searchMode, setSearchMode] = useState<'criteria' | 'map'>('criteria');
  const [mapSearchResults, setMapSearchResults] = useState<Property[]>([]);
  const [isMapSearching, setIsMapSearching] = useState(false);
  const [currentBoundary, setCurrentBoundary] = useState<number[][][] | null>(null);
  
  // Visual Match AI search state (for ranking comps by visual similarity)
  const [visualMatchEnabled, setVisualMatchEnabled] = useState(false);
  const [visualMatchItems, setVisualMatchItems] = useState<ImageSearchItem[]>([]);
  const [visualMatchResults, setVisualMatchResults] = useState<Property[]>([]);
  const [isVisualSearching, setIsVisualSearching] = useState(false);
  const [visualMatchError, setVisualMatchError] = useState<string>("");
  
  // Property detail dialog state
  const [selectedProperty, setSelectedProperty] = useState<Property | null>(null);
  const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
  
  // View mode state - persisted to localStorage
  type ViewMode = 'grid' | 'list' | 'table';
  const [viewMode, setViewMode] = useState<ViewMode>(() => {
    try {
      const saved = typeof window !== 'undefined' ? localStorage.getItem('cma-view-mode') : null;
      if (saved === 'grid' || saved === 'list' || saved === 'table') {
        return saved;
      }
    } catch {
      // localStorage may not be available
    }
    return 'grid';
  });
  
  // Persist view mode to localStorage
  const handleViewModeChange = (mode: ViewMode) => {
    setViewMode(mode);
    try {
      localStorage.setItem('cma-view-mode', mode);
    } catch {
      // localStorage may not be available
    }
  };
  
  // Status filter for client-side filtering of already-fetched results
  const [statusDisplayFilter, setStatusDisplayFilter] = useState<string>('all');
  
  // Autoplay carousel effect - advance every 3 seconds when dialog is open
  useEffect(() => {
    if (!selectedProperty) return;
    const photos = ((selectedProperty as any).photos as string[] | undefined) || [];
    if (photos.length <= 1) return;
    
    const interval = setInterval(() => {
      setCurrentPhotoIndex(prev => (prev + 1) % photos.length);
    }, 3000);
    
    return () => clearInterval(interval);
  }, [selectedProperty]);

  const resetForm = () => {
    setCmaName("");
    setHasUserEditedName(false);
    setSubjectProperty(null);
    setComparables([]);
    setSearchCity("");
    setSearchSubdivision("");
    setSearchZipCode("");
    setSearchMinBeds("");
    setSearchMaxBeds("");
    setSearchMinPrice("");
    setSearchMaxPrice("");
    setSearchMinBaths("");
    setSearchMaxBaths("");
    setSearchStatuses(["active"]);
    setSearchEnabled(false);
    setSearchMinSqft("");
    setSearchMaxSqft("");
    setSearchMinLotAcres("");
    setSearchMaxLotAcres("");
    setSearchStories("");
    setSearchMinYearBuilt("");
    setSearchMaxYearBuilt("");
    setSearchSoldDays("");
    setSearchPropertyType("");
    setStatusDisplayFilter('all');
  };
  
  const clearFilters = () => {
    setSearchCity("");
    setSearchSubdivision("");
    setSearchZipCode("");
    setSearchSchoolDistrict("");
    setSearchElementarySchool("");
    setSearchMiddleSchool("");
    setSearchHighSchool("");
    setSearchMinBeds("");
    setSearchMaxBeds("");
    setSearchMinPrice("");
    setSearchMaxPrice("");
    setVisualMatchEnabled(false);
    setVisualMatchItems([]);
    setVisualMatchResults([]);
    setSearchMinBaths("");
    setSearchMaxBaths("");
    setSearchStatuses(["active"]);
    setSearchMinSqft("");
    setSearchMaxSqft("");
    setSearchMinLotAcres("");
    setSearchMaxLotAcres("");
    setSearchStories("");
    setSearchMinYearBuilt("");
    setSearchMaxYearBuilt("");
    setSearchSoldDays("");
    setSearchPropertyType("");
    setSearchEnabled(false);
    setStatusDisplayFilter('all');
  };

  const buildSearchQuery = () => {
    const params = new URLSearchParams();
    // Support multiple statuses as comma-separated values
    if (searchStatuses.length > 0) {
      params.set('statuses', searchStatuses.join(','));
    }
    if (searchCity) params.set('city', searchCity.trim());
    if (searchSubdivision) params.set('subdivision', searchSubdivision.trim());
    if (searchZipCode) params.set('postalCode', searchZipCode.trim());
    if (searchSchoolDistrict) params.set('schoolDistrict', searchSchoolDistrict.trim());
    if (searchElementarySchool) params.set('elementarySchools', searchElementarySchool.trim());
    if (searchMiddleSchool) params.set('middleSchools', searchMiddleSchool.trim());
    if (searchHighSchool) params.set('highSchools', searchHighSchool.trim());
    if (searchMinBeds && searchMinBeds !== 'any') params.set('bedsMin', searchMinBeds);
    if (searchMaxBeds && searchMaxBeds !== 'any') params.set('bedsMax', searchMaxBeds);
    if (searchMinPrice && searchMinPrice !== 'any') params.set('minPrice', searchMinPrice);
    if (searchMaxPrice && searchMaxPrice !== 'any') params.set('maxPrice', searchMaxPrice);
    if (searchMinBaths && searchMinBaths !== 'any') params.set('bathsMin', searchMinBaths);
    if (searchMaxBaths && searchMaxBaths !== 'any') params.set('bathsMax', searchMaxBaths);
    if (searchMinSqft) params.set('minSqft', searchMinSqft);
    if (searchMaxSqft) params.set('maxSqft', searchMaxSqft);
    if (searchMinLotAcres) params.set('minLotAcres', searchMinLotAcres);
    if (searchMaxLotAcres) params.set('maxLotAcres', searchMaxLotAcres);
    if (searchStories && searchStories !== 'any') params.set('stories', searchStories);
    if (searchMinYearBuilt) params.set('minYearBuilt', searchMinYearBuilt);
    if (searchMaxYearBuilt) params.set('maxYearBuilt', searchMaxYearBuilt);
    // Only include soldDays when searching for Closed status
    if (searchStatuses.includes('closed') && searchSoldDays && searchSoldDays !== 'any') {
      params.set('soldDays', searchSoldDays);
    }
    if (searchPropertyType && searchPropertyType !== 'any') params.set('propertySubType', searchPropertyType);
    // Sort by listing date for active/under contract
    if (searchStatuses.includes('active') || searchStatuses.includes('under_contract')) {
      params.set('sortBy', 'listingContractDate');
      params.set('sortOrder', 'desc');
    }
    // CMA always uses sale listings only (no rentals/leases)
    params.set('type', 'sale');
    params.set('limit', '20');
    return params.toString();
  };
  
  const toggleStatus = (status: string) => {
    setSearchStatuses(prev => {
      if (prev.includes(status)) {
        // Don't allow deselecting all statuses
        if (prev.length === 1) return prev;
        return prev.filter(s => s !== status);
      } else {
        return [...prev, status];
      }
    });
  };

  const { data: searchResponse, isLoading, isError, error, refetch } = useQuery<UnifiedSearchResponse>({
    queryKey: ['/api/search', buildSearchQuery()],
    queryFn: async () => {
      const res = await fetch(`/api/search?${buildSearchQuery()}`);
      if (!res.ok) throw new Error('Failed to search properties');
      return res.json();
    },
    enabled: searchEnabled,
    retry: 1,
  });

  const searchResults = searchResponse?.properties || [];
  const totalResults = searchResponse?.count || 0;
  const schoolFilterWarning = searchResponse?.schoolFilterWarning;
  
  // Reset status filter when search results change (new search performed)
  const prevSearchResultsRef = useRef<Property[]>([]);
  useEffect(() => {
    // Only reset if the results have actually changed (new search)
    if (searchResults !== prevSearchResultsRef.current && searchResults.length > 0) {
      setStatusDisplayFilter('all');
      prevSearchResultsRef.current = searchResults;
    }
  }, [searchResults]);

  const handleSearch = () => {
    const missingFields: string[] = [];
    
    // Close Date is only required when searching for Closed/Sold properties
    if (searchStatuses.includes('closed') && (!searchSoldDays || searchSoldDays === 'any')) {
      missingFields.push('Close Date');
    }
    if (!searchPropertyType || searchPropertyType === 'any') {
      missingFields.push('Property Type');
    }
    // Sqft fields are now optional - users can leave blank for broader results
    
    if (missingFields.length > 0) {
      toast({
        title: "Required Fields Missing",
        description: `Please fill in: ${missingFields.join(', ')}`,
        variant: "destructive",
      });
      return;
    }
    
    setSearchEnabled(true);
    refetch();
  };

  // Visual Match AI search handler for ranking comps
  const handleVisualSearch = async () => {
    if (visualMatchItems.length === 0) return;
    
    setIsVisualSearching(true);
    setVisualMatchError("");
    
    try {
      // Build criteria from current search filters
      const criteria: any = {
        resultsPerPage: 50,
        pageNum: 1,
      };
      
      // Add status filters - prefer closed for CMAs
      if (searchStatuses.includes('closed')) {
        criteria.standardStatus = 'Closed';
      } else if (searchStatuses.includes('active')) {
        criteria.standardStatus = 'Active';
      }
      
      // CMA always uses sale listings only (no rentals/leases)
      criteria.type = 'sale';
      
      // Add filters
      if (searchCity) criteria.city = searchCity;
      if (searchZipCode) criteria.postalCode = searchZipCode;
      if (searchSubdivision) criteria.subdivision = searchSubdivision;
      if (searchMinPrice && searchMinPrice !== 'any') criteria.minPrice = parseInt(searchMinPrice);
      if (searchMaxPrice && searchMaxPrice !== 'any') criteria.maxPrice = parseInt(searchMaxPrice);
      if (searchMinBeds && searchMinBeds !== 'any') criteria.minBeds = parseInt(searchMinBeds);
      if (searchMaxBeds && searchMaxBeds !== 'any') criteria.maxBeds = parseInt(searchMaxBeds);
      if (searchMinBaths && searchMinBaths !== 'any') criteria.minBaths = parseInt(searchMinBaths);
      if (searchMinSqft) criteria.minSqft = parseInt(searchMinSqft);
      if (searchMaxSqft) criteria.maxSqft = parseInt(searchMaxSqft);
      
      const response = await fetch('/api/repliers/image-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          imageSearchItems: visualMatchItems,
          criteria,
        }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Visual search failed');
      }
      
      setVisualMatchResults(data.listings || []);
      
      if ((data.listings || []).length === 0) {
        setVisualMatchError("No matching properties found. Try different search criteria.");
      }
    } catch (error: any) {
      console.error('Visual search error:', error);
      setVisualMatchResults([]);
      setVisualMatchError(error.message || "Visual search failed. Please try again.");
    } finally {
      setIsVisualSearching(false);
    }
  };

  // Map polygon search handler
  const handlePolygonSearch = async (boundary: number[][][]) => {
    setCurrentBoundary(boundary);
    await executePolygonSearch(boundary);
  };
  
  // Execute polygon search with current filters
  const executePolygonSearch = async (boundary: number[][][]) => {
    setIsMapSearching(true);
    try {
      const response = await apiRequest('/api/properties/search/polygon', 'POST', {
        boundary,
        statuses: searchStatuses,
        limit: 50,
        type: 'sale',  // CMA always uses sale listings only (no rentals/leases)
        minBeds: searchMinBeds && searchMinBeds !== 'any' ? parseInt(searchMinBeds) : undefined,
        maxBeds: searchMaxBeds && searchMaxBeds !== 'any' ? parseInt(searchMaxBeds) : undefined,
        minBaths: searchMinBaths && searchMinBaths !== 'any' ? parseInt(searchMinBaths) : undefined,
        minPrice: searchMinPrice && searchMinPrice !== 'any' ? parseInt(searchMinPrice) : undefined,
        maxPrice: searchMaxPrice && searchMaxPrice !== 'any' ? parseInt(searchMaxPrice) : undefined,
        minSqft: searchMinSqft ? parseInt(searchMinSqft) : undefined,
        maxSqft: searchMaxSqft ? parseInt(searchMaxSqft) : undefined,
        propertyType: searchPropertyType && searchPropertyType !== 'any' ? searchPropertyType : undefined,
        minYearBuilt: searchMinYearBuilt ? parseInt(searchMinYearBuilt) : undefined,
        maxYearBuilt: searchMaxYearBuilt ? parseInt(searchMaxYearBuilt) : undefined,
        soldDays: searchSoldDays && searchSoldDays !== 'any' ? parseInt(searchSoldDays) : undefined,
      });
      const data = await response.json();
      setMapSearchResults(data.properties || []);
    } catch (err) {
      console.error('Polygon search error:', err);
      setMapSearchResults([]);
    } finally {
      setIsMapSearching(false);
    }
  };
  
  // Re-run polygon search with current boundary and updated filters
  const handleMapFilterSearch = () => {
    if (currentBoundary) {
      executePolygonSearch(currentBoundary);
    }
  };

  const handleClearPolygonSearch = () => {
    setMapSearchResults([]);
    setCurrentBoundary(null);
  };

  // Get the base results based on search mode and visual match
  const baseSearchResults = visualMatchEnabled && visualMatchResults.length > 0 
    ? visualMatchResults 
    : searchMode === 'map' 
      ? mapSearchResults 
      : searchResults;
  
  // Calculate status counts for the filter tabs (client-side)
  const statusCounts = useMemo(() => {
    const counts = {
      all: baseSearchResults.length,
      active: 0,
      underContract: 0,
      closed: 0,
    };
    
    baseSearchResults.forEach((listing) => {
      const status = listing.standardStatus;
      if (status === 'Active') {
        counts.active++;
      } else if (status === 'Active Under Contract' || status === 'Pending') {
        counts.underContract++;
      } else if (status === 'Closed') {
        counts.closed++;
      }
    });
    
    return counts;
  }, [baseSearchResults]);
  
  // Filter results by selected status (client-side filtering of already-fetched data)
  const activeSearchResults = useMemo(() => {
    if (statusDisplayFilter === 'all') return baseSearchResults;
    
    return baseSearchResults.filter((listing) => {
      const status = listing.standardStatus;
      
      switch (statusDisplayFilter) {
        case 'active':
          return status === 'Active';
        case 'underContract':
          return status === 'Active Under Contract' || status === 'Pending';
        case 'closed':
          return status === 'Closed';
        default:
          return true;
      }
    });
  }, [baseSearchResults, statusDisplayFilter]);
  
  const activeResultCount = visualMatchEnabled && visualMatchResults.length > 0
    ? visualMatchResults.length
    : searchMode === 'map' 
      ? mapSearchResults.length 
      : totalResults;

  const handleAddComparable = (property: Property) => {
    if (!comparables.find(p => p.id === property.id)) {
      setComparables([...comparables, property]);
    }
  };

  const handleRemoveComparable = (propertyId: string) => {
    setComparables(comparables.filter(p => p.id !== propertyId));
  };

  const handleSetSubject = (property: Property) => {
    setSubjectProperty(property);
  };

  const generateDefaultCMAName = () => {
    // Get status description
    const statusLabels = searchStatuses.map(s => {
      if (s === 'active') return 'Active';
      if (s === 'under_contract') return 'Active Under Contract';
      if (s === 'closed') return 'Closed';
      return s;
    }).join(' & ');
    
    // Get location from search criteria or first property
    const location = searchSubdivision 
      || searchCity 
      || comparables[0]?.subdivision 
      || comparables[0]?.city 
      || 'Properties';
    
    // Format current date/time
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit' 
    });
    const timeStr = now.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
    
    return `${location} - ${statusLabels} - ${dateStr} ${timeStr}`;
  };

  const handleCreate = () => {
    if (!subjectProperty) {
      // Subject property is required
      return;
    }
    if (comparables.length > 0) {
      const allProperties = subjectProperty 
        ? [subjectProperty, ...comparables] 
        : comparables;
      
      // Use user-provided name or generate a descriptive default
      const finalName = cmaName.trim() || generateDefaultCMAName();
      
      // Build search criteria to save with CMA for "Modify Search" feature
      const searchCriteria = {
        city: searchCity,
        subdivision: searchSubdivision,
        zipCode: searchZipCode,
        minBeds: searchMinBeds,
        maxBeds: searchMaxBeds,
        minPrice: searchMinPrice,
        maxPrice: searchMaxPrice,
        minBaths: searchMinBaths,
        maxBaths: searchMaxBaths,
        statuses: searchStatuses,
        minSqft: searchMinSqft,
        maxSqft: searchMaxSqft,
        minLotAcres: searchMinLotAcres,
        maxLotAcres: searchMaxLotAcres,
        minYearBuilt: searchMinYearBuilt,
        maxYearBuilt: searchMaxYearBuilt,
        stories: searchStories,
        soldDays: searchSoldDays,
        propertyType: searchPropertyType,
      };
      
      onCreateCMA({
        name: finalName,
        subjectPropertyId: subjectProperty?.id,
        comparablePropertyIds: comparables.map(p => p.id),
        propertiesData: allProperties,
        searchCriteria,
      });
      resetForm();
    }
  };

  const formatPrice = (price: string | number | null | undefined) => {
    if (!price) return 'N/A';
    return `$${Number(price).toLocaleString()}`;
  };

  const getPriceDisplay = (property: Property) => {
    if (property.standardStatus === 'Closed' && property.closePrice) {
      return formatPrice(property.closePrice);
    }
    return formatPrice(property.listPrice);
  };

  const getPriceLabel = (property: Property) => {
    if (property.standardStatus === 'Closed' && property.closePrice) {
      return 'Closed';
    }
    return 'List';
  };

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>CMA Information</CardTitle>
          <CardDescription>Name your Comparative Market Analysis</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="cma-name">CMA Name</Label>
            <Input
              id="cma-name"
              name="cma-name"
              placeholder="Auto-generated: Subdivision - Status - Date/Time"
              value={cmaName}
              onChange={handleNameChange}
              data-testid="input-cma-name"
              autoComplete="on"
            />
          </div>
        </CardContent>
      </Card>

      <Card ref={searchSectionRef}>
        <CardHeader>
          <div className="flex items-center justify-between flex-wrap gap-2">
            <CardTitle className="flex items-center gap-2">
              <Search className="w-5 h-5" />
              Search Properties
            </CardTitle>
            <Button 
              variant="outline" 
              size="sm" 
              onClick={clearFilters}
              data-testid="button-clear-filters"
            >
              <RotateCcw className="w-4 h-4 mr-1" />
              Clear Filters
            </Button>
          </div>
          <CardDescription>
            Find comparable properties from the Repliers database (30,000+ active listings)
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <Tabs value={searchMode} onValueChange={(v) => setSearchMode(v as 'criteria' | 'map')} className="w-full">
            <TabsList className="grid w-full grid-cols-2 mb-4">
              <TabsTrigger value="criteria" className="gap-2" data-testid="tab-search-criteria">
                <ListFilter className="w-4 h-4" />
                Search by Criteria
              </TabsTrigger>
              <TabsTrigger value="map" className="gap-2" data-testid="tab-search-map">
                <Map className="w-4 h-4" />
                Search by Map
              </TabsTrigger>
            </TabsList>
            
            <TabsContent value="criteria" className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div className="space-y-2">
                  <Label>City</Label>
                  <AutocompleteInput
                    placeholder="e.g., Austin"
                    value={searchCity}
                    onChange={setSearchCity}
                    endpoint="/api/autocomplete/cities"
                    testId="input-search-city"
                    name="city"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Subdivision</Label>
                  <AutocompleteInput
                    placeholder="e.g., Barton Hills"
                    value={searchSubdivision}
                    onChange={setSearchSubdivision}
                    endpoint="/api/autocomplete/subdivisions"
                    testId="input-search-subdivision"
                    name="subdivision"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Zip Code</Label>
                  <AutocompleteInput
                    placeholder="e.g., 78704"
                    value={searchZipCode}
                    onChange={setSearchZipCode}
                    endpoint="/api/autocomplete/postalCodes"
                    testId="input-search-zipcode"
                    name="zipCode"
                  />
                </div>
                <div className="space-y-2">
                  <Label>School District</Label>
                  <AutocompleteInput
                    placeholder="e.g., Austin ISD"
                    value={searchSchoolDistrict}
                    onChange={setSearchSchoolDistrict}
                    endpoint="/api/autocomplete/schoolDistricts"
                    testId="input-search-school-district"
                    name="schoolDistrict"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Elementary School</Label>
                  <AutocompleteInput
                    placeholder="e.g., Barton Hills"
                    value={searchElementarySchool}
                    onChange={setSearchElementarySchool}
                    endpoint="/api/autocomplete/elementarySchools"
                    testId="input-search-elementary"
                    name="elementarySchool"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Middle School</Label>
                  <AutocompleteInput
                    placeholder="e.g., O Henry"
                    value={searchMiddleSchool}
                    onChange={setSearchMiddleSchool}
                    endpoint="/api/autocomplete/middleSchools"
                    testId="input-search-middle"
                    name="middleSchool"
                  />
                </div>
                <div className="space-y-2">
                  <Label>High School</Label>
                  <AutocompleteInput
                    placeholder="e.g., Austin High"
                    value={searchHighSchool}
                    onChange={setSearchHighSchool}
                    endpoint="/api/autocomplete/highSchools"
                    testId="input-search-high"
                    name="highSchool"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Min Beds</Label>
                  <Select value={searchMinBeds} onValueChange={setSearchMinBeds}>
                    <SelectTrigger data-testid="select-min-beds">
                      <SelectValue placeholder="Any" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="any">Any</SelectItem>
                      <SelectItem value="2">2+</SelectItem>
                      <SelectItem value="3">3+</SelectItem>
                      <SelectItem value="4">4+</SelectItem>
                      <SelectItem value="5">5+</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>Min Baths</Label>
                  <Select value={searchMinBaths} onValueChange={setSearchMinBaths}>
                    <SelectTrigger data-testid="select-min-baths">
                      <SelectValue placeholder="Any" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="any">Any</SelectItem>
                      <SelectItem value="1">1+</SelectItem>
                      <SelectItem value="2">2+</SelectItem>
                      <SelectItem value="3">3+</SelectItem>
                      <SelectItem value="4">4+</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>Min Price</Label>
                  <Select value={searchMinPrice} onValueChange={setSearchMinPrice}>
                    <SelectTrigger data-testid="select-min-price">
                      <SelectValue placeholder="Any" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="any">Any</SelectItem>
                      <SelectItem value="100000">$100K</SelectItem>
                      <SelectItem value="200000">$200K</SelectItem>
                      <SelectItem value="300000">$300K</SelectItem>
                      <SelectItem value="500000">$500K</SelectItem>
                      <SelectItem value="750000">$750K</SelectItem>
                      <SelectItem value="1000000">$1M</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>Max Price</Label>
                  <Select value={searchMaxPrice} onValueChange={setSearchMaxPrice}>
                    <SelectTrigger data-testid="select-max-price">
                      <SelectValue placeholder="Any" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="any">Any</SelectItem>
                      <SelectItem value="300000">$300K</SelectItem>
                      <SelectItem value="500000">$500K</SelectItem>
                      <SelectItem value="750000">$750K</SelectItem>
                      <SelectItem value="1000000">$1M</SelectItem>
                      <SelectItem value="2000000">$2M</SelectItem>
                      <SelectItem value="5000000">$5M</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>Property Type <span className="text-destructive">*</span></Label>
                  <Select value={searchPropertyType} onValueChange={setSearchPropertyType}>
                    <SelectTrigger data-testid="select-property-type">
                      <SelectValue placeholder="Select..." />
                    </SelectTrigger>
                    <SelectContent>
                      {PROPERTY_TYPES.map(type => (
                        <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="flex flex-wrap gap-4 items-center">
                <Label className="text-sm font-medium">Status:</Label>
                <div className="flex items-center space-x-2">
                  <Checkbox 
                    id="status-active"
                    checked={searchStatuses.includes("active")}
                    onCheckedChange={() => toggleStatus("active")}
                    data-testid="checkbox-status-active"
                  />
                  <label htmlFor="status-active" className="text-sm cursor-pointer">Active</label>
                </div>
                <div className="flex items-center space-x-2">
                  <Checkbox 
                    id="status-under-contract"
                    checked={searchStatuses.includes("under_contract")}
                    onCheckedChange={() => toggleStatus("under_contract")}
                    data-testid="checkbox-status-under-contract"
                  />
                  <label htmlFor="status-under-contract" className="text-sm cursor-pointer">Active Under Contract</label>
                </div>
                <div className="flex items-center space-x-2">
                  <Checkbox 
                    id="status-closed"
                    checked={searchStatuses.includes("closed")}
                    onCheckedChange={() => toggleStatus("closed")}
                    data-testid="checkbox-status-closed"
                  />
                  <label htmlFor="status-closed" className="text-sm cursor-pointer">Closed</label>
                </div>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                {/* Close Date - Only show when Closed status is selected */}
                {searchStatuses.includes("closed") && (
                  <div className="space-y-2">
                    <Label>Close Date <span className="text-destructive">*</span></Label>
                    <Select value={searchSoldDays} onValueChange={setSearchSoldDays}>
                      <SelectTrigger data-testid="select-sold-days">
                        <SelectValue placeholder="Select..." />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="90">0-90 days</SelectItem>
                        <SelectItem value="150">0-150 days</SelectItem>
                        <SelectItem value="180">0-180 days</SelectItem>
                        <SelectItem value="365">0-365 days (default)</SelectItem>
                        <SelectItem value="730">0-730 days (2 years)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                )}
                <div className="space-y-2">
                  <Label>Min Sq Ft</Label>
                  <Input
                    type="number"
                    placeholder="e.g., 2000"
                    value={searchMinSqft}
                    onChange={(e) => setSearchMinSqft(e.target.value)}
                    data-testid="input-min-sqft"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Max Sq Ft</Label>
                  <Input
                    type="number"
                    placeholder="e.g., 5000"
                    value={searchMaxSqft}
                    onChange={(e) => setSearchMaxSqft(e.target.value)}
                    data-testid="input-max-sqft"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Min Lot (Acres)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    placeholder="e.g., 0.25"
                    value={searchMinLotAcres}
                    onChange={(e) => setSearchMinLotAcres(e.target.value)}
                    data-testid="input-min-lot-acres"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Max Lot (Acres)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    placeholder="e.g., 1.0"
                    value={searchMaxLotAcres}
                    onChange={(e) => setSearchMaxLotAcres(e.target.value)}
                    data-testid="input-max-lot-acres"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Stories</Label>
                  <Select value={searchStories} onValueChange={setSearchStories}>
                    <SelectTrigger data-testid="select-stories">
                      <SelectValue placeholder="Any" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="any">Any</SelectItem>
                      <SelectItem value="1">1</SelectItem>
                      <SelectItem value="2">2</SelectItem>
                      <SelectItem value="3">3+</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label>Min Year Built</Label>
                  <Input
                    type="number"
                    placeholder="e.g., 1990"
                    value={searchMinYearBuilt}
                    onChange={(e) => setSearchMinYearBuilt(e.target.value)}
                    data-testid="input-min-year-built"
                  />
                </div>
                <div className="space-y-2">
                  <Label>Max Year Built</Label>
                  <Input
                    type="number"
                    placeholder="e.g., 2024"
                    value={searchMaxYearBuilt}
                    onChange={(e) => setSearchMaxYearBuilt(e.target.value)}
                    data-testid="input-max-year-built"
                  />
                </div>
              </div>
              
              <Separator className="my-4" />
              
              {/* Visual Match AI Search - rank comps by visual similarity */}
              <VisualMatchPanel
                enabled={visualMatchEnabled}
                onEnabledChange={(enabled) => {
                  setVisualMatchEnabled(enabled);
                  if (!enabled) {
                    setVisualMatchResults([]);
                    setVisualMatchError("");
                  }
                }}
                items={visualMatchItems}
                onItemsChange={setVisualMatchItems}
                isSearching={isVisualSearching}
                onSearch={handleVisualSearch}
                compact={true}
                error={visualMatchError}
              />
              
              <Separator className="my-4" />
              
              <Button onClick={handleSearch} disabled={isLoading} data-testid="button-search-properties">
                {isLoading ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <Search className="w-4 h-4 mr-2" />
                )}
                Search Properties
              </Button>
            </TabsContent>
            
            <TabsContent value="map" className="space-y-4">
              <PolygonMapSearch
                onSearch={handlePolygonSearch}
                onClear={handleClearPolygonSearch}
                isLoading={isMapSearching}
                resultCount={mapSearchResults.length}
              />
              
              <Separator className="my-6" />
              
              <div className="space-y-4">
                <h4 className="font-medium text-sm text-muted-foreground">Filter properties within polygon:</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  <div className="space-y-2">
                    <Label>City</Label>
                    <AutocompleteInput
                      placeholder="e.g., Austin"
                      value={searchCity}
                      onChange={setSearchCity}
                      endpoint="/api/autocomplete/cities"
                      testId="input-map-search-city"
                      name="map-city"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Subdivision</Label>
                    <AutocompleteInput
                      placeholder="e.g., Barton Hills"
                      value={searchSubdivision}
                      onChange={setSearchSubdivision}
                      endpoint="/api/autocomplete/subdivisions"
                      testId="input-map-search-subdivision"
                      name="map-subdivision"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Zip Code</Label>
                    <AutocompleteInput
                      placeholder="e.g., 78704"
                      value={searchZipCode}
                      onChange={setSearchZipCode}
                      endpoint="/api/autocomplete/postalCodes"
                      testId="input-map-search-zipcode"
                      name="map-zipCode"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Min Beds</Label>
                    <Select value={searchMinBeds} onValueChange={setSearchMinBeds}>
                      <SelectTrigger data-testid="select-map-min-beds">
                        <SelectValue placeholder="Any" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="any">Any</SelectItem>
                        <SelectItem value="2">2+</SelectItem>
                        <SelectItem value="3">3+</SelectItem>
                        <SelectItem value="4">4+</SelectItem>
                        <SelectItem value="5">5+</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Min Baths</Label>
                    <Select value={searchMinBaths} onValueChange={setSearchMinBaths}>
                      <SelectTrigger data-testid="select-map-min-baths">
                        <SelectValue placeholder="Any" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="any">Any</SelectItem>
                        <SelectItem value="1">1+</SelectItem>
                        <SelectItem value="2">2+</SelectItem>
                        <SelectItem value="3">3+</SelectItem>
                        <SelectItem value="4">4+</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Min Price</Label>
                    <Select value={searchMinPrice} onValueChange={setSearchMinPrice}>
                      <SelectTrigger data-testid="select-map-min-price">
                        <SelectValue placeholder="Any" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="any">Any</SelectItem>
                        <SelectItem value="100000">$100K</SelectItem>
                        <SelectItem value="200000">$200K</SelectItem>
                        <SelectItem value="300000">$300K</SelectItem>
                        <SelectItem value="500000">$500K</SelectItem>
                        <SelectItem value="750000">$750K</SelectItem>
                        <SelectItem value="1000000">$1M</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Max Price</Label>
                    <Select value={searchMaxPrice} onValueChange={setSearchMaxPrice}>
                      <SelectTrigger data-testid="select-map-max-price">
                        <SelectValue placeholder="Any" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="any">Any</SelectItem>
                        <SelectItem value="300000">$300K</SelectItem>
                        <SelectItem value="500000">$500K</SelectItem>
                        <SelectItem value="750000">$750K</SelectItem>
                        <SelectItem value="1000000">$1M</SelectItem>
                        <SelectItem value="2000000">$2M</SelectItem>
                        <SelectItem value="5000000">$5M</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Property Type <span className="text-destructive">*</span></Label>
                    <Select value={searchPropertyType} onValueChange={setSearchPropertyType}>
                      <SelectTrigger data-testid="select-map-property-type">
                        <SelectValue placeholder="Select..." />
                      </SelectTrigger>
                      <SelectContent>
                        {PROPERTY_TYPES.map(type => (
                          <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="flex flex-wrap gap-4 items-center">
                  <Label className="text-sm font-medium">Status:</Label>
                  <div className="flex items-center space-x-2">
                    <Checkbox 
                      id="map-status-active"
                      checked={searchStatuses.includes("active")}
                      onCheckedChange={() => toggleStatus("active")}
                      data-testid="checkbox-map-status-active"
                    />
                    <label htmlFor="map-status-active" className="text-sm cursor-pointer">Active</label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Checkbox 
                      id="map-status-under-contract"
                      checked={searchStatuses.includes("under_contract")}
                      onCheckedChange={() => toggleStatus("under_contract")}
                      data-testid="checkbox-map-status-uc"
                    />
                    <label htmlFor="map-status-under-contract" className="text-sm cursor-pointer">Active Under Contract</label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Checkbox 
                      id="map-status-closed"
                      checked={searchStatuses.includes("closed")}
                      onCheckedChange={() => toggleStatus("closed")}
                      data-testid="checkbox-map-status-closed"
                    />
                    <label htmlFor="map-status-closed" className="text-sm cursor-pointer">Closed</label>
                  </div>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                  {/* Close Date - Only show when Closed status is selected */}
                  {searchStatuses.includes("closed") && (
                    <div className="space-y-2">
                      <Label>Close Date <span className="text-destructive">*</span></Label>
                      <Select value={searchSoldDays} onValueChange={setSearchSoldDays}>
                        <SelectTrigger data-testid="select-map-sold-days">
                          <SelectValue placeholder="Select..." />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="90">0-90 days</SelectItem>
                          <SelectItem value="150">0-150 days</SelectItem>
                          <SelectItem value="180">0-180 days</SelectItem>
                          <SelectItem value="365">0-365 days (default)</SelectItem>
                          <SelectItem value="730">0-730 days (2 years)</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  )}
                  <div className="space-y-2">
                    <Label>Min Sq Ft</Label>
                    <Input
                      type="number"
                      placeholder="e.g., 2000"
                      value={searchMinSqft}
                      onChange={(e) => setSearchMinSqft(e.target.value)}
                      data-testid="input-map-min-sqft"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Max Sq Ft</Label>
                    <Input
                      type="number"
                      placeholder="e.g., 5000"
                      value={searchMaxSqft}
                      onChange={(e) => setSearchMaxSqft(e.target.value)}
                      data-testid="input-map-max-sqft"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Min Lot (Acres)</Label>
                    <Input
                      type="number"
                      step="0.01"
                      placeholder="e.g., 0.25"
                      value={searchMinLotAcres}
                      onChange={(e) => setSearchMinLotAcres(e.target.value)}
                      data-testid="input-map-min-lot-acres"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Max Lot (Acres)</Label>
                    <Input
                      type="number"
                      step="0.01"
                      placeholder="e.g., 1.0"
                      value={searchMaxLotAcres}
                      onChange={(e) => setSearchMaxLotAcres(e.target.value)}
                      data-testid="input-map-max-lot-acres"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Stories</Label>
                    <Select value={searchStories} onValueChange={setSearchStories}>
                      <SelectTrigger data-testid="select-map-stories">
                        <SelectValue placeholder="Any" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="any">Any</SelectItem>
                        <SelectItem value="1">1</SelectItem>
                        <SelectItem value="2">2</SelectItem>
                        <SelectItem value="3">3+</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Min Year Built</Label>
                    <Input
                      type="number"
                      placeholder="e.g., 1990"
                      value={searchMinYearBuilt}
                      onChange={(e) => setSearchMinYearBuilt(e.target.value)}
                      data-testid="input-map-min-year-built"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Max Year Built</Label>
                    <Input
                      type="number"
                      placeholder="e.g., 2024"
                      value={searchMaxYearBuilt}
                      onChange={(e) => setSearchMaxYearBuilt(e.target.value)}
                      data-testid="input-map-max-year-built"
                    />
                  </div>
                </div>
                <Button 
                  onClick={handleMapFilterSearch} 
                  disabled={isMapSearching || !currentBoundary} 
                  data-testid="button-map-search-properties"
                >
                  {isMapSearching ? (
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  ) : (
                    <Search className="w-4 h-4 mr-2" />
                  )}
                  {currentBoundary ? 'Search Properties' : 'Draw polygon first'}
                </Button>
              </div>
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              Subject Property
              <Tooltip>
                <TooltipTrigger asChild>
                  <Info className="w-4 h-4 text-muted-foreground cursor-help" />
                </TooltipTrigger>
                <TooltipContent side="bottom" className="max-w-xs z-[100]">
                  <p>The property you are creating this CMA for. This is typically your client's home that they want to sell or a property they're considering buying.</p>
                </TooltipContent>
              </Tooltip>
            </CardTitle>
          </CardHeader>
          <CardContent>
            {subjectProperty ? (
              <div className="space-y-4">
                <div className="p-4 border rounded-md">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <p className="font-semibold text-sm">{subjectProperty.unparsedAddress}</p>
                      <div className="flex items-center gap-2 text-xs text-muted-foreground mt-1">
                        <Badge variant="secondary">{getPriceLabel(subjectProperty)}</Badge>
                        <span className="font-medium">{getPriceDisplay(subjectProperty)}</span>
                      </div>
                    </div>
                    <Button
                      size="icon"
                      variant="ghost"
                      onClick={() => setSubjectProperty(null)}
                      data-testid="button-remove-subject"
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </div>
                  <div className="flex gap-2 text-xs text-muted-foreground">
                    <span>{subjectProperty.bedroomsTotal} beds</span>
                    <span></span>
                    <span>{subjectProperty.bathroomsTotalInteger} baths</span>
                    <span></span>
                    <span>{subjectProperty.livingArea && `${Number(subjectProperty.livingArea).toLocaleString()} sqft`}</span>
                  </div>
                </div>
                <p className="text-xs text-muted-foreground mb-3">
                  This property will be the focus of your CMA analysis
                </p>
                <Button
                  variant="outline"
                  className="w-full"
                  onClick={() => {
                    // Auto-fill search criteria based on subject property
                    const sp = subjectProperty;
                    if (sp) {
                      // Set status to Closed for sold comps
                      setSearchStatuses(['closed']);
                      
                      // Set location from subject
                      if (sp.subdivision) setSearchSubdivision(sp.subdivision);
                      else if (sp.city) setSearchCity(sp.city);
                      if (sp.postalCode) setSearchZipCode(sp.postalCode);
                      
                      // Set sqft range (20%)
                      if (sp.livingArea) {
                        const sqft = Number(sp.livingArea);
                        const minSqft = Math.floor(sqft * 0.8);
                        const maxSqft = Math.ceil(sqft * 1.2);
                        setSearchMinSqft(String(minSqft));
                        setSearchMaxSqft(String(maxSqft));
                      }
                      
                      // Set beds (same or 1)
                      if (sp.bedroomsTotal) {
                        const beds = Number(sp.bedroomsTotal);
                        setSearchMinBeds(String(Math.max(1, beds - 1)));
                        setSearchMaxBeds(String(beds + 1));
                      }
                      
                      // Set baths (same or 1)
                      if (sp.bathroomsTotalInteger) {
                        const baths = Number(sp.bathroomsTotalInteger);
                        setSearchMinBaths(String(Math.max(1, baths - 1)));
                        setSearchMaxBaths(String(baths + 1));
                      }
                      
                      // Set sold days to last 6 months
                      setSearchSoldDays('180');
                      
                      // Trigger search
                      setSearchEnabled(true);
                      setTimeout(() => {
                        searchSectionRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                      }, 100);
                    }
                  }}
                  data-testid="button-find-sold-comps"
                >
                  <Search className="w-4 h-4 mr-2" />
                  Find Sold Comparables
                </Button>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="space-y-2">
                  <Label>Search by Address</Label>
                  <div className="flex gap-2">
                    <Input
                      placeholder="Enter property address..."
                      value={manualSubjectAddress}
                      onChange={(e) => setManualSubjectAddress(e.target.value)}
                      onKeyDown={async (e) => {
                        if (e.key === 'Enter' && manualSubjectAddress.length > 5) {
                          e.preventDefault();
                          try {
                            const res = await fetch(`/api/search?address=${encodeURIComponent(manualSubjectAddress)}&limit=1`);
                            const data = await res.json();
                            if (data.properties?.[0]) {
                              setSubjectProperty(data.properties[0]);
                              setManualSubjectAddress("");
                              setManualSubjectCity("");
                              setManualSubjectState("");
                              setManualSubjectZip("");
                            }
                          } catch (err) {
                            console.error('Address search error:', err);
                          }
                        }
                      }}
                      autoComplete="off"
                      data-testid="input-subject-address"
                      className="flex-1"
                    />
                    <Button
                      type="button"
                      variant="outline"
                      size="icon"
                      onClick={async () => {
                        if (manualSubjectAddress.length > 5) {
                          try {
                            const res = await fetch(`/api/search?address=${encodeURIComponent(manualSubjectAddress)}&limit=1`);
                            const data = await res.json();
                            if (data.properties?.[0]) {
                              setSubjectProperty(data.properties[0]);
                              setManualSubjectAddress("");
                              setManualSubjectCity("");
                              setManualSubjectState("");
                              setManualSubjectZip("");
                            }
                          } catch (err) {
                            console.error('Address search error:', err);
                          }
                        }
                      }}
                      data-testid="button-search-subject-address"
                    >
                      <Search className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-2">
                  <div className="space-y-1">
                    <Label className="text-xs">City</Label>
                    <Input 
                      placeholder="City" 
                      className="h-8 text-xs"
                      value={manualSubjectCity}
                      onChange={(e) => setManualSubjectCity(e.target.value)}
                      data-testid="input-subject-city"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">State</Label>
                    <Input 
                      placeholder="TX" 
                      className="h-8 text-xs"
                      value={manualSubjectState}
                      onChange={(e) => setManualSubjectState(e.target.value)}
                      data-testid="input-subject-state"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Zip</Label>
                    <Input 
                      placeholder="Zip" 
                      className="h-8 text-xs"
                      value={manualSubjectZip}
                      onChange={(e) => setManualSubjectZip(e.target.value)}
                      data-testid="input-subject-zip"
                    />
                  </div>
                </div>
                <div className="grid grid-cols-4 gap-2">
                  <div className="space-y-1">
                    <Label className="text-xs">List Price <span className="text-destructive">*</span></Label>
                    <Input 
                      type="text"
                      inputMode="numeric"
                      placeholder="500000" 
                      className="h-8 text-xs"
                      value={manualSubjectListPrice}
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9]/g, '');
                        setManualSubjectListPrice(val);
                      }}
                      data-testid="input-subject-listprice"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Beds</Label>
                    <Input 
                      type="text"
                      inputMode="numeric"
                      placeholder="3" 
                      className="h-8 text-xs"
                      value={manualSubjectBeds}
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9]/g, '');
                        setManualSubjectBeds(val);
                      }}
                      data-testid="input-subject-beds"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Baths</Label>
                    <Input 
                      type="text"
                      inputMode="numeric"
                      placeholder="2" 
                      className="h-8 text-xs"
                      value={manualSubjectBaths}
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9]/g, '');
                        setManualSubjectBaths(val);
                      }}
                      data-testid="input-subject-baths"
                    />
                  </div>
                  <div className="space-y-1">
                    <Label className="text-xs">Sq Ft <span className="text-destructive">*</span></Label>
                    <Input 
                      type="text"
                      inputMode="numeric"
                      pattern="[0-9]*"
                      placeholder="2000" 
                      className="h-8 text-xs"
                      value={manualSubjectSqft}
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9]/g, '');
                        setManualSubjectSqft(val);
                      }}
                      data-testid="input-subject-sqft"
                    />
                  </div>
                </div>
                {manualSubjectAddress.trim() && (!manualSubjectSqft.trim() || !manualSubjectListPrice.trim()) && (
                  <p className="text-xs text-muted-foreground text-center">
                    List price and square footage are required for pricing analysis
                  </p>
                )}
                {manualSubjectAddress.trim() && manualSubjectSqft.trim() && manualSubjectListPrice.trim() && (
                  <Button
                    variant="outline"
                    className="w-full"
                    onClick={() => {
                      const manualProperty = {
                        id: `manual-${Date.now()}`,
                        listingId: `manual-${Date.now()}`,
                        unparsedAddress: manualSubjectAddress.trim(),
                        streetNumber: '',
                        streetName: manualSubjectAddress.trim(),
                        city: manualSubjectCity.trim() || 'Unknown',
                        stateOrProvince: manualSubjectState.trim() || 'TX',
                        postalCode: manualSubjectZip.trim() || '',
                        latitude: null,
                        longitude: null,
                        listPrice: manualSubjectListPrice ? Number(manualSubjectListPrice) : null,
                        closePrice: null,
                        originalListPrice: null,
                        bedroomsTotal: manualSubjectBeds ? Number(manualSubjectBeds) : null,
                        bathroomsTotalInteger: manualSubjectBaths ? Number(manualSubjectBaths) : null,
                        livingArea: manualSubjectSqft ? Number(manualSubjectSqft) : null,
                        lotSizeAcres: null,
                        lotSizeSquareFeet: null,
                        yearBuilt: null,
                        propertyType: 'Residential',
                        propertySubType: null,
                        standardStatus: 'Active',
                        listingContractDate: null,
                        closeDate: null,
                        daysOnMarket: null,
                        neighborhood: null,
                        subdivision: null,
                        subdivisionName: null,
                        poolPrivateYn: null,
                        garageSpaces: null,
                        storiesTotal: null,
                        elementarySchool: null,
                        middleSchool: null,
                        highSchool: null,
                        publicRemarks: null,
                        mlsNumber: null,
                        virtualTourUrl: null,
                      } as unknown as Property;
                      setSubjectProperty(manualProperty);
                      // Reset form fields after setting subject
                      setManualSubjectAddress("");
                      setManualSubjectCity("");
                      setManualSubjectState("");
                      setManualSubjectZip("");
                      setManualSubjectListPrice("");
                      setManualSubjectBeds("");
                      setManualSubjectBaths("");
                      setManualSubjectSqft("");
                    }}
                    data-testid="button-use-manual-subject"
                  >
                    <Home className="w-4 h-4 mr-2" />
                    Use This Address as Subject
                  </Button>
                )}
                <div className="text-center text-muted-foreground">
                  <p className="text-xs mb-2">or</p>
                  <div 
                    className="py-4 cursor-pointer hover-elevate rounded-lg border border-dashed border-muted-foreground/30 transition-colors hover:border-primary/50"
                    onClick={() => searchSectionRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' })}
                    data-testid="button-select-subject"
                  >
                    <MousePointerClick className="w-6 h-6 mx-auto mb-2 opacity-50" />
                    <p className="text-xs">Select from search results below</p>
                  </div>
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              Comparable Properties
              <Tooltip>
                <TooltipTrigger asChild>
                  <Info className="w-4 h-4 text-muted-foreground cursor-help" />
                </TooltipTrigger>
                <TooltipContent side="bottom" className="max-w-xs z-[100]">
                  <p>Similar properties in the area that help establish market value. Select properties with similar features, location, and condition to the subject property.</p>
                </TooltipContent>
              </Tooltip>
              {comparables.length > 0 && (
                <Badge variant="secondary">{comparables.length} selected</Badge>
              )}
            </CardTitle>
          </CardHeader>
          <CardContent>
            {comparables.length > 0 ? (
              <div className="space-y-3">
                {comparables.map((property, index) => (
                  <div key={property.id} className="p-4 border rounded-md">
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs font-semibold text-muted-foreground">#{index + 1}</span>
                          <p className="font-semibold text-sm line-clamp-1">{property.unparsedAddress}</p>
                        </div>
                        <div className="flex items-center gap-2 text-xs text-muted-foreground">
                          <Badge variant="secondary">{getPriceLabel(property)}</Badge>
                          <span className="font-medium">{getPriceDisplay(property)}</span>
                        </div>
                      </div>
                      <Button
                        size="icon"
                        variant="ghost"
                        onClick={() => handleRemoveComparable(property.id)}
                        data-testid={`button-remove-comparable-${index}`}
                      >
                        <X className="w-4 h-4" />
                      </Button>
                    </div>
                    <div className="flex gap-2 text-xs text-muted-foreground">
                      <span>{property.bedroomsTotal} beds</span>
                      <span></span>
                      <span>{property.bathroomsTotalInteger} baths</span>
                      <span></span>
                      <span>{property.livingArea && `${Number(property.livingArea).toLocaleString()} sqft`}</span>
                    </div>
                  </div>
                ))}
                </div>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                <Plus className="w-8 h-8 mx-auto mb-2 opacity-50" />
                <p className="text-sm mb-2">No comparables selected</p>
                <p className="text-xs">Search and select properties to compare</p>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              Analysis
              <Tooltip>
                <TooltipTrigger asChild>
                  <Info className="w-4 h-4 text-muted-foreground cursor-help" />
                </TooltipTrigger>
                <TooltipContent side="bottom" className="max-w-xs z-[100]">
                  <p>Summary statistics calculated from your selected comparable properties including average price, square footage, and price per sqft to help determine fair market value.</p>
                </TooltipContent>
              </Tooltip>
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {comparables.length > 0 ? (
              <>
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="text-muted-foreground">Avg Price</span>
                    <span className="font-semibold">
                      {formatPrice(
                        comparables.reduce((sum, p) => {
                          const price = p.standardStatus === 'Closed' && p.closePrice 
                            ? Number(p.closePrice) 
                            : Number(p.listPrice || 0);
                          return sum + price;
                        }, 0) / comparables.length
                      )}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-muted-foreground">Avg Sqft</span>
                    <span className="font-semibold">
                      {Math.round(
                        comparables.reduce((sum, p) => sum + Number(p.livingArea || 0), 0) / comparables.length
                      ).toLocaleString()}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-muted-foreground">Avg $/Sqft</span>
                    <span className="font-semibold">
                      ${(
                        comparables.reduce((sum, p) => {
                          const price = p.standardStatus === 'Closed' && p.closePrice 
                            ? Number(p.closePrice) 
                            : Number(p.listPrice || 0);
                          const sqft = Number(p.livingArea || 1);
                          return sum + (price / sqft);
                        }, 0) / comparables.length
                      ).toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-muted-foreground">Price Range</span>
                    <span className="font-semibold text-xs">
                      {formatPrice(Math.min(...comparables.map(p => {
                        return p.standardStatus === 'Closed' && p.closePrice 
                          ? Number(p.closePrice) 
                          : Number(p.listPrice || 0);
                      })))} - {formatPrice(Math.max(...comparables.map(p => {
                        return p.standardStatus === 'Closed' && p.closePrice 
                          ? Number(p.closePrice) 
                          : Number(p.listPrice || 0);
                      })))}
                    </span>
                  </div>
                </div>

                <Separator />

                <Button 
                  className="w-full" 
                  onClick={handleCreate}
                  disabled={comparables.length === 0 || !subjectProperty}
                  data-testid="button-generate-report"
                >
                  <TrendingUp className="w-4 h-4 mr-2" />
                  Generate Report
                </Button>
                {!subjectProperty && comparables.length > 0 && (
                  <p className="text-xs text-amber-600 text-center mt-2">
                    Subject property required
                  </p>
                )}
              </>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                <TrendingUp className="w-8 h-8 mx-auto mb-2 opacity-50" />
                <p className="text-xs">Add properties to see analysis</p>
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader>
          <div className="flex flex-col gap-3">
            <div className="flex items-center justify-between flex-wrap gap-2">
              <CardTitle className="flex items-center gap-2">
                Search Results 
                {statusDisplayFilter === 'all' ? (
                  activeResultCount > 0 && ` (${activeResultCount.toLocaleString()} found)`
                ) : (
                  <>
                    {` (${activeSearchResults.length} `}
                    {statusDisplayFilter === 'active' ? 'Active' : 
                      statusDisplayFilter === 'underContract' ? 'Under Contract' : 'Closed'}
                    {`)  `}
                    <span className="text-muted-foreground font-normal text-sm">
                      of {statusCounts.all} total
                    </span>
                  </>
                )}
                {searchMode === 'map' && mapSearchResults.length > 0 && (
                  <Badge variant="outline" className="ml-2">
                    <Map className="w-3 h-3 mr-1" />
                    Map Search
                  </Badge>
                )}
              </CardTitle>
              
              {/* View Toggle */}
              {baseSearchResults.length > 0 && (
                <div className="flex items-center gap-1" data-testid="view-toggle">
                  <Button
                    size="icon"
                    variant={viewMode === 'grid' ? 'default' : 'ghost'}
                    className="toggle-elevate"
                    onClick={() => handleViewModeChange('grid')}
                    data-testid="button-view-grid"
                    title="Grid View"
                  >
                    <LayoutGrid className="w-4 h-4" />
                  </Button>
                  <Button
                    size="icon"
                    variant={viewMode === 'list' ? 'default' : 'ghost'}
                    className="toggle-elevate"
                    onClick={() => handleViewModeChange('list')}
                    data-testid="button-view-list"
                    title="List View"
                  >
                    <List className="w-4 h-4" />
                  </Button>
                  <Button
                    size="icon"
                    variant={viewMode === 'table' ? 'default' : 'ghost'}
                    className="toggle-elevate"
                    onClick={() => handleViewModeChange('table')}
                    data-testid="button-view-table"
                    title="Table View"
                  >
                    <Table2 className="w-4 h-4" />
                  </Button>
                </div>
              )}
            </div>
            
            {/* Status Filter Tabs - only show when there are results */}
            {baseSearchResults.length > 0 && (
              <StatusFilterTabs
                counts={statusCounts}
                activeFilter={statusDisplayFilter}
                onFilterChange={setStatusDisplayFilter}
              />
            )}
          </div>
        </CardHeader>
        <CardContent>
          {/* School filter warning */}
          {schoolFilterWarning && searchEnabled && !isLoading && (
            <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-md">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" />
                <p className="text-sm text-amber-800 dark:text-amber-200">{schoolFilterWarning}</p>
              </div>
            </div>
          )}
          
          {/* Warning 1: No subdivision filter when ZIP is filled */}
          {!searchSubdivision && searchZipCode && searchEnabled && !isLoading && baseSearchResults.length > 0 && (
            <div className="mb-4 p-3 bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-md" data-testid="warning-no-subdivision">
              <div className="flex items-start gap-2">
                <Info className="w-4 h-4 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0" />
                <p className="text-sm text-yellow-800 dark:text-yellow-200">
                  <span className="font-medium">Tip:</span> No subdivision filter applied. Results include ALL subdivisions in ZIP {searchZipCode}.
                </p>
              </div>
            </div>
          )}
          
          {/* Warning 2: Closed status selected but 0 results */}
          {searchStatuses.includes('closed') && statusCounts.closed === 0 && searchEnabled && !isLoading && (
            <div className="mb-4 p-3 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-md" data-testid="warning-no-closed">
              <div className="flex flex-col gap-2">
                <div className="flex items-start gap-2">
                  <Info className="w-4 h-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" />
                  <div>
                    <p className="text-sm font-medium text-blue-800 dark:text-blue-200">No Closed Listings Found</p>
                    <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                      No properties matching your criteria have closed in the last {searchSoldDays || 365} days.
                    </p>
                  </div>
                </div>
                <div className="flex flex-wrap gap-2 ml-6">
                  {searchSoldDays !== '365' && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-7 text-xs bg-blue-100 dark:bg-blue-900 border-blue-200 dark:border-blue-700 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800"
                      onClick={() => {
                        setSearchSoldDays('365');
                        setSearchEnabled(true);
                        setTimeout(() => refetch(), 100);
                      }}
                      data-testid="button-try-365-days"
                    >
                      Try 365 days
                    </Button>
                  )}
                  {(searchMinSqft || searchMaxSqft) && (
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-7 text-xs bg-blue-100 dark:bg-blue-900 border-blue-200 dark:border-blue-700 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800"
                      onClick={() => {
                        setSearchMinSqft('');
                        setSearchMaxSqft('');
                        setSearchEnabled(true);
                        setTimeout(() => refetch(), 100);
                      }}
                      data-testid="button-remove-sqft-limits"
                    >
                      Remove sqft limits
                    </Button>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {/* Warning 3: Very narrow sqft range */}
          {searchMinSqft && searchMaxSqft && 
           (parseInt(searchMaxSqft) - parseInt(searchMinSqft)) < 2000 && 
           (parseInt(searchMaxSqft) - parseInt(searchMinSqft)) > 0 &&
           searchEnabled && !isLoading && (
            <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-md" data-testid="warning-narrow-sqft">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" />
                <p className="text-sm text-amber-800 dark:text-amber-200">
                  <span className="font-medium">Note:</span> Narrow sqft range ({parseInt(searchMaxSqft) - parseInt(searchMinSqft)} sqft) may limit results.
                </p>
              </div>
            </div>
          )}
          
          {(isLoading || isMapSearching) ? (
            <div className="text-center py-12">
              <Loader2 className="w-8 h-8 mx-auto animate-spin text-muted-foreground mb-2" />
              <p className="text-sm text-muted-foreground">Searching properties...</p>
            </div>
          ) : isError && searchMode === 'criteria' ? (
            <div className="text-center py-12">
              <AlertCircle className="w-8 h-8 mx-auto text-destructive mb-2" />
              <p className="text-sm text-destructive mb-2">Unable to search properties</p>
              <p className="text-xs text-muted-foreground">
                The property search service may be temporarily unavailable. Please try again later.
              </p>
            </div>
          ) : activeSearchResults.length > 0 ? (
            <>
              {/* GRID VIEW */}
              {viewMode === 'grid' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {activeSearchResults.map((property) => {
                    const photos = (property as any).photos as string[] | undefined;
                    const primaryPhoto = photos?.[0];
                    const pricePerSqft = property.livingArea 
                      ? (property.standardStatus === 'Closed' && property.closePrice 
                          ? Number(property.closePrice) 
                          : Number(property.listPrice || 0)) / Number(property.livingArea)
                      : null;
                    const listingDate = property.listingContractDate 
                      ? new Date(property.listingContractDate).toLocaleDateString()
                      : null;
                    const getStatusBadge = () => {
                      if (property.standardStatus === 'Closed') {
                        return <Badge variant="secondary" className="flex-shrink-0">Closed</Badge>;
                      } else if (property.standardStatus === 'Active') {
                        return <Badge variant="default" className="flex-shrink-0 bg-green-600 hover:bg-green-600">Active</Badge>;
                      } else if (property.standardStatus === 'Active Under Contract') {
                        return <Badge variant="default" className="flex-shrink-0 bg-amber-500 hover:bg-amber-500">Active Under Contract</Badge>;
                      }
                      return <Badge variant="secondary" className="flex-shrink-0">{property.standardStatus}</Badge>;
                    };
                    const matchTier = (property as any).matchTier as string | undefined;
                    
                    return (
                      <Card 
                        key={property.id} 
                        className="overflow-hidden cursor-pointer hover-elevate relative"
                        onClick={() => {
                          setSelectedProperty(property);
                          setCurrentPhotoIndex(0);
                        }}
                        data-testid={`card-property-${property.id}`}
                      >
                        {matchTier && visualMatchEnabled && (
                          <div className="absolute top-2 left-2 z-10">
                            <Badge 
                              className={cn(
                                "text-xs",
                                matchTier === 'High' && "bg-emerald-500 text-white hover:bg-emerald-500",
                                matchTier === 'Medium' && "bg-amber-500 text-white hover:bg-amber-500",
                                matchTier === 'Low' && "bg-gray-500 text-white hover:bg-gray-500"
                              )}
                            >
                              <Sparkles className="w-3 h-3 mr-1" />
                              {matchTier} Match
                            </Badge>
                          </div>
                        )}
                        <div className="flex">
                          {primaryPhoto ? (
                            <div className="w-32 h-32 flex-shrink-0">
                              <img 
                                src={primaryPhoto} 
                                alt={property.unparsedAddress || 'Property'}
                                className="w-full h-full object-cover"
                              />
                            </div>
                          ) : (
                            <div className="w-32 h-32 flex-shrink-0 bg-muted flex flex-col items-center justify-center p-2">
                              <Home className="w-6 h-6 text-muted-foreground/50 mb-1" />
                              <span className="text-[10px] text-muted-foreground text-center leading-tight">No photos available</span>
                            </div>
                          )}
                          <CardContent className="flex-1 p-3 space-y-2">
                            <div className="flex items-start justify-between gap-2">
                              <div className="flex-1 min-w-0">
                                <p className="font-semibold text-sm line-clamp-1" data-testid={`text-address-${property.id}`}>
                                  {property.unparsedAddress}
                                </p>
                                {property.subdivision && (
                                  <p className="text-xs text-muted-foreground line-clamp-1">
                                    {property.subdivision}
                                  </p>
                                )}
                              </div>
                              {getStatusBadge()}
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="font-bold text-lg text-primary">{getPriceDisplay(property)}</span>
                              {pricePerSqft && (
                                <span className="text-xs text-muted-foreground">${pricePerSqft.toFixed(0)}/sqft</span>
                              )}
                            </div>
                            <div className="flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground">
                              <span>{property.bedroomsTotal || 0} beds</span>
                              <span>{property.bathroomsFull || property.bathroomsTotalInteger || 0}F/{property.bathroomsHalf || 0}H baths</span>
                              {property.livingArea && (
                                <span>{Number(property.livingArea).toLocaleString()} sqft</span>
                              )}
                              {property.yearBuilt && <span>Built {property.yearBuilt}</span>}
                            </div>
                            <div className="flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground">
                              {property.garageParkingSpaces !== null && property.garageParkingSpaces !== undefined && property.garageParkingSpaces > 0 && (
                                <span>{property.garageParkingSpaces} garage</span>
                              )}
                              {property.lotSizeAcres && Number(property.lotSizeAcres) > 0 && (
                                <span>{Number(property.lotSizeAcres).toFixed(2)} acres</span>
                              )}
                              {property.storiesTotal && Number(property.storiesTotal) > 0 && (
                                <span>{property.storiesTotal} story</span>
                              )}
                              {property.daysOnMarket !== null && property.daysOnMarket !== undefined && (
                                <span>{property.daysOnMarket} DOM</span>
                              )}
                            </div>
                            <div className="flex flex-wrap gap-x-2 gap-y-1 text-xs text-muted-foreground">
                              {listingDate && <span>Listed: {listingDate}</span>}
                              {property.standardStatus === 'Closed' && property.closeDate && (
                                <span>Closed: {new Date(property.closeDate).toLocaleDateString()}</span>
                              )}
                              {property.standardStatus === 'Closed' && property.closePrice && (
                                <span className="font-medium text-foreground">
                                  Close: ${Number(property.closePrice).toLocaleString()}
                                </span>
                              )}
                            </div>
                            <div className="flex gap-2 pt-1" onClick={(e) => e.stopPropagation()}>
                              <Button
                                size="sm"
                                variant="outline"
                                className="flex-1"
                                onClick={() => handleSetSubject(property)}
                                disabled={subjectProperty?.id === property.id}
                                data-testid={`button-set-subject-${property.id}`}
                              >
                                Set as Subject
                              </Button>
                              {comparables.some(p => p.id === property.id) ? (
                                <Button
                                  size="sm"
                                  variant="destructive"
                                  className="flex-1"
                                  onClick={() => handleRemoveComparable(property.id)}
                                  data-testid={`button-remove-comparable-${property.id}`}
                                >
                                  <X className="w-3 h-3 mr-1" />
                                  Remove
                                </Button>
                              ) : (
                                <Button
                                  size="sm"
                                  className="flex-1"
                                  onClick={() => handleAddComparable(property)}
                                  disabled={comparables.length >= 15}
                                  data-testid={`button-add-comparable-${property.id}`}
                                >
                                  <Plus className="w-3 h-3 mr-1" />
                                  Add
                                </Button>
                              )}
                            </div>
                          </CardContent>
                        </div>
                      </Card>
                    );
                  })}
                </div>
              )}
              
              {/* LIST VIEW */}
              {viewMode === 'list' && (
                <div className="flex flex-col gap-3">
                  {activeSearchResults.map((property) => {
                    const photos = (property as any).photos as string[] | undefined;
                    const primaryPhoto = photos?.[0];
                    const pricePerSqft = property.livingArea 
                      ? (property.standardStatus === 'Closed' && property.closePrice 
                          ? Number(property.closePrice) 
                          : Number(property.listPrice || 0)) / Number(property.livingArea)
                      : null;
                    const getStatusBadge = () => {
                      if (property.standardStatus === 'Closed') {
                        return <Badge variant="secondary" className="flex-shrink-0">Closed</Badge>;
                      } else if (property.standardStatus === 'Active') {
                        return <Badge variant="default" className="flex-shrink-0 bg-green-600 hover:bg-green-600">Active</Badge>;
                      } else if (property.standardStatus === 'Active Under Contract') {
                        return <Badge variant="default" className="flex-shrink-0 bg-amber-500 hover:bg-amber-500">Active Under Contract</Badge>;
                      }
                      return <Badge variant="secondary" className="flex-shrink-0">{property.standardStatus}</Badge>;
                    };
                    
                    return (
                      <Card 
                        key={property.id}
                        className="overflow-hidden cursor-pointer hover-elevate"
                        onClick={() => {
                          setSelectedProperty(property);
                          setCurrentPhotoIndex(0);
                        }}
                        data-testid={`list-property-${property.id}`}
                      >
                        <div className="flex flex-col md:flex-row">
                          {primaryPhoto ? (
                            <div className="w-full md:w-48 h-36 flex-shrink-0">
                              <img 
                                src={primaryPhoto} 
                                alt={property.unparsedAddress || 'Property'}
                                className="w-full h-full object-cover"
                              />
                            </div>
                          ) : (
                            <div className="w-full md:w-48 h-36 flex-shrink-0 bg-muted flex flex-col items-center justify-center">
                              <Home className="w-8 h-8 text-muted-foreground/50 mb-1" />
                              <span className="text-xs text-muted-foreground">No photo</span>
                            </div>
                          )}
                          <div className="flex-1 p-4">
                            <div className="flex justify-between items-start gap-2 mb-2">
                              <div>
                                <h4 className="font-semibold text-base" data-testid={`text-list-address-${property.id}`}>
                                  {property.unparsedAddress}
                                </h4>
                                {property.subdivision && (
                                  <p className="text-sm text-muted-foreground">{property.subdivision}</p>
                                )}
                              </div>
                              {getStatusBadge()}
                            </div>
                            <div className="flex items-center gap-4 mb-2">
                              <span className="text-xl font-bold text-primary">{getPriceDisplay(property)}</span>
                              {pricePerSqft && (
                                <span className="text-sm text-muted-foreground">${pricePerSqft.toFixed(0)}/sqft</span>
                              )}
                            </div>
                            <div className="flex flex-wrap items-center gap-4 text-sm text-muted-foreground mb-2">
                              <span>{property.bedroomsTotal || 0} beds</span>
                              <span>{property.bathroomsFull || property.bathroomsTotalInteger || 0}F/{property.bathroomsHalf || 0}H baths</span>
                              {property.livingArea && (
                                <span>{Number(property.livingArea).toLocaleString()} sqft</span>
                              )}
                              {property.yearBuilt && <span>Built {property.yearBuilt}</span>}
                              {property.daysOnMarket !== null && property.daysOnMarket !== undefined && (
                                <span>{property.daysOnMarket} DOM</span>
                              )}
                              {property.lotSizeAcres && Number(property.lotSizeAcres) > 0 && (
                                <span>{Number(property.lotSizeAcres).toFixed(2)} acres</span>
                              )}
                            </div>
                            {property.standardStatus === 'Closed' && (
                              <div className="text-sm text-muted-foreground mb-2">
                                {property.closeDate && (
                                  <span>Closed: {new Date(property.closeDate).toLocaleDateString()}</span>
                                )}
                                {property.closePrice && (
                                  <span className="ml-2 font-medium text-foreground">
                                    Close: ${Number(property.closePrice).toLocaleString()}
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                          <div className="flex md:flex-col justify-center gap-2 p-4 border-t md:border-t-0 md:border-l" onClick={(e) => e.stopPropagation()}>
                            <Button 
                              size="sm"
                              variant="outline"
                              onClick={() => handleSetSubject(property)}
                              disabled={subjectProperty?.id === property.id}
                              data-testid={`button-list-subject-${property.id}`}
                            >
                              Set as Subject
                            </Button>
                            {comparables.some(p => p.id === property.id) ? (
                              <Button
                                size="sm"
                                variant="destructive"
                                onClick={() => handleRemoveComparable(property.id)}
                                data-testid={`button-list-remove-${property.id}`}
                              >
                                <X className="w-3 h-3 mr-1" />
                                Remove
                              </Button>
                            ) : (
                              <Button
                                size="sm"
                                onClick={() => handleAddComparable(property)}
                                disabled={comparables.length >= 15}
                                data-testid={`button-list-add-${property.id}`}
                              >
                                <Plus className="w-3 h-3 mr-1" />
                                Add
                              </Button>
                            )}
                          </div>
                        </div>
                      </Card>
                    );
                  })}
                </div>
              )}
              
              {/* TABLE VIEW */}
              {viewMode === 'table' && (
                <div className="overflow-x-auto border rounded-lg">
                  <table className="w-full text-sm">
                    <thead className="bg-muted/50">
                      <tr>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Address</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Status</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Price</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Beds</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Baths</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Sq Ft</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">$/Sqft</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Year</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">DOM</th>
                        <th className="px-3 py-3 text-left font-medium text-muted-foreground">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {activeSearchResults.map((property) => {
                        const photos = (property as any).photos as string[] | undefined;
                        const primaryPhoto = photos?.[0];
                        const pricePerSqft = property.livingArea 
                          ? (property.standardStatus === 'Closed' && property.closePrice 
                              ? Number(property.closePrice) 
                              : Number(property.listPrice || 0)) / Number(property.livingArea)
                          : null;
                        const getStatusBadge = () => {
                          if (property.standardStatus === 'Closed') {
                            return <Badge variant="secondary" className="text-xs">Closed</Badge>;
                          } else if (property.standardStatus === 'Active') {
                            return <Badge variant="default" className="text-xs bg-green-600 hover:bg-green-600">Active</Badge>;
                          } else if (property.standardStatus === 'Active Under Contract') {
                            return <Badge variant="default" className="text-xs bg-amber-500 hover:bg-amber-500">AUC</Badge>;
                          }
                          return <Badge variant="secondary" className="text-xs">{property.standardStatus}</Badge>;
                        };
                        
                        return (
                          <tr 
                            key={property.id} 
                            className="hover:bg-muted/30 cursor-pointer"
                            onClick={() => {
                              setSelectedProperty(property);
                              setCurrentPhotoIndex(0);
                            }}
                            data-testid={`row-property-${property.id}`}
                          >
                            <td className="px-3 py-3">
                              <div className="flex items-center gap-2">
                                {primaryPhoto ? (
                                  <img 
                                    src={primaryPhoto} 
                                    alt=""
                                    className="w-10 h-8 object-cover rounded flex-shrink-0"
                                  />
                                ) : (
                                  <div className="w-10 h-8 bg-muted rounded flex items-center justify-center flex-shrink-0">
                                    <Home className="w-4 h-4 text-muted-foreground/50" />
                                  </div>
                                )}
                                <div className="min-w-0">
                                  <span className="font-medium block truncate max-w-[180px]" data-testid={`text-table-address-${property.id}`}>
                                    {property.unparsedAddress}
                                  </span>
                                  {property.subdivision && (
                                    <span className="text-xs text-muted-foreground block truncate max-w-[180px]">
                                      {property.subdivision}
                                    </span>
                                  )}
                                </div>
                              </div>
                            </td>
                            <td className="px-3 py-3">{getStatusBadge()}</td>
                            <td className="px-3 py-3 font-semibold text-primary whitespace-nowrap">
                              {getPriceDisplay(property)}
                            </td>
                            <td className="px-3 py-3">{property.bedroomsTotal || '-'}</td>
                            <td className="px-3 py-3">
                              {property.bathroomsFull || property.bathroomsTotalInteger || 0}F/{property.bathroomsHalf || 0}H
                            </td>
                            <td className="px-3 py-3 whitespace-nowrap">
                              {property.livingArea ? Number(property.livingArea).toLocaleString() : '-'}
                            </td>
                            <td className="px-3 py-3 whitespace-nowrap">
                              {pricePerSqft ? `$${pricePerSqft.toFixed(0)}` : '-'}
                            </td>
                            <td className="px-3 py-3">{property.yearBuilt || '-'}</td>
                            <td className="px-3 py-3">
                              {property.daysOnMarket !== null && property.daysOnMarket !== undefined ? property.daysOnMarket : '-'}
                            </td>
                            <td className="px-3 py-3" onClick={(e) => e.stopPropagation()}>
                              <div className="flex gap-1">
                                <Button 
                                  size="sm"
                                  variant="outline"
                                  className="text-xs px-2 py-1 h-7"
                                  onClick={() => handleSetSubject(property)}
                                  disabled={subjectProperty?.id === property.id}
                                  data-testid={`button-table-subject-${property.id}`}
                                >
                                  Subject
                                </Button>
                                {comparables.some(p => p.id === property.id) ? (
                                  <Button
                                    size="sm"
                                    variant="destructive"
                                    className="text-xs px-2 py-1 h-7"
                                    onClick={() => handleRemoveComparable(property.id)}
                                    data-testid={`button-table-remove-${property.id}`}
                                  >
                                    <X className="w-3 h-3" />
                                  </Button>
                                ) : (
                                  <Button
                                    size="sm"
                                    className="text-xs px-2 py-1 h-7"
                                    onClick={() => handleAddComparable(property)}
                                    disabled={comparables.length >= 15}
                                    data-testid={`button-table-add-${property.id}`}
                                  >
                                    <Plus className="w-3 h-3" />
                                  </Button>
                                )}
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </>
          ) : (searchEnabled || (searchMode === 'map' && mapSearchResults.length === 0)) ? (
            <div className="text-center py-12 text-muted-foreground">
              {searchMode === 'map' ? (
                <>
                  <Map className="w-12 h-12 mx-auto mb-4 opacity-50" />
                  <p className="text-sm mb-2">Draw a polygon on the map to search</p>
                  <p className="text-xs">Properties within your drawn area will appear here</p>
                </>
              ) : (
                <>
                  <Search className="w-12 h-12 mx-auto mb-4 opacity-50" />
                  <p className="text-sm mb-2">No properties found matching your criteria</p>
                  <p className="text-xs">Try adjusting your search filters</p>
                </>
              )}
            </div>
          ) : (
            <div className="text-center py-12 text-muted-foreground">
              <Search className="w-12 h-12 mx-auto mb-4 opacity-50" />
              <p className="text-sm mb-2">Search for properties to add to your CMA</p>
              <p className="text-xs">Use the filters above and click "Search Properties" or draw a map polygon</p>
            </div>
          )}
        </CardContent>
      </Card>
      
      {/* Property Detail Dialog */}
      <Dialog open={!!selectedProperty} onOpenChange={(open) => !open && setSelectedProperty(null)}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          {selectedProperty && (() => {
            // Photos are returned directly from Repliers API
            const photos = ((selectedProperty as any).photos as string[] | undefined) || [];
            const pricePerSqft = selectedProperty.livingArea 
              ? (selectedProperty.standardStatus === 'Closed' && selectedProperty.closePrice 
                  ? Number(selectedProperty.closePrice) 
                  : Number(selectedProperty.listPrice || 0)) / Number(selectedProperty.livingArea)
              : null;
            const listingDate = selectedProperty.listingContractDate 
              ? new Date(selectedProperty.listingContractDate).toLocaleDateString()
              : null;
              
            return (
              <>
                <DialogHeader>
                  <DialogTitle className="text-lg">{selectedProperty.unparsedAddress}</DialogTitle>
                </DialogHeader>
                
                {/* Photo Carousel */}
                {photos.length > 0 ? (
                  <div className="relative aspect-video bg-muted rounded-md overflow-hidden">
                    <img 
                      src={photos[currentPhotoIndex]} 
                      alt={`Property photo ${currentPhotoIndex + 1}`}
                      className="w-full h-full object-cover"
                      data-testid="img-cma-carousel"
                    />
                    {/* Click zones for navigation - invisible, covering full halves */}
                    {photos.length > 1 && (
                      <>
                        {/* Left click zone - covers left half */}
                        <div 
                          className="absolute left-0 top-0 w-1/2 h-full cursor-pointer z-10 group"
                          onClick={(e) => { e.stopPropagation(); setCurrentPhotoIndex(prev => (prev - 1 + photos.length) % photos.length); }}
                          data-testid="zone-cma-carousel-prev"
                        >
                          <div className="absolute left-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all opacity-70 group-hover:opacity-100">
                            <ChevronLeft className="w-5 h-5" />
                          </div>
                        </div>
                        {/* Right click zone - covers right half */}
                        <div 
                          className="absolute right-0 top-0 w-1/2 h-full cursor-pointer z-10 group"
                          onClick={(e) => { e.stopPropagation(); setCurrentPhotoIndex(prev => (prev + 1) % photos.length); }}
                          data-testid="zone-cma-carousel-next"
                        >
                          <div className="absolute right-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all opacity-70 group-hover:opacity-100">
                            <ChevronRight className="w-5 h-5" />
                          </div>
                        </div>
                        {/* Photo counter */}
                        <div className="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/60 text-white px-3 py-1.5 rounded-full text-sm font-medium z-20">
                          {currentPhotoIndex + 1} / {photos.length}
                        </div>
                      </>
                    )}
                  </div>
                ) : (
                  <div className="aspect-video bg-muted rounded-md flex flex-col items-center justify-center">
                    <Home className="w-12 h-12 text-muted-foreground/50 mb-2" />
                    <span className="text-sm text-muted-foreground">No photos available for this property</span>
                  </div>
                )}
                
                <ScrollArea className="max-h-[40vh]">
                  <div className="space-y-4 p-1">
                    {/* Price and Status */}
                    <div className="flex items-center justify-between gap-4">
                      <div>
                        <p className="text-2xl font-bold text-primary">{getPriceDisplay(selectedProperty)}</p>
                        {pricePerSqft && (
                          <p className="text-sm text-muted-foreground">${pricePerSqft.toFixed(0)}/sqft</p>
                        )}
                      </div>
                      {selectedProperty.standardStatus === 'Closed' ? (
                        <Badge variant="secondary" className="text-base px-3 py-1">Closed</Badge>
                      ) : selectedProperty.standardStatus === 'Active' ? (
                        <Badge className="bg-green-600 hover:bg-green-600 text-base px-3 py-1">Active</Badge>
                      ) : (
                        <Badge className="bg-amber-500 hover:bg-amber-500 text-base px-3 py-1">Active Under Contract</Badge>
                      )}
                    </div>
                    
                    {/* Property Details */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="text-center p-3 bg-muted rounded-md">
                        <p className="text-2xl font-bold">{selectedProperty.bedroomsTotal || 0}</p>
                        <p className="text-xs text-muted-foreground">Beds</p>
                      </div>
                      <div className="text-center p-3 bg-muted rounded-md">
                        <p className="text-2xl font-bold">{selectedProperty.bathroomsTotalInteger || 0}</p>
                        <p className="text-xs text-muted-foreground">Baths</p>
                      </div>
                      <div className="text-center p-3 bg-muted rounded-md">
                        <p className="text-2xl font-bold">{selectedProperty.livingArea ? Number(selectedProperty.livingArea).toLocaleString() : 'N/A'}</p>
                        <p className="text-xs text-muted-foreground">Sq Ft</p>
                      </div>
                      <div className="text-center p-3 bg-muted rounded-md">
                        <p className="text-2xl font-bold">{selectedProperty.yearBuilt || 'N/A'}</p>
                        <p className="text-xs text-muted-foreground">Year Built</p>
                      </div>
                    </div>
                    
                    {/* Dates */}
                    <div className="flex flex-wrap gap-4 text-sm">
                      {listingDate && (
                        <div>
                          <span className="text-muted-foreground">Listed: </span>
                          <span className="font-medium">{listingDate}</span>
                        </div>
                      )}
                      {selectedProperty.standardStatus === 'Closed' && selectedProperty.closeDate && (
                        <div>
                          <span className="text-muted-foreground">Closed: </span>
                          <span className="font-medium">{new Date(selectedProperty.closeDate).toLocaleDateString()}</span>
                        </div>
                      )}
                      {selectedProperty.subdivision && (
                        <div>
                          <span className="text-muted-foreground">Subdivision: </span>
                          <span className="font-medium">{selectedProperty.subdivision}</span>
                        </div>
                      )}
                    </div>
                    
                    {/* Action Buttons */}
                    <div className="flex gap-3 pt-2">
                      <Button
                        variant="outline"
                        className="flex-1"
                        onClick={() => {
                          handleSetSubject(selectedProperty);
                          setSelectedProperty(null);
                        }}
                        disabled={subjectProperty?.id === selectedProperty.id}
                        data-testid="button-dialog-set-subject"
                      >
                        <Home className="w-4 h-4 mr-2" />
                        Set as Subject
                      </Button>
                      {comparables.some(p => p.id === selectedProperty.id) ? (
                        <Button
                          variant="destructive"
                          className="flex-1"
                          onClick={() => {
                            handleRemoveComparable(selectedProperty.id);
                            setSelectedProperty(null);
                          }}
                          data-testid="button-dialog-remove-comparable"
                        >
                          <X className="w-4 h-4 mr-2" />
                          Remove from Comparables
                        </Button>
                      ) : (
                        <Button
                          className="flex-1"
                          onClick={() => {
                            handleAddComparable(selectedProperty);
                            setSelectedProperty(null);
                          }}
                          disabled={comparables.length >= 15}
                          data-testid="button-dialog-add-comparable"
                        >
                          <Plus className="w-4 h-4 mr-2" />
                          Add as Comparable
                        </Button>
                      )}
                    </div>
                  </div>
                </ScrollArea>
              </>
            );
          })()}
        </DialogContent>
      </Dialog>
    </div>
  );
}


================================================================================
FILE: CMADetailPage.tsx
COPY TO: client/src/pages/CMADetailPage.tsx
================================================================================\n
import { useState } from "react";
import { useRoute, useLocation } from "wouter";
import { useQuery, useMutation } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { ArrowLeft, Share2, Link as LinkIcon, Copy, Check, Trash2, ExternalLink, Printer, Loader2, Mail } from "lucide-react";
import { SiFacebook, SiX, SiInstagram, SiTiktok } from "react-icons/si";
import { Link } from "wouter";
import { CMAReport } from "@/components/CMAReport";
import { useToast } from "@/hooks/use-toast";
import { 
  Dialog, 
  DialogContent, 
  DialogDescription, 
  DialogHeader, 
  DialogTitle,
  DialogTrigger,
  DialogFooter
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import type { Cma, Property, PropertyStatistics, TimelineDataPoint } from "@shared/schema";
import { queryClient, apiRequest } from "@/lib/queryClient";

// Available metrics for statistics display - keys must match CMAReport's StatMetricKey
export const STAT_METRICS = [
  { key: 'price', label: 'Price' },
  { key: 'pricePerSqFt', label: 'Price/SqFt' },
  { key: 'daysOnMarket', label: 'Days on Market' },
  { key: 'livingArea', label: 'Living SqFt' },
  { key: 'lotSize', label: 'Lot SqFt' },
  { key: 'acres', label: 'Acres' },
  { key: 'bedrooms', label: 'Beds' },
  { key: 'bathrooms', label: 'Baths' },
  { key: 'yearBuilt', label: 'Year Built' },
] as const;

export type StatMetricKey = typeof STAT_METRICS[number]['key'];

interface ShareResponse {
  shareToken: string;
  shareUrl: string;
}

export default function CMADetailPage() {
  const [, params] = useRoute("/cmas/:id");
  const [, setLocation] = useLocation();
  const id = params?.id;
  const { toast } = useToast();
  const [shareDialogOpen, setShareDialogOpen] = useState(false);
  const [emailShareDialogOpen, setEmailShareDialogOpen] = useState(false);
  const [notesDialogOpen, setNotesDialogOpen] = useState(false);
  const [statsDialogOpen, setStatsDialogOpen] = useState(false);
  const [notes, setNotes] = useState("");
  const [copied, setCopied] = useState(false);
  
  // Email share form state
  const [emailForm, setEmailForm] = useState({
    yourName: '',
    yourEmail: '',
    friendName: '',
    friendEmail: '',
    comments: 'Check out this CMA report I created for you.',
  });
  
  // Visible metrics state - all enabled by default
  const [visibleMetrics, setVisibleMetrics] = useState<StatMetricKey[]>(
    STAT_METRICS.map(m => m.key)
  );
  
  const toggleMetric = (key: StatMetricKey) => {
    setVisibleMetrics(prev => 
      prev.includes(key) 
        ? prev.filter(k => k !== key)
        : [...prev, key]
    );
  };

  const { data: cma, isLoading: cmaLoading, refetch: refetchCma } = useQuery<Cma>({
    queryKey: ['/api/cmas', id],
    enabled: !!id,
    queryFn: async () => {
      const response = await fetch(`/api/cmas/${id}`);
      if (!response.ok) throw new Error('Failed to fetch CMA');
      return response.json();
    },
  });

  const { data: statistics, isLoading: statsLoading } = useQuery<PropertyStatistics>({
    queryKey: ['/api/cmas', id, 'statistics'],
    enabled: !!id && !!cma,
    queryFn: async () => {
      const response = await fetch(`/api/cmas/${id}/statistics`);
      if (!response.ok) throw new Error('Failed to fetch statistics');
      return response.json();
    },
  });

  const { data: timelineData = [], isLoading: timelineLoading } = useQuery<TimelineDataPoint[]>({
    queryKey: ['/api/cmas', id, 'timeline'],
    enabled: !!id && !!cma,
    queryFn: async () => {
      const response = await fetch(`/api/cmas/${id}/timeline`);
      if (!response.ok) throw new Error('Failed to fetch timeline');
      return response.json();
    },
  });


  const shareMutation = useMutation<ShareResponse>({
    mutationFn: async () => {
      const response = await fetch(`/api/cmas/${id}/share`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });
      if (!response.ok) throw new Error('Failed to generate share link');
      return response.json();
    },
    onSuccess: () => {
      refetchCma();
      toast({
        title: "Share link generated",
        description: "Your CMA is now shareable via the link.",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to generate share link.",
        variant: "destructive",
      });
    },
  });

  const unshareMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch(`/api/cmas/${id}/share`, {
        method: 'DELETE',
      });
      if (!response.ok) throw new Error('Failed to remove share link');
      return response.json();
    },
    onSuccess: () => {
      refetchCma();
      setShareDialogOpen(false);
      toast({
        title: "Share link removed",
        description: "This CMA is no longer publicly accessible.",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to remove share link.",
        variant: "destructive",
      });
    },
  });

  const updateNotesMutation = useMutation({
    mutationFn: async (newNotes: string) => {
      const response = await fetch(`/api/cmas/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: newNotes }),
      });
      if (!response.ok) throw new Error('Failed to update notes');
      return response.json();
    },
    onSuccess: () => {
      refetchCma();
      setNotesDialogOpen(false);
      toast({
        title: "Notes saved",
        description: "Your notes have been updated.",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to save notes.",
        variant: "destructive",
      });
    },
  });

  const properties = cma ? ((cma as any).propertiesData || []) : [];

  // Sync notes state when CMA loads
  const handleOpenNotesDialog = () => {
    setNotes(cma?.notes || "");
    setNotesDialogOpen(true);
  };

  const handleSaveNotes = () => {
    updateNotesMutation.mutate(notes);
  };

  const handleSave = () => {
    // CMA is already saved - just show confirmation
    toast({
      title: "CMA Saved",
      description: "Your CMA has been saved successfully.",
    });
  };

  const [emailFallbackUrl, setEmailFallbackUrl] = useState<string | null>(null);
  
  const emailShareMutation = useMutation({
    mutationFn: async (data: typeof emailForm) => {
      // First ensure we have a public link
      if (!cma?.publicLink) {
        await shareMutation.mutateAsync();
      }
      // Then send the email
      const response = await fetch(`/api/cmas/${id}/email-share`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          senderName: data.yourName,
          senderEmail: data.yourEmail,
          recipientName: data.friendName,
          recipientEmail: data.friendEmail,
          message: data.comments,
        }),
      });
      if (!response.ok) throw new Error('Failed to send email');
      return response.json();
    },
    onSuccess: (data) => {
      if (data.emailSent) {
        setEmailShareDialogOpen(false);
        toast({
          title: "CMA Shared",
          description: "Your CMA has been sent via email.",
        });
        setEmailFallbackUrl(null);
      } else {
        // Email service not configured - show fallback with URL
        setEmailFallbackUrl(data.shareUrl);
        toast({
          title: "Email Not Sent",
          description: data.message,
          variant: "destructive",
        });
      }
      // Reset form
      setEmailForm({
        yourName: '',
        yourEmail: '',
        friendName: '',
        friendEmail: '',
        comments: 'Check out this CMA report I created for you.',
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to send email. Please try again.",
        variant: "destructive",
      });
    },
  });

  const handleEmailShare = () => {
    // Validate form
    if (!emailForm.yourName || !emailForm.yourEmail || !emailForm.friendName || !emailForm.friendEmail) {
      toast({
        title: "Required fields missing",
        description: "Please fill in all required fields.",
        variant: "destructive",
      });
      return;
    }
    emailShareMutation.mutate(emailForm);
  };

  const handleModifySearch = () => {
    // Navigate to CMA builder with current CMA data pre-loaded
    setLocation(`/cmas/new?from=${id}`);
  };

  const handleModifyStats = () => {
    setStatsDialogOpen(true);
  };

  const handlePrint = () => {
    window.print();
  };

  const generateClientEmail = () => {
    if (!cma || !statistics) return '';
    
    const propertiesData = (cma as any).propertiesData || [];
    const compCount = propertiesData.length;
    
    const subjectProperty = cma.subjectPropertyId 
      ? propertiesData.find((p: Property) => p.id === cma.subjectPropertyId)
      : null;
    
    const subjectAddress = subjectProperty?.unparsedAddress || cma.name || 'your property';
    const subdivision = (cma.searchCriteria as any)?.subdivisionName || 
                        (cma.searchCriteria as any)?.subdivision ||
                        subjectProperty?.subdivision ||
                        (cma.searchCriteria as any)?.city || 
                        'your area';
    
    const soldWithinDays = (cma.searchCriteria as any)?.soldWithinDays;
    const timeframe = soldWithinDays 
      ? `last ${soldWithinDays} days`
      : 'last 6 months';
    
    const priceMin = statistics.price?.range?.min 
      ? `$${Math.round(statistics.price.range.min).toLocaleString()}`
      : 'N/A';
    const priceMax = statistics.price?.range?.max
      ? `$${Math.round(statistics.price.range.max).toLocaleString()}`
      : 'N/A';
    const avgPricePerSqFt = statistics.pricePerSqFt?.average
      ? `$${Math.round(statistics.pricePerSqFt.average)}`
      : 'N/A';
    const avgDOM = statistics.daysOnMarket?.average
      ? `${Math.round(statistics.daysOnMarket.average)}`
      : 'N/A';
    
    const subjectSqFt = subjectProperty?.livingArea 
      ? Number(subjectProperty.livingArea).toLocaleString()
      : (statistics.livingArea?.average ? Math.round(statistics.livingArea.average).toLocaleString() : 'comparable homes');
    
    const lowEstimate = statistics.price?.range?.min && statistics.price?.average
      ? `$${Math.round((statistics.price.range.min + statistics.price.average) / 2).toLocaleString()}`
      : priceMin;
    const highEstimate = statistics.price?.range?.max && statistics.price?.average
      ? `$${Math.round((statistics.price.average + statistics.price.range.max) / 2).toLocaleString()}`
      : priceMax;
    
    const medianDOM = statistics.daysOnMarket?.median 
      ? Math.round(statistics.daysOnMarket.median)
      : null;
    const domInsight = medianDOM 
      ? (medianDOM < 14 
          ? `Properties priced right are going under contract in under ${medianDOM} days`
          : `Typical time to contract is around ${medianDOM} days`)
      : 'Market activity is steady';
    
    const pricePerSqFtInsight = avgPricePerSqFt !== 'N/A'
      ? `Comparable homes are averaging ${avgPricePerSqFt}/sq ft`
      : '';

    const email = `Subject: Market Analysis for ${subjectAddress}

---

Hi there,

I put together a market analysis for your home based on recent activity in ${subdivision}. Here's what the data is showing:

**Comparable Sales Summary**
- Properties Analyzed: ${compCount} homes in ${subdivision} (${timeframe})
- Price Range: ${priceMin}  ${priceMax}
- Average Price/Sq Ft: ${avgPricePerSqFt}
- Average Days on Market: ${avgDOM} days

Based on your home's size (${subjectSqFt} sq ft) and features, the data suggests a competitive list price in the ${lowEstimate}  ${highEstimate} range.

A few things worth noting:
- ${pricePerSqFtInsight || 'Market conditions support pricing in this range'}
- ${domInsight}
- Well-priced homes are attracting strong buyer interest

I'd love to walk you through the full analysis and talk through your timing and goals. Want to grab 15 minutes this week?

Best regards`;

    return email;
  };

  const handleCopyClientEmail = async () => {
    const emailContent = generateClientEmail();
    if (!emailContent) {
      toast({
        title: "Unable to generate email",
        description: "CMA data is not available.",
        variant: "destructive",
      });
      return;
    }
    
    try {
      await navigator.clipboard.writeText(emailContent);
      toast({
        title: "Email copied",
        description: "Paste into Follow Up Boss to send to your client.",
      });
    } catch (error) {
      toast({
        title: "Copy failed",
        description: "Unable to copy to clipboard.",
        variant: "destructive",
      });
    }
  };

  const isLoading = cmaLoading || statsLoading || timelineLoading;

  const getShareUrl = () => {
    if (!cma?.publicLink) return '';
    const baseUrl = window.location.origin;
    return `${baseUrl}/share/cma/${cma.publicLink}`;
  };

  const handleCopyLink = () => {
    navigator.clipboard.writeText(getShareUrl());
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
    toast({
      title: "Link copied",
      description: "Share link copied to clipboard.",
    });
  };

  const mockStatistics: PropertyStatistics = {
    price: {
      range: { min: 371000, max: 710000 },
      average: 508577,
      median: 519500,
    },
    pricePerSqFt: {
      range: { min: 268.23, max: 503.06 },
      average: 406.53,
      median: 406.7,
    },
    daysOnMarket: {
      range: { min: 2, max: 139 },
      average: 37,
      median: 25,
    },
    livingArea: {
      range: { min: 1045, max: 1474 },
      average: 1263,
      median: 1296,
    },
    lotSize: {
      range: { min: 3816, max: 11609 },
      average: 8923,
      median: 8494,
    },
    acres: {
      range: { min: 0.09, max: 0.27 },
      average: 0.2,
      median: 0.2,
    },
    bedrooms: {
      range: { min: 3, max: 4 },
      average: 3,
      median: 3,
    },
    bathrooms: {
      range: { min: 1, max: 2 },
      average: 2,
      median: 2,
    },
    yearBuilt: {
      range: { min: 1953, max: 2018 },
      average: 1964,
      median: 1959,
    },
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-8 w-64" />
        <Skeleton className="h-96 w-full" />
      </div>
    );
  }

  if (!cma) {
    return (
      <div className="text-center py-12">
        <h2 className="text-2xl font-bold mb-2">CMA not found</h2>
        <Link href="/cmas">
          <Button variant="outline">Back to CMAs</Button>
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-6 cma-print">
      <div className="flex items-center justify-between flex-wrap gap-4 print:hidden">
        <div>
          <Link href="/cmas">
            <Button variant="ghost" size="sm" className="mb-4" data-testid="button-back-to-cmas">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to CMAs
            </Button>
          </Link>
          <h1 className="text-3xl font-bold" data-testid="text-cma-title">{cma.name}</h1>
          {cma.publicLink && (
            <Badge variant="secondary" className="mt-2">
              <LinkIcon className="w-3 h-3 mr-1" />
              Shared
            </Badge>
          )}
        </div>

        <div className="flex items-center gap-2">
          <Button 
            variant="outline" 
            onClick={handleCopyClientEmail}
            data-testid="button-copy-email"
          >
            <Mail className="w-4 h-4 mr-2" />
            Copy Email
          </Button>
          <Button 
            variant="outline" 
            onClick={async () => {
              try {
                let shareUrl: string;
                if (cma?.publicLink) {
                  shareUrl = `${window.location.origin}/share/cma/${cma.publicLink}`;
                } else {
                  const result = await shareMutation.mutateAsync();
                  shareUrl = `${window.location.origin}/share/cma/${result.shareToken}`;
                }
                await navigator.clipboard.writeText(shareUrl);
                toast({
                  title: "URL copied to clipboard",
                  description: shareUrl,
                });
              } catch (error) {
                toast({
                  title: "Error",
                  description: "Failed to generate or copy share URL",
                  variant: "destructive",
                });
              }
            }}
            disabled={shareMutation.isPending}
            data-testid="button-produce-url"
          >
            {shareMutation.isPending ? (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            ) : (
              <LinkIcon className="w-4 h-4 mr-2" />
            )}
            Produce URL
          </Button>
          <Button variant="outline" onClick={handlePrint} data-testid="button-print-header">
            <Printer className="w-4 h-4 mr-2" />
            Print
          </Button>
          <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>
            <DialogTrigger asChild>
              <Button variant="outline" data-testid="button-share-cma">
                <Share2 className="w-4 h-4 mr-2" />
                Share
              </Button>
            </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Share CMA</DialogTitle>
              <DialogDescription>
                Generate a public link to share this CMA with clients.
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4 pt-4">
              {cma.publicLink ? (
                <>
                  <div className="space-y-2">
                    <Label>Share Link</Label>
                    <div className="flex gap-2">
                      <Input 
                        value={getShareUrl()} 
                        readOnly 
                        data-testid="input-share-link"
                      />
                      <Button 
                        size="icon" 
                        variant="outline"
                        onClick={handleCopyLink}
                        data-testid="button-copy-link"
                      >
                        {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                      </Button>
                    </div>
                  </div>
                  
                  {/* Social Media Sharing */}
                  <div className="space-y-2 pt-4 border-t">
                    <Label>Share on Social Media</Label>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          const url = encodeURIComponent(getShareUrl());
                          const text = encodeURIComponent(`Check out this CMA report: ${cma.name}`);
                          window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
                        }}
                        data-testid="button-share-facebook"
                      >
                        <SiFacebook className="w-4 h-4 mr-2" />
                        Facebook
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          const url = encodeURIComponent(getShareUrl());
                          const text = encodeURIComponent(`Check out this CMA report: ${cma.name}`);
                          window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
                        }}
                        data-testid="button-share-x"
                      >
                        <SiX className="w-4 h-4 mr-2" />
                        X
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // Copy link silently, then open Instagram
                          navigator.clipboard.writeText(getShareUrl());
                          // Open Instagram web - users can share via story/post
                          window.open('https://www.instagram.com/', '_blank');
                        }}
                        data-testid="button-share-instagram"
                      >
                        <SiInstagram className="w-4 h-4 mr-2" />
                        Instagram
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // Copy link silently, then open TikTok
                          navigator.clipboard.writeText(getShareUrl());
                          // Open TikTok web - users can share via post/bio
                          window.open('https://www.tiktok.com/', '_blank');
                        }}
                        data-testid="button-share-tiktok"
                      >
                        <SiTiktok className="w-4 h-4 mr-2" />
                        TikTok
                      </Button>
                    </div>
                  </div>
                  
                  <div className="flex justify-between pt-4">
                    <Button
                      variant="destructive"
                      onClick={() => unshareMutation.mutate()}
                      disabled={unshareMutation.isPending}
                      data-testid="button-remove-share"
                    >
                      <Trash2 className="w-4 h-4 mr-2" />
                      Remove Link
                    </Button>
                    <Button onClick={() => setShareDialogOpen(false)}>
                      Done
                    </Button>
                  </div>
                </>
              ) : (
                <div className="text-center py-4">
                  <p className="text-muted-foreground mb-4">
                    Generate a shareable link for this CMA. Links are permanent and can be manually revoked.
                  </p>
                  <Button 
                    onClick={() => shareMutation.mutate()}
                    disabled={shareMutation.isPending}
                    data-testid="button-generate-link"
                  >
                    <LinkIcon className="w-4 h-4 mr-2" />
                    {shareMutation.isPending ? 'Generating...' : 'Generate Share Link'}
                  </Button>
                </div>
              )}
            </div>
          </DialogContent>
        </Dialog>
        </div>
      </div>

      <CMAReport
        properties={properties}
        statistics={statistics || mockStatistics}
        timelineData={timelineData}
        isPreview={true}
        expiresAt={cma.expiresAt ? new Date(cma.expiresAt) : new Date(Date.now() + 30 * 60 * 1000)}
        visibleMetrics={visibleMetrics}
        notes={cma.notes}
        reportTitle={cma.name}
        subjectPropertyId={cma.subjectPropertyId}
        onSave={handleSave}
        onShareCMA={() => setEmailShareDialogOpen(true)}
        onPublicLink={async () => {
          try {
            let shareUrl: string;
            if (cma?.publicLink) {
              shareUrl = `${window.location.origin}/share/cma/${cma.publicLink}`;
            } else {
              const result = await shareMutation.mutateAsync();
              shareUrl = `${window.location.origin}/share/cma/${result.shareToken}`;
            }
            await navigator.clipboard.writeText(shareUrl);
            toast({
              title: "URL copied to clipboard",
              description: shareUrl,
            });
          } catch (error) {
            toast({
              title: "Error",
              description: "Failed to generate or copy share URL",
              variant: "destructive",
            });
          }
        }}
        onModifySearch={handleModifySearch}
        onModifyStats={handleModifyStats}
        onAddNotes={handleOpenNotesDialog}
        onPrint={handlePrint}
      />

      {/* Notes Dialog */}
      <Dialog open={notesDialogOpen} onOpenChange={setNotesDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Agent Notes</DialogTitle>
            <DialogDescription>
              Add commentary or notes about this CMA for your client.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4 space-y-2">
            <Label htmlFor="notes">Your Notes</Label>
            <Textarea
              id="notes"
              placeholder="Enter your notes or commentary about this CMA..."
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows={6}
              className="mt-2"
              data-testid="textarea-notes"
            />
            <p className="text-xs text-muted-foreground">
              These notes will appear on the shared CMA report and PDF.
            </p>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setNotesDialogOpen(false)}>
              Cancel
            </Button>
            <Button 
              onClick={handleSaveNotes}
              disabled={updateNotesMutation.isPending}
              data-testid="button-save-notes"
            >
              {updateNotesMutation.isPending ? 'Saving...' : 'Save Notes'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Stats Visibility Dialog */}
      <Dialog open={statsDialogOpen} onOpenChange={setStatsDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Customize Statistics</DialogTitle>
            <DialogDescription>
              Choose which metrics to show in the Home Averages tab.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4 space-y-3">
            {STAT_METRICS.map((metric) => (
              <div key={metric.key} className="flex items-center space-x-3">
                <Checkbox
                  id={`metric-${metric.key}`}
                  checked={visibleMetrics.includes(metric.key)}
                  onCheckedChange={() => toggleMetric(metric.key)}
                  data-testid={`checkbox-metric-${metric.key}`}
                />
                <Label htmlFor={`metric-${metric.key}`} className="cursor-pointer">
                  {metric.label}
                </Label>
              </div>
            ))}
          </div>
          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => setVisibleMetrics(STAT_METRICS.map(m => m.key))}
              data-testid="button-reset-stats"
            >
              Show All
            </Button>
            <Button 
              onClick={() => setStatsDialogOpen(false)}
              data-testid="button-apply-stats"
            >
              Apply
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Email Share CMA Dialog */}
      <Dialog open={emailShareDialogOpen} onOpenChange={setEmailShareDialogOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle>Email CMA to a Friend</DialogTitle>
            <DialogDescription>
              Share this CMA report with your client via email.
            </DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="your-name">Your Name *</Label>
                <Input
                  id="your-name"
                  placeholder="Your Name"
                  value={emailForm.yourName}
                  onChange={(e) => setEmailForm(prev => ({ ...prev, yourName: e.target.value }))}
                  data-testid="input-your-name"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="friend-name">Friend's Name *</Label>
                <Input
                  id="friend-name"
                  placeholder="Friend's Name"
                  value={emailForm.friendName}
                  onChange={(e) => setEmailForm(prev => ({ ...prev, friendName: e.target.value }))}
                  data-testid="input-friend-name"
                />
              </div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="your-email">Your Email Address *</Label>
                <Input
                  id="your-email"
                  type="email"
                  placeholder="name@website.com"
                  value={emailForm.yourEmail}
                  onChange={(e) => setEmailForm(prev => ({ ...prev, yourEmail: e.target.value }))}
                  data-testid="input-your-email"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="friend-email">Friend's Email Address *</Label>
                <Input
                  id="friend-email"
                  type="email"
                  placeholder="name@website.com"
                  value={emailForm.friendEmail}
                  onChange={(e) => setEmailForm(prev => ({ ...prev, friendEmail: e.target.value }))}
                  data-testid="input-friend-email"
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label htmlFor="comments">Comments</Label>
              <Textarea
                id="comments"
                placeholder="Add a personal message..."
                value={emailForm.comments}
                onChange={(e) => setEmailForm(prev => ({ ...prev, comments: e.target.value }))}
                rows={3}
                data-testid="textarea-email-comments"
              />
            </div>
            {emailFallbackUrl && (
              <div className="p-3 bg-muted rounded-md space-y-2">
                <p className="text-sm text-muted-foreground">
                  Email service not configured. Share this link manually:
                </p>
                <div className="flex items-center gap-2">
                  <Input 
                    value={emailFallbackUrl} 
                    readOnly 
                    className="text-xs"
                    data-testid="input-fallback-share-url"
                  />
                  <Button 
                    size="sm" 
                    variant="outline"
                    onClick={() => {
                      navigator.clipboard.writeText(emailFallbackUrl);
                      toast({ title: "Copied!", description: "Link copied to clipboard." });
                    }}
                    data-testid="button-copy-fallback-url"
                  >
                    <Copy className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            )}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setEmailShareDialogOpen(false)}>
              Cancel
            </Button>
            <Button 
              onClick={handleEmailShare}
              disabled={emailShareMutation.isPending}
              data-testid="button-send-email-share"
            >
              {emailShareMutation.isPending ? 'Sending...' : 'Share'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


================================================================================
FILE: CMANew.tsx
COPY TO: client/src/pages/CMANew.tsx
================================================================================\n
import { useState, useEffect, useMemo } from "react";
import { useLocation, useSearch } from "wouter";
import { useMutation, useQueryClient, useQuery } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { Link } from "wouter";
import { CMABuilder } from "@/components/CMABuilder";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import type { Property } from "@shared/schema";

export default function CMANew() {
  const [, setLocation] = useLocation();
  const search = useSearch();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  
  // Parse URL search params for "modify" mode or "fromProperties" mode
  const params = new URLSearchParams(search);
  const fromCmaId = params.get('from');
  const fromProperties = params.get('fromProperties') === 'true';
  
  // Get pre-selected properties from Properties page (via sessionStorage)
  const [preSelectedProperties, setPreSelectedProperties] = useState<Property[]>([]);
  
  useEffect(() => {
    if (fromProperties) {
      const stored = sessionStorage.getItem('propertiesForCMA');
      if (stored) {
        try {
          const properties = JSON.parse(stored);
          setPreSelectedProperties(properties);
          // Clear sessionStorage after reading
          sessionStorage.removeItem('propertiesForCMA');
        } catch (e) {
          console.error('Failed to parse pre-selected properties:', e);
        }
      }
    }
  }, [fromProperties]);
  
  // Fetch original CMA data if modifying
  const { data: originalCma } = useQuery({
    queryKey: ['/api/cmas', fromCmaId],
    enabled: !!fromCmaId,
  });

  const createCmaMutation = useMutation({
    mutationFn: async (data: {
      name: string;
      subjectPropertyId?: string;
      comparablePropertyIds: string[];
      propertiesData: any[];
      searchCriteria?: any;
    }) => {
      const response = await apiRequest('/api/cmas', 'POST', data);
      return response.json();
    },
    onSuccess: (cma: { id: string }) => {
      queryClient.invalidateQueries({ queryKey: ['/api/cmas'] });
      toast({
        title: "CMA created",
        description: "Your comparative market analysis has been created successfully.",
      });
      setLocation(`/cmas/${cma.id}`);
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to create CMA. Please try again.",
        variant: "destructive",
      });
    },
  });

  const handleCreate = (data: {
    name: string;
    subjectPropertyId?: string;
    comparablePropertyIds: string[];
    propertiesData: any[];
    searchCriteria?: any;
  }) => {
    createCmaMutation.mutate(data);
  };

  // Build initialData from original CMA if modifying
  const buildInitialData = () => {
    if (!originalCma) return undefined;
    
    const cma = originalCma as any;
    const propertiesData = cma.propertiesData || [];
    const savedSearchCriteria = cma.searchCriteria || {};
    
    // Use saved searchCriteria, falling back to extracting from properties
    // Note: neighborhood is no longer used - use subdivision instead (RESO-compliant)
    const searchCriteria = {
      city: savedSearchCriteria.city || '',
      subdivision: savedSearchCriteria.subdivision || '',
      minBeds: savedSearchCriteria.minBeds || '',
      maxPrice: savedSearchCriteria.maxPrice || '',
      statuses: savedSearchCriteria.statuses || ['active'],
      minSqft: savedSearchCriteria.minSqft || '',
      maxSqft: savedSearchCriteria.maxSqft || '',
      minLotAcres: savedSearchCriteria.minLotAcres || '',
      maxLotAcres: savedSearchCriteria.maxLotAcres || '',
      minYearBuilt: savedSearchCriteria.minYearBuilt || '',
      maxYearBuilt: savedSearchCriteria.maxYearBuilt || '',
      stories: savedSearchCriteria.stories || '',
      soldDays: savedSearchCriteria.soldDays || '',
    };
    
    // If no saved criteria, try to infer from properties
    if (!cma.searchCriteria && propertiesData.length > 0) {
      const firstProp = propertiesData[0];
      if (firstProp.city) searchCriteria.city = firstProp.city;
      if (firstProp.subdivisionName) searchCriteria.subdivision = firstProp.subdivisionName;
      
      // Extract statuses from properties
      const statuses = new Set<string>();
      propertiesData.forEach((p: any) => {
        if (p.standardStatus === 'Active') statuses.add('active');
        else if (p.standardStatus === 'Active Under Contract' || p.standardStatus === 'Pending') statuses.add('under_contract');
        else if (p.standardStatus === 'Closed') statuses.add('closed');
      });
      if (statuses.size > 0) {
        searchCriteria.statuses = Array.from(statuses);
      }
    }
    
    // Separate subject property from comparables
    const subjectId = cma.subjectPropertyId;
    const subjectProperty = subjectId 
      ? propertiesData.find((p: any) => p.id === subjectId) || null
      : null;
    const comparables = subjectId
      ? propertiesData.filter((p: any) => p.id !== subjectId)
      : propertiesData;
    
    // Append "(Modified)" only if not already present
    let modifiedName = cma.name || 'CMA';
    if (!modifiedName.includes('(Modified)')) {
      modifiedName = `${modifiedName} (Modified)`;
    }
    
    return {
      name: modifiedName,
      searchCriteria,
      comparables: comparables as Property[],
      subjectProperty: subjectProperty as Property | null,
    };
  };

  const initialData = buildInitialData();
  
  // Build initial data from pre-selected properties (from Properties page)
  const propertiesInitialData = useMemo(() => {
    if (!fromProperties || preSelectedProperties.length === 0) return undefined;
    
    // Infer search criteria from selected properties
    const firstProp = preSelectedProperties[0];
    const statuses = new Set<string>();
    preSelectedProperties.forEach((p: any) => {
      if (p.standardStatus === 'Active') statuses.add('active');
      else if (p.standardStatus === 'Active Under Contract' || p.standardStatus === 'Pending') statuses.add('under_contract');
      else if (p.standardStatus === 'Closed') statuses.add('closed');
    });
    
    return {
      name: 'Quick CMA',
      searchCriteria: {
        city: firstProp?.city || '',
        subdivision: (firstProp as any)?.subdivisionName || '',
        statuses: Array.from(statuses).length > 0 ? Array.from(statuses) : ['active'],
        minBeds: '',
        maxPrice: '',
        minSqft: '',
        maxSqft: '',
        minLotAcres: '',
        maxLotAcres: '',
        minYearBuilt: '',
        maxYearBuilt: '',
        stories: '',
        soldDays: '',
      },
      comparables: preSelectedProperties,
      subjectProperty: null,
    };
  }, [fromProperties, preSelectedProperties]);
  
  // Use properties initial data if available, otherwise use CMA modify data
  const finalInitialData = propertiesInitialData || initialData;
  
  // Determine the title and description
  const pageTitle = fromProperties ? 'Quick CMA' : (fromCmaId ? 'Modify CMA' : 'Create New CMA');
  const pageDescription = fromProperties 
    ? `Create a CMA with ${preSelectedProperties.length} pre-selected properties`
    : (fromCmaId 
        ? 'Modify your search criteria and comparables to create an updated CMA'
        : 'Build a comprehensive comparative market analysis for your clients'
      );

  return (
    <div className="space-y-6">
      <div>
        <Link href={fromProperties ? "/properties" : "/cmas"}>
          <Button variant="ghost" size="sm" className="mb-4" data-testid="button-back-to-cmas">
            <ArrowLeft className="w-4 h-4 mr-2" />
            {fromProperties ? 'Back to Properties' : 'Back to CMAs'}
          </Button>
        </Link>
        <h1 className="text-3xl font-bold" data-testid="text-new-cma-title">
          {pageTitle}
        </h1>
        <p className="text-muted-foreground mt-2">
          {pageDescription}
        </p>
      </div>

      <CMABuilder onCreateCMA={handleCreate} initialData={finalInitialData} />
    </div>
  );
}


================================================================================
FILE: CMAReport.tsx
COPY TO: client/src/components/CMAReport.tsx
================================================================================\n
import { useState, useEffect, useRef, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, LineChart, Line, ReferenceLine, ScatterChart, Scatter, ZAxis, Cell } from "recharts";
import { Save, Edit, FileText, Printer, Info, Home, Mail, ChevronLeft, ChevronRight, Bed, Bath, Maximize, MapPin, Calendar, Map as MapIcon, ExternalLink, DollarSign, TrendingUp, Target, Zap, Clock, BarChart3, Menu, LayoutGrid, MoreHorizontal } from "lucide-react";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from "@/components/ui/dropdown-menu";
import { MapContainer, TileLayer, Marker, Popup, useMap } from "react-leaflet";
import "leaflet/dist/leaflet.css";
import L from "leaflet";

// Fix for default Leaflet marker icons
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { Separator } from "@/components/ui/separator";
import { Checkbox } from "@/components/ui/checkbox";
import { cn } from "@/lib/utils";
import type { Property, PropertyStatistics, TimelineDataPoint, Media } from "@shared/schema";
import { isLikelyRentalProperty, filterOutRentalProperties } from "@shared/schema";

// Component to fit map bounds to markers
function FitBounds({ positions }: { positions: [number, number][] }) {
  const map = useMap();
  useEffect(() => {
    if (positions.length > 0) {
      const bounds = L.latLngBounds(positions.map(pos => L.latLng(pos[0], pos[1])));
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }, [positions, map]);
  return null;
}

// Custom marker icon for subject property
const subjectIcon = new L.DivIcon({
  html: '<div style="background-color:#ef4444;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
  className: 'custom-div-icon',
  iconSize: [24, 24],
  iconAnchor: [12, 12],
});

// Custom marker icon for comp properties based on status
const getCompIcon = (status: string) => {
  const statusLower = (status || '').toLowerCase();
  let borderColor = '#22c55e'; // green for active
  let bgColor = 'rgba(34, 197, 94, 0.15)'; // light green background
  
  // Check for sold/closed status
  if (statusLower === 'closed' || statusLower === 'sold') {
    borderColor = '#6b7280'; // gray for sold
    bgColor = 'rgba(107, 114, 128, 0.15)';
  } 
  // Check for pending/under contract status (including variants like "Active Under Contract - Showing")
  else if (
    statusLower.includes('under contract') || 
    statusLower.includes('pending') || 
    statusLower.includes('in contract') ||
    statusLower.includes('contingent')
  ) {
    borderColor = '#f59e0b'; // orange for under contract/pending
    bgColor = 'rgba(245, 158, 11, 0.15)';
  }
  
  return new L.DivIcon({
    html: `<div style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;background-color:${bgColor};border:3px solid ${borderColor};border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:18px;"></div>`,
    className: 'custom-house-icon',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32],
  });
};

// Price label marker icon - shows price directly on map (CloudCMA style)
const getPriceMarkerIcon = (price: number, status: string, isSubject: boolean = false) => {
  const statusLower = (status || '').toLowerCase();
  let bgColor = '#22c55e'; // green for active
  let textColor = '#ffffff';
  
  if (statusLower === 'closed' || statusLower === 'sold') {
    bgColor = '#ef4444'; // red for sold (CloudCMA style)
  } else if (
    statusLower.includes('under contract') || 
    statusLower.includes('pending') || 
    statusLower.includes('in contract') ||
    statusLower.includes('contingent')
  ) {
    bgColor = '#f59e0b'; // orange for under contract/pending
  }
  
  // Subject property has special blue color
  if (isSubject) {
    bgColor = '#3b82f6'; // blue for subject
  }
  
  // Format price to compact form (e.g., $525K or $1.2M)
  const formatCompactPrice = (p: number) => {
    if (p >= 1000000) {
      return `$${(p / 1000000).toFixed(2)}M`;
    }
    return `$${Math.round(p / 1000)}K`;
  };
  
  const priceLabel = formatCompactPrice(price);
  
  return new L.DivIcon({
    html: `<div style="
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:5px 10px;
      background-color:${bgColor};
      color:${textColor};
      font-size:12px;
      font-weight:700;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
      white-space:nowrap;
      border:2px solid white;
    ">${isSubject ? ' ' : ''}${priceLabel}</div>`,
    className: 'price-marker-icon',
    iconSize: [80, 28],
    iconAnchor: [40, 28],
    popupAnchor: [0, -28],
  });
};

type StatMetricKey = 'price' | 'pricePerSqFt' | 'daysOnMarket' | 'livingArea' | 'lotSize' | 'acres' | 'bedrooms' | 'bathrooms' | 'yearBuilt';

interface CMAReportProps {
  properties: Property[];
  statistics: PropertyStatistics;
  timelineData: TimelineDataPoint[];
  isPreview?: boolean;
  expiresAt?: Date;
  visibleMetrics?: StatMetricKey[];
  notes?: string | null;
  reportTitle?: string;
  subjectPropertyId?: string | null;
  onSave?: () => void;
  onShareCMA?: () => void;
  onPublicLink?: () => void;
  onModifySearch?: () => void;
  onModifyStats?: () => void;
  onAddNotes?: () => void;
  onPrint?: () => void;
}

const ALL_METRICS: StatMetricKey[] = ['price', 'pricePerSqFt', 'daysOnMarket', 'livingArea', 'lotSize', 'acres', 'bedrooms', 'bathrooms', 'yearBuilt'];

export function CMAReport({ 
  properties, 
  statistics, 
  timelineData, 
  isPreview,
  expiresAt,
  visibleMetrics = ALL_METRICS,
  notes,
  reportTitle,
  subjectPropertyId,
  onSave,
  onShareCMA,
  onPublicLink,
  onModifySearch,
  onModifyStats,
  onAddNotes,
  onPrint
}: CMAReportProps) {
  const [activeTab, setActiveTab] = useState("compare");
  const [activeListingTab, setActiveListingTab] = useState("all");
  
  // Property exclusion state for Include All/Exclude All functionality
  const [excludedPropertyIds, setExcludedPropertyIds] = useState<Set<string>>(new Set());
  
  // Property notes state for Notes & Adjustments
  const [propertyNotes, setPropertyNotes] = useState<Record<string, string>>({});
  
  // Floating card state
  const [floatingCardOpen, setFloatingCardOpen] = useState(false);
  const [floatingCardProperty, setFloatingCardProperty] = useState<Property | null>(null);
  const [carouselIndex, setCarouselIndex] = useState(0);
  const autoAdvanceRef = useRef<ReturnType<typeof setInterval> | null>(null);
  
  // Timeline status filters
  const [showActiveOnTimeline, setShowActiveOnTimeline] = useState(true);
  const [showUnderContractOnTimeline, setShowUnderContractOnTimeline] = useState(true);
  const [showSoldOnTimeline, setShowSoldOnTimeline] = useState(true);
  
  // Pricing Strategy state
  const [showSubjectOnPricingChart, setShowSubjectOnPricingChart] = useState(true);
  const [selectedPricingProperty, setSelectedPricingProperty] = useState<Property | null>(null);
  const [pricingPhotoIndex, setPricingPhotoIndex] = useState(0);
  
  // Horizontal scroll refs for carousel arrows
  const statsScrollRef = useRef<HTMLDivElement>(null);
  const compareScrollRef = useRef<HTMLDivElement>(null);
  const listScrollRef = useRef<HTMLDivElement>(null);
  const [statsCanScrollLeft, setStatsCanScrollLeft] = useState(false);
  const [statsCanScrollRight, setStatsCanScrollRight] = useState(false);
  const [compareCanScrollLeft, setCompareCanScrollLeft] = useState(false);
  const [compareCanScrollRight, setCompareCanScrollRight] = useState(false);
  const [listCanScrollLeft, setListCanScrollLeft] = useState(false);
  const [listCanScrollRight, setListCanScrollRight] = useState(false);
  
  // Update scroll button visibility for Stats view
  const updateStatsScrollButtons = () => {
    if (statsScrollRef.current) {
      const { scrollLeft, scrollWidth, clientWidth } = statsScrollRef.current;
      setStatsCanScrollLeft(scrollLeft > 5);
      setStatsCanScrollRight(scrollLeft < scrollWidth - clientWidth - 5);
    }
  };
  
  // Update scroll button visibility for Compare view
  const updateCompareScrollButtons = () => {
    if (compareScrollRef.current) {
      const { scrollLeft, scrollWidth, clientWidth } = compareScrollRef.current;
      setCompareCanScrollLeft(scrollLeft > 5);
      setCompareCanScrollRight(scrollLeft < scrollWidth - clientWidth - 5);
    }
  };
  
  // Update scroll button visibility for List view
  const updateListScrollButtons = () => {
    if (listScrollRef.current) {
      const { scrollLeft, scrollWidth, clientWidth } = listScrollRef.current;
      setListCanScrollLeft(scrollLeft > 5);
      setListCanScrollRight(scrollLeft < scrollWidth - clientWidth - 5);
    }
  };
  
  useEffect(() => {
    updateStatsScrollButtons();
    updateCompareScrollButtons();
    updateListScrollButtons();
    const statsEl = statsScrollRef.current;
    const compareEl = compareScrollRef.current;
    const listEl = listScrollRef.current;
    
    if (statsEl) {
      statsEl.addEventListener('scroll', updateStatsScrollButtons);
    }
    if (compareEl) {
      compareEl.addEventListener('scroll', updateCompareScrollButtons);
    }
    if (listEl) {
      listEl.addEventListener('scroll', updateListScrollButtons);
    }
    window.addEventListener('resize', () => {
      updateStatsScrollButtons();
      updateCompareScrollButtons();
      updateListScrollButtons();
    });
    
    return () => {
      if (statsEl) {
        statsEl.removeEventListener('scroll', updateStatsScrollButtons);
      }
      if (compareEl) {
        compareEl.removeEventListener('scroll', updateCompareScrollButtons);
      }
      if (listEl) {
        listEl.removeEventListener('scroll', updateListScrollButtons);
      }
    };
  }, [activeTab, properties]);
  
  const scrollStatsLeft = () => {
    if (statsScrollRef.current) {
      statsScrollRef.current.scrollBy({ left: -280, behavior: 'smooth' });
    }
  };
  
  const scrollStatsRight = () => {
    if (statsScrollRef.current) {
      statsScrollRef.current.scrollBy({ left: 280, behavior: 'smooth' });
    }
  };
  
  const scrollCompareLeft = () => {
    if (compareScrollRef.current) {
      compareScrollRef.current.scrollBy({ left: -300, behavior: 'smooth' });
    }
  };
  
  const scrollCompareRight = () => {
    if (compareScrollRef.current) {
      compareScrollRef.current.scrollBy({ left: 300, behavior: 'smooth' });
    }
  };
  
  const scrollListLeft = () => {
    if (listScrollRef.current) {
      listScrollRef.current.scrollBy({ left: -280, behavior: 'smooth' });
    }
  };
  
  const scrollListRight = () => {
    if (listScrollRef.current) {
      listScrollRef.current.scrollBy({ left: 280, behavior: 'smooth' });
    }
  };
  
  // Helper to get photos from property
  const getPropertyPhotos = (property: Property): string[] => {
    const photos = (property as any).photos as string[] | undefined;
    const media = (property as any).media as any[] | undefined;
    if (photos && photos.length > 0) return photos;
    if (media && media.length > 0) {
      return media.map((m: any) => m.mediaURL || m.mediaUrl).filter(Boolean);
    }
    return [];
  };
  
  // Handle property click to open floating card
  const handlePropertyClick = (property: Property) => {
    setFloatingCardProperty(property);
    setCarouselIndex(0);
    setFloatingCardOpen(true);
  };
  
  // Carousel auto-advance
  useEffect(() => {
    if (autoAdvanceRef.current) {
      clearInterval(autoAdvanceRef.current);
    }
    
    if (floatingCardProperty && floatingCardOpen) {
      const photos = getPropertyPhotos(floatingCardProperty);
      if (photos.length > 1) {
        autoAdvanceRef.current = setInterval(() => {
          setCarouselIndex((prev) => (prev + 1) % photos.length);
        }, 3000);
      }
    }
    
    return () => {
      if (autoAdvanceRef.current) {
        clearInterval(autoAdvanceRef.current);
      }
    };
  }, [floatingCardProperty, floatingCardOpen]);
  
  const handlePrevImage = () => {
    if (!floatingCardProperty) return;
    const photos = getPropertyPhotos(floatingCardProperty);
    if (photos.length > 1) {
      setCarouselIndex((prev) => (prev - 1 + photos.length) % photos.length);
    }
  };
  
  const handleNextImage = () => {
    if (!floatingCardProperty) return;
    const photos = getPropertyPhotos(floatingCardProperty);
    if (photos.length > 1) {
      setCarouselIndex((prev) => (prev + 1) % photos.length);
    }
  };

  // Reset pricing photo index when selected property changes
  useEffect(() => {
    setPricingPhotoIndex(0);
  }, [selectedPricingProperty]);

  // Pricing panel navigation handlers
  const handlePricingPrevImage = () => {
    if (!selectedPricingProperty) return;
    const photos = getPropertyPhotos(selectedPricingProperty);
    if (photos.length > 1) {
      setPricingPhotoIndex((prev) => (prev - 1 + photos.length) % photos.length);
    }
  };

  const handlePricingNextImage = () => {
    if (!selectedPricingProperty) return;
    const photos = getPropertyPhotos(selectedPricingProperty);
    if (photos.length > 1) {
      setPricingPhotoIndex((prev) => (prev + 1) % photos.length);
    }
  };

  // Group properties by status, filtering out rentals from sold properties
  // Uses shared rental detection logic from @shared/schema
  const allProperties = properties;
  const closedProperties = properties.filter(p => p.standardStatus === 'Closed');
  const soldProperties = filterOutRentalProperties(closedProperties);
  const rentalProperties = closedProperties.filter(p => isLikelyRentalProperty(p));
  const underContractProperties = properties.filter(p => p.standardStatus === 'Active Under Contract');
  const activeProperties = properties.filter(p => p.standardStatus === 'Active');
  
  // Log filtered rentals for debugging
  if (rentalProperties.length > 0) {
    console.log(`CMAReport: Filtered ${rentalProperties.length} rental properties from Sold section:`, 
      rentalProperties.map(p => `${p.unparsedAddress}: $${Number(p.closePrice).toLocaleString()}`));
  }

  // Compute filtered counts based on excluded properties
  const includedAll = useMemo(() => allProperties.filter(p => !excludedPropertyIds.has(p.id)), [allProperties, excludedPropertyIds]);
  const includedSold = useMemo(() => soldProperties.filter(p => !excludedPropertyIds.has(p.id)), [soldProperties, excludedPropertyIds]);
  const includedActive = useMemo(() => activeProperties.filter(p => !excludedPropertyIds.has(p.id)), [activeProperties, excludedPropertyIds]);
  const includedUnderContract = useMemo(() => underContractProperties.filter(p => !excludedPropertyIds.has(p.id)), [underContractProperties, excludedPropertyIds]);

  // Compute filtered statistics based on excluded properties
  const filteredStatistics = useMemo(() => {
    const includedProperties = properties.filter(p => !excludedPropertyIds.has(p.id));
    
    if (includedProperties.length === 0) {
      // Return zeros if all properties are excluded
      return {
        price: { average: 0, median: 0, range: { min: 0, max: 0 } },
        pricePerSqFt: { average: 0, median: 0, range: { min: 0, max: 0 } },
        daysOnMarket: { average: 0, median: 0, range: { min: 0, max: 0 } },
        livingArea: { average: 0, median: 0, range: { min: 0, max: 0 } },
        lotSize: { average: 0, median: 0, range: { min: 0, max: 0 } },
        acres: { average: 0, median: 0, range: { min: 0, max: 0 } },
        bedrooms: { average: 0, median: 0, range: { min: 0, max: 0 } },
        bathrooms: { average: 0, median: 0, range: { min: 0, max: 0 } },
        yearBuilt: { average: 0, median: 0, range: { min: 0, max: 0 } },
      };
    }

    const computeStats = (values: number[]) => {
      const filtered = values.filter(v => v > 0);
      if (filtered.length === 0) {
        return { average: 0, median: 0, range: { min: 0, max: 0 } };
      }
      const sorted = [...filtered].sort((a, b) => a - b);
      const average = sorted.reduce((a, b) => a + b, 0) / sorted.length;
      const median = sorted.length % 2 === 0
        ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
        : sorted[Math.floor(sorted.length / 2)];
      return {
        average,
        median,
        range: { min: sorted[0], max: sorted[sorted.length - 1] }
      };
    };

    const prices = includedProperties.map(p => {
      const isClosed = p.standardStatus === 'Closed';
      return isClosed 
        ? (p.closePrice ? Number(p.closePrice) : Number(p.listPrice || 0))
        : Number(p.listPrice || 0);
    });
    
    const pricesPerSqFt = includedProperties
      .filter(p => p.livingArea && Number(p.livingArea) > 0)
      .map(p => {
        const isClosed = p.standardStatus === 'Closed';
        const price = isClosed 
          ? (p.closePrice ? Number(p.closePrice) : Number(p.listPrice || 0))
          : Number(p.listPrice || 0);
        return price / Number(p.livingArea);
      });

    return {
      price: computeStats(prices),
      pricePerSqFt: computeStats(pricesPerSqFt),
      daysOnMarket: computeStats(includedProperties.map(p => p.daysOnMarket || 0)),
      livingArea: computeStats(includedProperties.map(p => Number(p.livingArea || 0))),
      lotSize: computeStats(includedProperties.map(p => Number(p.lotSizeSquareFeet || 0))),
      acres: computeStats(includedProperties.map(p => Number(p.lotSizeAcres || 0))),
      bedrooms: computeStats(includedProperties.map(p => p.bedroomsTotal || 0)),
      bathrooms: computeStats(includedProperties.map(p => p.bathroomsTotalInteger || 0)),
      yearBuilt: computeStats(includedProperties.map(p => p.yearBuilt || 0)),
    };
  }, [properties, excludedPropertyIds]);

  // Dynamic pricing suggestion calculation based on market trends
  const pricingSuggestion = useMemo(() => {
    // Get included sold properties for analysis
    const soldForAnalysis = soldProperties.filter(p => !excludedPropertyIds.has(p.id));
    
    if (soldForAnalysis.length < 2) {
      return null; // Need at least 2 sold properties for analysis
    }

    // Calculate base metrics from sold properties
    const soldPrices = soldForAnalysis
      .map(p => p.closePrice ? Number(p.closePrice) : 0)
      .filter(price => price > 0);
    
    const soldPricesPerSqFt = soldForAnalysis
      .filter(p => p.livingArea && Number(p.livingArea) > 0 && p.closePrice)
      .map(p => Number(p.closePrice) / Number(p.livingArea));

    if (soldPrices.length === 0) return null;

    // Calculate average price per sqft
    const avgPricePerSqFt = soldPricesPerSqFt.length > 0 
      ? soldPricesPerSqFt.reduce((a, b) => a + b, 0) / soldPricesPerSqFt.length 
      : 0;

    // Calculate market trend adjustment based on recent sales
    let marketTrendAdjustment = 0;
    const soldWithDates = soldForAnalysis.filter(p => p.closeDate && p.closePrice);
    
    if (soldWithDates.length >= 3) {
      // Sort by close date
      const sortedByDate = [...soldWithDates].sort((a, b) => 
        new Date(a.closeDate!).getTime() - new Date(b.closeDate!).getTime()
      );
      
      // Compare first half vs second half average prices
      const midpoint = Math.floor(sortedByDate.length / 2);
      const earlyHalf = sortedByDate.slice(0, midpoint);
      const lateHalf = sortedByDate.slice(midpoint);
      
      const earlyAvg = earlyHalf.reduce((sum, p) => sum + Number(p.closePrice), 0) / earlyHalf.length;
      const lateAvg = lateHalf.reduce((sum, p) => sum + Number(p.closePrice), 0) / lateHalf.length;
      
      if (earlyAvg > 0) {
        marketTrendAdjustment = ((lateAvg - earlyAvg) / earlyAvg) * 100;
      }
    }

    // Calculate list-to-sale ratio from sold properties
    const ratios = soldForAnalysis
      .filter(p => p.listPrice && p.closePrice && Number(p.listPrice) > 0)
      .map(p => (Number(p.closePrice) / Number(p.listPrice)) * 100);
    
    const avgListToSaleRatio = ratios.length > 0 
      ? ratios.reduce((a, b) => a + b, 0) / ratios.length 
      : 100;

    // Calculate DOM (Days on Market) analysis
    const doms = soldForAnalysis
      .map(p => p.daysOnMarket || 0)
      .filter(dom => dom > 0);
    const avgDom = doms.length > 0 ? doms.reduce((a, b) => a + b, 0) / doms.length : 0;

    // Determine market condition based on DOM
    let marketCondition: 'hot' | 'balanced' | 'slow' = 'balanced';
    if (avgDom < 21) marketCondition = 'hot';
    else if (avgDom > 60) marketCondition = 'slow';

    // Calculate suggested price range
    const sortedPrices = [...soldPrices].sort((a, b) => a - b);
    const q1Index = Math.floor(sortedPrices.length * 0.25);
    const q3Index = Math.floor(sortedPrices.length * 0.75);
    const q1 = sortedPrices[q1Index] || sortedPrices[0];
    const q3 = sortedPrices[q3Index] || sortedPrices[sortedPrices.length - 1];
    const iqr = q3 - q1;
    
    // Apply market trend adjustment to suggestion (capped at 10%)
    const trendMultiplier = 1 + Math.max(-0.1, Math.min(0.1, marketTrendAdjustment / 100));
    
    // Suggested range based on quartiles with trend adjustment
    const suggestedLow = Math.round(q1 * trendMultiplier);
    const suggestedHigh = Math.round(q3 * trendMultiplier);
    const suggestedMid = Math.round(((q1 + q3) / 2) * trendMultiplier);

    // Quick sale vs maximum value suggestions
    const quickSalePrice = Math.round(suggestedLow * 0.98); // Slightly below low for quick sale
    const maxValuePrice = Math.round(suggestedHigh * 1.02); // Slightly above high for max value

    // Confidence score based on data quality (0-100)
    let confidenceScore = 50; // Base score
    confidenceScore += Math.min(20, soldForAnalysis.length * 2); // More comps = higher confidence
    confidenceScore += soldPricesPerSqFt.length > 3 ? 10 : 0; // Good sqft data
    confidenceScore += ratios.length > 2 ? 10 : 0; // Good ratio data
    confidenceScore -= Math.abs(marketTrendAdjustment) > 10 ? 10 : 0; // Volatile market reduces confidence
    confidenceScore = Math.max(0, Math.min(100, confidenceScore));

    return {
      suggestedLow,
      suggestedMid,
      suggestedHigh,
      quickSalePrice,
      maxValuePrice,
      avgPricePerSqFt,
      marketTrendAdjustment,
      avgListToSaleRatio,
      avgDom,
      marketCondition,
      confidenceScore,
      compsAnalyzed: soldForAnalysis.length,
      priceRange: { min: sortedPrices[0], max: sortedPrices[sortedPrices.length - 1] },
    };
  }, [soldProperties, excludedPropertyIds]);

  // Prepare chart data - use filtered statistics
  const priceRangeData = [
    { 
      name: 'Low', 
      value: filteredStatistics.price.range.min,
      fill: 'hsl(var(--chart-1))'
    },
    { 
      name: 'Avg', 
      value: filteredStatistics.price.average,
      fill: 'hsl(var(--chart-2))'
    },
    { 
      name: 'Med', 
      value: filteredStatistics.price.median,
      fill: 'hsl(var(--chart-3))'
    },
    { 
      name: 'High', 
      value: filteredStatistics.price.range.max,
      fill: 'hsl(var(--chart-4))'
    },
  ];

  return (
    <div className="space-y-6 cma-print">
      {/* Preview Banner - hidden in print/PDF */}
      {isPreview && expiresAt && (
        <div className="bg-yellow-100 dark:bg-yellow-900/20 border border-yellow-400 dark:border-yellow-600 rounded-md p-4 flex items-center justify-between gap-4 flex-wrap print:hidden cma-preview-banner" data-testid="cma-preview-banner">
          <p className="text-sm">
            You are seeing a preview of the report.
          </p>
          <div className="flex items-center gap-2 flex-wrap">
            <Button size="sm" onClick={onSave} data-testid="button-save-cma">
              <Save className="w-4 h-4 mr-2" />
              Save
            </Button>
            <Button size="sm" variant="outline" onClick={onPublicLink} data-testid="button-copy-live-url">
              <ExternalLink className="w-4 h-4 mr-2" />
              Copy Live URL
            </Button>
            <Button size="sm" variant="outline" onClick={onShareCMA} data-testid="button-share-cma-email">
              <Mail className="w-4 h-4 mr-2" />
              Share CMA
            </Button>
            <Button size="sm" variant="outline" onClick={onModifySearch} data-testid="button-modify-search">
              <Edit className="w-4 h-4 mr-2" />
              Modify Search
            </Button>
            {activeTab === "home-averages" && (
              <Button size="sm" variant="outline" onClick={onModifyStats} data-testid="button-modify-stats">
                <FileText className="w-4 h-4 mr-2" />
                Modify Stats
              </Button>
            )}
            <Button size="sm" variant="outline" onClick={onAddNotes} data-testid="button-notes">
              Notes
            </Button>
          </div>
        </div>
      )}

      {/* Print-only Summary Section - mirrors Share CMA layout for print/PDF */}
      <div className="hidden print:block space-y-6">
        {/* Report Title */}
        {reportTitle && (
          <div className="border-b pb-4">
            <h1 className="text-2xl font-bold">{reportTitle}</h1>
            <p className="text-sm text-muted-foreground">Comparative Market Analysis</p>
          </div>
        )}

        {/* Key Stats Cards Row - matches Share view */}
        <div className="grid grid-cols-3 gap-4">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">Average Price</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-primary">${Math.round(filteredStatistics.price.average).toLocaleString()}</p>
              <p className="text-xs text-muted-foreground">
                Range: ${filteredStatistics.price.range.min.toLocaleString()} - ${filteredStatistics.price.range.max.toLocaleString()}
              </p>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">Price Per Sqft</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">${filteredStatistics.pricePerSqFt.average.toFixed(0)}<span className="text-sm">/sqft</span></p>
              <p className="text-xs text-muted-foreground">
                Range: ${filteredStatistics.pricePerSqFt.range.min.toFixed(0)} - ${filteredStatistics.pricePerSqFt.range.max.toFixed(0)}
              </p>
            </CardContent>
          </Card>
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">Avg Living Area</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">{Math.round(filteredStatistics.livingArea.average).toLocaleString()}<span className="text-sm"> sqft</span></p>
              <p className="text-xs text-muted-foreground">
                {filteredStatistics.bedrooms.average.toFixed(1)} beds / {filteredStatistics.bathrooms.average.toFixed(1)} baths avg
              </p>
            </CardContent>
          </Card>
        </div>

        {/* CMA Market Review - Print Version (always included in PDF) */}
        <Card className="border-primary/30 bg-primary/5 print-cma-market-review">
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              <FileText className="w-5 h-5" />
              CMA Market Review
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <h4 className="font-semibold text-sm">Market Overview</h4>
                <p className="text-sm text-muted-foreground">
                  Based on {includedAll.length} comparable properties, the average price is{' '}
                  <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.average).toLocaleString()}</span>{' '}
                  with a median of{' '}
                  <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.median).toLocaleString()}</span>.
                  {' '}Prices range from ${filteredStatistics.price.range.min.toLocaleString()} to ${filteredStatistics.price.range.max.toLocaleString()}.
                </p>
              </div>
              <div className="space-y-2">
                <h4 className="font-semibold text-sm">Price Per Square Foot</h4>
                <p className="text-sm text-muted-foreground">
                  Average price per square foot is{' '}
                  <span className="font-semibold text-foreground">${filteredStatistics.pricePerSqFt.average.toFixed(2)}</span>{' '}
                  across comparable properties. This ranges from ${filteredStatistics.pricePerSqFt.range.min.toFixed(2)} to ${filteredStatistics.pricePerSqFt.range.max.toFixed(2)}/sqft.
                </p>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-4 pt-2">
              <div className="space-y-1">
                <h4 className="font-semibold text-sm">Days on Market</h4>
                <p className="text-sm text-muted-foreground">
                  Average: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.daysOnMarket.average)} days</span>
                </p>
              </div>
              <div className="space-y-1">
                <h4 className="font-semibold text-sm">Property Size</h4>
                <p className="text-sm text-muted-foreground">
                  Avg: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.livingArea.average).toLocaleString()} sqft</span>
                </p>
              </div>
              <div className="space-y-1">
                <h4 className="font-semibold text-sm">Bed/Bath</h4>
                <p className="text-sm text-muted-foreground">
                  Avg: <span className="font-semibold text-foreground">{filteredStatistics.bedrooms.average.toFixed(1)} beds / {filteredStatistics.bathrooms.average.toFixed(1)} baths</span>
                </p>
              </div>
            </div>
            <div className="pt-2 border-t">
              <p className="text-xs text-muted-foreground italic">
                This analysis is based on {includedActive.length} Active, {includedUnderContract.length} Active Under Contract, and {includedSold.length} Closed properties in your selection.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Agent Notes Section - shown when notes exist */}
      {notes && (
        <Card className="border-primary/20 bg-primary/5">
          <CardHeader className="pb-2">
            <CardTitle className="text-base flex items-center gap-2">
              <FileText className="w-4 h-4" />
              Agent Notes
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm whitespace-pre-wrap">{notes}</p>
          </CardContent>
        </Card>
      )}

      {/* CloudCMA-Style Header Bar */}
      <div className="bg-zinc-900 text-white rounded-t-lg print:hidden">
        <div className="flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-3">
            {/* Menu for legacy tabs */}
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="icon" className="text-white hover:bg-white/10" data-testid="button-menu">
                  <Menu className="w-5 h-5" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="start">
                <DropdownMenuItem onClick={() => setActiveTab("home-averages")} data-testid="menu-home-averages">
                  <LayoutGrid className="w-4 h-4 mr-2" />
                  Home Averages
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => setActiveTab("listings")} data-testid="menu-listings">
                  <MapIcon className="w-4 h-4 mr-2" />
                  Listings
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => setActiveTab("timeline")} data-testid="menu-timeline">
                  <Clock className="w-4 h-4 mr-2" />
                  Timeline
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => setActiveTab("market-stats")} data-testid="menu-market-stats">
                  <TrendingUp className="w-4 h-4 mr-2" />
                  Market Stats
                </DropdownMenuItem>
                {onModifyStats && (
                  <>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem onClick={onModifyStats} data-testid="menu-modify-stats">
                      <Edit className="w-4 h-4 mr-2" />
                      Modify Stats
                    </DropdownMenuItem>
                  </>
                )}
              </DropdownMenuContent>
            </DropdownMenu>
            <h2 className="text-lg font-semibold tracking-wide">
              {includedAll.length} COMPARABLE HOMES
            </h2>
          </div>
          <div className="flex items-center gap-1">
            <Button
              variant="ghost"
              size="sm"
              className={cn(
                "text-white hover:bg-white/10",
                activeTab === "compare" && "bg-white/20 text-primary"
              )}
              onClick={() => setActiveTab("compare")}
              data-testid="tab-compare"
            >
              <BarChart3 className="w-4 h-4 mr-1.5" />
              Compare
            </Button>
            <Button
              variant="ghost"
              size="sm"
              className={cn(
                "text-white hover:bg-white/10",
                activeTab === "map" && "bg-white/20 text-primary"
              )}
              onClick={() => setActiveTab("map")}
              data-testid="tab-map"
            >
              <MapIcon className="w-4 h-4 mr-1.5" />
              Map
            </Button>
            <Button
              variant="ghost"
              size="sm"
              className={cn(
                "text-white hover:bg-white/10",
                activeTab === "stats" && "bg-white/20 text-primary"
              )}
              onClick={() => setActiveTab("stats")}
              data-testid="tab-stats"
            >
              <TrendingUp className="w-4 h-4 mr-1.5" />
              Stats
            </Button>
            <Button
              variant="ghost"
              size="sm"
              className={cn(
                "text-white hover:bg-white/10",
                activeTab === "list" && "bg-white/20 text-primary"
              )}
              onClick={() => setActiveTab("list")}
              data-testid="tab-list"
            >
              <Home className="w-4 h-4 mr-1.5" />
              List
            </Button>
          </div>
        </div>
      </div>

      {/* Main Tabs - Hidden TabsList since we use the custom header */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="hidden">
          <TabsTrigger value="compare" data-testid="tab-compare-hidden">Compare</TabsTrigger>
          <TabsTrigger value="map" data-testid="tab-map-hidden">Map</TabsTrigger>
          <TabsTrigger value="stats" data-testid="tab-stats-hidden">Stats</TabsTrigger>
          <TabsTrigger value="list" data-testid="tab-list-hidden">List</TabsTrigger>
          <TabsTrigger value="home-averages" data-testid="tab-home-averages">Home Averages</TabsTrigger>
          <TabsTrigger value="listings" data-testid="tab-listings">Listings</TabsTrigger>
          <TabsTrigger value="timeline" data-testid="tab-timeline">Timeline</TabsTrigger>
          <TabsTrigger value="market-stats" data-testid="tab-market-stats">Market Stats</TabsTrigger>
        </TabsList>

        {/* Compare Tab - CloudCMA Style Table View */}
        <TabsContent value="compare" className="space-y-0 mt-0">
          {/* Status Filter Sub-tabs */}
          <div className="bg-zinc-800 px-2 sm:px-4 py-2 overflow-x-auto">
            <Tabs value={activeListingTab} onValueChange={setActiveListingTab} className="w-auto">
              <TabsList className="bg-transparent h-auto p-0 gap-1 sm:gap-2 flex-wrap sm:flex-nowrap">
                <TabsTrigger 
                  value="all" 
                  className="text-zinc-300 data-[state=active]:text-white data-[state=active]:bg-transparent data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none px-2 py-1 text-sm sm:text-base"
                  data-testid="compare-subtab-all"
                >
                  All
                </TabsTrigger>
                <TabsTrigger 
                  value="sold" 
                  className="text-zinc-300 data-[state=active]:text-white data-[state=active]:bg-transparent data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none px-2 py-1 text-sm sm:text-base"
                  data-testid="compare-subtab-closed"
                >
                  Closed
                </TabsTrigger>
                <TabsTrigger 
                  value="under-contract" 
                  className="text-zinc-300 data-[state=active]:text-white data-[state=active]:bg-transparent data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none px-2 py-1 text-sm sm:text-base whitespace-nowrap"
                  data-testid="compare-subtab-auc"
                >
                  <span className="hidden sm:inline">Active Under Contract</span>
                  <span className="sm:hidden">AUC</span>
                </TabsTrigger>
                <TabsTrigger 
                  value="pending" 
                  className="text-zinc-300 data-[state=active]:text-white data-[state=active]:bg-transparent data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none px-2 py-1 text-sm sm:text-base"
                  data-testid="compare-subtab-pending"
                >
                  Pending
                </TabsTrigger>
                <TabsTrigger 
                  value="active" 
                  className="text-zinc-300 data-[state=active]:text-white data-[state=active]:bg-transparent data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none px-2 py-1 text-sm sm:text-base"
                  data-testid="compare-subtab-active"
                >
                  Active
                </TabsTrigger>
              </TabsList>
            </Tabs>
          </div>

          {/* Summary Stats Bar - CloudCMA Style */}
          {(() => {
            const pendingProperties = properties.filter(p => p.standardStatus === 'Pending');
            const filteredProps = (activeListingTab === 'all' ? allProperties :
              activeListingTab === 'sold' ? soldProperties :
              activeListingTab === 'under-contract' ? underContractProperties :
              activeListingTab === 'pending' ? pendingProperties : activeProperties)
              .filter(p => !excludedPropertyIds.has(p.id));
            
            if (filteredProps.length === 0) return null;
            
            const prices = filteredProps.map(p => {
              const isSold = p.standardStatus === 'Closed';
              return isSold 
                ? (p.closePrice ? Number(p.closePrice) : (p.listPrice ? Number(p.listPrice) : 0))
                : (p.listPrice ? Number(p.listPrice) : 0);
            }).filter(p => p > 0).sort((a, b) => a - b);
            
            const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
            const minPrice = prices.length > 0 ? prices[0] : 0;
            const maxPrice = prices.length > 0 ? prices[prices.length - 1] : 0;
            const medianPrice = prices.length > 0 
              ? prices.length % 2 === 0 
                ? (prices[prices.length / 2 - 1] + prices[prices.length / 2]) / 2
                : prices[Math.floor(prices.length / 2)]
              : 0;
            
            // Calculate avg $/sqft and avg DOM
            const pricesPerSqFt = filteredProps
              .filter(p => p.livingArea && Number(p.livingArea) > 0)
              .map(p => {
                const isSold = p.standardStatus === 'Closed';
                const price = isSold 
                  ? (p.closePrice ? Number(p.closePrice) : Number(p.listPrice || 0))
                  : Number(p.listPrice || 0);
                return price / Number(p.livingArea);
              });
            const avgPricePerSqFt = pricesPerSqFt.length > 0 
              ? pricesPerSqFt.reduce((a, b) => a + b, 0) / pricesPerSqFt.length 
              : 0;
            
            const doms = filteredProps.map(p => p.daysOnMarket || 0).filter(d => d > 0);
            const avgDOM = doms.length > 0 ? Math.round(doms.reduce((a, b) => a + b, 0) / doms.length) : 0;
            
            return (
              <div className="bg-zinc-900 border-b border-zinc-700">
                <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-px bg-zinc-700">
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">Low Price</div>
                    <div className="text-lg sm:text-xl font-bold text-white">${minPrice.toLocaleString()}</div>
                  </div>
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">High Price</div>
                    <div className="text-lg sm:text-xl font-bold text-white">${maxPrice.toLocaleString()}</div>
                  </div>
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">Avg Price</div>
                    <div className="text-lg sm:text-xl font-bold text-white">${Math.round(avgPrice).toLocaleString()}</div>
                  </div>
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">Median</div>
                    <div className="text-lg sm:text-xl font-bold text-white">${Math.round(medianPrice).toLocaleString()}</div>
                  </div>
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">Avg $/sqft</div>
                    <div className="text-lg sm:text-xl font-bold text-white">${Math.round(avgPricePerSqFt)}</div>
                  </div>
                  <div className="px-3 py-3 bg-zinc-900">
                    <div className="text-xs text-zinc-400 uppercase tracking-wide">Avg DOM</div>
                    <div className="text-lg sm:text-xl font-bold text-white">{avgDOM} Days</div>
                  </div>
                </div>
              </div>
            );
          })()}

          {/* Data Table - CloudCMA Style */}
          <div className="bg-white dark:bg-zinc-950 rounded-b-lg relative">
            {/* Left scroll arrow for table */}
            {compareCanScrollLeft && (
              <Button
                variant="outline"
                size="icon"
                className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-zinc-900/90 shadow-lg rounded-full h-10 w-10"
                onClick={scrollCompareLeft}
                data-testid="button-compare-scroll-left"
              >
                <ChevronLeft className="w-5 h-5" />
              </Button>
            )}
            
            {/* Right scroll arrow for table */}
            {compareCanScrollRight && (
              <Button
                variant="outline"
                size="icon"
                className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-zinc-900/90 shadow-lg rounded-full h-10 w-10"
                onClick={scrollCompareRight}
                data-testid="button-compare-scroll-right"
              >
                <ChevronRight className="w-5 h-5" />
              </Button>
            )}
            
            <div ref={compareScrollRef} className="overflow-x-auto scroll-smooth">
              <Table>
              <TableHeader>
                <TableRow className="bg-zinc-100 dark:bg-zinc-800">
                  <TableHead className="w-12"></TableHead>
                  <TableHead className="min-w-[250px]">ADDRESS</TableHead>
                  <TableHead>STATUS</TableHead>
                  <TableHead className="text-right">PRICE</TableHead>
                  <TableHead className="text-right">SOLD DATE</TableHead>
                  <TableHead className="text-right">$/SQ.FT</TableHead>
                  <TableHead className="text-right">DOM</TableHead>
                  <TableHead className="text-right">BEDS</TableHead>
                  <TableHead className="text-right">BATHS</TableHead>
                  <TableHead className="text-right">SQ. FT.</TableHead>
                  <TableHead className="text-right">LOT SIZE</TableHead>
                  <TableHead className="text-right">GARAGE SPACES</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {(() => {
                  const pendingProperties = properties.filter(p => p.standardStatus === 'Pending');
                  const filteredProps = activeListingTab === 'all' ? allProperties :
                    activeListingTab === 'sold' ? soldProperties :
                    activeListingTab === 'under-contract' ? underContractProperties :
                    activeListingTab === 'pending' ? pendingProperties : activeProperties;
                  
                  const sortedProps = [...filteredProps].sort((a, b) => {
                    const priceA = a.standardStatus === 'Closed' 
                      ? (a.closePrice ? Number(a.closePrice) : Number(a.listPrice || 0))
                      : Number(a.listPrice || 0);
                    const priceB = b.standardStatus === 'Closed'
                      ? (b.closePrice ? Number(b.closePrice) : Number(b.listPrice || 0))
                      : Number(b.listPrice || 0);
                    return priceA - priceB;
                  });
                  
                  if (sortedProps.length === 0) {
                    return (
                      <TableRow>
                        <TableCell colSpan={12} className="text-center py-8 text-muted-foreground">
                          No properties in this category
                        </TableCell>
                      </TableRow>
                    );
                  }
                  
                  return sortedProps.map((property) => {
                    const isExcluded = excludedPropertyIds.has(property.id);
                    const isSold = property.standardStatus === 'Closed';
                    const price = isSold 
                      ? (property.closePrice ? Number(property.closePrice) : Number(property.listPrice || 0))
                      : Number(property.listPrice || 0);
                    const pricePerSqft = property.livingArea && Number(property.livingArea) > 0 
                      ? Math.round(price / Number(property.livingArea))
                      : null;
                    const lotSizeSqFt = property.lotSizeSquareFeet ? Number(property.lotSizeSquareFeet) : null;
                    
                    const statusColors: Record<string, string> = {
                      'Active': 'text-green-600',
                      'Closed': 'text-red-600',
                      'Active Under Contract': 'text-yellow-600',
                      'Pending': 'text-orange-600',
                    };
                    
                    return (
                      <TableRow 
                        key={property.id}
                        className={cn(
                          "cursor-pointer hover-elevate",
                          isExcluded && "opacity-40"
                        )}
                        onClick={() => handlePropertyClick(property)}
                        data-testid={`compare-row-${property.id}`}
                      >
                        <TableCell>
                          <div 
                            className={cn(
                              "w-8 h-4 rounded-full cursor-pointer transition-colors",
                              isExcluded ? "bg-zinc-300 dark:bg-zinc-600" : "bg-primary"
                            )}
                            onClick={(e) => {
                              e.stopPropagation();
                              setExcludedPropertyIds(prev => {
                                const next = new Set(prev);
                                if (next.has(property.id)) {
                                  next.delete(property.id);
                                } else {
                                  next.add(property.id);
                                }
                                return next;
                              });
                            }}
                            data-testid={`toggle-${property.id}`}
                          />
                        </TableCell>
                        <TableCell className="font-medium">
                          <div className="flex flex-col">
                            <span className="truncate max-w-[220px]">{property.unparsedAddress}</span>
                            <span className="text-xs text-muted-foreground">
                              {property.city}, {property.stateOrProvince} {property.postalCode}
                            </span>
                          </div>
                        </TableCell>
                        <TableCell>
                          <span className={cn("font-medium text-sm", statusColors[property.standardStatus || ''] || '')}>
                            {property.standardStatus}
                          </span>
                        </TableCell>
                        <TableCell className="text-right font-semibold">
                          ${price.toLocaleString()}
                        </TableCell>
                        <TableCell className="text-right">
                          {isSold && property.closeDate 
                            ? new Date(property.closeDate).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' })
                            : '-'}
                        </TableCell>
                        <TableCell className="text-right">
                          {pricePerSqft ? `$${pricePerSqft}` : '-'}
                        </TableCell>
                        <TableCell className="text-right">
                          {property.daysOnMarket || '-'}
                        </TableCell>
                        <TableCell className="text-right">{property.bedroomsTotal || '-'}</TableCell>
                        <TableCell className="text-right">{property.bathroomsTotalInteger || '-'}</TableCell>
                        <TableCell className="text-right">
                          {property.livingArea ? Number(property.livingArea).toLocaleString() : '-'}
                        </TableCell>
                        <TableCell className="text-right">
                          {lotSizeSqFt ? lotSizeSqFt.toLocaleString() : '-'}
                        </TableCell>
                        <TableCell className="text-right">
                          {(property as any).garageSpaces || '-'}
                        </TableCell>
                      </TableRow>
                    );
                  });
                })()}
              </TableBody>
              </Table>
            </div>
          </div>
        </TabsContent>

        {/* Map Tab - CloudCMA Style Full-width Map */}
        <TabsContent value="map" className="space-y-0 mt-0 relative">
          <div className="h-[600px] rounded-b-lg overflow-hidden">
            {(() => {
              const validPositions = properties
                .filter(p => p.latitude && p.longitude && !excludedPropertyIds.has(p.id))
                .map(p => [Number(p.latitude), Number(p.longitude)] as [number, number]);
              
              if (validPositions.length === 0) {
                return (
                  <div className="h-full flex items-center justify-center bg-muted">
                    <p className="text-muted-foreground">No properties with valid coordinates</p>
                  </div>
                );
              }
              
              const center = validPositions.reduce(
                (acc, pos) => [acc[0] + pos[0] / validPositions.length, acc[1] + pos[1] / validPositions.length],
                [0, 0]
              ) as [number, number];
              
              return (
                <MapContainer
                  center={center}
                  zoom={13}
                  style={{ height: '100%', width: '100%' }}
                >
                  <TileLayer
                    url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                    attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                  />
                  <FitBounds positions={validPositions} />
                  {properties
                    .filter(p => p.latitude && p.longitude && !excludedPropertyIds.has(p.id))
                    .map((property) => {
                      const isSold = property.standardStatus === 'Closed';
                      const price = isSold 
                        ? (property.closePrice ? Number(property.closePrice) : Number(property.listPrice || 0))
                        : Number(property.listPrice || 0);
                      const isSubject = subjectPropertyId ? property.id === subjectPropertyId : false;
                      
                      return (
                        <Marker
                          key={property.id}
                          position={[Number(property.latitude), Number(property.longitude)]}
                          icon={getPriceMarkerIcon(price, property.standardStatus || 'Active', isSubject)}
                          eventHandlers={{
                            click: () => handlePropertyClick(property),
                          }}
                        >
                          <Popup>
                            <div className="min-w-[200px]">
                              {isSubject && (
                                <Badge className="mb-2 bg-blue-500 text-white">Subject Property</Badge>
                              )}
                              <p className="font-semibold">{property.unparsedAddress}</p>
                              <p className="text-lg font-bold text-primary">${price.toLocaleString()}</p>
                              <p className="text-sm text-muted-foreground">
                                {property.bedroomsTotal} beds | {property.bathroomsTotalInteger} baths | {property.livingArea ? Number(property.livingArea).toLocaleString() : 'N/A'} sqft
                              </p>
                              <Badge variant="outline" className="mt-1">{property.standardStatus}</Badge>
                            </div>
                          </Popup>
                        </Marker>
                      );
                    })}
                </MapContainer>
              );
            })()}
          </div>
          {/* Map Legend */}
          <div className="absolute bottom-4 left-4 bg-white dark:bg-zinc-900 rounded-lg shadow-lg p-3 z-[1000]">
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <div className="w-5 h-5 rounded bg-green-500 flex items-center justify-center">
                  <span className="text-white text-[10px] font-bold">$</span>
                </div>
                <span className="text-xs">Active</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-5 h-5 rounded bg-orange-500 flex items-center justify-center">
                  <span className="text-white text-[10px] font-bold">$</span>
                </div>
                <span className="text-xs">Under Contract</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-5 h-5 rounded bg-red-500 flex items-center justify-center">
                  <span className="text-white text-[10px] font-bold">$</span>
                </div>
                <span className="text-xs">Closed</span>
              </div>
              {subjectPropertyId && (
                <div className="flex items-center gap-2">
                  <div className="w-5 h-5 rounded bg-blue-500 flex items-center justify-center">
                    <span className="text-[10px]"></span>
                  </div>
                  <span className="text-xs">Subject</span>
                </div>
              )}
            </div>
          </div>
        </TabsContent>

        {/* Stats Tab - Statistics Overview with Charts */}
        <TabsContent value="stats" className="space-y-6 p-4">
          {/* Header Stats Cards Row */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-lg">Average Price</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold text-primary">${Math.round(filteredStatistics.price.average).toLocaleString()}</p>
                <p className="text-xs text-muted-foreground">
                  Range: ${filteredStatistics.price.range.min.toLocaleString()} - ${filteredStatistics.price.range.max.toLocaleString()}
                </p>
              </CardContent>
            </Card>
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-lg">Price Per Sqft</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">${filteredStatistics.pricePerSqFt.average.toFixed(0)}<span className="text-sm">/sqft</span></p>
                <p className="text-xs text-muted-foreground">
                  Range: ${filteredStatistics.pricePerSqFt.range.min.toFixed(0)} - ${filteredStatistics.pricePerSqFt.range.max.toFixed(0)}
                </p>
              </CardContent>
            </Card>
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-lg">Avg Living Area</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-2xl font-bold">{Math.round(filteredStatistics.livingArea.average).toLocaleString()}<span className="text-sm"> sqft</span></p>
                <p className="text-xs text-muted-foreground">
                  {filteredStatistics.bedrooms.average.toFixed(1)} beds / {filteredStatistics.bathrooms.average.toFixed(1)} baths avg
                </p>
              </CardContent>
            </Card>
          </div>

          {/* Statistics Summary Table */}
          <Card>
            <CardHeader>
              <CardTitle>Statistics Summary ({includedAll.length} Properties)</CardTitle>
            </CardHeader>
            <CardContent>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-[150px]">Metric</TableHead>
                    <TableHead>Range</TableHead>
                    <TableHead>Average</TableHead>
                    <TableHead>Median</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  <TableRow>
                    <TableCell className="font-medium">Price</TableCell>
                    <TableCell>${filteredStatistics.price.range.min.toLocaleString()} - ${filteredStatistics.price.range.max.toLocaleString()}</TableCell>
                    <TableCell className="font-semibold">${Math.round(filteredStatistics.price.average).toLocaleString()}</TableCell>
                    <TableCell>${Math.round(filteredStatistics.price.median).toLocaleString()}</TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell className="font-medium">Price/SqFt</TableCell>
                    <TableCell>${filteredStatistics.pricePerSqFt.range.min.toFixed(0)} - ${filteredStatistics.pricePerSqFt.range.max.toFixed(0)}</TableCell>
                    <TableCell className="font-semibold">${filteredStatistics.pricePerSqFt.average.toFixed(0)}</TableCell>
                    <TableCell>${filteredStatistics.pricePerSqFt.median.toFixed(0)}</TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell className="font-medium">Living Area</TableCell>
                    <TableCell>{filteredStatistics.livingArea.range.min.toLocaleString()} - {filteredStatistics.livingArea.range.max.toLocaleString()} sqft</TableCell>
                    <TableCell className="font-semibold">{Math.round(filteredStatistics.livingArea.average).toLocaleString()} sqft</TableCell>
                    <TableCell>{Math.round(filteredStatistics.livingArea.median).toLocaleString()} sqft</TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell className="font-medium">Year Built</TableCell>
                    <TableCell>{filteredStatistics.yearBuilt.range.min} - {filteredStatistics.yearBuilt.range.max}</TableCell>
                    <TableCell className="font-semibold">{Math.round(filteredStatistics.yearBuilt.average)}</TableCell>
                    <TableCell>{Math.round(filteredStatistics.yearBuilt.median)}</TableCell>
                  </TableRow>
                </TableBody>
              </Table>
            </CardContent>
          </Card>

          {/* Price Comparison Bar Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BarChart3 className="w-5 h-5" />
                Price Comparison
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart
                    data={includedAll.map(property => {
                      const isSold = property.standardStatus === 'Closed';
                      const price = isSold 
                        ? (property.closePrice ? Number(property.closePrice) : Number(property.listPrice || 0))
                        : Number(property.listPrice || 0);
                      const address = property.unparsedAddress || '';
                      const shortAddress = address.length > 20 ? address.slice(0, 18) + '...' : address;
                      return {
                        address: shortAddress,
                        fullAddress: address,
                        price,
                        status: property.standardStatus,
                      };
                    })}
                    margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
                  >
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis 
                      dataKey="address" 
                      angle={-45} 
                      textAnchor="end" 
                      height={80}
                      tick={{ fontSize: 10 }}
                    />
                    <YAxis 
                      tickFormatter={(value) => `$${(value / 1000).toFixed(0)}K`}
                    />
                    <RechartsTooltip 
                      formatter={(value: number) => [`$${value.toLocaleString()}`, 'Price']}
                      labelFormatter={(label, payload) => {
                        if (payload && payload[0]) {
                          return payload[0].payload.fullAddress;
                        }
                        return label;
                      }}
                    />
                    <Bar dataKey="price" fill="hsl(25, 90%, 52%)" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>

          {/* CMA Market Review Summary */}
          <Card className="border-primary/30 bg-primary/5">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <FileText className="w-5 h-5" />
                CMA Market Review
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <h4 className="font-semibold text-sm">Market Overview</h4>
                  <p className="text-sm text-muted-foreground">
                    Based on {includedAll.length} comparable properties, the average price is{' '}
                    <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.average).toLocaleString()}</span>{' '}
                    with a median of{' '}
                    <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.median).toLocaleString()}</span>.
                    {' '}Prices range from ${filteredStatistics.price.range.min.toLocaleString()} to ${filteredStatistics.price.range.max.toLocaleString()}.
                  </p>
                </div>
                <div className="space-y-2">
                  <h4 className="font-semibold text-sm">Price Per Square Foot</h4>
                  <p className="text-sm text-muted-foreground">
                    Average price per square foot is{' '}
                    <span className="font-semibold text-foreground">${filteredStatistics.pricePerSqFt.average.toFixed(2)}</span>{' '}
                    across comparable properties. This ranges from ${filteredStatistics.pricePerSqFt.range.min.toFixed(2)} to ${filteredStatistics.pricePerSqFt.range.max.toFixed(2)}/sqft.
                  </p>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Days on Market</h4>
                  <p className="text-sm text-muted-foreground">
                    Average: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.daysOnMarket.average)} days</span>
                  </p>
                </div>
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Property Size</h4>
                  <p className="text-sm text-muted-foreground">
                    Avg: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.livingArea.average).toLocaleString()} sqft</span>
                  </p>
                </div>
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Bed/Bath</h4>
                  <p className="text-sm text-muted-foreground">
                    Avg: <span className="font-semibold text-foreground">{filteredStatistics.bedrooms.average.toFixed(1)} beds / {filteredStatistics.bathrooms.average.toFixed(1)} baths</span>
                  </p>
                </div>
              </div>
              <div className="pt-2 border-t">
                <p className="text-xs text-muted-foreground italic">
                  This analysis is based on {includedActive.length} Active, {includedUnderContract.length} Active Under Contract, and {includedSold.length} Closed properties in your selection.
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Days on Market / % of List Price Analysis */}
          {(() => {
            const closedWithData = soldProperties.filter(p => 
              !excludedPropertyIds.has(p.id) &&
              p.closePrice && p.listPrice && p.daysOnMarket !== null && p.daysOnMarket !== undefined
            );
            
            if (closedWithData.length === 0) return null;
            
            const avgDOM = closedWithData.reduce((sum, p) => sum + (p.daysOnMarket || 0), 0) / closedWithData.length;
            const avgListPriceRatio = closedWithData.reduce((sum, p) => {
              const listPrice = Number(p.listPrice || 0);
              const closePrice = Number(p.closePrice || 0);
              return sum + (listPrice > 0 ? (closePrice / listPrice) * 100 : 0);
            }, 0) / closedWithData.length;
            
            const sortedByPrice = [...closedWithData].sort((a, b) => 
              Number(b.closePrice || 0) - Number(a.closePrice || 0)
            );
            
            return (
              <Card>
                <CardHeader className="pb-2">
                  <div className="flex items-center justify-between flex-wrap gap-4">
                    <div className="flex items-center gap-6">
                      <div>
                        <span className="text-3xl font-bold text-primary">{Math.round(avgDOM)}</span>
                        <span className="text-lg font-medium text-muted-foreground ml-2">DAYS ON MARKET</span>
                      </div>
                      <div className="h-8 w-px bg-border" />
                      <div>
                        <span className="text-3xl font-bold text-primary">{avgListPriceRatio.toFixed(2)}%</span>
                        <span className="text-lg font-medium text-muted-foreground ml-2">OF LIST PRICE</span>
                      </div>
                    </div>
                  </div>
                  <p className="text-sm text-muted-foreground mt-2">
                    Sold homes were on the market for an average of <span className="font-semibold text-foreground">{Math.round(avgDOM)} days</span> before they accepted an offer. 
                    These homes sold for an average of <span className="font-semibold text-foreground">{avgListPriceRatio.toFixed(2)}%</span> of list price.
                  </p>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Left side - Property list */}
                    <div className="space-y-3">
                      <div className="flex items-center gap-2">
                        <Badge variant="outline" className="bg-red-500 text-white border-red-500">
                          {closedWithData.length}
                        </Badge>
                        <span className="font-semibold">Closed</span>
                      </div>
                      <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                        {sortedByPrice.map((property) => {
                          const photos = getPropertyPhotos(property);
                          const primaryPhoto = photos[0];
                          const listPrice = Number(property.listPrice || 0);
                          const closePrice = Number(property.closePrice || 0);
                          const ratio = listPrice > 0 ? (closePrice / listPrice * 100) : 0;
                          
                          return (
                            <div 
                              key={property.id}
                              className="flex items-center gap-3 p-2 rounded-lg hover-elevate cursor-pointer"
                              onClick={() => handlePropertyClick(property)}
                              data-testid={`dom-property-${property.id}`}
                            >
                              <div className="w-16 h-12 rounded overflow-hidden flex-shrink-0">
                                {primaryPhoto ? (
                                  <img src={primaryPhoto} alt="" className="w-full h-full object-cover" />
                                ) : (
                                  <div className="w-full h-full bg-muted flex items-center justify-center">
                                    <Home className="w-4 h-4 text-muted-foreground" />
                                  </div>
                                )}
                              </div>
                              <div className="flex-1 min-w-0">
                                <p className="font-medium text-sm truncate">{property.unparsedAddress}</p>
                                <p className="text-xs text-muted-foreground">
                                  {property.daysOnMarket} Days  {ratio.toFixed(2)}%
                                </p>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* Right side - Price comparison chart */}
                    <div className="h-[400px]">
                      <ResponsiveContainer width="100%" height="100%">
                        <ScatterChart margin={{ top: 20, right: 60, bottom: 20, left: 20 }}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <YAxis 
                            type="number" 
                            dataKey="price" 
                            name="Price"
                            tickFormatter={(v) => `$${(v / 1000000).toFixed(2)}M`}
                            domain={['dataMin - 50000', 'dataMax + 50000']}
                            orientation="right"
                          />
                          <XAxis 
                            type="number" 
                            dataKey="index" 
                            name="Property"
                            hide
                          />
                          <RechartsTooltip 
                            content={({ active, payload }) => {
                              if (!active || !payload?.length) return null;
                              const data = payload[0].payload;
                              return (
                                <div className="bg-background border rounded-lg p-2 shadow-lg text-sm">
                                  <p className="font-semibold">{data.address}</p>
                                  <p>Close: ${data.price.toLocaleString()}</p>
                                  <p>List: ${data.listPrice.toLocaleString()}</p>
                                  <p>{data.ratio.toFixed(2)}% of list</p>
                                </div>
                              );
                            }}
                          />
                          <Scatter 
                            data={sortedByPrice.map((p, i) => ({
                              index: i,
                              price: Number(p.closePrice || 0),
                              listPrice: Number(p.listPrice || 0),
                              ratio: Number(p.listPrice || 0) > 0 ? (Number(p.closePrice || 0) / Number(p.listPrice || 0)) * 100 : 0,
                              address: p.unparsedAddress,
                              status: p.standardStatus,
                            }))}
                            shape={(props: any) => {
                              const { cx, cy, payload } = props;
                              const ratio = payload.ratio;
                              let color = '#22c55e'; // green - above list
                              if (ratio < 95) color = '#ef4444'; // red - significantly below
                              else if (ratio < 100) color = '#eab308'; // yellow - slightly below
                              return (
                                <circle 
                                  cx={cx} 
                                  cy={cy} 
                                  r={10} 
                                  fill={color} 
                                  stroke="white" 
                                  strokeWidth={2}
                                  style={{ cursor: 'pointer' }}
                                />
                              );
                            }}
                          />
                        </ScatterChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  
                  {/* Legend */}
                  <div className="flex items-center justify-center gap-6 mt-4 pt-4 border-t">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded-full bg-green-500" />
                      <span className="text-sm text-muted-foreground">100% of list</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded-full bg-yellow-500" />
                      <span className="text-sm text-muted-foreground">95-99% of list</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded-full bg-red-500" />
                      <span className="text-sm text-muted-foreground">&lt;95% of list</span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })()}

          {/* Pricing Strategy - Average Price/Sq.Ft. Chart */}
          {(() => {
            const subjectProp = subjectPropertyId 
              ? properties.find(p => p.id === subjectPropertyId)
              : null;
            
            const closedComps = soldProperties.filter(p => 
              !excludedPropertyIds.has(p.id) && 
              p.id !== subjectPropertyId &&
              p.livingArea && Number(p.livingArea) > 0 &&
              (p.closePrice || p.listPrice)
            );
            
            if (closedComps.length === 0) return null;
            
            const avgPricePerSqFt = closedComps.reduce((sum, p) => {
              const price = p.closePrice ? Number(p.closePrice) : Number(p.listPrice || 0);
              const sqft = Number(p.livingArea || 0);
              return sum + (sqft > 0 ? price / sqft : 0);
            }, 0) / closedComps.length;
            
            const chartData = closedComps.map(p => {
              const price = p.closePrice ? Number(p.closePrice) : Number(p.listPrice || 0);
              const sqft = Number(p.livingArea || 0);
              const pricePerSqFt = sqft > 0 ? price / sqft : 0;
              const address = p.unparsedAddress || '';
              const shortAddress = address.split(' ').slice(0, 3).join(' ');
              return {
                id: p.id,
                address: shortAddress,
                fullAddress: address,
                sqft,
                price,
                pricePerSqFt,
                isSubject: false,
                property: p
              };
            });
            
            if (subjectProp && showSubjectOnPricingChart) {
              const subjectPrice = subjectProp.listPrice ? Number(subjectProp.listPrice) : 0;
              const subjectSqft = Number(subjectProp.livingArea || 0);
              if (subjectSqft > 0 && subjectPrice > 0) {
                chartData.push({
                  id: subjectProp.id,
                  address: 'Subject',
                  fullAddress: subjectProp.unparsedAddress || 'Subject Property',
                  sqft: subjectSqft,
                  price: subjectPrice,
                  pricePerSqFt: subjectPrice / subjectSqft,
                  isSubject: true,
                  property: subjectProp
                });
              }
            }
            
            const getPropertyPhotos = (property: Property): string[] => {
              const photos = (property as any).photos as string[] | undefined;
              const media = (property as any).media as any[] | undefined;
              if (photos && photos.length > 0) return photos;
              if (media && media.length > 0) {
                return media.map((m: any) => m.mediaURL || m.mediaUrl).filter(Boolean);
              }
              return [];
            };
            
            const sidebarProperties: Array<{ property: Property; isSubject: boolean }> = [];
            
            if (subjectProp && showSubjectOnPricingChart) {
              const subjectSqft = Number(subjectProp.livingArea || 0);
              const subjectPrice = subjectProp.listPrice ? Number(subjectProp.listPrice) : 0;
              if (subjectSqft > 0 && subjectPrice > 0) {
                sidebarProperties.push({ property: subjectProp, isSubject: true });
              }
            }
            
            closedComps.forEach(p => {
              sidebarProperties.push({ property: p, isSubject: false });
            });
            
            return (
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-xl uppercase tracking-wide">Average Price/Sq. Ft.</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="flex gap-4">
                    {/* Left Sidebar - Property List */}
                    <div className="w-64 flex-shrink-0 border-r pr-4">
                      <div className="text-xs text-muted-foreground mb-2">
                        {showSubjectOnPricingChart && subjectProp ? '1 Subject, ' : ''}{closedComps.length} Closed
                      </div>
                      <div className="space-y-2 max-h-[400px] overflow-y-auto">
                        {sidebarProperties.map(({ property, isSubject }) => {
                          const photos = getPropertyPhotos(property);
                          const photo = photos[0];
                          const price = isSubject 
                            ? Number(property.listPrice || 0)
                            : (property.closePrice ? Number(property.closePrice) : Number(property.listPrice || 0));
                          const sqft = Number(property.livingArea || 0);
                          const pricePerSqFt = sqft > 0 ? price / sqft : 0;
                          const address = property.unparsedAddress || '';
                          const shortAddress = address.split(' ').slice(0, 3).join(' ') + '...';
                          const isSelected = selectedPricingProperty?.id === property.id;
                          
                          return (
                            <div 
                              key={property.id}
                              className={cn(
                                "flex items-center gap-2 p-2 rounded cursor-pointer transition-colors",
                                isSelected ? "bg-primary/10 border border-primary" : "hover:bg-muted",
                                isSubject && "border-l-4 border-l-blue-500"
                              )}
                              onClick={() => setSelectedPricingProperty(isSelected ? null : property)}
                              data-testid={`pricing-property-${property.id}`}
                            >
                              <div className="w-12 h-12 flex-shrink-0 rounded overflow-hidden bg-muted relative">
                                {photo ? (
                                  <img src={photo} alt="" className="w-full h-full object-cover" />
                                ) : (
                                  <div className="w-full h-full flex items-center justify-center text-muted-foreground">
                                    <Home className="w-5 h-5" />
                                  </div>
                                )}
                                {isSubject && (
                                  <div className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                                    <span className="text-white text-[10px]"></span>
                                  </div>
                                )}
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="text-sm font-medium truncate">
                                  {isSubject && <span className="text-blue-500 font-semibold">Subject: </span>}
                                  {shortAddress}
                                </div>
                                <div className="text-xs text-primary font-semibold">${Math.round(pricePerSqFt)} / sq. ft.</div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* Main Content - Chart and Stats */}
                    <div className="flex-1">
                      {/* Large Price/SqFt Header */}
                      <div className="mb-4">
                        <div className="flex items-baseline gap-2">
                          <span className="text-4xl font-bold text-primary">${Math.round(avgPricePerSqFt)}</span>
                          <span className="text-xl text-muted-foreground">/ Sq. Ft.</span>
                        </div>
                        <p className="text-sm text-muted-foreground mt-1">
                          Comparable homes sold for an average of <span className="text-primary font-medium">${Math.round(avgPricePerSqFt)}</span>/sq. ft. 
                          Many factors such as location, use of space, condition, quality, and amenities determine the market value per square foot, 
                          so reviewing each comp carefully is important.
                        </p>
                      </div>
                      
                      {/* Scatter Chart */}
                      <div className="h-[350px]">
                        <ResponsiveContainer width="100%" height="100%">
                          <ScatterChart margin={{ top: 20, right: 20, bottom: 40, left: 60 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis 
                              type="number" 
                              dataKey="sqft" 
                              name="Square Feet"
                              tickFormatter={(value) => value.toLocaleString()}
                              label={{ value: 'Square feet', position: 'bottom', offset: 20 }}
                            />
                            <YAxis 
                              type="number" 
                              dataKey="price" 
                              name="Price"
                              tickFormatter={(value) => `$${(value / 1000).toFixed(0)}K`}
                            />
                            <ZAxis type="number" range={[200, 200]} />
                            <RechartsTooltip 
                              formatter={(value: number, name: string) => {
                                if (name === 'Price') return [`$${value.toLocaleString()}`, 'Price'];
                                if (name === 'Square Feet') return [value.toLocaleString(), 'Sq Ft'];
                                return [value, name];
                              }}
                              labelFormatter={(label, payload) => {
                                if (payload && payload[0]) {
                                  return payload[0].payload.fullAddress;
                                }
                                return label;
                              }}
                            />
                            <Scatter 
                              name="Properties" 
                              data={chartData}
                              shape={(props: any) => {
                                const { cx, cy, payload } = props;
                                if (payload.isSubject) {
                                  return (
                                    <g>
                                      <circle cx={cx} cy={cy} r={16} fill="#3b82f6" stroke="white" strokeWidth={2} />
                                      <text x={cx} y={cy + 4} textAnchor="middle" fill="white" fontSize={12}></text>
                                    </g>
                                  );
                                }
                                return (
                                  <circle 
                                    cx={cx} 
                                    cy={cy} 
                                    r={10} 
                                    fill="#dc2626"
                                    stroke="white" 
                                    strokeWidth={2}
                                    style={{ cursor: 'pointer' }}
                                  />
                                );
                              }}
                            />
                          </ScatterChart>
                        </ResponsiveContainer>
                      </div>
                      
                      {/* Legend */}
                      <div className="flex items-center gap-6 mt-4 pt-4 border-t">
                        <div 
                          className="flex items-center gap-2 cursor-pointer select-none"
                          onClick={() => setShowSubjectOnPricingChart(!showSubjectOnPricingChart)}
                          data-testid="toggle-subject-pricing"
                        >
                          <Checkbox 
                            id="show-subject-pricing"
                            checked={showSubjectOnPricingChart}
                            onCheckedChange={(checked) => setShowSubjectOnPricingChart(checked === true)}
                            data-testid="checkbox-show-subject"
                          />
                          <div className="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center">
                            <span className="text-white text-[10px]"></span>
                          </div>
                          <span className="text-sm text-muted-foreground">
                            Subject Property
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Right Panel - Selected Property Details */}
                    {selectedPricingProperty && (
                      <div className="w-72 flex-shrink-0 border-l pl-4">
                        <div className="flex items-center justify-between mb-2">
                          <Badge 
                            variant="secondary" 
                            className={cn("text-xs", selectedPricingProperty.id === subjectPropertyId && "bg-blue-500 text-white")}
                          >
                            {selectedPricingProperty.id === subjectPropertyId 
                              ? 'Subject Property' 
                              : (selectedPricingProperty.standardStatus === 'Closed' ? 'Closed' : selectedPricingProperty.standardStatus)}
                          </Badge>
                          <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-6 w-6"
                            onClick={() => setSelectedPricingProperty(null)}
                            data-testid="button-close-pricing-detail"
                          >
                            
                          </Button>
                        </div>
                        
                        {(() => {
                          const photos = getPropertyPhotos(selectedPricingProperty);
                          const currentPhoto = photos[pricingPhotoIndex] || photos[0];
                          const price = selectedPricingProperty.closePrice 
                            ? Number(selectedPricingProperty.closePrice) 
                            : Number(selectedPricingProperty.listPrice || 0);
                          const sqft = Number(selectedPricingProperty.livingArea || 0);
                          const pricePerSqFt = sqft > 0 ? price / sqft : 0;
                          const listPrice = Number(selectedPricingProperty.listPrice || 0);
                          const closePrice = Number(selectedPricingProperty.closePrice || 0);
                          const soldPriceRatio = listPrice > 0 && closePrice > 0 
                            ? ((closePrice / listPrice) * 100).toFixed(1) 
                            : null;
                          
                          return (
                            <>
                              <div className="aspect-video rounded overflow-hidden bg-muted mb-3 relative group">
                                {currentPhoto ? (
                                  <>
                                    <img 
                                      src={currentPhoto} 
                                      alt={selectedPricingProperty.unparsedAddress || 'Property'} 
                                      className="w-full h-full object-cover"
                                      data-testid="img-pricing-property"
                                    />
                                    {photos.length > 1 && (
                                      <>
                                        <div 
                                          className="absolute left-0 top-0 h-full w-1/3 cursor-pointer flex items-center justify-start pl-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                          onClick={handlePricingPrevImage}
                                          data-testid="button-pricing-prev-photo"
                                        >
                                          <div className="bg-black/50 rounded-full p-1">
                                            <ChevronLeft className="w-4 h-4 text-white" />
                                          </div>
                                        </div>
                                        <div 
                                          className="absolute right-0 top-0 h-full w-1/3 cursor-pointer flex items-center justify-end pr-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                          onClick={handlePricingNextImage}
                                          data-testid="button-pricing-next-photo"
                                        >
                                          <div className="bg-black/50 rounded-full p-1">
                                            <ChevronRight className="w-4 h-4 text-white" />
                                          </div>
                                        </div>
                                        <div className="absolute bottom-1 left-1/2 -translate-x-1/2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full">
                                          {pricingPhotoIndex + 1} / {photos.length}
                                        </div>
                                      </>
                                    )}
                                  </>
                                ) : (
                                  <div className="w-full h-full flex items-center justify-center text-muted-foreground">
                                    <Home className="w-8 h-8" />
                                  </div>
                                )}
                              </div>
                              
                              <h4 className="font-semibold text-sm truncate">{selectedPricingProperty.unparsedAddress}</h4>
                              <p className="text-xs text-muted-foreground mb-3">
                                {selectedPricingProperty.city}, {selectedPricingProperty.stateOrProvince} {selectedPricingProperty.postalCode}
                              </p>
                              
                              <div className="text-xl font-bold text-primary mb-3">
                                ${price.toLocaleString()}
                              </div>
                              
                              <div className="space-y-2 text-sm">
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Beds</span>
                                  <span className="font-medium">{selectedPricingProperty.bedroomsTotal || '-'}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Baths</span>
                                  <span className="font-medium">{selectedPricingProperty.bathroomsTotalInteger || '-'}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Sq. Ft.</span>
                                  <span className="font-medium">{sqft > 0 ? sqft.toLocaleString() : '-'}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Lot Size</span>
                                  <span className="font-medium">{selectedPricingProperty.lotSizeSquareFeet ? Number(selectedPricingProperty.lotSizeSquareFeet).toLocaleString() : '-'}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Garage Spaces</span>
                                  <span className="font-medium">{(selectedPricingProperty as any).garageSpaces || '-'}</span>
                                </div>
                              </div>
                              
                              <Separator className="my-3" />
                              
                              <div className="space-y-2 text-sm">
                                <div className="font-medium">Listing Details</div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Orig. Price</span>
                                  <span className="font-medium">${listPrice.toLocaleString()}</span>
                                </div>
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">List Price</span>
                                  <span className="font-medium">${listPrice.toLocaleString()}</span>
                                </div>
                                {closePrice > 0 && (
                                  <div className="flex justify-between">
                                    <span className="text-muted-foreground">Sold Price {soldPriceRatio && <span className="text-xs">({soldPriceRatio}%)</span>}</span>
                                    <span className="font-medium">${closePrice.toLocaleString()}</span>
                                  </div>
                                )}
                                <div className="flex justify-between">
                                  <span className="text-muted-foreground">Price per Sq. Ft.</span>
                                  <span className="font-medium">${Math.round(pricePerSqFt)}</span>
                                </div>
                              </div>
                            </>
                          );
                        })()}
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            );
          })()}
        </TabsContent>

        {/* List Tab - Property Cards with Horizontal Scroll */}
        <TabsContent value="list" className="space-y-0 mt-0">
          <div className="bg-white dark:bg-zinc-950 rounded-b-lg p-4 relative">
            {/* Left scroll arrow */}
            {listCanScrollLeft && (
              <Button
                variant="outline"
                size="icon"
                className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-zinc-900/90 shadow-lg rounded-full h-10 w-10"
                onClick={scrollListLeft}
                data-testid="button-list-scroll-left"
              >
                <ChevronLeft className="w-5 h-5" />
              </Button>
            )}
            
            {/* Right scroll arrow */}
            {listCanScrollRight && (
              <Button
                variant="outline"
                size="icon"
                className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 dark:bg-zinc-900/90 shadow-lg rounded-full h-10 w-10"
                onClick={scrollListRight}
                data-testid="button-list-scroll-right"
              >
                <ChevronRight className="w-5 h-5" />
              </Button>
            )}
            
            <div 
              ref={listScrollRef}
              className="flex gap-4 overflow-x-auto pb-4 scroll-smooth px-8"
              onLoad={() => updateListScrollButtons()}
            >
              {(() => {
                // Find the actual subject property using subjectPropertyId prop
                const subjectProp = subjectPropertyId 
                  ? properties.find(p => p.id === subjectPropertyId)
                  : null;
                
                // Get non-subject properties (comps)
                const compProps = properties
                  .filter(p => !excludedPropertyIds.has(p.id) && p.id !== subjectPropertyId)
                  .sort((a, b) => {
                    const priceA = a.standardStatus === 'Closed' 
                      ? (a.closePrice ? Number(a.closePrice) : Number(a.listPrice || 0))
                      : Number(a.listPrice || 0);
                    const priceB = b.standardStatus === 'Closed'
                      ? (b.closePrice ? Number(b.closePrice) : Number(b.listPrice || 0))
                      : Number(b.listPrice || 0);
                    return priceA - priceB;
                  });
                
                // Combine: subject first, then sorted comps
                const displayProps = subjectProp 
                  ? [subjectProp, ...compProps] 
                  : compProps;
                
                if (displayProps.length === 0) {
                  return (
                    <div className="w-full text-center py-8 text-muted-foreground">
                      No properties to compare
                    </div>
                  );
                }
                
                // Use actual subject property for comparison (or first comp if no subject)
                const referenceProperty = subjectProp || displayProps[0];
                const subjectBeds = referenceProperty.bedroomsTotal || 0;
                const subjectBaths = referenceProperty.bathroomsTotalInteger || 0;
                const subjectSqFt = Number(referenceProperty.livingArea || 0);
                const subjectLotSize = Number(referenceProperty.lotSizeSquareFeet || 0);
                const subjectGarage = Number((referenceProperty as any).garageSpaces || 0);
                
                return displayProps.map((property) => {
                  const photos = getPropertyPhotos(property);
                  const primaryPhoto = photos[0];
                  const isSold = property.standardStatus === 'Closed';
                  const price = isSold 
                    ? (property.closePrice ? Number(property.closePrice) : Number(property.listPrice || 0))
                    : Number(property.listPrice || 0);
                  
                  const beds = property.bedroomsTotal || 0;
                  const baths = property.bathroomsTotalInteger || 0;
                  const sqft = Number(property.livingArea || 0);
                  const lotSize = Number(property.lotSizeSquareFeet || 0);
                  const garage = Number((property as any).garageSpaces || 0);
                  
                  // Calculate differences from subject
                  const bedsDiff = beds - subjectBeds;
                  const sqftDiff = subjectSqFt > 0 ? ((sqft - subjectSqFt) / subjectSqFt * 100) : 0;
                  const lotDiff = subjectLotSize > 0 ? ((lotSize - subjectLotSize) / subjectLotSize * 100) : 0;
                  const garageDiff = garage - subjectGarage;
                  
                  const isSubject = subjectPropertyId ? property.id === subjectPropertyId : false;
                  
                  const statusColors: Record<string, string> = {
                    'Active': 'bg-green-500',
                    'Closed': 'bg-red-500',
                    'Active Under Contract': 'bg-yellow-500',
                    'Pending': 'bg-orange-500',
                  };
                  
                  return (
                    <div 
                      key={property.id}
                      className="flex-shrink-0 w-64 bg-card border rounded-lg overflow-hidden cursor-pointer hover-elevate"
                      onClick={() => handlePropertyClick(property)}
                      data-testid={`list-card-${property.id}`}
                    >
                      {/* Photo */}
                      <div className="relative h-36">
                        {primaryPhoto ? (
                          <img src={primaryPhoto} alt={property.unparsedAddress || ''} className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full bg-muted flex items-center justify-center">
                            <Home className="w-8 h-8 text-muted-foreground/50" />
                          </div>
                        )}
                        {isSubject && (
                          <div className="absolute top-2 right-2 bg-primary text-primary-foreground text-xs px-2 py-1 rounded">
                            Subject
                          </div>
                        )}
                      </div>
                      
                      {/* Details */}
                      <div className="p-3">
                        <div className="flex items-start justify-between gap-2 mb-1">
                          <h4 className="font-bold text-sm truncate">{property.unparsedAddress?.toUpperCase()}</h4>
                          <span className="font-bold text-primary">${price.toLocaleString()}</span>
                        </div>
                        <p className="text-xs text-muted-foreground mb-2">
                          {property.city}, {property.stateOrProvince} {property.postalCode}
                        </p>
                        <Badge className={cn("text-xs text-white", statusColors[property.standardStatus || ''] || 'bg-gray-500')}>
                          {property.standardStatus}
                        </Badge>
                        
                        <Separator className="my-3" />
                        
                        {/* Comparison Stats */}
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Beds</span>
                            <span className="font-medium">
                              {beds}
                              {!isSubject && bedsDiff !== 0 && (
                                <span className={cn("ml-1 text-xs", bedsDiff > 0 ? "text-green-600" : "text-red-600")}>
                                  {bedsDiff > 0 ? `+${bedsDiff}` : bedsDiff}
                                </span>
                              )}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Baths</span>
                            <span className="font-medium">{baths}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Sq. Ft. (Living Area)</span>
                            <span className="font-medium">
                              {sqft.toLocaleString()}
                              {!isSubject && sqftDiff !== 0 && (
                                <span className={cn("ml-1 text-xs", sqftDiff > 0 ? "text-green-600" : "text-red-600")}>
                                  {sqftDiff > 0 ? "+" : ""}{sqftDiff.toFixed(1)}%
                                </span>
                              )}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Lot Size</span>
                            <span className="font-medium">
                              {lotSize.toLocaleString()}
                              {!isSubject && lotDiff !== 0 && (
                                <span className={cn("ml-1 text-xs", lotDiff > 0 ? "text-green-600" : "text-red-600")}>
                                  {lotDiff > 0 ? "+" : ""}{lotDiff.toFixed(0)}%
                                </span>
                              )}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Garage Spaces</span>
                            <span className="font-medium">
                              {garage}
                              {!isSubject && garageDiff !== 0 && (
                                <span className={cn("ml-1 text-xs", garageDiff > 0 ? "text-green-600" : "text-red-600")}>
                                  {garageDiff > 0 ? `+${garageDiff}` : garageDiff}
                                </span>
                              )}
                            </span>
                          </div>
                        </div>
                        
                        <Separator className="my-3" />
                        
                        {/* Listing Details */}
                        <div className="space-y-1 text-sm">
                          <h5 className="font-semibold text-xs text-muted-foreground uppercase">Listing Details</h5>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">Orig. Price</span>
                            <span className="font-medium">
                              ${((property as any).originalListPrice ? Number((property as any).originalListPrice) : price).toLocaleString()}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-muted-foreground">List Price</span>
                            <span className="font-medium">${Number(property.listPrice || 0).toLocaleString()}</span>
                          </div>
                          {isSold && property.closePrice && (
                            <div className="flex justify-between">
                              <span className="text-muted-foreground">Sold Price</span>
                              <span className="font-medium">${Number(property.closePrice).toLocaleString()}</span>
                            </div>
                          )}
                        </div>
                        
                        {/* Public Remarks */}
                        {property.publicRemarks && (
                          <>
                            <Separator className="my-3" />
                            <div className="space-y-1 text-sm">
                              <h5 className="font-semibold text-xs text-muted-foreground uppercase">Public Remarks</h5>
                              <p className="text-xs text-muted-foreground line-clamp-4">
                                {property.publicRemarks}
                              </p>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  );
                });
              })()}
            </div>
          </div>
        </TabsContent>

        {/* Home Averages Tab */}
        <TabsContent value="home-averages" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Statistics ({includedAll.length} Properties)</CardTitle>
            </CardHeader>
            <CardContent>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-[200px]"></TableHead>
                    <TableHead>Range</TableHead>
                    <TableHead>Average</TableHead>
                    <TableHead>Median</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {visibleMetrics.includes('price') && (
                    <TableRow>
                      <TableCell className="font-medium">Price</TableCell>
                      <TableCell data-testid="text-price-range">
                        ${filteredStatistics.price.range.min.toLocaleString()} - ${filteredStatistics.price.range.max.toLocaleString()}
                      </TableCell>
                      <TableCell data-testid="text-price-average">
                        ${Math.round(filteredStatistics.price.average).toLocaleString()}
                      </TableCell>
                      <TableCell data-testid="text-price-median">
                        ${Math.round(filteredStatistics.price.median).toLocaleString()}
                      </TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('pricePerSqFt') && (
                    <TableRow>
                      <TableCell className="font-medium">Price/SqFt</TableCell>
                      <TableCell>
                        ${filteredStatistics.pricePerSqFt.range.min.toFixed(2)}/SqFt - ${filteredStatistics.pricePerSqFt.range.max.toFixed(2)}/SqFt
                      </TableCell>
                      <TableCell>
                        ${filteredStatistics.pricePerSqFt.average.toFixed(2)}/SqFt
                      </TableCell>
                      <TableCell>
                        ${filteredStatistics.pricePerSqFt.median.toFixed(2)}/SqFt
                      </TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('daysOnMarket') && (
                    <TableRow>
                      <TableCell className="font-medium">Days on Market</TableCell>
                      <TableCell>
                        {filteredStatistics.daysOnMarket.range.min} - {filteredStatistics.daysOnMarket.range.max}
                      </TableCell>
                      <TableCell>{Math.round(filteredStatistics.daysOnMarket.average)}</TableCell>
                      <TableCell>{Math.round(filteredStatistics.daysOnMarket.median)}</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('livingArea') && (
                    <TableRow>
                      <TableCell className="font-medium">Liv SqFt</TableCell>
                      <TableCell>
                        {filteredStatistics.livingArea.range.min.toLocaleString()} SqFt - {filteredStatistics.livingArea.range.max.toLocaleString()} SqFt
                      </TableCell>
                      <TableCell>{Math.round(filteredStatistics.livingArea.average).toLocaleString()} SqFt</TableCell>
                      <TableCell>{Math.round(filteredStatistics.livingArea.median).toLocaleString()} SqFt</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('lotSize') && (
                    <TableRow>
                      <TableCell className="font-medium">Lot SqFt</TableCell>
                      <TableCell>
                        {filteredStatistics.lotSize.range.min.toLocaleString()} SqFt - {filteredStatistics.lotSize.range.max.toLocaleString()} SqFt
                      </TableCell>
                      <TableCell>{Math.round(filteredStatistics.lotSize.average).toLocaleString()} SqFt</TableCell>
                      <TableCell>{Math.round(filteredStatistics.lotSize.median).toLocaleString()} SqFt</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('acres') && (
                    <TableRow>
                      <TableCell className="font-medium">Acres</TableCell>
                      <TableCell>
                        {filteredStatistics.acres.range.min.toFixed(2)} Acres - {filteredStatistics.acres.range.max.toFixed(2)} Acres
                      </TableCell>
                      <TableCell>{filteredStatistics.acres.average.toFixed(2)} Acres</TableCell>
                      <TableCell>{filteredStatistics.acres.median.toFixed(2)} Acres</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('bedrooms') && (
                    <TableRow>
                      <TableCell className="font-medium">Beds</TableCell>
                      <TableCell>
                        {filteredStatistics.bedrooms.range.min} - {filteredStatistics.bedrooms.range.max}
                      </TableCell>
                      <TableCell>{filteredStatistics.bedrooms.average.toFixed(1)}</TableCell>
                      <TableCell>{filteredStatistics.bedrooms.median}</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('bathrooms') && (
                    <TableRow>
                      <TableCell className="font-medium">Baths</TableCell>
                      <TableCell>
                        {filteredStatistics.bathrooms.range.min} - {filteredStatistics.bathrooms.range.max}
                      </TableCell>
                      <TableCell>{filteredStatistics.bathrooms.average.toFixed(1)}</TableCell>
                      <TableCell>{filteredStatistics.bathrooms.median}</TableCell>
                    </TableRow>
                  )}
                  {visibleMetrics.includes('yearBuilt') && (
                    <TableRow>
                      <TableCell className="font-medium">Year Built</TableCell>
                      <TableCell>
                        {filteredStatistics.yearBuilt.range.min} - {filteredStatistics.yearBuilt.range.max}
                      </TableCell>
                      <TableCell>{Math.round(filteredStatistics.yearBuilt.average)}</TableCell>
                      <TableCell>{filteredStatistics.yearBuilt.median}</TableCell>
                    </TableRow>
                  )}
                </TableBody>
              </Table>
            </CardContent>
          </Card>

          {/* Dynamic Pricing Suggestion Card */}
          {pricingSuggestion && (
            <Card className="border-primary/20 bg-gradient-to-br from-background to-primary/5">
              <CardHeader className="pb-2">
                <CardTitle className="flex items-center gap-2">
                  <Target className="w-5 h-5 text-primary" />
                  Suggested Price Range
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <Info className="w-4 h-4 text-muted-foreground cursor-help" />
                    </TooltipTrigger>
                    <TooltipContent side="right" className="max-w-sm">
                      <p className="text-sm">
                        Price suggestions based on {pricingSuggestion.compsAnalyzed} sold comparable properties, 
                        adjusted for current market trends. Not a formal appraisal.
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Main Price Range Display */}
                <div className="text-center space-y-2">
                  <div className="flex items-center justify-center gap-3 text-3xl font-bold">
                    <span className="text-muted-foreground">${pricingSuggestion.suggestedLow.toLocaleString()}</span>
                    <span className="text-muted-foreground">-</span>
                    <span className="text-primary">${pricingSuggestion.suggestedHigh.toLocaleString()}</span>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    Suggested listing range based on {pricingSuggestion.compsAnalyzed} comparable sales
                  </p>
                </div>

                {/* Visual Price Range Bar */}
                {(() => {
                  const rangeSpan = pricingSuggestion.priceRange.max - pricingSuggestion.priceRange.min;
                  const hasValidRange = rangeSpan > 0;
                  
                  const clamp = (val: number) => Math.max(0, Math.min(100, val));
                  
                  const leftPct = hasValidRange 
                    ? clamp(((pricingSuggestion.suggestedLow - pricingSuggestion.priceRange.min) / rangeSpan) * 100)
                    : 10;
                  const rightPct = hasValidRange 
                    ? clamp(100 - ((pricingSuggestion.suggestedHigh - pricingSuggestion.priceRange.min) / rangeSpan) * 100)
                    : 10;
                  const midPct = hasValidRange
                    ? clamp(((pricingSuggestion.suggestedMid - pricingSuggestion.priceRange.min) / rangeSpan) * 100)
                    : 50;
                  
                  return (
                    <div className="space-y-2">
                      <div className="relative h-8 bg-muted rounded-md overflow-hidden">
                        {hasValidRange ? (
                          <>
                            <div 
                              className="absolute h-full bg-gradient-to-r from-green-500/40 via-primary/60 to-orange-500/40 rounded-md"
                              style={{ left: `${leftPct}%`, right: `${rightPct}%` }}
                            />
                            <div 
                              className="absolute w-1 h-full bg-primary"
                              style={{ left: `${midPct}%` }}
                            />
                          </>
                        ) : (
                          <>
                            <div className="absolute inset-0 bg-primary/40 rounded-md" />
                            <div className="absolute w-1 h-full bg-primary left-1/2 transform -translate-x-1/2" />
                          </>
                        )}
                      </div>
                      <div className="flex justify-between text-xs text-muted-foreground">
                        <span>${pricingSuggestion.priceRange.min.toLocaleString()}</span>
                        <span className="font-medium text-primary">Target: ${pricingSuggestion.suggestedMid.toLocaleString()}</span>
                        <span>${pricingSuggestion.priceRange.max.toLocaleString()}</span>
                      </div>
                    </div>
                  );
                })()}

                {/* Price Strategy Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 rounded-md bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800">
                    <div className="flex items-center gap-2 mb-2">
                      <Zap className="w-4 h-4 text-green-600 dark:text-green-400" />
                      <span className="font-medium text-green-700 dark:text-green-400">Quick Sale Price</span>
                    </div>
                    <p className="text-2xl font-bold text-green-700 dark:text-green-400">
                      ${pricingSuggestion.quickSalePrice.toLocaleString()}
                    </p>
                    <p className="text-xs text-green-600/80 dark:text-green-400/80 mt-1">
                      Competitive pricing for faster sale
                    </p>
                  </div>

                  <div className="p-4 rounded-md bg-orange-50 dark:bg-orange-950/30 border border-orange-200 dark:border-orange-800">
                    <div className="flex items-center gap-2 mb-2">
                      <TrendingUp className="w-4 h-4 text-orange-600 dark:text-orange-400" />
                      <span className="font-medium text-orange-700 dark:text-orange-400">Maximum Value</span>
                    </div>
                    <p className="text-2xl font-bold text-orange-700 dark:text-orange-400">
                      ${pricingSuggestion.maxValuePrice.toLocaleString()}
                    </p>
                    <p className="text-xs text-orange-600/80 dark:text-orange-400/80 mt-1">
                      Aggressive pricing for maximum return
                    </p>
                  </div>
                </div>

                {/* Market Metrics Grid */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div className="text-center p-3 bg-muted/50 rounded-md">
                    <div className="flex items-center justify-center gap-1 mb-1">
                      <DollarSign className="w-4 h-4 text-muted-foreground" />
                      <span className="text-xs text-muted-foreground">Avg $/SqFt</span>
                    </div>
                    <p className="text-lg font-bold">${pricingSuggestion.avgPricePerSqFt.toFixed(0)}</p>
                  </div>

                  <div className="text-center p-3 bg-muted/50 rounded-md">
                    <div className="flex items-center justify-center gap-1 mb-1">
                      <TrendingUp className="w-4 h-4 text-muted-foreground" />
                      <span className="text-xs text-muted-foreground">Market Trend</span>
                    </div>
                    <p className={cn(
                      "text-lg font-bold",
                      pricingSuggestion.marketTrendAdjustment >= 0 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"
                    )}>
                      {pricingSuggestion.marketTrendAdjustment >= 0 ? '+' : ''}{pricingSuggestion.marketTrendAdjustment.toFixed(1)}%
                    </p>
                  </div>

                  <div className="text-center p-3 bg-muted/50 rounded-md">
                    <div className="flex items-center justify-center gap-1 mb-1">
                      <BarChart3 className="w-4 h-4 text-muted-foreground" />
                      <span className="text-xs text-muted-foreground">List/Sale Ratio</span>
                    </div>
                    <p className="text-lg font-bold">{pricingSuggestion.avgListToSaleRatio.toFixed(1)}%</p>
                  </div>

                  <div className="text-center p-3 bg-muted/50 rounded-md">
                    <div className="flex items-center justify-center gap-1 mb-1">
                      <Clock className="w-4 h-4 text-muted-foreground" />
                      <span className="text-xs text-muted-foreground">Avg DOM</span>
                    </div>
                    <p className="text-lg font-bold">{Math.round(pricingSuggestion.avgDom)} days</p>
                  </div>
                </div>

                {/* Market Condition & Confidence */}
                <div className="flex flex-wrap items-center justify-between gap-3 pt-2 border-t">
                  <div className="flex items-center gap-2">
                    <span className="text-sm text-muted-foreground">Market:</span>
                    <Badge 
                      variant="outline"
                      className={cn(
                        pricingSuggestion.marketCondition === 'hot' && "bg-red-100 text-red-700 border-red-300 dark:bg-red-950/30 dark:text-red-400 dark:border-red-800",
                        pricingSuggestion.marketCondition === 'balanced' && "bg-blue-100 text-blue-700 border-blue-300 dark:bg-blue-950/30 dark:text-blue-400 dark:border-blue-800",
                        pricingSuggestion.marketCondition === 'slow' && "bg-gray-100 text-gray-700 border-gray-300 dark:bg-gray-900/30 dark:text-gray-400 dark:border-gray-700"
                      )}
                    >
                      {pricingSuggestion.marketCondition === 'hot' ? 'Hot Market' : 
                       pricingSuggestion.marketCondition === 'balanced' ? 'Balanced Market' : 'Slow Market'}
                    </Badge>
                  </div>

                  <div className="flex items-center gap-2">
                    <span className="text-sm text-muted-foreground">Confidence:</span>
                    <div className="flex items-center gap-1">
                      <div className="w-24 h-2 bg-muted rounded-full overflow-hidden">
                        <div 
                          className={cn(
                            "h-full rounded-full",
                            pricingSuggestion.confidenceScore >= 70 ? "bg-green-500" :
                            pricingSuggestion.confidenceScore >= 50 ? "bg-yellow-500" : "bg-red-500"
                          )}
                          style={{ width: `${pricingSuggestion.confidenceScore}%` }}
                        />
                      </div>
                      <span className="text-sm font-medium">{pricingSuggestion.confidenceScore}%</span>
                    </div>
                  </div>
                </div>

                <p className="text-xs text-muted-foreground italic">
                  This analysis is based on comparable sales data and market trends. 
                  Consult with your agent for a comprehensive pricing strategy.
                </p>
              </CardContent>
            </Card>
          )}

          {/* Property List at Bottom of Home Averages */}
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-base">Properties Used in Analysis ({includedAll.length})</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {[...includedAll].sort((a, b) => {
                  const priceA = a.standardStatus === 'Closed' 
                    ? (a.closePrice ? Number(a.closePrice) : Number(a.listPrice || 0))
                    : Number(a.listPrice || 0);
                  const priceB = b.standardStatus === 'Closed'
                    ? (b.closePrice ? Number(b.closePrice) : Number(b.listPrice || 0))
                    : Number(b.listPrice || 0);
                  return priceA - priceB;
                }).map((property) => {
                  const photos = (property as any).photos as string[] | undefined;
                  const media = (property as any).media as any[] | undefined;
                  const primaryPhoto = photos?.[0] || media?.[0]?.mediaURL || media?.[0]?.mediaUrl;
                  const isSold = property.standardStatus === 'Closed';
                  const price = isSold 
                    ? (property.closePrice ? Number(property.closePrice) : (property.listPrice ? Number(property.listPrice) : 0))
                    : (property.listPrice ? Number(property.listPrice) : 0);
                  const pricePerSqft = property.livingArea ? price / Number(property.livingArea) : null;
                  
                  const statusConfig = {
                    'Active': { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-400', border: 'border-green-200 dark:border-green-800' },
                    'Active Under Contract': { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-400', border: 'border-yellow-200 dark:border-yellow-800' },
                    'Closed': { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-400', border: 'border-red-200 dark:border-red-800' }
                  };
                  const status = statusConfig[property.standardStatus as keyof typeof statusConfig] || statusConfig['Active'];
                  
                  return (
                    <div 
                      key={property.id} 
                      className={`flex gap-3 p-3 rounded-md border cursor-pointer hover-elevate transition-colors ${status.border}`}
                      onClick={() => handlePropertyClick(property)}
                      onKeyDown={(e) => e.key === 'Enter' && handlePropertyClick(property)}
                      tabIndex={0}
                      role="button"
                      data-testid={`home-avg-card-${property.id}`}
                    >
                      {primaryPhoto ? (
                        <img src={primaryPhoto} alt={property.unparsedAddress || ''} className="w-20 h-20 object-cover rounded-md flex-shrink-0" />
                      ) : (
                        <div className="w-20 h-20 bg-muted rounded-md flex flex-col items-center justify-center flex-shrink-0 p-1">
                          <Home className="w-5 h-5 text-muted-foreground/50 mb-0.5" />
                          <span className="text-[8px] text-muted-foreground text-center leading-tight">No photos available</span>
                        </div>
                      )}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-2 flex-wrap">
                          <p className="font-semibold text-sm truncate max-w-[200px]">{property.unparsedAddress}</p>
                          <Badge variant="outline" className={`${status.bg} ${status.text} text-xs flex-shrink-0`}>
                            {property.standardStatus}
                          </Badge>
                        </div>
                        {(property.propertySubType || property.propertyType) && (
                          <p className="text-xs text-muted-foreground">{property.propertySubType || property.propertyType}</p>
                        )}
                        <p className="text-lg font-bold text-primary">${price.toLocaleString()}</p>
                        <div className="flex flex-wrap gap-x-3 text-xs text-muted-foreground mt-1">
                          <span>{property.bedroomsTotal || 0} beds</span>
                          <span>{property.bathroomsTotalInteger || 0} baths</span>
                          {property.livingArea && <span>{Number(property.livingArea).toLocaleString()} sqft</span>}
                          {pricePerSqft && <span>${pricePerSqft.toFixed(0)}/sqft</span>}
                        </div>
                        <div className="flex flex-wrap gap-x-3 text-xs text-muted-foreground mt-1">
                          {(property as any).listDate && <span>Listed: {new Date((property as any).listDate).toLocaleDateString()}</span>}
                          {isSold && property.closeDate && <span>Closed: {new Date(property.closeDate).toLocaleDateString()}</span>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Listings Tab - Properties sorted by price lowhigh with Map */}
        <TabsContent value="listings" className="space-y-6">
          {/* Side-by-side layout: List on left, Map on right */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Left Column: Property List */}
            <div className="space-y-4">
              <Tabs value={activeListingTab} onValueChange={setActiveListingTab}>
                <div className="flex items-center justify-between flex-wrap gap-2">
                  <TabsList>
                    <TabsTrigger value="all" data-testid="subtab-all">All ({includedAll.length})</TabsTrigger>
                    <TabsTrigger value="sold" data-testid="subtab-sold">Closed ({includedSold.length})</TabsTrigger>
                    <TabsTrigger value="under-contract" data-testid="subtab-under-contract">
                      AUC ({includedUnderContract.length})
                    </TabsTrigger>
                    <TabsTrigger value="active" data-testid="subtab-active">Active ({includedActive.length})</TabsTrigger>
                  </TabsList>
                  
                  {/* Include All / Exclude All buttons - CloudCMA style */}
                  <div className="flex items-center gap-2">
                    <Button 
                      size="sm" 
                      variant="outline"
                      onClick={() => setExcludedPropertyIds(new Set())}
                      data-testid="button-include-all"
                    >
                      Include All
                    </Button>
                    <Button 
                      size="sm" 
                      variant="outline"
                      onClick={() => setExcludedPropertyIds(new Set(allProperties.map(p => p.id)))}
                      data-testid="button-exclude-all"
                    >
                      Exclude All
                    </Button>
                    {excludedPropertyIds.size > 0 && (
                      <Badge variant="secondary" className="text-xs">
                        {excludedPropertyIds.size} excluded
                      </Badge>
                    )}
                  </div>
                </div>

                <div className="mt-4 space-y-4">
              {/* Summary Stats Cards at Top - CloudCMA style: Low/Median/Average/High */}
              {(() => {
                const filteredProps = (activeListingTab === 'all' ? allProperties :
                  activeListingTab === 'sold' ? soldProperties :
                  activeListingTab === 'under-contract' ? underContractProperties : activeProperties)
                  .filter(p => !excludedPropertyIds.has(p.id));
                
                const totalCount = activeListingTab === 'all' ? includedAll.length :
                  activeListingTab === 'sold' ? includedSold.length :
                  activeListingTab === 'under-contract' ? includedUnderContract.length : includedActive.length;
                
                if (totalCount === 0) return null;
                
                const prices = filteredProps.map(p => {
                  const isSold = p.standardStatus === 'Closed';
                  return isSold 
                    ? (p.closePrice ? Number(p.closePrice) : (p.listPrice ? Number(p.listPrice) : 0))
                    : (p.listPrice ? Number(p.listPrice) : 0);
                }).filter(p => p > 0).sort((a, b) => a - b);
                
                const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
                const minPrice = prices.length > 0 ? prices[0] : 0;
                const maxPrice = prices.length > 0 ? prices[prices.length - 1] : 0;
                const medianPrice = prices.length > 0 
                  ? prices.length % 2 === 0 
                    ? (prices[prices.length / 2 - 1] + prices[prices.length / 2]) / 2
                    : prices[Math.floor(prices.length / 2)]
                  : 0;
                
                return (
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <Card>
                      <CardContent className="pt-3 pb-3">
                        <div className="text-xs text-muted-foreground uppercase tracking-wide">Properties</div>
                        <div className="text-2xl font-bold">{filteredProps.length}</div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-3 pb-3">
                        <div className="text-xs text-muted-foreground uppercase tracking-wide">Low</div>
                        <div className="text-lg font-bold text-green-600">${minPrice.toLocaleString()}</div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-3 pb-3">
                        <div className="text-xs text-muted-foreground uppercase tracking-wide">Median</div>
                        <div className="text-lg font-bold">${Math.round(medianPrice).toLocaleString()}</div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-3 pb-3">
                        <div className="text-xs text-muted-foreground uppercase tracking-wide">Average</div>
                        <div className="text-lg font-bold">${Math.round(avgPrice).toLocaleString()}</div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-3 pb-3">
                        <div className="text-xs text-muted-foreground uppercase tracking-wide">High</div>
                        <div className="text-lg font-bold text-red-600">${maxPrice.toLocaleString()}</div>
                      </CardContent>
                    </Card>
                  </div>
                );
              })()}
              
              {/* Properties List - Sorted by price lowhigh */}
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-base">
                    {activeListingTab === 'all' ? 'All Properties' :
                     activeListingTab === 'sold' ? 'Closed Properties' :
                     activeListingTab === 'under-contract' ? 'Active Under Contract' : 'Active Listings'} - Price Low to High
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  {(() => {
                    // Show all properties (including excluded) for toggle functionality
                    // Excluded properties are visually indicated with opacity-50
                    const filteredProps = activeListingTab === 'all' ? allProperties :
                      activeListingTab === 'sold' ? soldProperties :
                      activeListingTab === 'under-contract' ? underContractProperties : activeProperties;
                    
                    // Sort by price lowhigh
                    const sortedProps = [...filteredProps].sort((a, b) => {
                      const priceA = a.standardStatus === 'Closed' 
                        ? (a.closePrice ? Number(a.closePrice) : Number(a.listPrice || 0))
                        : Number(a.listPrice || 0);
                      const priceB = b.standardStatus === 'Closed'
                        ? (b.closePrice ? Number(b.closePrice) : Number(b.listPrice || 0))
                        : Number(b.listPrice || 0);
                      return priceA - priceB;
                    });
                    
                    if (sortedProps.length === 0) {
                      return (
                        <p className="text-sm text-muted-foreground text-center py-8">
                          No properties in this category
                        </p>
                      );
                    }
                    
                    return (
                      <div className="space-y-3">
                        {sortedProps.map((property) => {
                          const photos = (property as any).photos as string[] | undefined;
                          const media = (property as any).media as any[] | undefined;
                          const primaryPhoto = photos?.[0] || media?.[0]?.mediaURL || media?.[0]?.mediaUrl;
                          const isSold = property.standardStatus === 'Closed';
                          const price = isSold 
                            ? (property.closePrice ? Number(property.closePrice) : (property.listPrice ? Number(property.listPrice) : 0))
                            : (property.listPrice ? Number(property.listPrice) : 0);
                          const pricePerSqft = property.livingArea ? price / Number(property.livingArea) : null;
                          
                          // Status badge styling
                          const statusConfig = {
                            'Active': { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-400', border: 'border-green-200 dark:border-green-800' },
                            'Active Under Contract': { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-400', border: 'border-yellow-200 dark:border-yellow-800' },
                            'Closed': { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-400', border: 'border-red-200 dark:border-red-800' }
                          };
                          const status = statusConfig[property.standardStatus as keyof typeof statusConfig] || statusConfig['Active'];
                          const isExcluded = excludedPropertyIds.has(property.id);
                          
                          const toggleExclude = (e: React.MouseEvent | React.KeyboardEvent) => {
                            e.stopPropagation();
                            const newSet = new Set(excludedPropertyIds);
                            if (isExcluded) {
                              newSet.delete(property.id);
                            } else {
                              newSet.add(property.id);
                            }
                            setExcludedPropertyIds(newSet);
                          };
                          
                          return (
                            <div 
                              key={property.id} 
                              className={cn(
                                `flex gap-3 p-3 rounded-md border cursor-pointer hover-elevate transition-colors ${status.border}`,
                                isExcluded && 'opacity-50 bg-muted/30'
                              )}
                              onClick={() => handlePropertyClick(property)}
                              onKeyDown={(e) => e.key === 'Enter' && handlePropertyClick(property)}
                              tabIndex={0}
                              role="button"
                              data-testid={`listing-card-${property.id}`}
                            >
                              {/* Exclude toggle */}
                              <div 
                                className="flex items-start pt-1"
                                onClick={toggleExclude}
                                onKeyDown={(e) => e.key === 'Enter' && toggleExclude(e)}
                              >
                                <Checkbox 
                                  checked={!isExcluded}
                                  className="h-4 w-4"
                                  data-testid={`checkbox-include-${property.id}`}
                                />
                              </div>
                              {primaryPhoto ? (
                                <img src={primaryPhoto} alt={property.unparsedAddress || ''} className="w-24 h-24 object-cover rounded-md flex-shrink-0" />
                              ) : (
                                <div className="w-24 h-24 bg-muted rounded-md flex flex-col items-center justify-center flex-shrink-0 p-1">
                                  <Home className="w-6 h-6 text-muted-foreground/50 mb-1" />
                                  <span className="text-[9px] text-muted-foreground text-center leading-tight">No photos available</span>
                                </div>
                              )}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-start justify-between gap-2 flex-wrap">
                                  <p className="font-semibold text-sm truncate max-w-[200px]">{property.unparsedAddress}</p>
                                  <Badge variant="outline" className={`${status.bg} ${status.text} text-xs flex-shrink-0`}>
                                    {property.standardStatus}
                                  </Badge>
                                </div>
                                <p className="text-xl font-bold text-primary">${price.toLocaleString()}</p>
                                <div className="flex flex-wrap gap-x-3 text-xs text-muted-foreground mt-1">
                                  <span>{property.bedroomsTotal || 0} beds</span>
                                  <span>{property.bathroomsTotalInteger || 0} baths</span>
                                  {property.livingArea && <span>{Number(property.livingArea).toLocaleString()} sqft</span>}
                                  {pricePerSqft && <span>${pricePerSqft.toFixed(0)}/sqft</span>}
                                </div>
                                <div className="flex flex-wrap gap-x-3 text-xs text-muted-foreground mt-1">
                                  {isSold && property.closeDate && <span>Closed: {new Date(property.closeDate).toLocaleDateString()}</span>}
                                  {!isSold && property.daysOnMarket !== null && property.daysOnMarket !== undefined && <span>{property.daysOnMarket} DOM</span>}
                                  {property.propertySubType && <span>{property.propertySubType}</span>}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })()}
                </CardContent>
              </Card>
            </div>
          </Tabs>
        </div>

        {/* Right Column: Property Map */}
            <div className="lg:sticky lg:top-4 lg:self-start">
              <Card>
                <CardHeader className="pb-3">
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <CardTitle className="flex items-center gap-2 text-base">
                      <MapIcon className="w-4 h-4" />
                      Property Locations
                    </CardTitle>
                    <div className="flex items-center gap-3 text-xs">
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-green-500"></div>
                        <span>Active</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-orange-500"></div>
                        <span>Pending</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-gray-500"></div>
                        <span>Closed</span>
                      </div>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  {(() => {
                    // Sync map with filter: use filtered properties based on activeListingTab and exclusions
                    const filteredForMap = (activeListingTab === 'all' ? allProperties :
                      activeListingTab === 'sold' ? soldProperties :
                      activeListingTab === 'under-contract' ? underContractProperties : activeProperties)
                      .filter(p => !excludedPropertyIds.has(p.id));
                    
                    const propertiesWithCoords = filteredForMap.filter(
                      p => p.latitude && p.longitude && 
                      typeof p.latitude === 'number' && typeof p.longitude === 'number' &&
                      !isNaN(p.latitude) && !isNaN(p.longitude)
                    );
                    
                    if (propertiesWithCoords.length === 0) {
                      return (
                        <div className="h-[400px] flex items-center justify-center bg-muted/10 rounded-lg border border-dashed">
                          <div className="text-center">
                            <MapIcon className="w-12 h-12 text-muted-foreground mx-auto mb-2" />
                            <p className="text-muted-foreground">No location data available</p>
                          </div>
                        </div>
                      );
                    }
                    
                    const positions: [number, number][] = propertiesWithCoords.map(
                      p => [Number(p.latitude), Number(p.longitude)]
                    );
                    const center: [number, number] = [
                      positions.reduce((sum, pos) => sum + pos[0], 0) / positions.length,
                      positions.reduce((sum, pos) => sum + pos[1], 0) / positions.length
                    ];
                    
                    return (
                      <div className="h-[400px] rounded-lg overflow-hidden border">
                        <MapContainer
                          key={activeListingTab}
                          center={center}
                          zoom={13}
                          style={{ height: '100%', width: '100%' }}
                          scrollWheelZoom={true}
                        >
                          <TileLayer
                            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                          />
                          <FitBounds positions={positions} />
                          {propertiesWithCoords.map((property) => {
                            const status = property.standardStatus || 'Active';
                            const isClosed = status === 'Closed';
                            const price = isClosed 
                              ? (property.closePrice ? Number(property.closePrice) : (property.listPrice ? Number(property.listPrice) : 0))
                              : (property.listPrice ? Number(property.listPrice) : 0);
                            
                            return (
                              <Marker
                                key={property.listingId}
                                position={[Number(property.latitude), Number(property.longitude)]}
                                icon={getPriceMarkerIcon(price, status)}
                              >
                                <Popup>
                                  <div className="min-w-[200px]">
                                    <p className="font-semibold text-sm">{property.unparsedAddress}</p>
                                    <p className="text-lg font-bold text-primary">${Number(price).toLocaleString()}</p>
                                    <Badge variant="outline" className="text-xs mt-1">
                                      {status}
                                    </Badge>
                                    <div className="flex flex-wrap gap-2 text-xs text-muted-foreground mt-2">
                                      <span>{property.bedroomsTotal || 0} beds</span>
                                      <span>{property.bathroomsTotalInteger || 0} baths</span>
                                      {property.livingArea && <span>{Number(property.livingArea).toLocaleString()} sqft</span>}
                                    </div>
                                  </div>
                                </Popup>
                              </Marker>
                            );
                          })}
                        </MapContainer>
                      </div>
                    );
                  })()}
                </CardContent>
              </Card>
            </div>
          </div>
          
          {/* Price Distribution - moved below Property Locations */}
          <Card>
            <CardHeader>
              <CardTitle>Price Distribution</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-[300px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={priceRangeData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <RechartsTooltip formatter={(value) => `$${Number(value).toLocaleString()}`} />
                    <Legend />
                    <Bar dataKey="value" fill="hsl(var(--primary))" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Timeline Tab */}
        <TabsContent value="timeline" className="space-y-6">
          {/* Market Insights - Texas Agent Metrics */}
          <Card className="bg-primary/5 border-primary/20">
            <CardHeader className="pb-2">
              <CardTitle className="text-base">Market Insights</CardTitle>
            </CardHeader>
            <CardContent>
              {(() => {
                // Filter out excluded properties for all calculations
                const includedSold = soldProperties.filter(p => !excludedPropertyIds.has(p.id));
                
                const soldPrices = includedSold
                  .map(p => p.closePrice ? Number(p.closePrice) : null)
                  .filter((p): p is number => p !== null && p > 0)
                  .sort((a, b) => a - b);
                
                const medianSoldPrice = soldPrices.length > 0 
                  ? soldPrices[Math.floor(soldPrices.length / 2)] 
                  : 0;
                
                const avgSoldPrice = soldPrices.length > 0
                  ? soldPrices.reduce((a, b) => a + b, 0) / soldPrices.length
                  : 0;
                
                const avgDOMSold = includedSold.length > 0
                  ? includedSold.reduce((sum, p) => sum + (p.daysOnMarket || 0), 0) / includedSold.length
                  : 0;
                
                const ratios = includedSold
                  .filter(p => p.listPrice && p.closePrice && Number(p.listPrice) > 0)
                  .map(p => (Number(p.closePrice) / Number(p.listPrice)) * 100);
                const avgListToSaleRatio = ratios.length > 0 
                  ? ratios.reduce((a, b) => a + b, 0) / ratios.length 
                  : 0;
                
                const now = new Date();
                const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                const twoYearsAgo = new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
                
                const currentYearSold = includedSold.filter(p => {
                  if (!p.closeDate) return false;
                  const closeDate = new Date(p.closeDate);
                  return closeDate >= oneYearAgo && closeDate <= now;
                });
                
                const priorYearSold = includedSold.filter(p => {
                  if (!p.closeDate) return false;
                  const closeDate = new Date(p.closeDate);
                  return closeDate >= twoYearsAgo && closeDate < oneYearAgo;
                });
                
                const currentYearPrices = currentYearSold
                  .map(p => p.closePrice ? Number(p.closePrice) : 0)
                  .filter(p => p > 0)
                  .sort((a, b) => a - b);
                
                const priorYearPrices = priorYearSold
                  .map(p => p.closePrice ? Number(p.closePrice) : 0)
                  .filter(p => p > 0)
                  .sort((a, b) => a - b);
                
                const currentYearAvg = currentYearPrices.length > 0
                  ? currentYearPrices.reduce((a, b) => a + b, 0) / currentYearPrices.length
                  : 0;
                const priorYearAvg = priorYearPrices.length > 0
                  ? priorYearPrices.reduce((a, b) => a + b, 0) / priorYearPrices.length
                  : 0;
                
                const currentYearMedian = currentYearPrices.length > 0
                  ? currentYearPrices[Math.floor(currentYearPrices.length / 2)]
                  : 0;
                const priorYearMedian = priorYearPrices.length > 0
                  ? priorYearPrices[Math.floor(priorYearPrices.length / 2)]
                  : 0;
                
                const yoyAvgChange = (priorYearAvg > 0 && currentYearAvg > 0)
                  ? ((currentYearAvg - priorYearAvg) / priorYearAvg) * 100
                  : null;
                
                const yoyMedianChange = (priorYearMedian > 0 && currentYearMedian > 0)
                  ? ((currentYearMedian - priorYearMedian) / priorYearMedian) * 100
                  : null;
                
                return (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="text-center p-3 bg-background rounded-lg border">
                        <div className="text-2xl font-bold text-primary">
                          {medianSoldPrice > 0 ? `$${medianSoldPrice.toLocaleString()}` : 'N/A'}
                        </div>
                        <div className="text-sm text-muted-foreground">Median Close Price</div>
                      </div>
                      <div className="text-center p-3 bg-background rounded-lg border">
                        <div className="text-2xl font-bold">
                          {avgDOMSold > 0 ? `${Math.round(avgDOMSold)} days` : 'N/A'}
                        </div>
                        <div className="text-sm text-muted-foreground">Avg Days on Market (Closed)</div>
                      </div>
                      <div className="text-center p-3 bg-background rounded-lg border">
                        <div className="text-2xl font-bold">
                          {avgListToSaleRatio > 0 ? `${avgListToSaleRatio.toFixed(1)}%` : 'N/A'}
                        </div>
                        <div className="text-sm text-muted-foreground">List-to-Sale Ratio</div>
                      </div>
                    </div>
                    
                    <div className="border-t pt-4">
                      <h4 className="text-sm font-semibold mb-3 text-muted-foreground">Year-over-Year (YoY) Comparison</h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex items-center justify-between p-3 bg-background rounded-lg border">
                          <div>
                            <div className="text-sm text-muted-foreground">YoY Avg Close Price</div>
                            <div className="text-xs text-muted-foreground/70">vs prior 12 months</div>
                          </div>
                          <div className={`text-xl font-bold flex items-center gap-1 ${
                            yoyAvgChange === null ? 'text-muted-foreground' :
                            yoyAvgChange >= 0 ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {yoyAvgChange === null ? (
                              'N/A'
                            ) : (
                              <>
                                {yoyAvgChange >= 0 ? '' : ''}
                                {Math.abs(yoyAvgChange).toFixed(1)}%
                              </>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center justify-between p-3 bg-background rounded-lg border">
                          <div>
                            <div className="text-sm text-muted-foreground">YoY Median Close Price</div>
                            <div className="text-xs text-muted-foreground/70">vs prior 12 months</div>
                          </div>
                          <div className={`text-xl font-bold flex items-center gap-1 ${
                            yoyMedianChange === null ? 'text-muted-foreground' :
                            yoyMedianChange >= 0 ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {yoyMedianChange === null ? (
                              'N/A'
                            ) : (
                              <>
                                {yoyMedianChange >= 0 ? '' : ''}
                                {Math.abs(yoyMedianChange).toFixed(1)}%
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </CardContent>
          </Card>

          {/* Price Timeline */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between flex-wrap gap-4">
                <CardTitle>Price Timeline</CardTitle>
                <div className="flex items-center gap-4 flex-wrap">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-green-500"></div>
                    <span className="text-sm">Active</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span className="text-sm">Active Under Contract</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                    <span className="text-sm">Closed</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-1 bg-blue-500"></div>
                    <span className="text-sm">Avg Price</span>
                  </div>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {(() => {
                // Filter timeline data based on exclusions and status filters
                const filteredTimelineData = timelineData.filter(d => {
                  // First filter by excluded property IDs
                  if (excludedPropertyIds.has(d.propertyId)) return false;
                  // Then filter by status toggles
                  if (d.status === 'Active' && !showActiveOnTimeline) return false;
                  if (d.status === 'Active Under Contract' && !showUnderContractOnTimeline) return false;
                  if (d.status === 'Closed' && !showSoldOnTimeline) return false;
                  return true;
                });
                
                // Calculate timeline statistics
                const prices = filteredTimelineData.map(d => d.price).filter(p => p > 0);
                const sortedPrices = [...prices].sort((a, b) => a - b);
                const timelineStats = {
                  count: prices.length,
                  min: sortedPrices.length > 0 ? sortedPrices[0] : 0,
                  max: sortedPrices.length > 0 ? sortedPrices[sortedPrices.length - 1] : 0,
                  avg: prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0,
                  median: sortedPrices.length > 0 ? sortedPrices[Math.floor(sortedPrices.length / 2)] : 0,
                };
                
                const getStatusColor = (status: string) => {
                  if (status === 'Active') return '#22c55e';
                  if (status === 'Active Under Contract') return '#eab308';
                  return '#ef4444';
                };
                
                return filteredTimelineData.length > 0 ? (
                <>
                <div className="h-[350px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <ScatterChart margin={{ top: 20, right: 30, bottom: 20, left: 20 }}>
                      <CartesianGrid strokeDasharray="3 3" className="stroke-muted/30" />
                      <XAxis 
                        type="number"
                        dataKey="dateNum"
                        domain={['dataMin', 'dataMax']}
                        tickFormatter={(value) => new Date(value).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        className="text-xs"
                        tick={{ fontSize: 11 }}
                        name="Date"
                      />
                      <YAxis 
                        type="number"
                        dataKey="price"
                        tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
                        className="text-xs"
                        tick={{ fontSize: 11 }}
                        domain={['auto', 'auto']}
                        name="Price"
                      />
                      <ZAxis range={[80, 80]} />
                      <RechartsTooltip 
                        content={({ active, payload }) => {
                          if (active && payload && payload.length > 0) {
                            const data = payload[0].payload;
                            const statusColor = data.status === 'Active' ? 'text-green-600' : 
                                               data.status === 'Active Under Contract' ? 'text-yellow-600' : 'text-red-600';
                            return (
                              <div className="bg-popover border rounded-lg shadow-lg p-3 text-sm">
                                <p className="font-semibold text-foreground mb-1">{data.address || 'Property'}</p>
                                <div className="space-y-1 text-muted-foreground">
                                  <p className="flex justify-between gap-4">
                                    <span>Status:</span>
                                    <span className={`font-medium ${statusColor}`}>{data.status}</span>
                                  </p>
                                  <p className="flex justify-between gap-4">
                                    <span>{data.status === 'Closed' ? 'Close Price:' : 'List Price:'}</span>
                                    <span className="font-medium text-foreground">${Number(data.price).toLocaleString()}</span>
                                  </p>
                                  <p className="flex justify-between gap-4">
                                    <span>{data.status === 'Closed' ? 'Close Date:' : 'List Date:'}</span>
                                    <span className="font-medium text-foreground">{new Date(data.date).toLocaleDateString()}</span>
                                  </p>
                                  {data.status === 'Closed' && data.daysOnMarket != null && (
                                    <p className="flex justify-between gap-4">
                                      <span>Days on Market:</span>
                                      <span className="font-medium text-foreground">{data.daysOnMarket} days</span>
                                    </p>
                                  )}
                                  {data.status === 'Active' && data.daysActive != null && (
                                    <p className="flex justify-between gap-4">
                                      <span>Days Active:</span>
                                      <span className="font-medium text-foreground">{data.daysActive} days</span>
                                    </p>
                                  )}
                                </div>
                              </div>
                            );
                          }
                          return null;
                        }}
                      />
                      <ReferenceLine 
                        y={timelineStats.avg} 
                        stroke="#3b82f6" 
                        strokeWidth={2}
                        label={{ value: 'Avg', position: 'right', fontSize: 11, fill: '#3b82f6' }}
                      />
                      <ReferenceLine 
                        y={timelineStats.median} 
                        stroke="#a855f7" 
                        strokeWidth={2}
                        label={{ value: 'Median', position: 'left', fontSize: 11, fill: '#a855f7' }}
                      />
                      <Scatter 
                        name="Properties"
                        data={filteredTimelineData.map(d => ({
                          ...d,
                          dateNum: new Date(d.date).getTime(),
                        }))}
                        shape={(props: any) => {
                          const { cx, cy, payload } = props;
                          const color = getStatusColor(payload.status);
                          return (
                            <circle 
                              cx={cx} 
                              cy={cy} 
                              r={8} 
                              fill={color} 
                              stroke="white" 
                              strokeWidth={2}
                              style={{ cursor: 'pointer' }}
                            />
                          );
                        }}
                      />
                    </ScatterChart>
                  </ResponsiveContainer>
                </div>
                
                {/* Statistics Summary Table */}
                <div className="mt-4 border rounded-lg overflow-hidden">
                  <Table>
                    <TableHeader>
                      <TableRow className="bg-muted/50">
                        <TableHead className="font-semibold">Metric</TableHead>
                        <TableHead className="text-right">Range</TableHead>
                        <TableHead className="text-right">Average</TableHead>
                        <TableHead className="text-right">Median</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      <TableRow>
                        <TableCell className="font-medium">Price</TableCell>
                        <TableCell className="text-right">
                          ${timelineStats.min.toLocaleString()} - ${timelineStats.max.toLocaleString()}
                        </TableCell>
                        <TableCell className="text-right font-semibold text-blue-600">
                          ${Math.round(timelineStats.avg).toLocaleString()}
                        </TableCell>
                        <TableCell className="text-right font-semibold text-purple-500">
                          ${Math.round(timelineStats.median).toLocaleString()}
                        </TableCell>
                      </TableRow>
                    </TableBody>
                  </Table>
                </div>
                </>
                ) : (
                <div className="h-[350px] flex items-center justify-center">
                  <div className="text-center text-muted-foreground">
                    <p className="text-lg font-medium mb-2">No timeline data available</p>
                    <p className="text-sm">Timeline data requires properties with listing or closing dates.</p>
                  </div>
                </div>
              );
              })()}
              
            </CardContent>
          </Card>
        </TabsContent>

        {/* Market Stats Tab */}
        <TabsContent value="market-stats" className="space-y-6">
          {/* Key Metrics Row - Prioritized: Avg Price, Median Price, Price/SqFt, Avg DOM */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Avg Price</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">${Math.round(filteredStatistics.price.average).toLocaleString()}</div>
                <p className="text-xs text-muted-foreground">Across all {includedAll.length} comparables</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Median Price</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">${Math.round(filteredStatistics.price.median).toLocaleString()}</div>
                <p className="text-xs text-muted-foreground">50th percentile</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Price/SqFt</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">${filteredStatistics.pricePerSqFt.average.toFixed(2)}</div>
                <p className="text-xs text-muted-foreground">Per square foot</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Avg DOM</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{Math.round(filteredStatistics.daysOnMarket.average)}</div>
                <p className="text-xs text-muted-foreground">Days on market</p>
              </CardContent>
            </Card>
          </div>

          {/* Secondary Metrics - Property Features (moved above CMA Market Review per QA request) */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Price Range</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-lg font-bold">${(filteredStatistics.price.range.min / 1000).toFixed(0)}K - ${(filteredStatistics.price.range.max / 1000).toFixed(0)}K</div>
                <p className="text-xs text-muted-foreground">Min to max</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Avg SqFt</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{Math.round(filteredStatistics.livingArea.average).toLocaleString()}</div>
                <p className="text-xs text-muted-foreground">Living area</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Avg Beds</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{filteredStatistics.bedrooms.average.toFixed(1)}</div>
                <p className="text-xs text-muted-foreground">Bedrooms</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 gap-1">
                <CardTitle className="text-sm font-medium">Avg Baths</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{filteredStatistics.bathrooms.average.toFixed(1)}</div>
                <p className="text-xs text-muted-foreground">Bathrooms</p>
              </CardContent>
            </Card>
          </div>

          {/* CMA Market Review Summary */}
          <Card className="border-primary/30 bg-primary/5">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <FileText className="w-5 h-5" />
                CMA Market Review
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <h4 className="font-semibold text-sm">Market Overview</h4>
                  <p className="text-sm text-muted-foreground">
                    Based on {includedAll.length} comparable properties, the average price is{' '}
                    <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.average).toLocaleString()}</span>{' '}
                    with a median of{' '}
                    <span className="font-semibold text-foreground">${Math.round(filteredStatistics.price.median).toLocaleString()}</span>.
                    {' '}Prices range from ${filteredStatistics.price.range.min.toLocaleString()} to ${filteredStatistics.price.range.max.toLocaleString()}.
                  </p>
                </div>
                <div className="space-y-2">
                  <h4 className="font-semibold text-sm">Price Per Square Foot</h4>
                  <p className="text-sm text-muted-foreground">
                    Average price per square foot is{' '}
                    <span className="font-semibold text-foreground">${filteredStatistics.pricePerSqFt.average.toFixed(2)}</span>{' '}
                    across comparable properties. This ranges from ${filteredStatistics.pricePerSqFt.range.min.toFixed(2)} to ${filteredStatistics.pricePerSqFt.range.max.toFixed(2)}/sqft.
                  </p>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Days on Market</h4>
                  <p className="text-sm text-muted-foreground">
                    Average: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.daysOnMarket.average)} days</span>
                  </p>
                </div>
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Property Size</h4>
                  <p className="text-sm text-muted-foreground">
                    Avg: <span className="font-semibold text-foreground">{Math.round(filteredStatistics.livingArea.average).toLocaleString()} sqft</span>
                  </p>
                </div>
                <div className="space-y-1">
                  <h4 className="font-semibold text-sm">Bed/Bath</h4>
                  <p className="text-sm text-muted-foreground">
                    Avg: <span className="font-semibold text-foreground">{filteredStatistics.bedrooms.average.toFixed(1)} beds / {filteredStatistics.bathrooms.average.toFixed(1)} baths</span>
                  </p>
                </div>
              </div>
              <div className="pt-2 border-t">
                <p className="text-xs text-muted-foreground italic">
                  This analysis is based on {includedActive.length} Active, {includedUnderContract.length} Active Under Contract, and {includedSold.length} Closed properties in your selection.
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Time to Sell Analysis - CloudCMA style */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <Calendar className="w-5 h-5" />
                Time to Sell Analysis
              </CardTitle>
            </CardHeader>
            <CardContent>
              {(() => {
                // Filter out excluded properties from Time to Sell analysis
                const closedWithData = soldProperties.filter(p => 
                  !excludedPropertyIds.has(p.id) &&
                  p.closePrice && p.listPrice && p.daysOnMarket !== null && p.daysOnMarket !== undefined
                );
                
                if (closedWithData.length === 0) {
                  return (
                    <div className="text-center py-6 text-muted-foreground">
                      <Calendar className="w-10 h-10 mx-auto mb-2 opacity-50" />
                      <p>No closed sales data available for Time to Sell analysis</p>
                    </div>
                  );
                }
                
                const avgDOM = closedWithData.reduce((sum, p) => sum + (p.daysOnMarket || 0), 0) / closedWithData.length;
                const medianDOM = (() => {
                  const sorted = closedWithData.map(p => p.daysOnMarket || 0).sort((a, b) => a - b);
                  return sorted.length % 2 === 0
                    ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
                    : sorted[Math.floor(sorted.length / 2)];
                })();
                
                const listToSaleRatios = closedWithData.map(p => {
                  const closePrice = Number(p.closePrice);
                  const listPrice = Number(p.listPrice);
                  return listPrice > 0 ? (closePrice / listPrice) * 100 : 0;
                }).filter(r => r > 0);
                
                const avgListToSaleRatio = listToSaleRatios.length > 0 
                  ? listToSaleRatios.reduce((a, b) => a + b, 0) / listToSaleRatios.length 
                  : 0;
                const minRatio = listToSaleRatios.length > 0 ? Math.min(...listToSaleRatios) : 0;
                const maxRatio = listToSaleRatios.length > 0 ? Math.max(...listToSaleRatios) : 0;
                
                return (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div className="text-center p-4 bg-muted/30 rounded-lg">
                      <div className="text-3xl font-bold">{Math.round(avgDOM)}</div>
                      <div className="text-sm text-muted-foreground">Avg Days on Market</div>
                    </div>
                    <div className="text-center p-4 bg-muted/30 rounded-lg">
                      <div className="text-3xl font-bold">{Math.round(medianDOM)}</div>
                      <div className="text-sm text-muted-foreground">Median Days on Market</div>
                    </div>
                    <div className="text-center p-4 bg-muted/30 rounded-lg">
                      <div className={cn(
                        "text-3xl font-bold",
                        avgListToSaleRatio >= 100 ? "text-green-600" : "text-red-600"
                      )}>
                        {avgListToSaleRatio.toFixed(1)}%
                      </div>
                      <div className="text-sm text-muted-foreground">Avg List-to-Sale Ratio</div>
                    </div>
                    <div className="text-center p-4 bg-muted/30 rounded-lg">
                      <div className="text-lg font-bold">
                        {minRatio.toFixed(1)}% - {maxRatio.toFixed(1)}%
                      </div>
                      <div className="text-sm text-muted-foreground">Ratio Range</div>
                    </div>
                  </div>
                );
              })()}
            </CardContent>
          </Card>

          {/* Side-by-Side: Inventory Dial + Property Map */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Left: Market Health Indicator - Inventory Dial */}
            <div>
              {(() => {
                // Filter out excluded properties for inventory calculations
                const includedActive = activeProperties.filter(p => !excludedPropertyIds.has(p.id));
                const includedSold = soldProperties.filter(p => !excludedPropertyIds.has(p.id));
                
                const activeCount = includedActive.length;
                const soldCount = includedSold.length;
                const avgSoldPerMonth = soldCount > 0 ? soldCount / 6 : 0;
                const monthsOfInventory = avgSoldPerMonth > 0 ? activeCount / avgSoldPerMonth : 0;
                const absorptionRate = avgSoldPerMonth;
                
                let marketCondition = 'Balanced';
                let marketColor = 'text-blue-600';
                let gaugePosition = 50;
                
                if (monthsOfInventory < 4) {
                  marketCondition = "Seller's Market";
                  marketColor = 'text-red-600';
                  gaugePosition = Math.max(10, 25 - (4 - monthsOfInventory) * 6);
                } else if (monthsOfInventory > 6) {
                  marketCondition = "Buyer's Market";
                  marketColor = 'text-green-600';
                  gaugePosition = Math.min(90, 75 + (monthsOfInventory - 6) * 3);
                } else {
                  gaugePosition = 25 + ((monthsOfInventory - 4) / 2) * 50;
                }
                
                return (
                  <Card className="border-2 border-primary/20 h-full">
                    <CardHeader className="pb-2">
                      <CardTitle className="text-lg">Market Health Indicator</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="space-y-4">
                        <div className="min-w-[200px]">
                          <div className="relative h-4 bg-gradient-to-r from-red-500 via-blue-500 to-green-500 rounded-full overflow-hidden">
                            <div 
                              className="absolute top-1/2 -translate-y-1/2 w-4 h-6 bg-foreground rounded-sm border-2 border-background shadow-lg transition-all duration-500"
                              style={{ left: `calc(${gaugePosition}% - 8px)` }}
                            />
                          </div>
                          <div className="flex justify-between text-xs text-muted-foreground mt-2">
                            <span>Seller's Market</span>
                            <span>Balanced</span>
                            <span>Buyer's Market</span>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3 text-center">
                          <div className="p-3 bg-muted/30 rounded-lg">
                            <div className={`text-xl font-bold ${marketColor}`}>
                              {monthsOfInventory > 0 ? monthsOfInventory.toFixed(1) : 'N/A'}
                            </div>
                            <div className="text-xs text-muted-foreground">Months Inventory</div>
                          </div>
                          <div className="p-3 bg-muted/30 rounded-lg">
                            <div className="text-xl font-bold text-primary">
                              {absorptionRate > 0 ? absorptionRate.toFixed(1) : 'N/A'}
                            </div>
                            <div className="text-xs text-muted-foreground">Sales/Month</div>
                          </div>
                          <div className="p-3 bg-muted/30 rounded-lg">
                            <div className={`text-lg font-bold ${marketColor}`}>
                              {marketCondition}
                            </div>
                            <div className="text-xs text-muted-foreground">Market Type</div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-3 bg-primary/5 rounded-lg border border-primary/10">
                        <p className="text-sm text-muted-foreground">
                          <span className="font-semibold text-foreground">Analysis:</span>{' '}
                          {monthsOfInventory < 4 ? (
                            <>Low inventory ({monthsOfInventory.toFixed(1)} mo) favors sellers.</>
                          ) : monthsOfInventory > 6 ? (
                            <>High inventory ({monthsOfInventory.toFixed(1)} mo) favors buyers.</>
                          ) : (
                            <>Balanced market ({monthsOfInventory.toFixed(1)} mo).</>
                          )}
                        </p>
                      </div>
                    </CardContent>
                  </Card>
                );
              })()}
            </div>

            {/* Right: Property Map */}
            <div>
              <Card className="h-full">
                <CardHeader className="pb-3">
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <CardTitle className="flex items-center gap-2 text-base">
                      <MapIcon className="w-4 h-4" />
                      Property Locations
                    </CardTitle>
                    <div className="flex items-center gap-3 text-xs">
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-green-500"></div>
                        <span>Active</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-orange-500"></div>
                        <span>Pending</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-lg"></span>
                        <div className="w-2 h-2 rounded-sm bg-gray-500"></div>
                        <span>Closed</span>
                      </div>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  {(() => {
                    // Filter out excluded properties
                    const propertiesWithCoords = allProperties
                      .filter(p => !excludedPropertyIds.has(p.id))
                      .filter(
                        p => p.latitude && p.longitude && 
                        typeof p.latitude === 'number' && typeof p.longitude === 'number' &&
                        !isNaN(p.latitude) && !isNaN(p.longitude)
                      );
                    
                    if (propertiesWithCoords.length === 0) {
                      return (
                        <div className="h-[300px] flex items-center justify-center bg-muted/10 rounded-lg border border-dashed">
                          <div className="text-center">
                            <MapIcon className="w-12 h-12 text-muted-foreground mx-auto mb-2" />
                            <p className="text-muted-foreground">No location data available</p>
                          </div>
                        </div>
                      );
                    }
                    
                    const bounds = propertiesWithCoords.map(p => [Number(p.latitude), Number(p.longitude)] as [number, number]);
                    const centerLat = bounds.reduce((sum, [lat]) => sum + lat, 0) / bounds.length;
                    const centerLng = bounds.reduce((sum, [, lng]) => sum + lng, 0) / bounds.length;
                    
                    return (
                      <div className="h-[300px] rounded-lg overflow-hidden border">
                        <MapContainer
                          center={[centerLat, centerLng]}
                          zoom={12}
                          style={{ height: '100%', width: '100%' }}
                          scrollWheelZoom={false}
                        >
                          <TileLayer
                            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                          />
                          {propertiesWithCoords.map((property) => {
                            const status = property.standardStatus || 'Active';
                            const isClosed = status === 'Closed';
                            const price = isClosed 
                              ? (property.closePrice ? Number(property.closePrice) : (property.listPrice ? Number(property.listPrice) : 0))
                              : (property.listPrice ? Number(property.listPrice) : 0);
                            
                            return (
                              <Marker
                                key={property.listingId}
                                position={[Number(property.latitude), Number(property.longitude)]}
                                icon={getPriceMarkerIcon(price, status)}
                              >
                                <Popup>
                                  <div className="min-w-[180px]">
                                    <p className="font-semibold text-sm">{property.unparsedAddress}</p>
                                    <p className="text-lg font-bold text-primary">${Number(price).toLocaleString()}</p>
                                    <Badge variant="outline" className="text-xs mt-1">
                                      {status}
                                    </Badge>
                                  </div>
                                </Popup>
                              </Marker>
                            );
                          })}
                        </MapContainer>
                      </div>
                    );
                  })()}
                </CardContent>
              </Card>
            </div>
          </div>

          {/* Price Trend Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Calendar className="w-5 h-5" />
                Price Trend Analysis
              </CardTitle>
            </CardHeader>
            <CardContent>
              {(() => {
                // Group sold properties by month for trend analysis (respecting exclusions)
                const soldByMonth: { [key: string]: { prices: number[]; count: number } } = {};
                
                includedSold.forEach(p => {
                  const closeDate = p.closeDate ? new Date(p.closeDate) : null;
                  const price = p.closePrice ? Number(p.closePrice) : 0;
                  
                  if (closeDate && price > 0) {
                    const monthKey = `${closeDate.getFullYear()}-${String(closeDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!soldByMonth[monthKey]) {
                      soldByMonth[monthKey] = { prices: [], count: 0 };
                    }
                    soldByMonth[monthKey].prices.push(price);
                    soldByMonth[monthKey].count++;
                  }
                });
                
                const trendData = Object.entries(soldByMonth)
                  .map(([month, data]) => ({
                    month,
                    monthLabel: new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                    avgPrice: data.prices.reduce((a, b) => a + b, 0) / data.prices.length,
                    count: data.count,
                    minPrice: Math.min(...data.prices),
                    maxPrice: Math.max(...data.prices),
                  }))
                  .sort((a, b) => a.month.localeCompare(b.month));
                
                if (trendData.length < 2) {
                  return (
                    <div className="h-[250px] flex items-center justify-center bg-muted/10 rounded-lg border border-dashed">
                      <div className="text-center text-muted-foreground">
                        <Calendar className="w-10 h-10 mx-auto mb-2 opacity-50" />
                        <p>Not enough sold data for trend analysis</p>
                        <p className="text-xs">Requires at least 2 months of sales data</p>
                      </div>
                    </div>
                  );
                }
                
                // Calculate YoY change if we have data
                const firstMonth = trendData[0];
                const lastMonth = trendData[trendData.length - 1];
                const priceChange = ((lastMonth.avgPrice - firstMonth.avgPrice) / firstMonth.avgPrice) * 100;
                
                return (
                  <>
                    <div className="h-[250px]">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={trendData}>
                          <CartesianGrid strokeDasharray="3 3" className="stroke-muted/30" />
                          <XAxis 
                            dataKey="monthLabel" 
                            tick={{ fontSize: 11 }}
                          />
                          <YAxis 
                            tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
                            tick={{ fontSize: 11 }}
                            domain={['auto', 'auto']}
                          />
                          <RechartsTooltip 
                            content={({ active, payload }) => {
                              if (active && payload && payload.length > 0) {
                                const data = payload[0].payload;
                                return (
                                  <div className="bg-popover border rounded-lg shadow-lg p-3 text-sm">
                                    <p className="font-semibold">{data.monthLabel}</p>
                                    <p className="text-primary">Avg: ${Math.round(data.avgPrice).toLocaleString()}</p>
                                    <p className="text-muted-foreground text-xs">{data.count} sales</p>
                                  </div>
                                );
                              }
                              return null;
                            }}
                          />
                          <Line 
                            type="monotone" 
                            dataKey="avgPrice" 
                            stroke="hsl(var(--primary))" 
                            strokeWidth={2}
                            dot={{ fill: 'hsl(var(--primary))', strokeWidth: 2, r: 4 }}
                          />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                    
                    <div className="flex items-center justify-between mt-4 p-3 bg-muted/30 rounded-lg">
                      <div className="text-sm">
                        <span className="text-muted-foreground">Period:</span>{' '}
                        <span className="font-medium">{firstMonth.monthLabel}  {lastMonth.monthLabel}</span>
                      </div>
                      <div className={`text-lg font-bold ${priceChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {priceChange >= 0 ? '+' : ''}{priceChange.toFixed(1)}%
                        <span className="text-xs text-muted-foreground ml-1">price change</span>
                      </div>
                    </div>
                  </>
                );
              })()}
            </CardContent>
          </Card>

          {/* Status Breakdown with Property Details - Sorted by count descending */}
          {(() => {
            const statusSections = [
              {
                key: 'active',
                label: 'Active Listings',
                properties: includedActive,
                borderClass: 'border-green-200 dark:border-green-800',
                bgClass: 'bg-green-50 dark:bg-green-950/30',
                dotClass: 'bg-green-500',
                titleClass: 'text-green-700 dark:text-green-400',
                emptyText: 'No active listings in this CMA',
                isSold: false
              },
              {
                key: 'under-contract',
                label: 'Active Under Contract',
                properties: includedUnderContract,
                borderClass: 'border-yellow-200 dark:border-yellow-800',
                bgClass: 'bg-yellow-50 dark:bg-yellow-950/30',
                dotClass: 'bg-yellow-500',
                titleClass: 'text-yellow-700 dark:text-yellow-400',
                emptyText: 'No active under contract listings in this CMA',
                isSold: false
              },
              {
                key: 'sold',
                label: 'Closed',
                properties: includedSold,
                borderClass: 'border-red-200 dark:border-red-800',
                bgClass: 'bg-red-50 dark:bg-red-950/30',
                dotClass: 'bg-red-500',
                titleClass: 'text-red-700 dark:text-red-400',
                emptyText: 'No closed listings in this CMA',
                isSold: true
              }
            ];
            
            const sortedSections = [...statusSections].sort((a, b) => b.properties.length - a.properties.length);
            
            return sortedSections.map((section) => (
              <Card key={section.key} className={section.borderClass}>
                <CardHeader className={`${section.bgClass} rounded-t-lg`}>
                  <div className="flex items-center gap-3">
                    <div className={`w-4 h-4 rounded-full ${section.dotClass}`}></div>
                    <CardTitle className={`text-base ${section.titleClass}`}>
                      {section.label} ({section.properties.length})
                    </CardTitle>
                  </div>
                </CardHeader>
                <CardContent className="pt-4">
                  {section.properties.length > 0 ? (
                    <div className="space-y-3">
                      {section.properties.map((property) => {
                        const photos = (property as any).photos as string[] | undefined;
                        const media = (property as any).media as any[] | undefined;
                        const primaryPhoto = photos?.[0] || media?.[0]?.mediaURL || media?.[0]?.mediaUrl;
                        const price = section.isSold 
                          ? (property.closePrice ? Number(property.closePrice) : (property.listPrice ? Number(property.listPrice) : 0))
                          : (property.listPrice ? Number(property.listPrice) : 0);
                        const pricePerSqft = property.livingArea ? price / Number(property.livingArea) : null;
                        return (
                          <div 
                            key={property.id} 
                            className="flex gap-3 p-2 rounded-md border bg-card cursor-pointer hover-elevate transition-colors"
                            onClick={() => handlePropertyClick(property)}
                            onKeyDown={(e) => e.key === 'Enter' && handlePropertyClick(property)}
                            tabIndex={0}
                            role="button"
                            data-testid={`card-property-${property.id}`}
                          >
                            {primaryPhoto ? (
                              <img src={primaryPhoto} alt={property.unparsedAddress || ''} className="w-20 h-20 object-cover rounded-md flex-shrink-0" />
                            ) : (
                              <div className="w-20 h-20 bg-muted rounded-md flex flex-col items-center justify-center flex-shrink-0 p-1">
                                <Home className="w-5 h-5 text-muted-foreground/50 mb-0.5" />
                                <span className="text-[8px] text-muted-foreground text-center leading-tight">No photos available</span>
                              </div>
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-sm truncate">{property.unparsedAddress}</p>
                              <p className="text-lg font-bold text-primary">${price.toLocaleString()}</p>
                              <div className="flex flex-wrap gap-x-3 text-xs text-muted-foreground">
                                <span>{property.bedroomsTotal || 0} beds</span>
                                <span>{property.bathroomsTotalInteger || 0} baths</span>
                                {property.livingArea && <span>{Number(property.livingArea).toLocaleString()} sqft</span>}
                                {pricePerSqft && <span>${pricePerSqft.toFixed(0)}/sqft</span>}
                                {section.isSold && property.closeDate && <span>Closed: {new Date(property.closeDate).toLocaleDateString()}</span>}
                                {!section.isSold && property.daysOnMarket && <span>{property.daysOnMarket} DOM</span>}
                              </div>
                              <p className="text-xs text-muted-foreground">{property.propertySubType || property.propertyType}</p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p className="text-sm text-muted-foreground text-center py-4">{section.emptyText}</p>
                  )}
                </CardContent>
              </Card>
            ));
          })()}
        </TabsContent>
      </Tabs>
      
      {/* Floating Property Card Modal (Centered) */}
      <Dialog open={floatingCardOpen} onOpenChange={setFloatingCardOpen}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          {floatingCardProperty && (
            <>
              <DialogHeader className="sr-only">
                <DialogTitle>Property Details</DialogTitle>
                <DialogDescription>View detailed information about this property including photos, price, and specifications.</DialogDescription>
              </DialogHeader>
              
              {/* Image Carousel */}
              <div className="relative aspect-[16/9] bg-muted rounded-lg overflow-hidden mb-4 -mx-6 -mt-6">
                {(() => {
                  const photos = getPropertyPhotos(floatingCardProperty);
                  return photos.length > 0 ? (
                    <>
                      <img 
                        src={photos[carouselIndex]} 
                        alt={floatingCardProperty.unparsedAddress || 'Property'} 
                        className="w-full h-full object-cover"
                        data-testid="img-floating-card-property"
                      />
                      {/* Carousel Controls - Click zones for navigation (full height, invisible background) */}
                      {photos.length > 1 && (
                        <>
                          {/* Left click zone - covers left half */}
                          <div 
                            className="absolute left-0 top-0 w-1/2 h-full cursor-pointer z-10 group"
                            onClick={(e) => { e.stopPropagation(); handlePrevImage(); }}
                            data-testid="zone-carousel-prev"
                          >
                            <div className="absolute left-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all opacity-70 group-hover:opacity-100">
                              <ChevronLeft className="w-5 h-5" />
                            </div>
                          </div>
                          {/* Right click zone - covers right half */}
                          <div 
                            className="absolute right-0 top-0 w-1/2 h-full cursor-pointer z-10 group"
                            onClick={(e) => { e.stopPropagation(); handleNextImage(); }}
                            data-testid="zone-carousel-next"
                          >
                            <div className="absolute right-3 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all opacity-70 group-hover:opacity-100">
                              <ChevronRight className="w-5 h-5" />
                            </div>
                          </div>
                        </>
                      )}
                      {/* Photo Count - centered at bottom */}
                      <div className="absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-3 py-1 rounded-full">
                        {carouselIndex + 1} / {photos.length}
                      </div>
                    </>
                  ) : (
                    <div className="w-full h-full flex flex-col items-center justify-center text-muted-foreground">
                      <Home className="w-12 h-12 opacity-50 mb-2" />
                      <span className="text-sm">No photos available for this property</span>
                    </div>
                  );
                })()}
                {/* Status Badge */}
                {floatingCardProperty.standardStatus && (
                  <div className="absolute top-2 left-2 z-20">
                    <Badge 
                      className={cn(
                        floatingCardProperty.standardStatus === 'Active' && "bg-emerald-500 text-white",
                        floatingCardProperty.standardStatus === 'Active Under Contract' && "bg-amber-500 text-white",
                        floatingCardProperty.standardStatus === 'Closed' && "bg-slate-500 text-white"
                      )}
                    >
                      {floatingCardProperty.standardStatus}
                    </Badge>
                  </div>
                )}
              </div>

              {/* Price */}
              <div className="mb-4">
                <p className="text-2xl font-bold text-primary" data-testid="text-floating-price">
                  {floatingCardProperty.standardStatus === 'Closed' && floatingCardProperty.closePrice
                    ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(floatingCardProperty.closePrice))
                    : floatingCardProperty.listPrice 
                      ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(floatingCardProperty.listPrice))
                      : 'Price upon request'}
                </p>
                {floatingCardProperty.listPrice && floatingCardProperty.livingArea && (
                  <p className="text-sm text-muted-foreground">
                    ${(Number(floatingCardProperty.standardStatus === 'Closed' && floatingCardProperty.closePrice ? floatingCardProperty.closePrice : floatingCardProperty.listPrice) / Number(floatingCardProperty.livingArea)).toFixed(0)}/sqft
                  </p>
                )}
              </div>

              {/* Address */}
              <div className="flex items-start gap-2 mb-4">
                <MapPin className="w-4 h-4 mt-0.5 text-muted-foreground shrink-0" />
                <div>
                  <p className="font-medium" data-testid="text-floating-address">
                    {floatingCardProperty.unparsedAddress || 'Address not available'}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    {[
                      floatingCardProperty.city,
                      floatingCardProperty.stateOrProvince,
                      floatingCardProperty.postalCode
                    ].filter(Boolean).join(', ')}
                  </p>
                </div>
              </div>

              <Separator className="my-4" />

              {/* Key Stats */}
              <div className="grid grid-cols-3 gap-4 mb-4">
                {floatingCardProperty.bedroomsTotal !== null && (
                  <div className="text-center">
                    <div className="flex items-center justify-center gap-1 text-muted-foreground mb-1">
                      <Bed className="w-4 h-4" />
                    </div>
                    <p className="font-semibold" data-testid="text-floating-beds">{floatingCardProperty.bedroomsTotal}</p>
                    <p className="text-xs text-muted-foreground">Beds</p>
                  </div>
                )}
                {floatingCardProperty.bathroomsTotalInteger !== null && (
                  <div className="text-center">
                    <div className="flex items-center justify-center gap-1 text-muted-foreground mb-1">
                      <Bath className="w-4 h-4" />
                    </div>
                    <p className="font-semibold" data-testid="text-floating-baths">{floatingCardProperty.bathroomsTotalInteger}</p>
                    <p className="text-xs text-muted-foreground">Baths</p>
                  </div>
                )}
                {floatingCardProperty.livingArea && (
                  <div className="text-center">
                    <div className="flex items-center justify-center gap-1 text-muted-foreground mb-1">
                      <Maximize className="w-4 h-4" />
                    </div>
                    <p className="font-semibold" data-testid="text-floating-sqft">{Number(floatingCardProperty.livingArea).toLocaleString()}</p>
                    <p className="text-xs text-muted-foreground">Sq Ft</p>
                  </div>
                )}
              </div>

              {/* Additional Details */}
              <div className="space-y-2 text-sm">
                {(floatingCardProperty.propertySubType || floatingCardProperty.propertyType) && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Property Type</span>
                    <span className="font-medium">{floatingCardProperty.propertySubType || floatingCardProperty.propertyType}</span>
                  </div>
                )}
                {floatingCardProperty.yearBuilt && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Year Built</span>
                    <span className="font-medium">{floatingCardProperty.yearBuilt}</span>
                  </div>
                )}
                {/* Subdivision (tract/community label from listing) */}
                {/* Note: Neighborhood is only available via boundary resolution on Property Detail page */}
                {(floatingCardProperty.subdivision || (floatingCardProperty as any).subdivisionName) && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Subdivision</span>
                    <span className="font-medium">{floatingCardProperty.subdivision || (floatingCardProperty as any).subdivisionName}</span>
                  </div>
                )}
                {floatingCardProperty.schoolDistrict && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">School District</span>
                    <span className="font-medium">{floatingCardProperty.schoolDistrict}</span>
                  </div>
                )}
                {floatingCardProperty.elementarySchool && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Elementary</span>
                    <span className="font-medium">{floatingCardProperty.elementarySchool}</span>
                  </div>
                )}
                {floatingCardProperty.middleOrJuniorSchool && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Middle School</span>
                    <span className="font-medium">{floatingCardProperty.middleOrJuniorSchool}</span>
                  </div>
                )}
                {floatingCardProperty.highSchool && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">High School</span>
                    <span className="font-medium">{floatingCardProperty.highSchool}</span>
                  </div>
                )}
                {floatingCardProperty.daysOnMarket !== null && floatingCardProperty.daysOnMarket !== undefined && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Days on Market</span>
                    <span className="font-medium">{floatingCardProperty.daysOnMarket}</span>
                  </div>
                )}
                {floatingCardProperty.standardStatus === 'Closed' && floatingCardProperty.closeDate && (
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Close Date</span>
                    <span className="font-medium">{new Date(floatingCardProperty.closeDate).toLocaleDateString()}</span>
                  </div>
                )}
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}


================================================================================
FILE: CMAs.tsx
COPY TO: client/src/pages/CMAs.tsx
================================================================================\n
import { useState, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { FileText, Plus, Calendar, ArrowUpDown } from "lucide-react";
import { Link } from "wouter";
import type { Cma } from "@shared/schema";

type SortOption = 'newest' | 'oldest' | 'az' | 'za';

export default function CMAs() {
  const [sortOption, setSortOption] = useState<SortOption>('newest');
  
  const { data: cmas = [], isLoading } = useQuery<Cma[]>({
    queryKey: ['/api/cmas'],
  });

  // Sort CMAs based on selected option
  const sortedCmas = useMemo(() => {
    const sorted = [...cmas];
    
    switch (sortOption) {
      case 'newest':
        return sorted.sort((a, b) => {
          const dateA = new Date(a.updatedAt || a.createdAt).getTime();
          const dateB = new Date(b.updatedAt || b.createdAt).getTime();
          return dateB - dateA; // Newest first
        });
      case 'oldest':
        return sorted.sort((a, b) => {
          const dateA = new Date(a.updatedAt || a.createdAt).getTime();
          const dateB = new Date(b.updatedAt || b.createdAt).getTime();
          return dateA - dateB; // Oldest first
        });
      case 'az':
        return sorted.sort((a, b) => a.name.localeCompare(b.name));
      case 'za':
        return sorted.sort((a, b) => b.name.localeCompare(a.name));
      default:
        return sorted;
    }
  }, [cmas, sortOption]);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-3xl font-bold mb-2" data-testid="text-cmas-title">CMAs</h1>
          <p className="text-muted-foreground">
            {cmas.length > 0 
              ? `${cmas.length} Comparative Market Analyses`
              : 'Comparative Market Analyses'
            }
          </p>
        </div>
        <div className="flex items-center gap-3">
          {cmas.length > 0 && (
            <div className="flex items-center gap-2">
              <ArrowUpDown className="w-4 h-4 text-muted-foreground" />
              <Select value={sortOption} onValueChange={(val) => setSortOption(val as SortOption)}>
                <SelectTrigger className="w-[180px]" data-testid="select-cma-sort">
                  <SelectValue placeholder="Sort by..." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="newest" data-testid="sort-newest">Newest to Oldest</SelectItem>
                  <SelectItem value="oldest" data-testid="sort-oldest">Oldest to Newest</SelectItem>
                  <SelectItem value="az" data-testid="sort-az">Name A-Z</SelectItem>
                  <SelectItem value="za" data-testid="sort-za">Name Z-A</SelectItem>
                </SelectContent>
              </Select>
            </div>
          )}
          <Link href="/cmas/new">
            <Button data-testid="button-create-new-cma">
              <Plus className="w-4 h-4 mr-2" />
              Create New CMA
            </Button>
          </Link>
        </div>
      </div>

      {isLoading ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {[1, 2, 3].map((i) => (
            <Card key={i}>
              <CardHeader>
                <Skeleton className="h-6 w-3/4" />
              </CardHeader>
              <CardContent className="space-y-2">
                <Skeleton className="h-4 w-full" />
                <Skeleton className="h-4 w-2/3" />
              </CardContent>
            </Card>
          ))}
        </div>
      ) : sortedCmas.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {sortedCmas.map((cma) => (
            <Link key={cma.id} href={`/cmas/${cma.id}`}>
              <Card className="hover-elevate active-elevate-2 cursor-pointer" data-testid={`card-cma-${cma.id}`}>
                <CardHeader>
                  <CardTitle className="flex items-start justify-between gap-2">
                    <span className="line-clamp-2">{cma.name}</span>
                    <FileText className="w-5 h-5 text-muted-foreground flex-shrink-0" />
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <div className="flex items-center gap-2 text-sm text-muted-foreground">
                    <Calendar className="w-4 h-4" />
                    <span>Created {new Date(cma.createdAt).toLocaleDateString()}</span>
                  </div>
                  {cma.updatedAt && new Date(cma.updatedAt).getTime() !== new Date(cma.createdAt).getTime() && (
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <span>Modified {new Date(cma.updatedAt).toLocaleDateString()}</span>
                    </div>
                  )}
                  <p className="text-sm text-muted-foreground">
                    {cma.comparablePropertyIds.length} comparable properties
                  </p>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      ) : (
        <Card>
          <CardContent className="py-12">
            <div className="text-center">
              <FileText className="w-16 h-16 mx-auto mb-4 text-muted-foreground opacity-50" />
              <h3 className="text-lg font-semibold mb-2">No CMAs yet</h3>
              <p className="text-muted-foreground mb-6">
                Create your first comparative market analysis to get started
              </p>
              <Link href="/cmas/new">
                <Button data-testid="button-get-started-cma">
                  <Plus className="w-4 h-4 mr-2" />
                  Get Started
                </Button>
              </Link>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


================================================================================
FILE: PolygonMapSearch.tsx
COPY TO: client/src/components/PolygonMapSearch.tsx
================================================================================\n
import { useEffect, useRef, useState, useCallback } from "react";
import { MapContainer, TileLayer, FeatureGroup, useMap } from "react-leaflet";
import L from "leaflet";
import "leaflet-draw";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Trash2, MapPin, AlertCircle, Search, PenTool } from "lucide-react";
import { cn } from "@/lib/utils";
import { MapLayersControl } from "./MapLayersControl";
import "leaflet/dist/leaflet.css";
import "leaflet-draw/dist/leaflet.draw.css";

interface PolygonMapSearchProps {
  onSearch: (boundary: number[][][]) => void;
  onClear: () => void;
  isLoading?: boolean;
  resultCount?: number;
  fullHeight?: boolean;
}

const AUSTIN_CENTER: [number, number] = [30.2672, -97.7431];
const DEFAULT_ZOOM = 11;

function DrawControl({ 
  onPolygonCreated, 
  onPolygonDeleted 
}: { 
  onPolygonCreated: (coords: number[][]) => void;
  onPolygonDeleted: () => void;
}) {
  const map = useMap();
  const drawControlRef = useRef<L.Control.Draw | null>(null);
  const featureGroupRef = useRef<L.FeatureGroup>(L.featureGroup());

  useEffect(() => {
    featureGroupRef.current.addTo(map);

    const drawControl = new L.Control.Draw({
      position: "topright",
      draw: {
        polyline: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false,
        polygon: {
          allowIntersection: false,
          showArea: false,
          shapeOptions: {
            color: "#f97316",
            fillColor: "#f97316",
            fillOpacity: 0.2,
            weight: 2,
          },
        },
      },
      edit: {
        featureGroup: featureGroupRef.current,
        remove: true,
      },
    });

    drawControlRef.current = drawControl;
    map.addControl(drawControl);

    const handleCreated = (e: L.LeafletEvent) => {
      const event = e as L.DrawEvents.Created;
      featureGroupRef.current.clearLayers();
      featureGroupRef.current.addLayer(event.layer);
      
      if (event.layer instanceof L.Polygon) {
        const latlngs = event.layer.getLatLngs()[0] as L.LatLng[];
        const coordinates = latlngs.map(ll => [ll.lng, ll.lat]);
        if (coordinates.length > 0) {
          coordinates.push(coordinates[0]);
        }
        onPolygonCreated(coordinates);
      }
    };

    const handleDeleted = () => {
      onPolygonDeleted();
    };

    map.on(L.Draw.Event.CREATED, handleCreated);
    map.on(L.Draw.Event.DELETED, handleDeleted);

    return () => {
      if (drawControlRef.current) {
        map.removeControl(drawControlRef.current);
      }
      map.off(L.Draw.Event.CREATED, handleCreated);
      map.off(L.Draw.Event.DELETED, handleDeleted);
      featureGroupRef.current.remove();
    };
  }, [map, onPolygonCreated, onPolygonDeleted]);

  return null;
}

function MapController() {
  const map = useMap();
  
  useEffect(() => {
    setTimeout(() => {
      map.invalidateSize();
    }, 100);
  }, [map]);
  
  return null;
}

export function PolygonMapSearch({ onSearch, onClear, isLoading, resultCount, fullHeight }: PolygonMapSearchProps) {
  const [hasPolygon, setHasPolygon] = useState(false);
  const [currentBoundary, setCurrentBoundary] = useState<number[][][] | null>(null);

  const handlePolygonCreated = useCallback((coordinates: number[][]) => {
    const boundary: number[][][] = [coordinates];
    setCurrentBoundary(boundary);
    setHasPolygon(true);
  }, []);

  const handlePolygonDeleted = useCallback(() => {
    setHasPolygon(false);
    setCurrentBoundary(null);
    onClear();
  }, [onClear]);

  const handleSearchClick = useCallback(() => {
    if (currentBoundary) {
      onSearch(currentBoundary);
    }
  }, [currentBoundary, onSearch]);

  return (
    <div className={cn("flex flex-col gap-3", fullHeight && "h-full")}>
      <div className="flex items-center justify-between flex-wrap gap-2 flex-shrink-0">
        <div className="flex items-center gap-2">
          <MapPin className="w-5 h-5 text-primary" />
          <span className="font-medium">Draw a search area on the map</span>
        </div>
        {hasPolygon && (
          <div className="flex items-center gap-2">
            <Button
              size="sm"
              onClick={handleSearchClick}
              disabled={isLoading}
              data-testid="button-search-polygon"
            >
              {isLoading ? (
                <Loader2 className="w-4 h-4 mr-1 animate-spin" />
              ) : (
                <Search className="w-4 h-4 mr-1" />
              )}
              Search Area
            </Button>
          </div>
        )}
      </div>

      {resultCount !== undefined && resultCount > 0 && (
        <Badge variant="secondary" className="text-sm flex-shrink-0">
          {resultCount} properties found in area
        </Badge>
      )}

      <Card className={cn("overflow-hidden", fullHeight ? "flex-1 min-h-0" : "")}>
        <div className={cn("w-full relative", fullHeight ? "h-full" : "h-[400px]")}>
          <MapContainer
            center={AUSTIN_CENTER}
            zoom={DEFAULT_ZOOM}
            style={{ height: "100%", width: "100%" }}
            scrollWheelZoom={true}
          >
            <MapController />
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
              url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            />
            <DrawControl 
              onPolygonCreated={handlePolygonCreated}
              onPolygonDeleted={handlePolygonDeleted}
            />
            <MapLayersControl position="topleft" />
          </MapContainer>
          
          {!hasPolygon && (
            <div className="absolute bottom-4 left-4 right-4 z-[1001]">
              <div className="bg-card/95 backdrop-blur-sm border rounded-lg p-3 shadow-lg">
                <div className="flex items-start gap-2">
                  <PenTool className="w-4 h-4 text-primary mt-0.5 flex-shrink-0" />
                  <p className="text-sm text-muted-foreground">
                    Click the <strong>polygon tool</strong> (pentagon icon) in the top-right corner, then click on the map to draw points around your search area. Double-click to complete the shape.
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>
      </Card>
    </div>
  );
}


================================================================================
FILE: SharedCMAView.tsx
COPY TO: client/src/components/SharedCMAView.tsx
================================================================================\n
import { useQuery } from "@tanstack/react-query";
import { useParams } from "wouter";
import { Loader2, AlertCircle } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { CMAReport } from "@/components/CMAReport";
import type { Property, PropertyStatistics, TimelineDataPoint } from "@shared/schema";

interface SharedCMAData {
  cma: {
    id: string;
    name: string;
    notes: string | null;
    createdAt: string;
    expiresAt: string | null;
    subjectPropertyId?: string | null;
  };
  properties: Property[];
  statistics: PropertyStatistics;
  timelineData: TimelineDataPoint[];
}

export default function SharedCMAView() {
  const { token } = useParams<{ token: string }>();

  const { data, isLoading, isError, error } = useQuery<SharedCMAData>({
    queryKey: ['/api/share/cma', token],
    queryFn: async () => {
      const res = await fetch(`/api/share/cma/${token}`);
      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Failed to load CMA');
      }
      return res.json();
    },
    retry: false,
  });

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-background">
        <div className="text-center">
          <Loader2 className="w-8 h-8 mx-auto animate-spin text-primary mb-4" />
          <p className="text-muted-foreground">Loading CMA...</p>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-background">
        <Card className="max-w-md w-full mx-4">
          <CardContent className="pt-6">
            <div className="text-center">
              <AlertCircle className="w-12 h-12 mx-auto text-destructive mb-4" />
              <h2 className="text-xl font-semibold mb-2">Unable to Load CMA</h2>
              <p className="text-muted-foreground">
                {(error as Error).message || 'This CMA link may have expired or is invalid.'}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!data) {
    return null;
  }

  const { cma, properties, statistics, timelineData } = data;

  return (
    <div className="min-h-screen bg-background">
      {/* Spyglass Realty Branded Header */}
      <header className="bg-zinc-900 text-white py-4 px-6 shadow-lg">
        <div className="container mx-auto max-w-7xl flex items-center justify-between">
          <div className="flex items-center gap-4">
            <img 
              src="/spyglass-logo-white.png" 
              alt="Spyglass Realty" 
              className="h-10 w-auto"
            />
          </div>
          <div className="text-right">
            <h1 className="text-xl font-bold">{cma.name}</h1>
            <p className="text-sm text-zinc-400">
              Comparative Market Analysis
              {cma.expiresAt && (
                <span className="ml-2 text-amber-400">
                   Expires {new Date(cma.expiresAt).toLocaleDateString()}
                </span>
              )}
            </p>
          </div>
        </div>
      </header>

      {/* CMA Report with CloudCMA-style interface */}
      <div className="container mx-auto max-w-7xl px-4 py-6">
        <CMAReport
          properties={properties}
          statistics={statistics}
          timelineData={timelineData}
          isPreview={false}
          expiresAt={cma.expiresAt ? new Date(cma.expiresAt) : undefined}
          notes={cma.notes}
          reportTitle={cma.name}
          subjectPropertyId={cma.subjectPropertyId || null}
        />
      </div>

      {/* Footer with Spyglass branding */}
      <footer className="bg-zinc-900 text-zinc-400 py-6 mt-8">
        <div className="container mx-auto max-w-7xl px-6 text-center">
          <img 
            src="/spyglass-logo-white.png" 
            alt="Spyglass Realty" 
            className="h-8 w-auto mx-auto mb-3 opacity-80"
          />
          <p className="text-sm">
            Comparative Market Analysis provided by Spyglass Realty
          </p>
          <p className="text-xs mt-2 text-zinc-500">
            Created {new Date(cma.createdAt).toLocaleDateString()}
          </p>
        </div>
      </footer>
    </div>
  );
}


================================================================================
FILE: StatusFilterTabs.tsx
COPY TO: client/src/components/StatusFilterTabs.tsx
================================================================================\n
import { cn } from "@/lib/utils";

interface StatusFilterTabsProps {
  counts: {
    all: number;
    active: number;
    underContract: number;
    closed: number;
  };
  activeFilter: string;
  onFilterChange: (filter: string) => void;
}

export function StatusFilterTabs({ counts, activeFilter, onFilterChange }: StatusFilterTabsProps) {
  const filters = [
    { key: 'all', label: 'All', count: counts.all },
    { key: 'active', label: 'Active', count: counts.active },
    { key: 'underContract', label: 'Under Contract', count: counts.underContract },
    { key: 'closed', label: 'Closed', count: counts.closed },
  ];

  return (
    <div 
      className="flex items-center gap-1 bg-muted/50 rounded-lg p-1 overflow-x-auto"
      data-testid="status-filter-tabs"
    >
      {filters.map(filter => (
        <button
          key={filter.key}
          onClick={() => onFilterChange(filter.key)}
          className={cn(
            "px-2.5 py-1 rounded-md text-xs font-medium transition-all whitespace-nowrap flex items-center gap-1.5",
            activeFilter === filter.key 
              ? "bg-background shadow-sm text-foreground" 
              : "text-muted-foreground hover:text-foreground hover:bg-background/50"
          )}
          data-testid={`button-filter-${filter.key}`}
        >
          <span>{filter.label}</span>
          <span 
            className={cn(
              "px-1.5 py-0.5 rounded-full text-xs tabular-nums",
              activeFilter === filter.key 
                ? filter.key === 'active' ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"
                : filter.key === 'underContract' ? "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
                : filter.key === 'closed' ? "bg-gray-100 text-gray-700 dark:bg-gray-700/30 dark:text-gray-400"
                : "bg-primary/10 text-primary"
                : "bg-muted text-muted-foreground"
            )}
          >
            {filter.count}
          </span>
        </button>
      ))}
    </div>
  );
}


================================================================================
FILE: VisualMatchPanel.tsx
COPY TO: client/src/components/VisualMatchPanel.tsx
================================================================================\n
import { useState, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Switch } from "@/components/ui/switch";
import { Separator } from "@/components/ui/separator";
import { 
  Sparkles, 
  X, 
  Plus, 
  Image as ImageIcon, 
  Type, 
  Loader2,
  ChevronDown,
  ChevronUp,
  Trash2,
  Link as LinkIcon
} from "lucide-react";
import { cn } from "@/lib/utils";

export interface ImageSearchItem {
  type: 'text' | 'image';
  value?: string;
  url?: string;
  boost?: number;
}

export interface VisualMatchCriteria {
  imageSearchItems: ImageSearchItem[];
  standardStatus?: string;
  status?: string;
  type?: string;
  city?: string;
  subdivision?: string;
  postalCode?: string;
  minPrice?: number;
  maxPrice?: number;
  minBeds?: number;
  maxBeds?: number;
  minBaths?: number;
  maxBaths?: number;
  minSqft?: number;
  maxSqft?: number;
  class?: string;
  propertyType?: string;
  resultsPerPage?: number;
  pageNum?: number;
}

interface VisualMatchPanelProps {
  enabled: boolean;
  onEnabledChange: (enabled: boolean) => void;
  items: ImageSearchItem[];
  onItemsChange: (items: ImageSearchItem[]) => void;
  isSearching?: boolean;
  onSearch?: () => void;
  compact?: boolean;
  className?: string;
  demoMode?: boolean;
  error?: string;
}

const PRESET_CHIPS = [
  { label: "Modern Kitchen", value: "modern kitchen with granite countertops" },
  { label: "Open Floor Plan", value: "open floor plan living area" },
  { label: "Pool & Backyard", value: "swimming pool with landscaped backyard" },
  { label: "Natural Light", value: "large windows with natural light" },
  { label: "Hardwood Floors", value: "hardwood floors throughout" },
  { label: "Updated Bathroom", value: "updated bathroom with modern fixtures" },
  { label: "High Ceilings", value: "high vaulted ceilings" },
  { label: "Outdoor Living", value: "covered patio outdoor living space" },
];

export default function VisualMatchPanel({
  enabled,
  onEnabledChange,
  items,
  onItemsChange,
  isSearching = false,
  onSearch,
  compact = false,
  className,
  demoMode = false,
  error = ''
}: VisualMatchPanelProps) {
  const [showImageUrl, setShowImageUrl] = useState(false);
  const [imageUrl, setImageUrl] = useState("");
  const [customText, setCustomText] = useState("");
  const [isExpanded, setIsExpanded] = useState(true);
  const inputRef = useRef<HTMLInputElement>(null);

  const addTextItem = (text: string) => {
    if (!text.trim()) return;
    if (items.length >= 10) return;
    const newItem: ImageSearchItem = { type: 'text', value: text.trim() };
    onItemsChange([...items, newItem]);
    setCustomText("");
  };

  const addImageItem = (url: string) => {
    if (!url.trim()) return;
    if (items.length >= 10) return;
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      return;
    }
    const newItem: ImageSearchItem = { type: 'image', url: url.trim() };
    onItemsChange([...items, newItem]);
    setImageUrl("");
    setShowImageUrl(false);
  };

  const removeItem = (index: number) => {
    const newItems = items.filter((_, i) => i !== index);
    onItemsChange(newItems);
  };

  const updateItemBoost = (index: number, boost: number) => {
    const newItems = items.map((item, i) => 
      i === index ? { ...item, boost } : item
    );
    onItemsChange(newItems);
  };

  const clearAll = () => {
    onItemsChange([]);
    setImageUrl("");
    setCustomText("");
    setShowImageUrl(false);
  };

  if (!enabled) {
    return (
      <div className={cn("space-y-3", className)}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Sparkles className="w-4 h-4 text-primary" />
            <Label className="text-base font-semibold">Visual Match</Label>
          </div>
          <Switch
            checked={enabled}
            onCheckedChange={onEnabledChange}
            data-testid="switch-visual-match"
          />
        </div>
        <p className="text-xs text-muted-foreground">
          Rank results by visual similarity to photos or descriptions
        </p>
      </div>
    );
  }

  return (
    <div className={cn("space-y-3", className)}>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Sparkles className="w-4 h-4 text-primary" />
          <Label className="text-base font-semibold">Visual Match</Label>
          {demoMode && (
            <Badge variant="outline" className="text-xs border-amber-500 text-amber-600">
              Demo
            </Badge>
          )}
          {items.length > 0 && (
            <Badge variant="secondary" className="text-xs">
              {items.length}
            </Badge>
          )}
        </div>
        <div className="flex items-center gap-2">
          {items.length > 0 && (
            <Button
              variant="ghost"
              size="sm"
              onClick={clearAll}
              className="h-6 px-2 text-xs text-muted-foreground"
              data-testid="button-clear-visual-match"
            >
              Clear
            </Button>
          )}
          <Switch
            checked={enabled}
            onCheckedChange={onEnabledChange}
            data-testid="switch-visual-match"
          />
        </div>
      </div>

      {/* Error/Demo Mode Message */}
      {error && (
        <div className="text-xs text-amber-600 bg-amber-50 dark:bg-amber-900/20 rounded-md p-2">
          {error}
        </div>
      )}

      <div className="space-y-3">
        {items.length > 0 && (
          <div className="flex flex-wrap gap-2">
            {items.map((item, index) => (
              <Badge
                key={index}
                variant="secondary"
                className="pl-2 pr-1 py-1 flex items-center gap-1 max-w-full"
                data-testid={`badge-visual-item-${index}`}
              >
                {item.type === 'image' ? (
                  <ImageIcon className="w-3 h-3 flex-shrink-0" />
                ) : (
                  <Type className="w-3 h-3 flex-shrink-0" />
                )}
                <span className="truncate max-w-[150px] text-xs">
                  {item.type === 'image' ? 'Image URL' : item.value}
                </span>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => removeItem(index)}
                  className="h-4 w-4 p-0 ml-1 hover:bg-destructive/20"
                  data-testid={`button-remove-item-${index}`}
                >
                  <X className="w-3 h-3" />
                </Button>
              </Badge>
            ))}
          </div>
        )}

        {!compact && (
          <>
            <div className="space-y-2">
              <Label className="text-xs text-muted-foreground">Quick Add</Label>
              <div className="flex flex-wrap gap-1.5">
                {PRESET_CHIPS.map((preset, index) => {
                  const isAdded = items.some(
                    item => item.type === 'text' && item.value === preset.value
                  );
                  return (
                    <Button
                      key={index}
                      type="button"
                      variant={isAdded ? "secondary" : "outline"}
                      size="sm"
                      onClick={() => {
                        if (isAdded) {
                          const newItems = items.filter(
                            item => !(item.type === 'text' && item.value === preset.value)
                          );
                          onItemsChange(newItems);
                        } else {
                          addTextItem(preset.value);
                        }
                      }}
                      disabled={items.length >= 10 && !isAdded}
                      className={cn(
                        "h-7 text-xs",
                        isAdded && "toggle-elevate toggle-elevated"
                      )}
                      data-testid={`button-preset-${index}`}
                    >
                      {preset.label}
                    </Button>
                  );
                })}
              </div>
            </div>

            <div className="space-y-2">
              <Label className="text-xs text-muted-foreground">Custom Description</Label>
              <div className="flex gap-2">
                <Input
                  ref={inputRef}
                  placeholder="e.g., Chef's kitchen, spa bathroom..."
                  value={customText}
                  onChange={(e) => setCustomText(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      addTextItem(customText);
                    }
                  }}
                  disabled={items.length >= 10}
                  className="h-8 text-sm"
                  data-testid="input-custom-text"
                />
                <Button
                  type="button"
                  size="sm"
                  onClick={() => addTextItem(customText)}
                  disabled={!customText.trim() || items.length >= 10}
                  className="h-8"
                  data-testid="button-add-text"
                >
                  <Plus className="w-4 h-4" />
                </Button>
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <Label className="text-xs text-muted-foreground">Reference Image</Label>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setShowImageUrl(!showImageUrl)}
                  className="h-6 px-2 text-xs"
                  data-testid="button-toggle-image-url"
                >
                  <LinkIcon className="w-3 h-3 mr-1" />
                  {showImageUrl ? 'Hide' : 'Add URL'}
                </Button>
              </div>
              
              {showImageUrl && (
                <div className="flex gap-2">
                  <Input
                    placeholder="https://example.com/image.jpg"
                    value={imageUrl}
                    onChange={(e) => setImageUrl(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.preventDefault();
                        addImageItem(imageUrl);
                      }
                    }}
                    disabled={items.length >= 10}
                    className="h-8 text-sm"
                    data-testid="input-image-url"
                  />
                  <Button
                    type="button"
                    size="sm"
                    onClick={() => addImageItem(imageUrl)}
                    disabled={!imageUrl.trim() || items.length >= 10 || (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://'))}
                    className="h-8"
                    data-testid="button-add-image"
                  >
                    <Plus className="w-4 h-4" />
                  </Button>
                </div>
              )}
            </div>
          </>
        )}

        {items.length >= 10 && (
          <p className="text-xs text-muted-foreground">
            Maximum 10 items reached
          </p>
        )}

        {onSearch && items.length > 0 && (
          <Button
            onClick={onSearch}
            disabled={isSearching || items.length === 0}
            className="w-full"
            data-testid="button-visual-search"
          >
            {isSearching ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Searching...
              </>
            ) : (
              <>
                <Sparkles className="w-4 h-4 mr-2" />
                Search by Visual Match
              </>
            )}
          </Button>
        )}
      </div>
    </div>
  );
}