# Contract Conduit ‚Äî Image Crop Sync to Preview & Export

## üìå Overview

The Flyer Generator has a **Crop Image** feature that allows users to zoom and crop property photos. This cropped image MUST:

1. **Sync immediately** to the Live Preview
2. **Be used in PNG export** (exact same crop)
3. **Be used in CMYK export** (exact same crop)

---

## üñºÔ∏è Current Feature

The crop modal includes:
- Image display area
- Zoom slider (to zoom in/out)
- "Cancel" button
- "Apply Crop" button

The crop icon appears on:
- Main Property Photo
- Kitchen Photo
- Room Photo
- Agent Photo (if applicable)

---

## üîÑ Data Flow Required

```
User clicks crop icon
        ‚Üì
Crop modal opens with image
        ‚Üì
User adjusts zoom/position
        ‚Üì
User clicks "Apply Crop"
        ‚Üì
Cropped image is generated (canvas/blob)
        ‚Üì
Cropped image stored in state
        ‚Üì
Live Preview updates IMMEDIATELY
        ‚Üì
Export uses the CROPPED image (not original)
```

---

## üîß Implementation

### Step 1: Crop Modal Component

```tsx
// components/ImageCropModal.tsx

import { useState, useCallback, useRef } from 'react';
import Cropper from 'react-easy-crop';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Slider } from '@/components/ui/slider';

interface ImageCropModalProps {
  isOpen: boolean;
  onClose: () => void;
  imageSrc: string;
  onCropComplete: (croppedImageDataUrl: string) => void;
  aspectRatio?: number; // e.g., 16/9 for main photo, 4/3 for secondary
}

interface CroppedArea {
  x: number;
  y: number;
  width: number;
  height: number;
}

export function ImageCropModal({
  isOpen,
  onClose,
  imageSrc,
  onCropComplete,
  aspectRatio = 16 / 9,
}: ImageCropModalProps) {
  const [crop, setCrop] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(1);
  const [croppedAreaPixels, setCroppedAreaPixels] = useState<CroppedArea | null>(null);

  const onCropChange = useCallback((crop: { x: number; y: number }) => {
    setCrop(crop);
  }, []);

  const onZoomChange = useCallback((zoom: number) => {
    setZoom(zoom);
  }, []);

  const onCropCompleteCallback = useCallback(
    (croppedArea: CroppedArea, croppedAreaPixels: CroppedArea) => {
      setCroppedAreaPixels(croppedAreaPixels);
    },
    []
  );

  const handleApplyCrop = async () => {
    if (!croppedAreaPixels) return;

    try {
      const croppedImage = await getCroppedImg(imageSrc, croppedAreaPixels);
      onCropComplete(croppedImage);
      onClose();
    } catch (error) {
      console.error('Error cropping image:', error);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Crop Image</DialogTitle>
        </DialogHeader>

        {/* Crop Area */}
        <div className="relative h-[400px] bg-gray-100 rounded-lg overflow-hidden">
          <Cropper
            image={imageSrc}
            crop={crop}
            zoom={zoom}
            aspect={aspectRatio}
            onCropChange={onCropChange}
            onZoomChange={onZoomChange}
            onCropComplete={onCropCompleteCallback}
          />
        </div>

        {/* Zoom Slider */}
        <div className="space-y-2">
          <label className="text-sm font-medium">Zoom</label>
          <Slider
            value={[zoom]}
            min={1}
            max={3}
            step={0.1}
            onValueChange={([value]) => setZoom(value)}
            className="w-full"
          />
        </div>

        {/* Actions */}
        <div className="flex justify-end gap-3 mt-4">
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button onClick={handleApplyCrop}>
            Apply Crop
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// Helper function to create cropped image
async function getCroppedImg(
  imageSrc: string,
  pixelCrop: CroppedArea
): Promise<string> {
  const image = await createImage(imageSrc);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  if (!ctx) throw new Error('No 2d context');

  // Set canvas size to the cropped area
  canvas.width = pixelCrop.width;
  canvas.height = pixelCrop.height;

  // Draw the cropped image
  ctx.drawImage(
    image,
    pixelCrop.x,
    pixelCrop.y,
    pixelCrop.width,
    pixelCrop.height,
    0,
    0,
    pixelCrop.width,
    pixelCrop.height
  );

  // Return as data URL (base64)
  return canvas.toDataURL('image/jpeg', 0.95);
}

function createImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const image = new Image();
    image.addEventListener('load', () => resolve(image));
    image.addEventListener('error', (error) => reject(error));
    image.crossOrigin = 'anonymous';
    image.src = url;
  });
}
```

### Step 2: Image Thumbnail with Crop Button

```tsx
// components/ImageThumbnail.tsx

import { useState } from 'react';
import { Crop, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ImageCropModal } from './ImageCropModal';

interface ImageThumbnailProps {
  label: string;
  imageSrc: string | null;
  onImageChange: (newImageDataUrl: string) => void;
  onRemove: () => void;
  aspectRatio?: number;
}

export function ImageThumbnail({
  label,
  imageSrc,
  onImageChange,
  onRemove,
  aspectRatio = 16 / 9,
}: ImageThumbnailProps) {
  const [showCropModal, setShowCropModal] = useState(false);

  return (
    <div className="space-y-2">
      <label className="text-sm font-medium text-muted-foreground uppercase tracking-wider">
        {label}
      </label>

      {imageSrc ? (
        <div className="relative group">
          <img
            src={imageSrc}
            alt={label}
            className="w-full h-32 object-cover rounded-lg border"
          />

          {/* Action Buttons - Top Right */}
          <div className="absolute top-2 right-2 flex gap-1">
            {/* Crop Button */}
            <Button
              type="button"
              variant="secondary"
              size="icon"
              className="w-8 h-8 bg-white/90 hover:bg-white shadow-sm"
              onClick={() => setShowCropModal(true)}
              title="Crop Image"
            >
              <Crop className="w-4 h-4" />
            </Button>

            {/* Remove Button */}
            <Button
              type="button"
              variant="destructive"
              size="icon"
              className="w-8 h-8 shadow-sm"
              onClick={onRemove}
              title="Remove Image"
            >
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>
      ) : (
        <div className="w-full h-32 border-2 border-dashed rounded-lg flex items-center justify-center text-muted-foreground">
          No image
        </div>
      )}

      {/* Crop Modal */}
      {imageSrc && (
        <ImageCropModal
          isOpen={showCropModal}
          onClose={() => setShowCropModal(false)}
          imageSrc={imageSrc}
          aspectRatio={aspectRatio}
          onCropComplete={(croppedImage) => {
            // Update the image with cropped version
            onImageChange(croppedImage);
          }}
        />
      )}
    </div>
  );
}
```

### Step 3: Integration in Flyer Generator

```tsx
// In the Flyer Generator component

// State for images (stores CROPPED versions)
const [images, setImages] = useState({
  mainImage: null as string | null,      // Stores cropped image
  kitchenImage: null as string | null,   // Stores cropped image
  roomImage: null as string | null,      // Stores cropped image
  agentPhoto: null as string | null,     // Stores cropped image
  companyLogo: null as string | null,
  secondaryLogo: null as string | null,
  qrCode: null as string | null,
});

// Handler for when crop is applied
const handleImageCropComplete = (imageKey: keyof typeof images, croppedImageDataUrl: string) => {
  console.log(`[Flyer] Cropped ${imageKey}, updating state...`);
  
  setImages(prev => ({
    ...prev,
    [imageKey]: croppedImageDataUrl,  // ‚Üê Store the CROPPED image
  }));
  
  // Live Preview will automatically update because it reads from `images` state
};

// In the JSX
<ImageThumbnail
  label="Main Property Photo"
  imageSrc={images.mainImage}
  aspectRatio={16 / 9}  // Wide for main photo
  onImageChange={(croppedImage) => handleImageCropComplete('mainImage', croppedImage)}
  onRemove={() => setImages(prev => ({ ...prev, mainImage: null }))}
/>

<div className="grid grid-cols-2 gap-4">
  <ImageThumbnail
    label="Kitchen"
    imageSrc={images.kitchenImage}
    aspectRatio={4 / 3}  // Standard for secondary
    onImageChange={(croppedImage) => handleImageCropComplete('kitchenImage', croppedImage)}
    onRemove={() => setImages(prev => ({ ...prev, kitchenImage: null }))}
  />
  
  <ImageThumbnail
    label="Room"
    imageSrc={images.roomImage}
    aspectRatio={4 / 3}  // Standard for secondary
    onImageChange={(croppedImage) => handleImageCropComplete('roomImage', croppedImage)}
    onRemove={() => setImages(prev => ({ ...prev, roomImage: null }))}
  />
</div>
```

### Step 4: Live Preview Uses Cropped Images

```tsx
// LivePreview component reads from images state
// Since we store the CROPPED image in state, preview automatically shows cropped version

function LivePreview({ images, propertyData, agentData }) {
  return (
    <div className="flyer-preview">
      {/* Main Photo - Uses cropped image from state */}
      {images.mainImage && (
        <img 
          src={images.mainImage}  // ‚Üê This is already the CROPPED version
          alt="Main Property" 
          className="w-full aspect-[16/9] object-cover"
        />
      )}
      
      {/* Secondary Photos */}
      <div className="grid grid-cols-2">
        {images.kitchenImage && (
          <img 
            src={images.kitchenImage}  // ‚Üê Already cropped
            alt="Kitchen" 
          />
        )}
        {images.roomImage && (
          <img 
            src={images.roomImage}  // ‚Üê Already cropped
            alt="Room" 
          />
        )}
      </div>
      
      {/* ... rest of preview */}
    </div>
  );
}
```

### Step 5: Export Uses Same Cropped Images

```tsx
// When exporting, send the SAME images from state (which are cropped)

const handleExportPNG = async () => {
  const exportData = {
    // ... other data
    
    // Images - These are the CROPPED versions from state
    mainPhoto: images.mainImage,       // ‚Üê Cropped image
    kitchenPhoto: images.kitchenImage, // ‚Üê Cropped image
    roomPhoto: images.roomImage,       // ‚Üê Cropped image
    agentPhoto: images.agentPhoto,     // ‚Üê Cropped image
  };
  
  console.log('[Export] Using cropped images from state');
  
  const response = await fetch('/api/flyer/export-png', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(exportData),
  });
  
  // ... handle response
};
```

---

## üéØ Key Principle

**The `images` state stores the CROPPED version of images.**

```
Original Image (from MLS/upload)
        ‚Üì
User crops image
        ‚Üì
Cropped image (data URL) saved to state
        ‚Üì
State is used for BOTH:
  ‚îú‚îÄ Live Preview
  ‚îî‚îÄ Export (PNG & CMYK)
```

This ensures **perfect consistency** between preview and export.

---

## üì¶ Required Package

If not already installed:

```bash
npm install react-easy-crop
```

Or use an alternative like `react-image-crop`.

---

## üîó Aspect Ratios

Use appropriate aspect ratios for each image type:

| Image | Aspect Ratio | Use |
|-------|--------------|-----|
| Main Property Photo | 16:9 (1.78) | Wide landscape |
| Kitchen Photo | 4:3 (1.33) | Standard |
| Room Photo | 4:3 (1.33) | Standard |
| Agent Photo | 1:1 | Square/circular |

```tsx
// In code
aspectRatio={16/9}  // Main photo
aspectRatio={4/3}   // Secondary photos
aspectRatio={1}     // Agent photo (square)
```

---

## ‚úÖ Testing Checklist

### Crop Functionality
- [ ] Click crop icon opens modal
- [ ] Image displays in modal
- [ ] Zoom slider works (1x to 3x)
- [ ] Can drag to reposition image
- [ ] "Cancel" closes modal without changes
- [ ] "Apply Crop" saves cropped image

### Sync to Preview
- [ ] After applying crop, Live Preview updates IMMEDIATELY
- [ ] Preview shows the exact cropped area
- [ ] No delay or need to refresh

### Sync to Export
- [ ] Export PNG uses the cropped image
- [ ] Export CMYK uses the cropped image
- [ ] Exported image matches the preview exactly
- [ ] Crop area is identical in preview and export

### Multiple Images
- [ ] Can crop main photo independently
- [ ] Can crop kitchen photo independently
- [ ] Can crop room photo independently
- [ ] Each crop is saved separately
- [ ] Cropping one doesn't affect others

### Edge Cases
- [ ] Crop works on uploaded images
- [ ] Crop works on MLS images (cross-origin handled)
- [ ] Re-cropping an already cropped image works
- [ ] High resolution images crop correctly