# Contract Conduit â€” CMA Presentation Builder Scaffold

## OVERVIEW

**Task:** Scaffold the CMA Presentation Builder feature for Contract Conduit. This creates the foundational structure for building customizable CMA presentations with PDF export capabilities.

**Reference:** This mirrors the Presentation Builder from Client Data Portal, adapted for Contract Conduit's architecture.

**Brand:** Spyglass Realty (Orange: `#F37216`)

---

## PHASE 1: Install Dependencies

Run in terminal:

```bash
npm install @react-pdf/renderer@^3 mapbox-gl@^2 @dnd-kit/core@^6 @dnd-kit/sortable@^8 recharts@^2 openai@^4
npm install -D @types/mapbox-gl
```

---

## PHASE 2: Database Schema Updates

### Task 2.1: Add Interface Types

Add to `shared/schema.ts` (before table definitions):

```typescript
// CMA Presentation Builder Types
export interface CmaBrochure {
  type: "pdf" | "image";
  url: string;
  thumbnail?: string;
  filename: string;
  generated: boolean;
  uploadedAt: string;
}

export interface CmaAdjustmentRates {
  sqftPerUnit: number;        // Default: 50
  bedroomValue: number;       // Default: 10000
  bathroomValue: number;      // Default: 7500
  poolValue: number;          // Default: 25000
  garagePerSpace: number;     // Default: 5000
  yearBuiltPerYear: number;   // Default: 1000
  lotSizePerSqft: number;     // Default: 2
}

export interface CmaCompAdjustmentOverrides {
  sqft?: number | null;
  bedrooms?: number | null;
  bathrooms?: number | null;
  pool?: number | null;
  garage?: number | null;
  yearBuilt?: number | null;
  lotSize?: number | null;
  custom?: { name: string; value: number }[];
}

export interface CmaAdjustmentsData {
  rates: CmaAdjustmentRates;
  compAdjustments: Record<string, CmaCompAdjustmentOverrides>;
  enabled: boolean;
}

export interface CoverPageConfig {
  title: string;
  subtitle: string;
  showDate: boolean;
  showAgentPhoto: boolean;
  background: "none" | "gradient" | "property";
}
```

### Task 2.2: Update CMA Table (if columns don't exist)

In your existing `cmas` table, ensure these columns exist:

```typescript
// Add to cmas table definition if not present:
brochure: json("brochure").$type<CmaBrochure>(),
adjustments: json("adjustments").$type<CmaAdjustmentsData>(),
```

### Task 2.3: Create Report Config Table

Add to `shared/schema.ts`:

```typescript
export const cmaReportConfigs = pgTable("cma_report_configs", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  cmaId: integer("cma_id").notNull().references(() => cmas.id, { onDelete: 'cascade' }).unique(),
  includedSections: json("included_sections").$type<string[]>(),
  sectionOrder: json("section_order").$type<string[]>(),
  coverLetterOverride: text("cover_letter_override"),
  layout: text("layout").default("two_photos"),
  template: text("template").default("default"),
  theme: text("theme").default("default"),
  photoLayout: text("photo_layout").default("first_dozen"),
  mapStyle: text("map_style").default("streets"),
  showMapPolygon: boolean("show_map_polygon").default(true),
  includeAgentFooter: boolean("include_agent_footer").default(true),
  coverPageConfig: json("cover_page_config").$type<CoverPageConfig>(),
  customPhotoSelections: json("custom_photo_selections").$type<Record<string, string[]>>(),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});
```

### Task 2.4: Create Templates Table

Add to `shared/schema.ts`:

```typescript
export const cmaReportTemplates = pgTable("cma_report_templates", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  userId: text("user_id").notNull().references(() => users.id, { onDelete: 'cascade' }),
  name: text("name").notNull(),
  isDefault: boolean("is_default").default(false),
  includedSections: json("included_sections").$type<string[]>(),
  sectionOrder: json("section_order").$type<string[]>(),
  coverLetterOverride: text("cover_letter_override"),
  layout: text("layout").default("two_photos"),
  theme: text("theme").default("default"),
  photoLayout: text("photo_layout").default("first_dozen"),
  mapStyle: text("map_style").default("streets"),
  showMapPolygon: boolean("show_map_polygon").default(true),
  includeAgentFooter: boolean("include_agent_footer").default(true),
  coverPageConfig: json("cover_page_config").$type<CoverPageConfig>(),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});
```

### Task 2.5: Run Migration

```bash
npm run db:push
```

---

## PHASE 3: Create Shared Constants

### Task 3.1: Section Definitions

Create file: `shared/cma-sections.ts`

```typescript
// CMA Report Sections - All 17 sections for the presentation builder

export const CMA_REPORT_SECTIONS = [
  // INTRODUCTION CATEGORY (7 sections)
  { id: 'cover_page', name: 'Cover Page', category: 'introduction', defaultEnabled: true },
  { id: 'listing_brochure', name: 'Listing Brochure', category: 'introduction', defaultEnabled: false },
  { id: 'cover_letter', name: 'Cover Letter', category: 'introduction', defaultEnabled: true, editable: true },
  { id: 'agent_resume', name: 'Agent Resume', category: 'introduction', defaultEnabled: false, editable: true },
  { id: 'our_company', name: 'Our Company', category: 'introduction', defaultEnabled: false },
  { id: 'what_is_cma', name: 'What is a CMA?', category: 'introduction', defaultEnabled: false },
  { id: 'contact_me', name: 'Contact Me', category: 'introduction', defaultEnabled: true },
  
  // LISTINGS CATEGORY (6 sections)
  { id: 'map_all_listings', name: 'Map of All Listings', category: 'listings', defaultEnabled: true },
  { id: 'summary_comparables', name: 'Summary of Comparable Properties', category: 'listings', defaultEnabled: true },
  { id: 'listings_header', name: 'Listings Chapter Header', category: 'listings', defaultEnabled: false },
  { id: 'property_details', name: 'Property Details', category: 'listings', defaultEnabled: true },
  { id: 'property_photos', name: 'Property Photos', category: 'listings', defaultEnabled: true },
  { id: 'adjustments', name: 'Adjustments', category: 'listings', defaultEnabled: false },
  
  // ANALYSIS CATEGORY (4 sections)
  { id: 'analysis_header', name: 'Analysis Chapter Header', category: 'analysis', defaultEnabled: false },
  { id: 'online_valuation', name: 'Online Valuation Analysis', category: 'analysis', defaultEnabled: false },
  { id: 'price_per_sqft', name: 'Average Price Per Sq. Ft.', category: 'analysis', defaultEnabled: true },
  { id: 'comparable_stats', name: 'Comparable Property Statistics', category: 'analysis', defaultEnabled: true },
] as const;

export type CmaSectionId = typeof CMA_REPORT_SECTIONS[number]['id'];
export type CmaSectionCategory = 'introduction' | 'listings' | 'analysis';

// Helper functions
export const DEFAULT_ENABLED_SECTIONS = CMA_REPORT_SECTIONS
  .filter(s => s.defaultEnabled)
  .map(s => s.id);

export const ALL_SECTION_IDS = CMA_REPORT_SECTIONS.map(s => s.id);

export const SECTION_CATEGORIES = {
  introduction: CMA_REPORT_SECTIONS.filter(s => s.category === 'introduction'),
  listings: CMA_REPORT_SECTIONS.filter(s => s.category === 'listings'),
  analysis: CMA_REPORT_SECTIONS.filter(s => s.category === 'analysis'),
};

export const EDITABLE_SECTIONS = CMA_REPORT_SECTIONS.filter(s => s.editable);
```

### Task 3.2: Default Configuration

Create file: `shared/cma-defaults.ts`

```typescript
import type { CoverPageConfig, CmaAdjustmentRates } from './schema';

export const DEFAULT_COVER_PAGE_CONFIG: CoverPageConfig = {
  title: "Comparative Market Analysis",
  subtitle: "Prepared exclusively for you",
  showDate: true,
  showAgentPhoto: true,
  background: "none",
};

export const DEFAULT_ADJUSTMENT_RATES: CmaAdjustmentRates = {
  sqftPerUnit: 50,
  bedroomValue: 10000,
  bathroomValue: 7500,
  poolValue: 25000,
  garagePerSpace: 5000,
  yearBuiltPerYear: 1000,
  lotSizePerSqft: 2,
};

export const LAYOUT_OPTIONS = [
  { value: "two_photos", label: "Two Photos per Property" },
  { value: "single_photo", label: "Single Photo per Property" },
  { value: "no_photos", label: "No Photos" },
] as const;

export const PHOTO_LAYOUT_OPTIONS = [
  { value: "first_dozen", label: "First 12 Photos" },
  { value: "all", label: "All Photos" },
  { value: "ai_suggested", label: "AI Suggested (Best Quality)" },
  { value: "custom", label: "Custom Selection" },
] as const;

export const MAP_STYLE_OPTIONS = [
  { value: "streets", label: "Streets" },
  { value: "satellite", label: "Satellite" },
] as const;
```

---

## PHASE 4: Create Client Utilities

### Task 4.1: Status Colors Utility

Create file: `client/src/lib/statusColors.ts`

```typescript
// Centralized status color system for CMA

export const STATUS_COLORS = {
  subject: { hex: '#3b82f6', tailwind: 'bg-blue-500', text: 'text-blue-500', label: 'Subject Property' },
  active: { hex: '#22c55e', tailwind: 'bg-green-500', text: 'text-green-500', label: 'Active' },
  underContract: { hex: '#f97316', tailwind: 'bg-orange-500', text: 'text-orange-500', label: 'Under Contract' },
  closed: { hex: '#ef4444', tailwind: 'bg-red-500', text: 'text-red-500', label: 'Closed' },
  pending: { hex: '#6b7280', tailwind: 'bg-gray-500', text: 'text-gray-500', label: 'Pending' },
};

export const MAP_STYLES = {
  streets: 'mapbox://styles/mapbox/streets-v12',
  satellite: 'mapbox://styles/mapbox/satellite-streets-v12',
};

export function getStatusColor(status: string): typeof STATUS_COLORS[keyof typeof STATUS_COLORS] {
  const normalizedStatus = status?.toLowerCase().replace(/\s+/g, '');
  
  if (normalizedStatus?.includes('active') && !normalizedStatus.includes('contract')) {
    return STATUS_COLORS.active;
  }
  if (normalizedStatus?.includes('contract') || normalizedStatus?.includes('pending')) {
    return STATUS_COLORS.underContract;
  }
  if (normalizedStatus?.includes('closed') || normalizedStatus?.includes('sold')) {
    return STATUS_COLORS.closed;
  }
  
  return STATUS_COLORS.pending;
}

export function getStatusHex(status: string, isSubject = false): string {
  if (isSubject) return STATUS_COLORS.subject.hex;
  return getStatusColor(status).hex;
}
```

### Task 4.2: PDF Styles Utility

Create file: `client/src/lib/pdfStyles.ts`

```typescript
// PDF styling constants for @react-pdf/renderer

export const PDF_COLORS = {
  primary: '#F37216',           // Spyglass Orange
  text: '#1f2937',              // Gray-800
  textLight: '#4b5563',         // Gray-600
  textMuted: '#9ca3af',         // Gray-400
  background: '#ffffff',        // White
  backgroundAlt: '#f9fafb',     // Gray-50
  border: '#e5e7eb',            // Gray-200
  
  // Status colors
  statusSubject: '#3b82f6',     // Blue
  statusActive: '#22c55e',      // Green
  statusUnderContract: '#f97316', // Orange
  statusClosed: '#ef4444',      // Red
};

export const PDF_FONTS = {
  family: 'Inter',
  sizes: {
    xs: 8,
    sm: 10,
    base: 11,
    lg: 14,
    xl: 18,
    xxl: 24,
  },
};

export const PDF_SPACING = {
  page: 40,
  coverPage: 60,
  section: 20,
  element: 10,
};
```

### Task 4.3: Adjustment Calculations Utility

Create file: `client/src/lib/adjustmentCalculations.ts`

```typescript
import type { CmaAdjustmentRates, CmaCompAdjustmentOverrides } from '@shared/schema';
import { DEFAULT_ADJUSTMENT_RATES } from '@shared/cma-defaults';

export interface PropertyForAdjustment {
  listingId?: string;
  mlsNumber?: string;
  streetAddress?: string;
  address?: string;
  livingArea?: number;
  bedroomsTotal?: number;
  bathroomsTotal?: number;
  poolFeatures?: string | string[];
  garageSpaces?: number;
  yearBuilt?: number;
  lotSizeArea?: number;
  lotSizeSquareFeet?: number;
  listPrice?: number;
  closePrice?: number;
  soldPrice?: number;
}

export interface AdjustmentItem {
  name: string;
  value: number;
  description?: string;
}

export interface CompAdjustmentResult {
  compId: string;
  compAddress: string;
  salePrice: number;
  adjustments: AdjustmentItem[];
  totalAdjustment: number;
  adjustedPrice: number;
}

export function getPropertyId(property: PropertyForAdjustment): string {
  return property.listingId || property.mlsNumber || '';
}

export function hasPool(property: PropertyForAdjustment): boolean {
  if (!property.poolFeatures) return false;
  if (Array.isArray(property.poolFeatures)) {
    return property.poolFeatures.length > 0 && 
           !property.poolFeatures.every(f => f.toLowerCase() === 'none');
  }
  return property.poolFeatures.toLowerCase() !== 'none' && 
         property.poolFeatures.toLowerCase() !== '';
}

export function calculateAdjustments(
  subject: PropertyForAdjustment,
  comp: PropertyForAdjustment,
  rates: CmaAdjustmentRates = DEFAULT_ADJUSTMENT_RATES,
  overrides?: Partial<CmaCompAdjustmentOverrides>
): CompAdjustmentResult {
  const adjustments: AdjustmentItem[] = [];
  
  // Square footage adjustment
  const subjectSqft = subject.livingArea || 0;
  const compSqft = comp.livingArea || 0;
  const sqftDiff = subjectSqft - compSqft;
  const sqftAdj = overrides?.sqft ?? sqftDiff * rates.sqftPerUnit;
  if (sqftAdj !== 0) {
    adjustments.push({ 
      name: "Sq Ft", 
      value: sqftAdj,
      description: `${sqftDiff > 0 ? '+' : ''}${sqftDiff} sqft @ $${rates.sqftPerUnit}/sqft`
    });
  }
  
  // Bedroom adjustment
  const subjectBeds = subject.bedroomsTotal || 0;
  const compBeds = comp.bedroomsTotal || 0;
  const bedDiff = subjectBeds - compBeds;
  const bedAdj = overrides?.bedrooms ?? bedDiff * rates.bedroomValue;
  if (bedAdj !== 0) {
    adjustments.push({ 
      name: "Beds", 
      value: bedAdj,
      description: `${bedDiff > 0 ? '+' : ''}${bedDiff} beds @ $${rates.bedroomValue.toLocaleString()}/bed`
    });
  }
  
  // Bathroom adjustment
  const subjectBaths = subject.bathroomsTotal || 0;
  const compBaths = comp.bathroomsTotal || 0;
  const bathDiff = subjectBaths - compBaths;
  const bathAdj = overrides?.bathrooms ?? bathDiff * rates.bathroomValue;
  if (bathAdj !== 0) {
    adjustments.push({ 
      name: "Baths", 
      value: bathAdj,
      description: `${bathDiff > 0 ? '+' : ''}${bathDiff} baths @ $${rates.bathroomValue.toLocaleString()}/bath`
    });
  }
  
  // Pool adjustment
  const subjectHasPool = hasPool(subject);
  const compHasPool = hasPool(comp);
  if (subjectHasPool !== compHasPool) {
    const poolAdj = overrides?.pool ?? (subjectHasPool ? rates.poolValue : -rates.poolValue);
    adjustments.push({ 
      name: "Pool", 
      value: poolAdj,
      description: subjectHasPool ? 'Subject has pool' : 'Comp has pool'
    });
  }
  
  // Garage adjustment
  const subjectGarage = subject.garageSpaces || 0;
  const compGarage = comp.garageSpaces || 0;
  const garageDiff = subjectGarage - compGarage;
  const garageAdj = overrides?.garage ?? garageDiff * rates.garagePerSpace;
  if (garageAdj !== 0) {
    adjustments.push({ 
      name: "Garage", 
      value: garageAdj,
      description: `${garageDiff > 0 ? '+' : ''}${garageDiff} spaces @ $${rates.garagePerSpace.toLocaleString()}/space`
    });
  }
  
  // Year built adjustment
  const subjectYear = subject.yearBuilt || 0;
  const compYear = comp.yearBuilt || 0;
  if (subjectYear > 0 && compYear > 0) {
    const yearDiff = subjectYear - compYear;
    const yearAdj = overrides?.yearBuilt ?? yearDiff * rates.yearBuiltPerYear;
    if (yearAdj !== 0) {
      adjustments.push({ 
        name: "Year Built", 
        value: yearAdj,
        description: `${yearDiff > 0 ? '+' : ''}${yearDiff} years @ $${rates.yearBuiltPerYear.toLocaleString()}/year`
      });
    }
  }
  
  // Lot size adjustment
  const subjectLot = subject.lotSizeSquareFeet || subject.lotSizeArea || 0;
  const compLot = comp.lotSizeSquareFeet || comp.lotSizeArea || 0;
  const lotDiff = subjectLot - compLot;
  const lotAdj = overrides?.lotSize ?? lotDiff * rates.lotSizePerSqft;
  if (Math.abs(lotAdj) > 100) {
    adjustments.push({ 
      name: "Lot Size", 
      value: lotAdj,
      description: `${lotDiff > 0 ? '+' : ''}${lotDiff.toLocaleString()} sqft @ $${rates.lotSizePerSqft}/sqft`
    });
  }
  
  // Custom adjustments
  if (overrides?.custom) {
    for (const custom of overrides.custom) {
      adjustments.push({ name: custom.name, value: custom.value });
    }
  }
  
  const totalAdjustment = adjustments.reduce((sum, a) => sum + a.value, 0);
  const salePrice = comp.closePrice || comp.soldPrice || comp.listPrice || 0;
  const adjustedPrice = salePrice + totalAdjustment;
  
  return {
    compId: getPropertyId(comp),
    compAddress: comp.streetAddress || comp.address || 'Unknown',
    salePrice,
    adjustments,
    totalAdjustment,
    adjustedPrice,
  };
}

export function calculateAllAdjustments(
  subject: PropertyForAdjustment,
  comparables: PropertyForAdjustment[],
  rates: CmaAdjustmentRates = DEFAULT_ADJUSTMENT_RATES,
  overridesMap: Record<string, CmaCompAdjustmentOverrides> = {}
): CompAdjustmentResult[] {
  return comparables.map(comp => {
    const compId = getPropertyId(comp);
    return calculateAdjustments(subject, comp, rates, overridesMap[compId]);
  });
}
```

---

## PHASE 5: Create Main Page Component

Create file: `client/src/pages/CMAPresentationBuilder.tsx`

```typescript
import { useState, useEffect, useMemo } from 'react';
import { useParams, useLocation } from 'wouter';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useToast } from '@/hooks/use-toast';
import { 
  ArrowLeft, 
  RotateCcw, 
  Save, 
  FileDown, 
  Expand,
  LayoutGrid,
  FileText,
  Settings2,
  Loader2,
  GripVertical
} from 'lucide-react';

import { 
  CMA_REPORT_SECTIONS, 
  DEFAULT_ENABLED_SECTIONS, 
  ALL_SECTION_IDS,
  SECTION_CATEGORIES 
} from '@shared/cma-sections';
import { 
  DEFAULT_COVER_PAGE_CONFIG, 
  LAYOUT_OPTIONS,
  PHOTO_LAYOUT_OPTIONS,
  MAP_STYLE_OPTIONS 
} from '@shared/cma-defaults';
import type { CoverPageConfig, CmaBrochure, CmaAdjustmentsData } from '@shared/schema';

export default function CMAPresentationBuilder() {
  const { id: cmaId } = useParams<{ id: string }>();
  const [, navigate] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Core presentation state
  const [includedSections, setIncludedSections] = useState<string[]>(DEFAULT_ENABLED_SECTIONS);
  const [sectionOrder, setSectionOrder] = useState<string[]>(ALL_SECTION_IDS);
  const [layout, setLayout] = useState<string>("two_photos");
  const [photoLayout, setPhotoLayout] = useState<string>("first_dozen");
  const [hasChanges, setHasChanges] = useState(false);
  
  // Content state
  const [coverPageConfig, setCoverPageConfig] = useState<CoverPageConfig>(DEFAULT_COVER_PAGE_CONFIG);
  const [coverLetterOverride, setCoverLetterOverride] = useState<string>("");
  const [brochure, setBrochure] = useState<CmaBrochure | null>(null);
  const [adjustments, setAdjustments] = useState<CmaAdjustmentsData | null>(null);
  const [includeAgentFooter, setIncludeAgentFooter] = useState(true);
  
  // Map state
  const [mapStyle, setMapStyle] = useState<"streets" | "satellite">("streets");
  const [showMapPolygon, setShowMapPolygon] = useState(true);
  
  // Custom photo selections
  const [customPhotoSelections, setCustomPhotoSelections] = useState<Record<string, string[]>>({});
  
  // UI state
  const [activeTab, setActiveTab] = useState("sections");
  const [isExporting, setIsExporting] = useState(false);
  const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
  const [isPreviewUpdating, setIsPreviewUpdating] = useState(false);

  // Fetch CMA data
  const { data: cma, isLoading: cmaLoading } = useQuery({
    queryKey: ['cma', cmaId],
    queryFn: async () => {
      const response = await fetch(`/api/cmas/${cmaId}`);
      if (!response.ok) throw new Error('Failed to fetch CMA');
      return response.json();
    },
    enabled: !!cmaId,
  });

  // Fetch report config
  const { data: reportConfig, isLoading: configLoading } = useQuery({
    queryKey: ['cma-report-config', cmaId],
    queryFn: async () => {
      const response = await fetch(`/api/cmas/${cmaId}/report-config`);
      if (!response.ok) return null;
      return response.json();
    },
    enabled: !!cmaId,
  });

  // Initialize state from saved config
  useEffect(() => {
    if (reportConfig) {
      if (reportConfig.includedSections) setIncludedSections(reportConfig.includedSections);
      if (reportConfig.sectionOrder) setSectionOrder(reportConfig.sectionOrder);
      if (reportConfig.layout) setLayout(reportConfig.layout);
      if (reportConfig.photoLayout) setPhotoLayout(reportConfig.photoLayout);
      if (reportConfig.mapStyle) setMapStyle(reportConfig.mapStyle);
      if (reportConfig.showMapPolygon !== undefined) setShowMapPolygon(reportConfig.showMapPolygon);
      if (reportConfig.includeAgentFooter !== undefined) setIncludeAgentFooter(reportConfig.includeAgentFooter);
      if (reportConfig.coverPageConfig) setCoverPageConfig(reportConfig.coverPageConfig);
      if (reportConfig.coverLetterOverride) setCoverLetterOverride(reportConfig.coverLetterOverride);
      if (reportConfig.customPhotoSelections) setCustomPhotoSelections(reportConfig.customPhotoSelections);
    }
    if (cma?.brochure) setBrochure(cma.brochure);
    if (cma?.adjustments) setAdjustments(cma.adjustments);
  }, [reportConfig, cma]);

  // Save mutation
  const saveMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch(`/api/cmas/${cmaId}/report-config`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          includedSections,
          sectionOrder,
          layout,
          photoLayout,
          mapStyle,
          showMapPolygon,
          includeAgentFooter,
          coverPageConfig,
          coverLetterOverride,
          customPhotoSelections,
        }),
      });
      if (!response.ok) throw new Error('Failed to save');
      return response.json();
    },
    onSuccess: () => {
      setHasChanges(false);
      toast({ title: 'Saved', description: 'Presentation settings saved successfully.' });
      queryClient.invalidateQueries({ queryKey: ['cma-report-config', cmaId] });
    },
    onError: () => {
      toast({ title: 'Error', description: 'Failed to save settings.', variant: 'destructive' });
    },
  });

  // Derived data
  const properties = useMemo(() => cma?.comparablesData || cma?.propertiesData || [], [cma]);
  const subjectProperty = useMemo(() => 
    cma?.subjectPropertyData || properties.find((p: any) => p.listingId === cma?.subjectPropertyId), 
    [properties, cma]
  );
  const comparables = useMemo(() => 
    properties.filter((p: any) => p.listingId !== cma?.subjectPropertyId), 
    [properties, cma?.subjectPropertyId]
  );

  // Handlers
  const handleSectionToggle = (sectionId: string) => {
    setIncludedSections(prev => 
      prev.includes(sectionId) 
        ? prev.filter(id => id !== sectionId)
        : [...prev, sectionId]
    );
    setHasChanges(true);
  };

  const handleExportPDF = async () => {
    setIsExporting(true);
    try {
      toast({ title: 'Export started', description: 'Generating your PDF...' });
      
      // TODO: Implement PDF export with @react-pdf/renderer
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      toast({ title: 'PDF exported', description: 'Your CMA presentation has been downloaded.' });
    } catch (error) {
      console.error('PDF export error:', error);
      toast({ title: 'Export failed', description: 'Please try again.', variant: 'destructive' });
    } finally {
      setIsExporting(false);
    }
  };

  const handleReset = () => {
    setIncludedSections(DEFAULT_ENABLED_SECTIONS);
    setSectionOrder(ALL_SECTION_IDS);
    setLayout("two_photos");
    setPhotoLayout("first_dozen");
    setMapStyle("streets");
    setShowMapPolygon(true);
    setIncludeAgentFooter(true);
    setCoverPageConfig(DEFAULT_COVER_PAGE_CONFIG);
    setCoverLetterOverride("");
    setHasChanges(true);
  };

  // Loading state
  if (cmaLoading || configLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!cma) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen gap-4">
        <p className="text-muted-foreground">CMA not found</p>
        <Button onClick={() => navigate('/transactions')}>Back to Transactions</Button>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="bg-card border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => navigate(`/transactions/${cma.transactionId || ''}`)}
                className="gap-2"
              >
                <ArrowLeft className="w-4 h-4" />
                Back to CMA
              </Button>
              <div>
                <h1 className="text-xl font-semibold">Presentation Builder</h1>
                <p className="text-sm text-muted-foreground">{cma.name}</p>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleReset}
                className="gap-2"
              >
                <RotateCcw className="w-4 h-4" />
                Reset
              </Button>
              
              <Button
                variant="default"
                size="sm"
                onClick={() => saveMutation.mutate()}
                disabled={!hasChanges || saveMutation.isPending}
                className="gap-2 bg-[#F37216] hover:bg-[#F37216]/90"
              >
                {saveMutation.isPending ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Save className="w-4 h-4" />
                )}
                Save Configuration
              </Button>

              <Button
                variant="outline"
                size="sm"
                onClick={handleExportPDF}
                disabled={isExporting}
                className="gap-2"
              >
                {isExporting ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <FileDown className="w-4 h-4" />
                )}
                Export PDF
              </Button>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 py-6">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Left: Configuration Tabs */}
          <div>
            <Card>
              <Tabs value={activeTab} onValueChange={setActiveTab}>
                <CardHeader className="pb-0">
                  <TabsList className="w-full justify-start">
                    <TabsTrigger value="sections" className="gap-2">
                      <LayoutGrid className="w-4 h-4" />
                      Sections
                    </TabsTrigger>
                    <TabsTrigger value="content" className="gap-2">
                      <FileText className="w-4 h-4" />
                      Content
                    </TabsTrigger>
                    <TabsTrigger value="layout" className="gap-2">
                      <Settings2 className="w-4 h-4" />
                      Layout
                    </TabsTrigger>
                  </TabsList>
                </CardHeader>

                <CardContent className="pt-6">
                  {/* Sections Tab */}
                  <TabsContent value="sections" className="mt-0">
                    <div className="space-y-6">
                      {Object.entries(SECTION_CATEGORIES).map(([category, sections]) => (
                        <div key={category}>
                          <h3 className="font-medium capitalize mb-3 text-sm text-muted-foreground uppercase tracking-wide">
                            {category}
                          </h3>
                          <div className="space-y-2">
                            {sections.map(section => (
                              <div 
                                key={section.id}
                                className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
                              >
                                <div className="flex items-center gap-3">
                                  <GripVertical className="w-4 h-4 text-muted-foreground cursor-grab" />
                                  <span className="text-sm">{section.name}</span>
                                  {section.editable && (
                                    <Badge variant="outline" className="text-xs">Editable</Badge>
                                  )}
                                </div>
                                <Switch
                                  checked={includedSections.includes(section.id)}
                                  onCheckedChange={() => handleSectionToggle(section.id)}
                                />
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  </TabsContent>

                  {/* Content Tab */}
                  <TabsContent value="content" className="mt-0">
                    <div className="space-y-6">
                      <div>
                        <h3 className="font-medium mb-3">Cover Page Settings</h3>
                        <div className="space-y-4">
                          <div>
                            <Label>Title</Label>
                            <input 
                              className="w-full mt-1 px-3 py-2 border rounded-md bg-background"
                              value={coverPageConfig.title}
                              onChange={(e) => {
                                setCoverPageConfig(prev => ({ ...prev, title: e.target.value }));
                                setHasChanges(true);
                              }}
                            />
                          </div>
                          <div>
                            <Label>Subtitle</Label>
                            <input 
                              className="w-full mt-1 px-3 py-2 border rounded-md bg-background"
                              value={coverPageConfig.subtitle}
                              onChange={(e) => {
                                setCoverPageConfig(prev => ({ ...prev, subtitle: e.target.value }));
                                setHasChanges(true);
                              }}
                            />
                          </div>
                          <div className="flex items-center justify-between">
                            <Label>Show Date</Label>
                            <Switch 
                              checked={coverPageConfig.showDate}
                              onCheckedChange={(checked) => {
                                setCoverPageConfig(prev => ({ ...prev, showDate: checked }));
                                setHasChanges(true);
                              }}
                            />
                          </div>
                          <div className="flex items-center justify-between">
                            <Label>Show Agent Photo</Label>
                            <Switch 
                              checked={coverPageConfig.showAgentPhoto}
                              onCheckedChange={(checked) => {
                                setCoverPageConfig(prev => ({ ...prev, showAgentPhoto: checked }));
                                setHasChanges(true);
                              }}
                            />
                          </div>
                        </div>
                      </div>

                      <div>
                        <h3 className="font-medium mb-3">Cover Letter</h3>
                        <textarea 
                          className="w-full h-32 px-3 py-2 border rounded-md bg-background resize-none"
                          placeholder="Enter custom cover letter or leave blank for AI-generated..."
                          value={coverLetterOverride}
                          onChange={(e) => {
                            setCoverLetterOverride(e.target.value);
                            setHasChanges(true);
                          }}
                        />
                        <Button 
                          variant="outline" 
                          size="sm" 
                          className="mt-2"
                          onClick={() => {
                            toast({ title: 'Coming soon', description: 'AI cover letter generation will be available soon.' });
                          }}
                        >
                          Generate with AI
                        </Button>
                      </div>
                    </div>
                  </TabsContent>

                  {/* Layout Tab */}
                  <TabsContent value="layout" className="mt-0">
                    <div className="space-y-6">
                      <div>
                        <Label>Property Layout</Label>
                        <Select value={layout} onValueChange={(v) => { setLayout(v); setHasChanges(true); }}>
                          <SelectTrigger className="mt-1">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            {LAYOUT_OPTIONS.map(opt => (
                              <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      <div>
                        <Label>Photo Selection</Label>
                        <Select value={photoLayout} onValueChange={(v) => { setPhotoLayout(v); setHasChanges(true); }}>
                          <SelectTrigger className="mt-1">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            {PHOTO_LAYOUT_OPTIONS.map(opt => (
                              <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      <div>
                        <Label>Map Style</Label>
                        <Select value={mapStyle} onValueChange={(v: "streets" | "satellite") => { setMapStyle(v); setHasChanges(true); }}>
                          <SelectTrigger className="mt-1">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            {MAP_STYLE_OPTIONS.map(opt => (
                              <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      <div className="flex items-center justify-between">
                        <div>
                          <Label>Show Map Polygon</Label>
                          <p className="text-xs text-muted-foreground">Display search area boundary</p>
                        </div>
                        <Switch 
                          checked={showMapPolygon}
                          onCheckedChange={(checked) => { setShowMapPolygon(checked); setHasChanges(true); }}
                        />
                      </div>

                      <div className="flex items-center justify-between">
                        <div>
                          <Label>Include Agent Footer</Label>
                          <p className="text-xs text-muted-foreground">Show agent info on each page</p>
                        </div>
                        <Switch 
                          checked={includeAgentFooter}
                          onCheckedChange={(checked) => { setIncludeAgentFooter(checked); setHasChanges(true); }}
                        />
                      </div>
                    </div>
                  </TabsContent>
                </CardContent>
              </Tabs>
            </Card>
          </div>

          {/* Right: Live Preview */}
          <div className="lg:sticky lg:top-24 lg:self-start">
            <Card>
              <CardHeader className="pb-3">
                <div className="flex items-center justify-between gap-2">
                  <div>
                    <CardTitle className="text-lg">Live Preview</CardTitle>
                    <CardDescription>Preview how your CMA presentation will appear</CardDescription>
                  </div>
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <Badge variant="outline">{includedSections.length} sections</Badge>
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      onClick={() => setIsPreviewModalOpen(true)}
                    >
                      <Expand className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <ScrollArea className="h-[500px] md:h-[600px] lg:h-[calc(100vh-200px)] lg:min-h-[600px] lg:max-h-[900px]">
                  <div className={`p-4 space-y-4 transition-opacity duration-300 ${isPreviewUpdating ? "opacity-50" : "opacity-100"}`}>
                    {/* Preview Content */}
                    <div className="bg-white rounded-lg shadow-sm border p-4 text-center">
                      <div className="text-[#F37216] font-medium text-sm mb-1">SPYGLASS REALTY</div>
                      <h2 className="text-xl font-bold">{coverPageConfig.title}</h2>
                      <p className="text-muted-foreground text-sm">{coverPageConfig.subtitle}</p>
                      {coverPageConfig.showDate && (
                        <p className="text-xs text-muted-foreground mt-2">{new Date().toLocaleDateString()}</p>
                      )}
                    </div>

                    {/* Section previews */}
                    {includedSections.includes('summary_comparables') && (
                      <div className="bg-white rounded-lg shadow-sm border p-4">
                        <h3 className="font-medium mb-2">Summary of Comparables</h3>
                        <p className="text-sm text-muted-foreground">
                          {comparables.length} comparable properties
                        </p>
                      </div>
                    )}

                    {includedSections.includes('map_all_listings') && (
                      <div className="bg-white rounded-lg shadow-sm border p-4">
                        <h3 className="font-medium mb-2">Map of All Listings</h3>
                        <div className="h-32 bg-muted rounded flex items-center justify-center">
                          <span className="text-sm text-muted-foreground">Map Preview ({mapStyle})</span>
                        </div>
                      </div>
                    )}

                    {includedSections.includes('comparable_stats') && (
                      <div className="bg-white rounded-lg shadow-sm border p-4">
                        <h3 className="font-medium mb-2">Comparable Statistics</h3>
                        <p className="text-sm text-muted-foreground">Price analysis and market trends</p>
                      </div>
                    )}

                    {includedSections.filter(s => !['cover_page', 'summary_comparables', 'map_all_listings', 'comparable_stats'].includes(s)).map(sectionId => {
                      const section = CMA_REPORT_SECTIONS.find(s => s.id === sectionId);
                      return section ? (
                        <div key={sectionId} className="bg-white rounded-lg shadow-sm border p-4">
                          <h3 className="font-medium text-sm">{section.name}</h3>
                        </div>
                      ) : null;
                    })}
                  </div>
                </ScrollArea>
              </CardContent>
            </Card>
          </div>
        </div>
      </main>
    </div>
  );
}
```

---

## PHASE 6: API Routes

Add to your server routes file (e.g., `server/routes.ts` or `server/routes/cmas.ts`):

```typescript
import { eq } from 'drizzle-orm';
import { cmaReportConfigs, cmaReportTemplates } from '@shared/schema';
import { DEFAULT_ENABLED_SECTIONS, ALL_SECTION_IDS } from '@shared/cma-sections';
import { DEFAULT_COVER_PAGE_CONFIG } from '@shared/cma-defaults';

// Get report config
app.get('/api/cmas/:id/report-config', requireAuth, async (req, res) => {
  try {
    const { id } = req.params;
    
    const [config] = await db.select()
      .from(cmaReportConfigs)
      .where(eq(cmaReportConfigs.cmaId, parseInt(id)))
      .limit(1);
    
    if (!config) {
      return res.json({
        includedSections: DEFAULT_ENABLED_SECTIONS,
        sectionOrder: ALL_SECTION_IDS,
        layout: 'two_photos',
        photoLayout: 'first_dozen',
        mapStyle: 'streets',
        showMapPolygon: true,
        includeAgentFooter: true,
        coverPageConfig: DEFAULT_COVER_PAGE_CONFIG,
      });
    }
    
    res.json(config);
  } catch (error) {
    console.error('Error fetching report config:', error);
    res.status(500).json({ error: 'Failed to fetch report config' });
  }
});

// Save report config
app.put('/api/cmas/:id/report-config', requireAuth, async (req, res) => {
  try {
    const { id } = req.params;
    const config = req.body;
    const cmaIdInt = parseInt(id);
    
    const [existing] = await db.select()
      .from(cmaReportConfigs)
      .where(eq(cmaReportConfigs.cmaId, cmaIdInt))
      .limit(1);
    
    if (existing) {
      await db.update(cmaReportConfigs)
        .set({ ...config, updatedAt: new Date() })
        .where(eq(cmaReportConfigs.cmaId, cmaIdInt));
    } else {
      await db.insert(cmaReportConfigs)
        .values({ cmaId: cmaIdInt, ...config });
    }
    
    res.json({ success: true });
  } catch (error) {
    console.error('Error saving report config:', error);
    res.status(500).json({ error: 'Failed to save report config' });
  }
});

// Get available sections
app.get('/api/cma/report-sections', (req, res) => {
  const { CMA_REPORT_SECTIONS } = require('@shared/cma-sections');
  res.json(CMA_REPORT_SECTIONS);
});
```

---

## PHASE 7: Register Route

Add to your client routing configuration (e.g., `client/src/App.tsx` or wherever routes are defined):

```typescript
import CMAPresentationBuilder from '@/pages/CMAPresentationBuilder';

// Add this route
<Route path="/cmas/:id/presentation" component={CMAPresentationBuilder} />
```

---

## PHASE 8: Add Navigation Button

In your CMA Tab or CMA detail component, add a button to navigate to the Presentation Builder:

```typescript
import { LayoutGrid } from 'lucide-react';
import { useLocation } from 'wouter';

// Inside your component:
const [, navigate] = useLocation();

// Add this button to your CMA header actions:
<Button
  variant="outline"
  disabled={!savedCma || comparables.length === 0}
  onClick={() => navigate(`/cmas/${savedCma.id}/presentation`)}
  className="gap-2"
>
  <LayoutGrid className="w-4 h-4" />
  Presentation
</Button>
```

---

## PHASE 9: Environment Variables

Ensure these are set in your `.env` file:

```bash
# Mapbox (for interactive maps in presentation)
VITE_MAPBOX_TOKEN=pk.your_mapbox_token

# OpenAI (for AI cover letter generation - Phase 2)
OPENAI_API_KEY=sk-your_openai_key
```

---

## ACCEPTANCE CRITERIA

After implementing this scaffold:

- [ ] Database tables created: `cma_report_configs`, `cma_report_templates`
- [ ] All TypeScript types compile without errors
- [ ] Section constants defined with 17 sections (7 intro, 6 listings, 4 analysis)
- [ ] Main page renders at `/cmas/:id/presentation`
- [ ] Three tabs (Sections, Content, Layout) are visible and functional
- [ ] Section toggles work (switches enable/disable sections)
- [ ] Live Preview panel shows section count and previews
- [ ] Save button triggers API call and shows success toast
- [ ] Reset button restores defaults
- [ ] Back button navigates to transaction
- [ ] API routes respond correctly
- [ ] No console errors on page load

---

## NEXT STEPS (PHASE 2)

After scaffold is working:

1. **Implement DndKit** for section drag-and-drop reordering
2. **Implement MapboxCMAMap** component with status colors and polygon
3. **Implement CMAPdfDocument** with @react-pdf/renderer
4. **Implement AI cover letter generation** endpoint
5. **Implement brochure upload** functionality
6. **Implement ExpandedPreviewModal** for full-screen preview
7. **Test full PDF export** end-to-end

---

## FILE STRUCTURE SUMMARY

```
shared/
  schema.ts          (update - add types and tables)
  cma-sections.ts    (create)
  cma-defaults.ts    (create)

client/src/
  pages/
    CMAPresentationBuilder.tsx    (create)
  lib/
    statusColors.ts               (create)
    pdfStyles.ts                  (create)
    adjustmentCalculations.ts     (create)

server/
  routes.ts          (update - add report config endpoints)
```