I found the Repliers Image Insights information. Now let me create a comprehensive Replit prompt for the Layout tab with AI photo selection:

Replit Prompt: Enhance Layout Tab with Photo Options & AI Selection
Task
Add photo selection options to the Layout tab in CMA Presentation Builder, including integration with Repliers Image Insights API for AI-powered photo selection.

Reference Screenshots
The Layout tab should have these dropdowns:

Photos per property - One, Two, Three, Four, Six photos
Photo source - First 12 Photos, All Photos, AI Suggested (Best Quality), Custom Selection
Property display layout - Two Photos per Property, Single Photo per Property, No Photos


Part 1: Add Layout State
tsx// In CMAPresentationBuilder.tsx - add to state

const [layoutSettings, setLayoutSettings] = useState({
  photosPerProperty: 1,
  photoSource: 'first12',
  propertyDisplayLayout: 'twoPhotos',
});

// Photo source options
const photoSourceOptions = [
  { value: 'first12', label: 'First 12 Photos' },
  { value: 'all', label: 'All Photos' },
  { value: 'aiSuggested', label: 'AI Suggested (Best Quality)' },
  { value: 'custom', label: 'Custom Selection' },
];

// Photos per property options
const photosPerPropertyOptions = [
  { value: 1, label: 'One photo per property' },
  { value: 2, label: 'Two photos per property' },
  { value: 3, label: 'Three photos per property' },
  { value: 4, label: 'Four photos per property' },
  { value: 6, label: 'Six photos per property' },
];

// Property display layout options
const propertyDisplayOptions = [
  { value: 'twoPhotos', label: 'Two Photos per Property' },
  { value: 'singlePhoto', label: 'Single Photo per Property' },
  { value: 'noPhotos', label: 'No Photos' },
];

Part 2: Layout Tab JSX
tsx{/* Layout Tab Content */}
{activeTab === 'layout' && (
  <div className="space-y-6">
    {/* Property Layout Section */}
    <div className="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
      <h2 className="text-lg font-semibold text-gray-900 dark:text-white mb-1">
        Property Layout
      </h2>
      <p className="text-sm text-gray-500 dark:text-gray-400 mb-6">
        Choose how properties are displayed in the report
      </p>

      <div className="space-y-6">
        {/* Photos per property */}
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Photos per property
          </label>
          <Select
            value={layoutSettings.photosPerProperty.toString()}
            onValueChange={(value) => setLayoutSettings(prev => ({
              ...prev,
              photosPerProperty: parseInt(value)
            }))}
          >
            <SelectTrigger className="w-full bg-white dark:bg-gray-800">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {photosPerPropertyOptions.map(option => (
                <SelectItem key={option.value} value={option.value.toString()}>
                  {option.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Photo source */}
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Photo source
          </label>
          <Select
            value={layoutSettings.photoSource}
            onValueChange={(value) => setLayoutSettings(prev => ({
              ...prev,
              photoSource: value
            }))}
          >
            <SelectTrigger className="w-full bg-white dark:bg-gray-800">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {photoSourceOptions.map(option => (
                <SelectItem key={option.value} value={option.value}>
                  <div className="flex items-center gap-2">
                    {option.value === 'aiSuggested' && (
                      <Sparkles className="w-4 h-4 text-yellow-500" />
                    )}
                    {option.label}
                  </div>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Photos are pulled directly from MLS listing via Repliers API
          </p>
        </div>

        {/* Property display layout */}
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Property display layout
          </label>
          <Select
            value={layoutSettings.propertyDisplayLayout}
            onValueChange={(value) => setLayoutSettings(prev => ({
              ...prev,
              propertyDisplayLayout: value
            }))}
          >
            <SelectTrigger className="w-full bg-white dark:bg-gray-800">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {propertyDisplayOptions.map(option => (
                <SelectItem key={option.value} value={option.value}>
                  {option.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>
    </div>

    {/* Photo Preview Section - Shows when AI Suggested or Custom is selected */}
    {(layoutSettings.photoSource === 'aiSuggested' || layoutSettings.photoSource === 'custom') && (
      <PhotoSelectionPreview 
        properties={[subjectProperty, ...comparables]}
        photoSource={layoutSettings.photoSource}
        photosPerProperty={layoutSettings.photosPerProperty}
        onSelectionChange={(selections) => setCustomPhotoSelections(selections)}
      />
    )}
  </div>
)}

Part 3: Photo Selection Preview Component
tsx// client/src/components/cma/PhotoSelectionPreview.tsx

import React, { useState, useEffect } from 'react';
import { Sparkles, Check, Image as ImageIcon, Loader2 } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';

interface PhotoSelectionPreviewProps {
  properties: any[];
  photoSource: 'aiSuggested' | 'custom';
  photosPerProperty: number;
  onSelectionChange: (selections: Record<string, string[]>) => void;
}

export function PhotoSelectionPreview({
  properties,
  photoSource,
  photosPerProperty,
  onSelectionChange,
}: PhotoSelectionPreviewProps) {
  const [selections, setSelections] = useState<Record<string, string[]>>({});
  const [aiRecommendations, setAiRecommendations] = useState<Record<string, any[]>>({});
  const [loading, setLoading] = useState(false);

  // Fetch AI recommendations when source is 'aiSuggested'
  useEffect(() => {
    if (photoSource === 'aiSuggested') {
      fetchAiRecommendations();
    }
  }, [photoSource, properties]);

  const fetchAiRecommendations = async () => {
    setLoading(true);
    try {
      // Fetch image insights for each property
      const recommendations: Record<string, any[]> = {};
      
      for (const property of properties) {
        if (!property?.listingId) continue;
        
        // Check if property already has imageInsights
        if (property.imageInsights?.images) {
          recommendations[property.listingId] = getTopPhotos(property.imageInsights.images, photosPerProperty);
        } else {
          // Fetch from API if not present
          const response = await fetch(`/api/repliers/listing/${property.listingId}/image-insights`);
          if (response.ok) {
            const data = await response.json();
            recommendations[property.listingId] = getTopPhotos(data.images || [], photosPerProperty);
          }
        }
      }
      
      setAiRecommendations(recommendations);
      
      // Auto-select AI recommendations
      const autoSelections: Record<string, string[]> = {};
      for (const [listingId, photos] of Object.entries(recommendations)) {
        autoSelections[listingId] = photos.map((p: any) => p.url);
      }
      setSelections(autoSelections);
      onSelectionChange(autoSelections);
      
    } catch (error) {
      console.error('Failed to fetch AI recommendations:', error);
    } finally {
      setLoading(false);
    }
  };

  // Get top photos based on Image Insights quality and classification
  const getTopPhotos = (images: any[], count: number) => {
    // Priority: Exterior/Front > Kitchen > Living Room > Pool > Other high-quality
    const priorityOrder = ['front', 'exterior', 'kitchen', 'living', 'pool', 'patio', 'backyard'];
    
    const scored = images.map((img, index) => {
      let score = 0;
      const classification = img.classification?.imageOf?.toLowerCase() || '';
      
      // Quality score
      if (img.quality?.qualitative === 'excellent') score += 100;
      else if (img.quality?.qualitative === 'above average') score += 75;
      else if (img.quality?.qualitative === 'average') score += 50;
      
      // Classification priority score
      const priorityIndex = priorityOrder.findIndex(p => classification.includes(p));
      if (priorityIndex !== -1) {
        score += (priorityOrder.length - priorityIndex) * 20;
      }
      
      // Numeric quality score if available
      if (img.quality?.score) {
        score += img.quality.score * 10;
      }
      
      return { ...img, score, originalIndex: index };
    });
    
    // Sort by score descending and take top N
    return scored
      .sort((a, b) => b.score - a.score)
      .slice(0, count);
  };

  const togglePhotoSelection = (propertyId: string, photoUrl: string) => {
    setSelections(prev => {
      const current = prev[propertyId] || [];
      let updated: string[];
      
      if (current.includes(photoUrl)) {
        updated = current.filter(url => url !== photoUrl);
      } else if (current.length < photosPerProperty) {
        updated = [...current, photoUrl];
      } else {
        // Replace oldest selection
        updated = [...current.slice(1), photoUrl];
      }
      
      const newSelections = { ...prev, [propertyId]: updated };
      onSelectionChange(newSelections);
      return newSelections;
    });
  };

  if (loading) {
    return (
      <div className="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
        <div className="flex items-center justify-center gap-2 py-8">
          <Loader2 className="w-5 h-5 animate-spin text-primary" />
          <span className="text-gray-500">Analyzing photos with AI...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
      <div className="flex items-center gap-2 mb-4">
        {photoSource === 'aiSuggested' ? (
          <>
            <Sparkles className="w-5 h-5 text-yellow-500" />
            <h3 className="font-semibold text-gray-900 dark:text-white">AI Suggested Photos</h3>
            <Badge variant="secondary" className="text-xs">Repliers Image Insights</Badge>
          </>
        ) : (
          <>
            <ImageIcon className="w-5 h-5 text-gray-500" />
            <h3 className="font-semibold text-gray-900 dark:text-white">Custom Photo Selection</h3>
          </>
        )}
      </div>
      
      <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
        {photoSource === 'aiSuggested' 
          ? 'AI has selected the best quality photos based on image classification and quality scores.'
          : `Select up to ${photosPerProperty} photo(s) per property.`
        }
      </p>

      <div className="space-y-6">
        {properties.filter(Boolean).map((property) => {
          const propertyId = property.listingId || property.id;
          const photos = property.photos || property.images || [];
          const selectedPhotos = selections[propertyId] || [];
          const aiRecs = aiRecommendations[propertyId] || [];
          
          return (
            <div key={propertyId} className="border-t border-gray-200 dark:border-gray-700 pt-4 first:border-t-0 first:pt-0">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                    {property.unparsedAddress?.split(',')[0] || property.address || 'Property'}
                  </h4>
                  <span className="text-xs text-gray-500">
                    {photos.length} available â€¢ {selectedPhotos.length}/{photosPerProperty} selected
                  </span>
                </div>
              </div>
              
              <div className="grid grid-cols-6 gap-2">
                {photos.slice(0, 12).map((photo: string, idx: number) => {
                  const isSelected = selectedPhotos.includes(photo);
                  const aiRec = aiRecs.find((r: any) => r.url === photo || r.originalIndex === idx);
                  
                  return (
                    <button
                      key={idx}
                      onClick={() => togglePhotoSelection(propertyId, photo)}
                      className={cn(
                        "relative aspect-square rounded-lg overflow-hidden border-2 transition-all",
                        isSelected 
                          ? "border-primary ring-2 ring-primary/20" 
                          : "border-transparent hover:border-gray-300 dark:hover:border-gray-600"
                      )}
                    >
                      <img 
                        src={photo} 
                        alt={`Photo ${idx + 1}`}
                        className="w-full h-full object-cover"
                      />
                      
                      {/* Selection indicator */}
                      {isSelected && (
                        <div className="absolute top-1 right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center">
                          <Check className="w-3 h-3 text-white" />
                        </div>
                      )}
                      
                      {/* AI badge */}
                      {aiRec && photoSource === 'aiSuggested' && (
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-1">
                          <span className="text-[10px] text-white font-medium">
                            {aiRec.classification?.imageOf || 'Best'}
                          </span>
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

Part 4: API Endpoint for Image Insights
typescript// server/routes.ts - Add endpoint to fetch Image Insights

// GET /api/repliers/listing/:listingId/image-insights
app.get('/api/repliers/listing/:listingId/image-insights', async (req, res) => {
  try {
    const { listingId } = req.params;
    
    // Fetch listing with imageInsights from Repliers
    const response = await fetch(
      `https://api.repliers.io/listings/${listingId}?fields=imageInsights,photos`,
      {
        headers: {
          'Authorization': `Bearer ${process.env.REPLIERS_API_KEY}`,
          'Content-Type': 'application/json',
        },
      }
    );
    
    if (!response.ok) {
      throw new Error('Failed to fetch from Repliers');
    }
    
    const data = await response.json();
    
    // Check if Image Insights is available
    if (data.imageInsights?.images) {
      return res.json({
        available: true,
        images: data.imageInsights.images.map((img: any, index: number) => ({
          url: data.photos?.[index] || img.url,
          originalIndex: index,
          classification: img.classification,
          quality: img.quality,
        })),
      });
    }
    
    // Fallback: return photos without insights
    return res.json({
      available: false,
      images: (data.photos || []).map((url: string, index: number) => ({
        url,
        originalIndex: index,
        classification: null,
        quality: null,
      })),
    });
    
  } catch (error) {
    console.error('Image insights error:', error);
    return res.status(500).json({ 
      error: 'Failed to fetch image insights',
      available: false,
      images: [],
    });
  }
});

Part 5: Required Imports
tsx// Add to CMAPresentationBuilder.tsx imports
import { Sparkles } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { PhotoSelectionPreview } from '@/components/cma/PhotoSelectionPreview';

Files to Create/Modify

client/src/pages/CMAPresentationBuilder.tsx - Add Layout tab content
client/src/components/cma/PhotoSelectionPreview.tsx - Create new component
server/routes.ts - Add image insights endpoint


Acceptance Criteria

 Layout tab shows three dropdown selects matching the screenshot design
 "Photos per property" has 5 options (1, 2, 3, 4, 6)
 "Photo source" has 4 options with sparkle icon on AI Suggested
 "Property display layout" has 3 options
 Helper text shows under Photo source dropdown
 When "AI Suggested" is selected, PhotoSelectionPreview shows with AI badges
 When "Custom Selection" is selected, user can manually select photos
 AI recommendations prioritize: Exterior > Kitchen > Living Room > Pool
 Selected photos show checkmark indicator
 Photo count shows "X/Y selected" per property