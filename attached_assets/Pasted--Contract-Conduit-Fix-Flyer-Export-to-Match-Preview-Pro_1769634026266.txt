# Contract Conduit ‚Äî Fix Flyer Export to Match Preview

## üìå Problem

The exported PNG/CMYK flyer is **NOT matching the Live Preview**. Several elements are missing from the export:

| Element | In Preview? | In Export? | Status |
|---------|-------------|------------|--------|
| Spyglass Logo | ‚úÖ | ‚úÖ | OK |
| Secondary Logo (Leading RE) | ‚úÖ | ‚ùå | **MISSING** |
| Price Badge | ‚úÖ | ‚úÖ | OK |
| Address | ‚úÖ | ‚úÖ | OK |
| Main Photo | ‚úÖ | ‚úÖ | OK |
| Secondary Photos | ‚úÖ | ‚úÖ | OK |
| Beds/Baths/Sq Ft | ‚úÖ | ‚úÖ | OK |
| Headline | ‚úÖ | ‚úÖ | OK |
| Description | ‚úÖ | ‚úÖ | OK |
| Agent Photo | ‚úÖ | ‚úÖ | OK |
| **Agent Name** | ‚úÖ | ‚ùå | **MISSING** |
| **Agent Title** | ‚úÖ | Shows wrong | **WRONG** |
| **Agent Phone** | ‚úÖ | ‚ùå | **MISSING** |
| **QR Code** | ‚úÖ | ‚ùå | **MISSING** |

---

## üéØ Goal

**The exported PNG/CMYK must be an EXACT match of the Live Preview.**

Whatever the user sees in the preview is what they should get in the download.

---

## üîß Fix: Export Template

The server-side export template (used by Puppeteer) needs to include ALL elements from the preview.

### Check the Export Endpoint

Find the export endpoint (likely `/api/flyer/export-png` or similar) and ensure it receives ALL data:

```typescript
// Client-side: Send ALL data to export endpoint
const handleExportPNG = async () => {
  setIsExporting(true);
  
  try {
    const response = await fetch('/api/flyer/export-png', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        // Property Details
        address: watchedValues.address,
        price: watchedValues.price,
        bedrooms: watchedValues.bedrooms,
        bathrooms: watchedValues.bathrooms,
        sqft: watchedValues.sqft,
        headline: watchedValues.introHeadline,
        description: watchedValues.introDescription,
        
        // Images
        mainPhoto: images.mainImage,
        kitchenPhoto: images.kitchenImage,
        roomPhoto: images.roomImage,
        
        // Agent Details - MAKE SURE THESE ARE INCLUDED
        agentName: watchedValues.agentName,        // ‚Üê REQUIRED
        agentTitle: watchedValues.agentTitle,      // ‚Üê REQUIRED
        agentPhone: watchedValues.phone,           // ‚Üê REQUIRED
        agentPhoto: images.agentPhoto,             // ‚Üê REQUIRED
        
        // Branding - MAKE SURE THESE ARE INCLUDED
        companyLogo: images.companyLogo,           // ‚Üê REQUIRED
        secondaryLogo: images.secondaryLogo,       // ‚Üê REQUIRED (Leading RE)
        logoScales: logoScales,                    // ‚Üê REQUIRED
        dividerPosition: dividerPosition,          // ‚Üê REQUIRED
        secondaryLogoOffsetY: secondaryLogoOffsetY, // ‚Üê REQUIRED
        
        // QR Code - MAKE SURE THIS IS INCLUDED
        qrCode: images.qrCode,                     // ‚Üê REQUIRED
      }),
    });
    
    // ... handle response
  } catch (error) {
    console.error('Export failed:', error);
  } finally {
    setIsExporting(false);
  }
};
```

### Fix the Server-Side HTML Template

The Puppeteer HTML template must render ALL these elements:

```typescript
// server/routes/flyer-export.ts or similar

function generateFlyerHTML(data: FlyerExportData): string {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      width: 2550px;  /* 8.5" x 300 DPI */
      height: 3300px; /* 11" x 300 DPI */
      background: white;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      padding: 60px 80px;
      border-bottom: 3px solid #8B7355;
      position: relative;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 30px;
    }
    
    .company-logo {
      height: 80px;
      object-fit: contain;
      transform: scale(${data.logoScales?.primary || 1});
    }
    
    .logo-divider {
      width: 2px;
      height: 60px;
      background: #d1d5db;
      margin-left: ${data.dividerPosition || 148}px;
    }
    
    .secondary-logo {
      height: 70px;
      object-fit: contain;
      transform: scale(${data.logoScales?.secondary || 1}) translateY(${data.secondaryLogoOffsetY || 0}px);
    }
    
    .price-badge {
      position: absolute;
      right: 0;
      top: 0;
      background: #8B7355;
      color: white;
      padding: 40px 60px;
      text-align: right;
    }
    
    .price-label {
      font-size: 24px;
      text-transform: uppercase;
      letter-spacing: 3px;
      opacity: 0.9;
    }
    
    .price-value {
      font-size: 64px;
      font-weight: bold;
    }
    
    /* Address */
    .address {
      padding: 40px 80px;
      font-size: 48px;
      font-weight: 600;
      letter-spacing: 2px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    /* Photos */
    .main-photo {
      width: 100%;
      height: 1100px;
      object-fit: cover;
    }
    
    .secondary-photos {
      display: flex;
    }
    
    .secondary-photo {
      width: 50%;
      height: 550px;
      object-fit: cover;
    }
    
    /* Bottom Section */
    .bottom-section {
      display: flex;
      padding: 60px 80px;
      gap: 60px;
    }
    
    /* Property Stats */
    .stats {
      width: 280px;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      font-size: 36px;
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
    }
    
    /* Description */
    .description-section {
      flex: 1;
    }
    
    .headline {
      font-size: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }
    
    .description {
      font-size: 28px;
      line-height: 1.5;
      color: #4b5563;
    }
    
    /* Agent Section */
    .agent-section {
      width: 350px;
      text-align: center;
    }
    
    .agent-photo {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 20px;
    }
    
    .agent-photo-placeholder {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: #e5e7eb;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }
    
    .agent-name {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .agent-title {
      font-size: 24px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .agent-phone {
      font-size: 24px;
      color: #6b7280;
      margin-bottom: 20px;
    }
    
    .qr-code {
      width: 140px;
      height: 140px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  
  <!-- ====== HEADER ====== -->
  <div class="header">
    <div class="logo-section">
      <!-- Company Logo -->
      ${data.companyLogo ? `
        <img src="${data.companyLogo}" alt="Company Logo" class="company-logo" />
      ` : ''}
      
      <!-- Divider -->
      ${data.secondaryLogo ? `
        <div class="logo-divider"></div>
      ` : ''}
      
      <!-- Secondary Logo (Leading RE) -->
      ${data.secondaryLogo ? `
        <img src="${data.secondaryLogo}" alt="Secondary Logo" class="secondary-logo" />
      ` : ''}
    </div>
    
    <!-- Price Badge -->
    <div class="price-badge">
      <div class="price-label">Offered At</div>
      <div class="price-value">${data.price || '$0'}</div>
    </div>
  </div>
  
  <!-- ====== ADDRESS ====== -->
  <div class="address">${data.address || ''}</div>
  
  <!-- ====== PHOTOS ====== -->
  ${data.mainPhoto ? `
    <img src="${data.mainPhoto}" alt="Main Photo" class="main-photo" />
  ` : '<div class="main-photo" style="background: #f3f4f6;"></div>'}
  
  <div class="secondary-photos">
    ${data.kitchenPhoto ? `
      <img src="${data.kitchenPhoto}" alt="Kitchen" class="secondary-photo" />
    ` : '<div class="secondary-photo" style="background: #e5e7eb;"></div>'}
    
    ${data.roomPhoto ? `
      <img src="${data.roomPhoto}" alt="Room" class="secondary-photo" />
    ` : '<div class="secondary-photo" style="background: #e5e7eb;"></div>'}
  </div>
  
  <!-- ====== BOTTOM SECTION ====== -->
  <div class="bottom-section">
    
    <!-- Property Stats -->
    <div class="stats">
      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span><strong>${data.bedrooms || '-'}</strong> bedrooms</span>
      </div>
      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 12h16a1 1 0 0 1 1 1v3a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4v-3a1 1 0 0 1 1-1z"></path>
          <path d="M6 12V5a2 2 0 0 1 2-2h3"></path>
        </svg>
        <span><strong>${data.bathrooms || '-'}</strong> bathrooms</span>
      </div>
      <div class="stat-item">
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        </svg>
        <span><strong>${data.sqft || '-'}</strong> sq. ft</span>
      </div>
    </div>
    
    <!-- Description -->
    <div class="description-section">
      ${data.headline ? `<div class="headline">${data.headline}</div>` : ''}
      ${data.description ? `<div class="description">${data.description}</div>` : ''}
    </div>
    
    <!-- Agent Section -->
    <div class="agent-section">
      <!-- Agent Photo -->
      ${data.agentPhoto ? `
        <img src="${data.agentPhoto}" alt="${data.agentName}" class="agent-photo" />
      ` : `
        <div class="agent-photo-placeholder">üë§</div>
      `}
      
      <!-- Agent Name - MUST BE INCLUDED -->
      ${data.agentName ? `
        <div class="agent-name">${data.agentName}</div>
      ` : ''}
      
      <!-- Agent Title - MUST BE INCLUDED -->
      ${data.agentTitle ? `
        <div class="agent-title">${data.agentTitle}</div>
      ` : ''}
      
      <!-- Agent Phone - MUST BE INCLUDED -->
      ${data.agentPhone ? `
        <div class="agent-phone">${data.agentPhone}</div>
      ` : ''}
      
      <!-- QR Code - MUST BE INCLUDED -->
      ${data.qrCode ? `
        <img src="${data.qrCode}" alt="QR Code" class="qr-code" />
      ` : ''}
    </div>
    
  </div>
  
</body>
</html>
  `;
}
```

---

## üìã Data Checklist for Export

Ensure the export endpoint receives and renders ALL of these:

### Property Data
- [ ] `address` ‚Äî Property address (uppercase)
- [ ] `price` ‚Äî Formatted price with $ and commas
- [ ] `bedrooms` ‚Äî Number of bedrooms
- [ ] `bathrooms` ‚Äî Number of bathrooms
- [ ] `sqft` ‚Äî Square footage with commas
- [ ] `headline` ‚Äî AI-generated or custom headline
- [ ] `description` ‚Äî Property description (truncated if needed)

### Images
- [ ] `mainPhoto` ‚Äî Main property photo URL
- [ ] `kitchenPhoto` ‚Äî Kitchen photo URL
- [ ] `roomPhoto` ‚Äî Additional room photo URL

### Agent Data (FROM SETTINGS)
- [ ] `agentName` ‚Äî Full name from Settings
- [ ] `agentTitle` ‚Äî Title from Settings (e.g., "REALTOR¬Æ")
- [ ] `agentPhone` ‚Äî Phone from Settings
- [ ] `agentPhoto` ‚Äî Profile photo from Settings

### Branding
- [ ] `companyLogo` ‚Äî Spyglass logo URL
- [ ] `secondaryLogo` ‚Äî Leading RE logo URL
- [ ] `logoScales` ‚Äî `{ primary: number, secondary: number }`
- [ ] `dividerPosition` ‚Äî Divider position in pixels
- [ ] `secondaryLogoOffsetY` ‚Äî Y offset for secondary logo

### QR Code
- [ ] `qrCode` ‚Äî Generated QR code as data URL (base64)

---

## üêõ Debug: Log What's Being Sent

Add console logs to verify data is being sent:

```typescript
// Before fetch call
const exportData = {
  address: watchedValues.address,
  price: watchedValues.price,
  // ... all other fields
  agentName: watchedValues.agentName,
  agentTitle: watchedValues.agentTitle,
  agentPhone: watchedValues.phone,
  qrCode: images.qrCode,
};

console.log('[Export] Sending data:', exportData);
console.log('[Export] Agent Name:', exportData.agentName);
console.log('[Export] Agent Title:', exportData.agentTitle);
console.log('[Export] Agent Phone:', exportData.agentPhone);
console.log('[Export] QR Code exists:', !!exportData.qrCode);
console.log('[Export] Secondary Logo:', exportData.secondaryLogo);
```

On the server side:
```typescript
// In export endpoint
app.post('/api/flyer/export-png', async (req, res) => {
  const data = req.body;
  
  console.log('[Export Server] Received data:');
  console.log('- Agent Name:', data.agentName);
  console.log('- Agent Title:', data.agentTitle);
  console.log('- Agent Phone:', data.agentPhone);
  console.log('- QR Code exists:', !!data.qrCode);
  console.log('- Secondary Logo:', data.secondaryLogo);
  
  // ... rest of export logic
});
```

---

## ‚úÖ Testing Checklist

After fix, verify the exported PNG contains:

### Header
- [ ] Spyglass logo at correct size
- [ ] Divider line visible
- [ ] **Secondary logo (Leading RE)** visible
- [ ] Logo sizes match preview
- [ ] Price badge with correct price

### Photos
- [ ] Main photo renders correctly
- [ ] Kitchen photo renders correctly
- [ ] Room photo renders correctly
- [ ] Photos match preview exactly

### Agent Section
- [ ] **Agent photo** visible
- [ ] **Agent name** visible (NOT just title)
- [ ] **Agent title** correct (from Settings)
- [ ] **Agent phone** visible
- [ ] **QR code** visible

### Overall
- [ ] Export matches Live Preview exactly
- [ ] No missing elements
- [ ] Correct fonts and sizing
- [ ] Same for PNG and CMYK exports