# CMA Presentation Builder â€” Replicate Comparable Properties Feature

## Objective

Update the **CompsWidget** in CMA Presentation Builder to match the full CMA tab's Comparable Properties feature, including:
- Stats summary row (Low/High/Avg Price, Median, Avg $/SqFt, Avg DOM)
- Status filter tabs (All, Closed, Active Under Contract, Pending, Active)
- View toggles (Grid, List, Table)
- Top tabs (Compare, Map, Stats, List)
- Property cards with full details

---

## Current State vs Target State

| Feature | Current (CompsWidget) | Target (CMA Tab Style) |
|---------|----------------------|------------------------|
| Stats row | Missing | Full stats: Low/High/Avg/Median/$/SqFt/DOM |
| Status filters | Missing | All, Closed, Active Under Contract, Pending, Active |
| View modes | Missing | Grid, List, Table toggles |
| Property cards | Basic photo + badge | Full card with address, price, beds/baths/sqft, $/sqft, DOM |
| Top tabs | Compare, Map, Stats | Compare, Map, Stats, List |

---

## Implementation

### File to Update:
```
client/src/components/cma-presentation/widgets/CompsWidget.tsx
```

### Reference Files:
```
client/src/components/cma-tab.tsx (main logic)
client/src/components/cma-stats-view.tsx (stats display)
client/src/components/cma-map.tsx (map component)
client/src/components/cma-presentation/types/index.ts (types)
```

---

## Step 1: Add State Management

```tsx
// Add these state variables to CompsWidget
const [mainView, setMainView] = useState<'compare' | 'map' | 'stats' | 'list'>('compare');
const [subView, setSubView] = useState<'grid' | 'list' | 'table'>('grid');
const [statusFilter, setStatusFilter] = useState<'all' | 'closed' | 'activeUnderContract' | 'pending' | 'active'>('all');
```

---

## Step 2: Add Filter Constants

```tsx
const STATUS_FILTERS = [
  { id: 'all', label: 'All' },
  { id: 'closed', label: 'Closed' },
  { id: 'activeUnderContract', label: 'Active Under Contract' },
  { id: 'pending', label: 'Pending' },
  { id: 'active', label: 'Active' },
];

const STATUS_COLORS: Record<string, string> = {
  closed: 'bg-green-500',
  active: 'bg-red-500',
  pending: 'bg-yellow-500',
  activeUnderContract: 'bg-amber-500',
};

const getStatusColor = (status: string) => {
  const s = status.toLowerCase();
  if (s.includes('closed')) return 'bg-green-500';
  if (s.includes('active') && !s.includes('under')) return 'bg-red-500';
  if (s.includes('pending') || s.includes('under')) return 'bg-yellow-500';
  return 'bg-gray-500';
};
```

---

## Step 3: Add Statistics Calculation

```tsx
interface CmaStatMetric {
  range: { min: number; max: number };
  average: number;
  median: number;
}

interface PropertyStatistics {
  price: CmaStatMetric;
  pricePerSqFt: CmaStatMetric;
  daysOnMarket: CmaStatMetric;
}

function calculateStatistics(comparables: CmaProperty[]): PropertyStatistics | null {
  if (!comparables || comparables.length === 0) return null;
  
  const calculateMetric = (values: number[]): CmaStatMetric => {
    const filtered = values.filter(v => v != null && !isNaN(v) && v > 0);
    if (filtered.length === 0) {
      return { range: { min: 0, max: 0 }, average: 0, median: 0 };
    }
    const sorted = [...filtered].sort((a, b) => a - b);
    const sum = sorted.reduce((acc, v) => acc + v, 0);
    const median = sorted.length % 2 === 0
      ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
      : sorted[Math.floor(sorted.length / 2)];
    
    return {
      range: { min: sorted[0], max: sorted[sorted.length - 1] },
      average: sum / sorted.length,
      median
    };
  };
  
  const pricePerSqFts = comparables
    .filter(c => c.sqft > 0)
    .map(c => c.price / c.sqft);
  
  return {
    price: calculateMetric(comparables.map(c => c.price)),
    pricePerSqFt: calculateMetric(pricePerSqFts),
    daysOnMarket: calculateMetric(comparables.map(c => c.daysOnMarket)),
  };
}
```

---

## Step 4: Filter Comparables by Status

```tsx
const filteredComparables = useMemo(() => {
  if (statusFilter === 'all') return comparables;
  
  return comparables.filter(comp => {
    const status = comp.status.toLowerCase();
    switch (statusFilter) {
      case 'closed':
        return status.includes('closed');
      case 'active':
        return status === 'active';
      case 'pending':
        return status.includes('pending');
      case 'activeUnderContract':
        return status.includes('under contract') || status.includes('active under');
      default:
        return true;
    }
  });
}, [comparables, statusFilter]);

const statistics = useMemo(() => calculateStatistics(filteredComparables), [filteredComparables]);
```

---

## Step 5: Component JSX Structure

```tsx
export function CompsWidget({ comparables, subjectProperty }: CompsWidgetProps) {
  const [mainView, setMainView] = useState<'compare' | 'map' | 'stats' | 'list'>('compare');
  const [subView, setSubView] = useState<'grid' | 'list' | 'table'>('grid');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  
  // ... filtering and stats calculation ...

  return (
    <div className="h-full flex flex-col bg-white">
      {/* Header */}
      <div className="p-4 border-b border-gray-200">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <h2 className="text-xl font-semibold text-gray-900">
              Comparable Properties
            </h2>
            <span className="text-sm text-gray-500">
              {filteredComparables.length} properties
            </span>
            <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">
              MLS
            </span>
          </div>
          
          {/* Main View Tabs */}
          <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
            {['compare', 'map', 'stats', 'list'].map(view => (
              <button
                key={view}
                onClick={() => setMainView(view as any)}
                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors min-h-[36px] ${
                  mainView === view
                    ? 'bg-white text-gray-900 shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                {view === 'compare' && 'ğŸ“Š Compare'}
                {view === 'map' && 'ğŸ—ºï¸ Map'}
                {view === 'stats' && 'ğŸ“ˆ Stats'}
                {view === 'list' && 'ğŸ“‹ List'}
              </button>
            ))}
          </div>
        </div>
        
        {/* Status Filter Tabs */}
        <div className="flex items-center gap-2 mb-4">
          {STATUS_FILTERS.map(filter => (
            <button
              key={filter.id}
              onClick={() => setStatusFilter(filter.id)}
              className={`px-3 py-1.5 text-sm font-medium rounded-full transition-colors min-h-[36px] ${
                statusFilter === filter.id
                  ? 'bg-gray-900 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {filter.label}
            </button>
          ))}
        </div>
        
        {/* Stats Summary Row */}
        {statistics && (
          <div className="grid grid-cols-2 md:grid-cols-6 gap-4 p-4 bg-gray-50 rounded-lg">
            <StatItem 
              label="LOW PRICE" 
              value={formatCurrency(statistics.price.range.min)} 
            />
            <StatItem 
              label="HIGH PRICE" 
              value={formatCurrency(statistics.price.range.max)} 
            />
            <StatItem 
              label="AVG PRICE" 
              value={formatCurrency(statistics.price.average)}
              subtext="â†“ 59.4% vs market"
              subtextColor="text-green-600"
            />
            <StatItem 
              label="MEDIAN" 
              value={formatCurrency(statistics.price.median)} 
            />
            <StatItem 
              label="AVG $/SQFT" 
              value={`$${Math.round(statistics.pricePerSqFt.average)}`} 
            />
            <StatItem 
              label="AVG DOM" 
              value={`${Math.round(statistics.daysOnMarket.average)} days`} 
            />
          </div>
        )}
        
        {/* View Toggle (Grid/List/Table) - only show in Compare view */}
        {mainView === 'compare' && (
          <div className="flex items-center gap-2 mt-4">
            <span className="text-sm text-gray-500">View:</span>
            {['grid', 'list', 'table'].map(view => (
              <button
                key={view}
                onClick={() => setSubView(view as any)}
                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors min-h-[36px] flex items-center gap-1 ${
                  subView === view
                    ? 'bg-gray-200 text-gray-900'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                {view === 'grid' && 'âŠ Grid'}
                {view === 'list' && 'â˜° List'}
                {view === 'table' && 'â–¤ Table'}
              </button>
            ))}
          </div>
        )}
      </div>
      
      {/* Content Area */}
      <div className="flex-1 overflow-auto p-4">
        {mainView === 'compare' && (
          <CompareView 
            comparables={filteredComparables}
            subjectProperty={subjectProperty}
            viewMode={subView}
          />
        )}
        {mainView === 'map' && (
          <MapView 
            comparables={filteredComparables}
            subjectProperty={subjectProperty}
          />
        )}
        {mainView === 'stats' && (
          <StatsView statistics={statistics} />
        )}
        {mainView === 'list' && (
          <ListView comparables={filteredComparables} />
        )}
      </div>
    </div>
  );
}
```

---

## Step 6: Sub-Components

### StatItem Component:
```tsx
function StatItem({ 
  label, 
  value, 
  subtext, 
  subtextColor = 'text-gray-500' 
}: { 
  label: string; 
  value: string; 
  subtext?: string;
  subtextColor?: string;
}) {
  return (
    <div>
      <p className="text-xs text-gray-500 font-medium uppercase tracking-wider">
        {label}
      </p>
      <p className="text-xl font-bold text-gray-900">{value}</p>
      {subtext && (
        <p className={`text-xs ${subtextColor}`}>{subtext}</p>
      )}
    </div>
  );
}
```

### PropertyCard Component (Grid View):
```tsx
function PropertyCard({ property, isSubject = false }: { property: CmaProperty; isSubject?: boolean }) {
  return (
    <div className={`rounded-lg border overflow-hidden ${isSubject ? 'border-[#EF4923] border-2' : 'border-gray-200'}`}>
      {/* Image */}
      <div className="relative aspect-[4/3]">
        <img 
          src={property.photos?.[0] || '/placeholder-property.jpg'} 
          alt={property.address}
          className="w-full h-full object-cover"
        />
        {/* Status Badge */}
        <div className="absolute top-3 left-3 flex items-center gap-2">
          <span className={`px-2 py-1 text-xs font-medium text-white rounded ${getStatusColor(property.status)}`}>
            {isSubject ? 'Subject' : property.status}
          </span>
          {property.distance && (
            <span className="px-2 py-1 text-xs font-medium bg-white/90 text-gray-700 rounded">
              {property.distance} mi
            </span>
          )}
        </div>
      </div>
      
      {/* Details */}
      <div className="p-4">
        <p className="font-medium text-gray-900 truncate">{property.address}</p>
        <div className="flex items-baseline justify-between mt-1">
          <p className="text-xl font-bold text-gray-900">
            {formatCurrency(property.price)}
          </p>
          <p className="text-sm text-gray-500">
            ${Math.round(property.pricePerSqft || property.price / property.sqft)}/sqft
          </p>
        </div>
        <div className="flex items-center gap-4 mt-2 text-sm text-gray-600">
          <span className="flex items-center gap-1">
            ğŸ›ï¸ {property.beds} beds
          </span>
          <span className="flex items-center gap-1">
            ğŸ› {property.baths} baths
          </span>
          <span className="flex items-center gap-1">
            ğŸ“ {property.sqft.toLocaleString()} sqft
          </span>
        </div>
        <p className="text-sm text-gray-500 mt-2 flex items-center gap-1">
          â±ï¸ {property.daysOnMarket} days on market
        </p>
      </div>
    </div>
  );
}
```

### CompareView Component:
```tsx
function CompareView({ 
  comparables, 
  subjectProperty, 
  viewMode 
}: { 
  comparables: CmaProperty[]; 
  subjectProperty?: CmaProperty;
  viewMode: 'grid' | 'list' | 'table';
}) {
  if (viewMode === 'grid') {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {subjectProperty && (
          <PropertyCard property={subjectProperty} isSubject />
        )}
        {comparables.map(comp => (
          <PropertyCard key={comp.id} property={comp} />
        ))}
      </div>
    );
  }
  
  if (viewMode === 'list') {
    return (
      <div className="space-y-3">
        {subjectProperty && (
          <PropertyListItem property={subjectProperty} isSubject />
        )}
        {comparables.map(comp => (
          <PropertyListItem key={comp.id} property={comp} />
        ))}
      </div>
    );
  }
  
  if (viewMode === 'table') {
    return <PropertyTable comparables={comparables} subjectProperty={subjectProperty} />;
  }
  
  return null;
}
```

---

## Step 7: Utility Functions

```tsx
function formatCurrency(value: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
}
```

---

## Copy/Paste for Replit

```
Update the CompsWidget in CMA Presentation Builder to match the CMA tab's Comparable Properties feature.

## FILE:
client/src/components/cma-presentation/widgets/CompsWidget.tsx

## REFERENCE FILES:
- client/src/components/cma-tab.tsx (main logic, stats calculation)
- client/src/components/cma-stats-view.tsx (stats display)

## ADD THESE FEATURES:

### 1. STATE MANAGEMENT
const [mainView, setMainView] = useState<'compare' | 'map' | 'stats' | 'list'>('compare');
const [subView, setSubView] = useState<'grid' | 'list' | 'table'>('grid');
const [statusFilter, setStatusFilter] = useState<string>('all');

### 2. STATUS FILTER TABS
- All, Closed, Active Under Contract, Pending, Active
- Filter comparables based on selection
- Style: pill buttons, active = dark background

### 3. STATS SUMMARY ROW
6 columns in a row:
- LOW PRICE: $749,000
- HIGH PRICE: $2,199,000
- AVG PRICE: $1,353,780 (with "â†“ 59.4% vs market" subtitle)
- MEDIAN: $1,299,000
- AVG $/SQFT: $394
- AVG DOM: 0 days

Use calculateStatistics function from cma-tab.tsx (lines 133-175)

### 4. VIEW TOGGLE (in Compare tab)
- Grid: 3-column card layout
- List: horizontal list items
- Table: data table format

### 5. TOP TABS
[Compare] [Map] [Stats] [List]
- Icons: ğŸ“Š ğŸ—ºï¸ ğŸ“ˆ ğŸ“‹
- Active state: white bg with shadow

### 6. PROPERTY CARDS (Grid View)
Each card shows:
- Photo (aspect-[4/3])
- Status badge (colored): Closed=green, Active=red, Pending=yellow
- Distance badge (gray): "9.4 mi"
- Address
- Price + $/sqft
- Beds, Baths, Sqft icons
- Days on market

### 7. STATUS BADGE COLORS
const getStatusColor = (status: string) => {
  const s = status.toLowerCase();
  if (s.includes('closed')) return 'bg-green-500';
  if (s.includes('active') && !s.includes('under')) return 'bg-red-500';
  if (s.includes('pending') || s.includes('under')) return 'bg-yellow-500';
  return 'bg-gray-500';
};

### 8. SUBJECT PROPERTY
- Show first in grid with orange border (border-[#EF4923])
- Badge says "Subject" instead of status

## MOBILE OPTIMIZATION:
- Stats row: 2 columns on mobile, 6 on desktop
- Cards: 1 column mobile, 2 tablet, 3 desktop
- All buttons: min-h-[44px] touch targets
- Horizontal scroll for filter tabs on mobile

I've attached screenshots showing:
1. Current CompsWidget (basic)
2. Target design from CMA tab (full featured)
```

---

## Expected Result

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Comparable Properties  10 properties  [MLS]     [Compare][Map][Stats][List] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [All] [Closed] [Active Under Contract] [Pending] [Active]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LOW PRICE | HIGH PRICE | AVG PRICE    | MEDIAN    | AVG $/SQFT | AVG DOM â”‚
â”‚ $749,000  | $2,199,000 | $1,353,780   | $1,299,000| $394       | 0 days  â”‚
â”‚           |            | â†“59.4% vs mkt|           |            |         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View: [Grid] [List] [Table]                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ â”‚ [Subject]   â”‚ â”‚ [Closed]9mi â”‚ â”‚ [Closed]12miâ”‚                    â”‚
â”‚ â”‚ [  Photo  ] â”‚ â”‚ [  Photo  ] â”‚ â”‚ [  Photo  ] â”‚                    â”‚
â”‚ â”‚ 154 Petti...â”‚ â”‚ 321 Delayne â”‚ â”‚ 140 Hawtho..â”‚                    â”‚
â”‚ â”‚ $434,990    â”‚ â”‚ $2,099,900  â”‚ â”‚ $998,000    â”‚                    â”‚
â”‚ â”‚ 4bd 2ba 1850â”‚ â”‚ 4bd 4ba 3578â”‚ â”‚ 4bd 4ba 3336â”‚                    â”‚
â”‚ â”‚ â± 0 days    â”‚ â”‚ â± 0 days    â”‚ â”‚ â± 0 days    â”‚                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```