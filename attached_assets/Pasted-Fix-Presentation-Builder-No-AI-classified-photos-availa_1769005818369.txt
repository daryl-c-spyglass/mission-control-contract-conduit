Fix: Presentation Builder "No AI-classified photos available" Error

### Problem
The Presentation Builder's Layout tab shows "No AI-classified photos available" for property MLS# ACT2572987, which has 23 photos with AI classification data. 

The Create Property Flyer dialog works correctly with the same property, showing "Smart Photo Selection" with AI-classified photos.

### Reference Implementation
The flyer generator (Create Property Flyer dialog) already has working AI photo selection. Copy that implementation to the Presentation Builder.

---

## PART 1: Identify Working Code in Flyer Generator

Files to examine:
- `client/src/components/create-flyer-dialog.tsx` (or similar)
- `server/routes.ts` (endpoint for image insights)

Find and copy:
1. The API call that fetches Image Insights data
2. The `selectBestPhotos` or similar function
3. The UI that displays classified photos with labels

---

## PART 2: Create/Fix Image Insights Endpoint

Ensure this endpoint exists and works:
```typescript
// server/routes.ts

// GET /api/repliers/listing/:listingId/image-insights
app.get('/api/repliers/listing/:listingId/image-insights', async (req, res) => {
  try {
    const { listingId } = req.params;
    const apiKey = process.env.REPLIERS_API_KEY;
    
    if (!apiKey) {
      return res.status(500).json({ 
        available: false, 
        error: 'API key not configured',
        images: [] 
      });
    }
    
    // Fetch listing with imageInsights from Repliers
    const response = await fetch(
      `https://api.repliers.io/listings/${listingId}`,
      {
        method: 'GET',
        headers: {
          'REPLIERS-API-KEY': apiKey,
          'Content-Type': 'application/json',
        },
      }
    );
    
    if (!response.ok) {
      return res.status(response.status).json({ 
        available: false, 
        error: `Repliers API error: ${response.status}`,
        images: [] 
      });
    }
    
    const data = await response.json();
    const photos = data.images || data.photos || [];
    
    // Check if Image Insights is available
    if (data.imageInsights?.images && data.imageInsights.images.length > 0) {
      const classifiedPhotos = data.imageInsights.images.map((insight, index) => ({
        url: photos[index] || `https://cdn.repliers.io/${insight.image}`,
        originalIndex: index,
        classification: {
          imageOf: insight.classification?.imageOf || null,
          prediction: insight.classification?.prediction || 0,
        },
        quality: {
          qualitative: insight.quality?.qualitative || 'unknown',
          quantitative: insight.quality?.quantitative || 0,
        },
      }));
      
      return res.json({
        available: true,
        totalImages: photos.length,
        classifiedImages: classifiedPhotos.length,
        images: classifiedPhotos,
      });
    }
    
    // Fallback: No Image Insights available
    return res.json({
      available: false,
      totalImages: photos.length,
      images: photos.map((url, index) => ({
        url,
        originalIndex: index,
        classification: null,
        quality: null,
      })),
    });
    
  } catch (error) {
    console.error('Image Insights error:', error);
    return res.status(500).json({ 
      available: false, 
      error: error.message,
      images: [] 
    });
  }
});
```

---

## PART 3: Fix Presentation Builder Layout Tab

Update the CMA Presentation Builder to fetch and display AI-classified photos:
```tsx
// client/src/pages/CMAPresentationBuilder.tsx (or components/cma/CoverPhotoSelector.tsx)

// 1. Add state for image insights
const [imageInsights, setImageInsights] = useState({
  available: false,
  loading: true,
  images: [],
  error: null,
});

// 2. Fetch image insights when component mounts
useEffect(() => {
  const fetchImageInsights = async () => {
    if (!mlsNumber) return;
    
    setImageInsights(prev => ({ ...prev, loading: true }));
    
    try {
      const response = await fetch(`/api/repliers/listing/${mlsNumber}/image-insights`);
      const data = await response.json();
      
      setImageInsights({
        available: data.available,
        loading: false,
        images: data.images || [],
        error: data.error || null,
      });
      
      // Auto-select best exterior photo if AI available
      if (data.available && data.images.length > 0) {
        const bestExterior = data.images.find(img => 
          img.classification?.imageOf?.toLowerCase().includes('front') ||
          img.classification?.imageOf?.toLowerCase().includes('exterior')
        ) || data.images[0];
        
        setCoverPhotoSettings(prev => ({
          ...prev,
          photoUrl: bestExterior.url,
        }));
      }
    } catch (error) {
      setImageInsights({
        available: false,
        loading: false,
        images: [],
        error: error.message,
      });
    }
  };
  
  fetchImageInsights();
}, [mlsNumber]);

// 3. Update the photo grid to show classifications
{imageInsights.loading ? (
  <div className="flex items-center justify-center py-8">
    <Loader2 className="w-6 h-6 animate-spin mr-2" />
    <span>Analyzing photos with AI...</span>
  </div>
) : imageInsights.available ? (
  <div className="grid grid-cols-6 gap-2">
    {imageInsights.images.map((photo, index) => (
      <button
        key={index}
        onClick={() => setCoverPhotoSettings(prev => ({ 
          ...prev, 
          photoUrl: photo.url 
        }))}
        className={cn(
          "relative aspect-square rounded-lg overflow-hidden border-2 transition-all",
          coverPhotoSettings.photoUrl === photo.url
            ? "border-primary ring-2 ring-primary/30"
            : "border-transparent hover:border-primary/50"
        )}
      >
        <img 
          src={photo.url} 
          alt={photo.classification?.imageOf || `Photo ${index + 1}`}
          className="w-full h-full object-cover"
        />
        
        {/* Room type badge */}
        {photo.classification?.imageOf && (
          <span className="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-[10px] px-1 py-0.5 truncate">
            {photo.classification.imageOf}
          </span>
        )}
        
        {/* Quality indicator dot */}
        {photo.quality?.qualitative && (
          <span className={cn(
            "absolute top-1 right-1 w-2 h-2 rounded-full",
            photo.quality.qualitative === 'excellent' ? 'bg-green-500' :
            photo.quality.qualitative === 'above average' ? 'bg-blue-500' :
            'bg-yellow-500'
          )} />
        )}
        
        {/* Selection checkmark */}
        {coverPhotoSettings.photoUrl === photo.url && (
          <div className="absolute top-1 left-1 bg-primary rounded-full p-0.5">
            <Check className="w-3 h-3 text-white" />
          </div>
        )}
      </button>
    ))}
  </div>
) : (
  /* Fallback to Manual Selection - show all photos without classification */
  <div>
    <p className="text-sm text-amber-600 dark:text-amber-400 mb-4">
      AI photo classification not available for this listing. Showing all {subjectProperty?.photos?.length || 0} photos.
    </p>
    <div className="grid grid-cols-6 gap-2">
      {(subjectProperty?.photos || []).map((photo, index) => (
        <button
          key={index}
          onClick={() => setCoverPhotoSettings(prev => ({ 
            ...prev, 
            photoUrl: photo 
          }))}
          className={cn(
            "relative aspect-square rounded-lg overflow-hidden border-2",
            coverPhotoSettings.photoUrl === photo
              ? "border-primary ring-2 ring-primary/30"
              : "border-transparent hover:border-primary/50"
          )}
        >
          <img src={photo} className="w-full h-full object-cover" />
        </button>
      ))}
    </div>
  </div>
)}
```

---

## PART 4: Match Flyer Generator UI Pattern

Copy the exact UI from the Create Property Flyer dialog (see 2nd screenshot):
```tsx
// AI Best Photo mode header (when available)
<div className="bg-primary/5 border border-primary/20 rounded-lg p-3 mb-4">
  <div className="flex items-center gap-2 text-sm font-medium text-primary">
    <Sparkles className="w-4 h-4" />
    Smart Photo Selection
  </div>
  <p className="text-xs text-muted-foreground mt-1">
    Using AI Image Insights to select:
  </p>
  <ul className="text-xs text-muted-foreground mt-1 ml-4">
    <li>• Photo 1: Best Exterior/Front</li>
    <li>• Photo 2: Best Kitchen</li>
    <li>• Photo 3: Best Living Room</li>
  </ul>
  <p className="text-xs text-muted-foreground mt-2 italic">
    Based on room classification & quality scores
  </p>
</div>

// For Presentation Builder cover photo (only need 1 photo):
<div className="bg-primary/5 border border-primary/20 rounded-lg p-3 mb-4">
  <div className="flex items-center gap-2 text-sm font-medium text-primary">
    <Sparkles className="w-4 h-4" />
    Smart Photo Selection
  </div>
  <p className="text-xs text-muted-foreground mt-1">
    Using AI Image Insights to select the best exterior/front photo
  </p>
  <p className="text-xs text-muted-foreground mt-2 italic">
    Based on room classification & quality scores
  </p>
</div>
```

---

## PART 5: Debug Logging

Add console logs to diagnose if this still doesn't work:
```typescript
// In the useEffect that fetches image insights
console.log('[Presentation Builder] Fetching image insights for:', mlsNumber);
console.log('[Presentation Builder] API response:', data);
console.log('[Presentation Builder] Images available:', data.available);
console.log('[Presentation Builder] Classified images count:', data.images?.length);

// In the render
console.log('[Presentation Builder] Rendering with:', {
  loading: imageInsights.loading,
  available: imageInsights.available,
  imageCount: imageInsights.images.length,
});
```

---

## Acceptance Criteria

- [ ] Presentation Builder Layout tab fetches image insights from Repliers API
- [ ] "Analyzing photos with AI..." loading state shows while fetching
- [ ] When AI available: Photos display with room type labels (Kitchen, Living Room, etc.)
- [ ] When AI available: Quality dots show (green=excellent, blue=above average, yellow=average)
- [ ] When AI available: "Smart Photo Selection" info box displays
- [ ] When AI NOT available: Falls back to showing all photos without labels
- [ ] Photo selection works - clicking a photo sets it as cover photo
- [ ] Selected photo shows checkmark indicator
- [ ] Same property (MLS# ACT2572987) shows AI-classified photos like it does in Create Property Flyer

---

## Testing

1. Open transaction for 13106 New Boston (MLS# ACT2572987)
2. Click Presentation Builder
3. Go to Layout tab
4. Click "AI Best Photo" toggle
5. Verify: Photos load with room type labels
6. Verify: "Smart Photo Selection" info box shows
7. Compare with Create Property Flyer dialog - should look similar

This prompt references our confirmed working flyer implementation and provides complete code to fix the Presentation Builder. The key insight from our past conversations is that Image Insights IS enabled on your Repliers account and returns data like this for ACT2572987:
FieldSample Valueclassification.imageOf"Kitchen", "Living Room", "Patio", etc.classification.prediction0.984, 0.999, 0.936 (confidence scores)quality.qualitative"excellent", "above average", "average"quality.quantitative4.02, 4.94, 3.26 (1-5 scale)