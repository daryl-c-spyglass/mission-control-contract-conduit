# Replit Prompt: Fix Advanced Flyer Builder â€” Sync & Auto-Fill Issues

## ğŸ¯ Issues to Fix

Based on the screenshot, these issues need to be resolved:

| Issue | Current State | Expected State |
|-------|---------------|----------------|
| Live Preview scale | User has to select 100% | **Default to 100%** |
| Listed Price (left pane) | Empty | Auto-filled from MLS `listPrice` |
| Beds/Baths/Sq Ft (left pane) | Empty | Auto-filled from MLS data |
| Listed Price (Live Preview) | Shows $499,999 (incorrect) | Sync with actual MLS price |
| Property Address (Property Images) | Empty | Auto-filled from transaction |
| Agent Name/Title/Phone | Empty | Auto-filled from Settings |
| Zoom/Horizontal/Vertical/Reset | Present on photos | **REMOVE entirely** |

---

## ğŸ”§ Fix 1: Default Live Preview Scale to 100%

Find the scale state initialization and set default to "1" (100%):

```tsx
// In AdvancedFlyerGenerator/index.tsx

// CHANGE FROM:
const [scale, setScale] = useState<string>('fit');

// CHANGE TO:
const [scale, setScale] = useState<string>('1'); // Default to 100%
```

Also update the `getPreviewScale` function if needed:

```tsx
const getPreviewScale = () => {
  if (scale === 'fit') return 0.55;
  return parseFloat(scale);
};
```

---

## ğŸ”§ Fix 2: Auto-Fill Property Details from MLS Data

The Live Preview shows data but left pane is empty. This means the form values are not being set correctly. Fix the useEffect:

```tsx
// In AdvancedFlyerGenerator/index.tsx

useEffect(() => {
  // Get MLS data from transaction
  const mlsData = transaction?.mlsData;
  
  if (!mlsData) {
    console.warn('No MLS data available');
    return;
  }

  console.log('Loading MLS data:', mlsData);

  // =====================================================
  // FORMAT FUNCTIONS
  // =====================================================
  
  const formatPrice = (price: number | string | null | undefined): string => {
    if (!price) return '';
    const num = typeof price === 'string' 
      ? parseFloat(price.replace(/[^0-9.]/g, '')) 
      : price;
    if (isNaN(num)) return '';
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    }).format(num);
  };

  const formatNumber = (num: number | string | null | undefined): string => {
    if (num === null || num === undefined || num === '') return '';
    const n = typeof num === 'string' ? parseFloat(num) : num;
    if (isNaN(n)) return '';
    return new Intl.NumberFormat('en-US').format(Math.round(n));
  };

  // =====================================================
  // EXTRACT VALUES (check multiple possible field names)
  // =====================================================
  
  // Price - check multiple field names
  const price = mlsData.listPrice || mlsData.ListPrice || mlsData.price || mlsData.Price || '';
  
  // Beds - check multiple field names
  const beds = mlsData.bedroomsTotal || mlsData.BedroomsTotal || 
               mlsData.beds || mlsData.Beds || 
               mlsData.bedrooms || mlsData.Bedrooms || '';
  
  // Baths - check multiple field names
  const baths = mlsData.bathroomsTotalInteger || mlsData.BathroomsTotalInteger || 
                mlsData.baths || mlsData.Baths || 
                mlsData.bathrooms || mlsData.Bathrooms || 
                mlsData.bathroomsFull || '';
  
  // Sq Ft - check multiple field names
  const sqft = mlsData.livingArea || mlsData.LivingArea || 
               mlsData.buildingAreaTotal || mlsData.BuildingAreaTotal ||
               mlsData.sqft || mlsData.SqFt || 
               mlsData.squareFeet || '';

  // Address - build from components
  const buildAddress = (): string => {
    const addr = mlsData.address || mlsData;
    
    const streetParts = [
      addr.streetNumber || mlsData.streetNumber,
      addr.streetDirection || mlsData.streetDirection,
      addr.streetName || mlsData.streetName,
      addr.streetSuffix || mlsData.streetSuffix,
    ].filter(Boolean).join(' ');
    
    const unit = (addr.unitNumber || mlsData.unitNumber) 
      ? `, Unit ${addr.unitNumber || mlsData.unitNumber}` 
      : '';
    const city = addr.city || mlsData.city || '';
    const state = addr.state || mlsData.state || 'TX';
    const zip = addr.postalCode || mlsData.postalCode || '';
    
    if (streetParts && city) {
      return `${streetParts}${unit}, ${city}, ${state} ${zip}`.toUpperCase().trim();
    }
    
    // Fallback to transaction address
    return (transaction?.address || '').toUpperCase();
  };

  // Description
  const description = mlsData.publicRemarks || mlsData.PublicRemarks || 
                      mlsData.remarks || mlsData.description || '';
  
  // Neighborhood for headline
  const neighborhood = mlsData.subdivision || mlsData.Subdivision || 
                       mlsData.neighborhood || '';
  const city = mlsData.city || mlsData.address?.city || '';

  // =====================================================
  // SET FORM VALUES
  // =====================================================
  
  const formattedPrice = formatPrice(price);
  const formattedAddress = buildAddress();
  
  console.log('Setting form values:', {
    price: formattedPrice,
    address: formattedAddress,
    beds,
    baths,
    sqft: formatNumber(sqft),
  });

  // Use form.reset to set all values at once
  form.reset({
    price: formattedPrice,
    address: formattedAddress,
    bedrooms: beds ? String(beds) : '',
    bathrooms: baths ? String(baths) : '',
    sqft: formatNumber(sqft),
    introHeadline: neighborhood 
      ? `Prime Opportunity in ${neighborhood}`
      : city 
        ? `Beautiful Home in ${city}`
        : 'Your Dream Home Awaits',
    introDescription: description.length > 150 
      ? description.substring(0, 147) + '...'
      : description,
    // Keep existing agent values if already set
    agentName: form.getValues('agentName') || '',
    agentTitle: form.getValues('agentTitle') || '',
    phone: form.getValues('phone') || '',
  });

  // Store original description for AI summarize
  setOriginalDescription(description);

}, [transaction?.mlsData, transaction?.address, form]);
```

---

## ğŸ”§ Fix 3: Auto-Fill Agent Details from Settings

Separate useEffect for settings to avoid overwriting:

```tsx
// In AdvancedFlyerGenerator/index.tsx

useEffect(() => {
  if (!settings) return;

  console.log('Loading settings:', settings);

  // Build agent name
  const firstName = settings.firstName || '';
  const lastName = settings.lastName || '';
  const agentName = `${firstName} ${lastName}`.trim();

  // Only set if fields are empty (don't overwrite user edits)
  if (!form.getValues('agentName')) {
    form.setValue('agentName', agentName || 'Agent Name');
  }
  if (!form.getValues('agentTitle')) {
    form.setValue('agentTitle', settings.title || 'REALTORÂ®');
  }
  if (!form.getValues('phone')) {
    form.setValue('phone', settings.phone || '');
  }

  // Set images from settings
  setImages(prev => ({
    ...prev,
    agentPhoto: settings.profilePhoto || prev.agentPhoto,
    qrCode: settings.qrCode || prev.qrCode,
    companyLogo: settings.companyLogoUseDefault !== false
      ? '/logos/SpyglassRealty_Logo_Black.png'
      : settings.companyLogo || '/logos/SpyglassRealty_Logo_Black.png',
    secondaryLogo: settings.secondaryLogoUseDefault !== false
      ? '/logos/LeadingRE_Logo.png'
      : settings.secondaryLogo || '/logos/LeadingRE_Logo.png',
  }));

}, [settings, form]);
```

---

## ğŸ”§ Fix 4: Auto-Fill Property Address in Property Images Section

The Property Address field under "Property Images" should use the same address:

```tsx
// In the Property Images section

// Use the address from form or build from MLS
const propertyAddress = form.watch('address') || '';

// JSX:
<div className="space-y-2">
  <div className="flex items-center gap-2">
    <MapPin className="w-4 h-4 text-muted-foreground" />
    <Label className="text-xs font-medium uppercase tracking-wide">
      Property Address
    </Label>
  </div>
  <Input
    value={propertyAddress}
    readOnly
    className="bg-muted/50 font-medium text-sm"
    placeholder="Address will auto-fill from MLS"
  />
</div>
```

---

## ğŸ”§ Fix 5: Remove ALL Zoom/Horizontal/Vertical/Reset Controls

Remove the crop controls entirely from the flyer builder.

### Remove from State:

```tsx
// DELETE or comment out imageTransforms state if not needed elsewhere:
// const [imageTransforms, setImageTransforms] = useState({...});

// If you need to keep the state for other purposes, just don't render the controls
```

### Remove from ImageUploadField Component:

Find the `ImageUploadField` component and remove the crop controls:

```tsx
// In ImageUploadField.tsx or wherever it's defined

// REMOVE these props:
// - transform
// - onTransformChange  
// - showCropControls

// REMOVE the crop controls JSX (the sliders and reset button):
// DELETE this entire section:
/*
{preview && showCropControls && onTransformChange && (
  <div className="space-y-2 pt-2">
    {/* Zoom */}
    <div className="flex items-center gap-2">
      <ZoomIn className="w-3 h-3 text-muted-foreground" />
      ...
    </div>
    
    {/* Horizontal */}
    <div className="flex items-center gap-2">
      <MoveHorizontal className="w-3 h-3 text-muted-foreground" />
      ...
    </div>
    
    {/* Vertical */}
    <div className="flex items-center gap-2">
      <MoveVertical className="w-3 h-3 text-muted-foreground" />
      ...
    </div>
    
    {/* Reset */}
    <Button ... >
      <RotateCcw className="w-3 h-3" />
      Reset
    </Button>
  </div>
)}
*/
```

### Update All ImageUploadField Usages:

Remove the crop-related props from all instances:

```tsx
// BEFORE:
<ImageUploadField
  label="Main Property Photo"
  id="mainImage"
  preview={images.mainImage}
  onChange={handleImageUpload('mainImage')}
  transform={imageTransforms.mainImage}
  onTransformChange={handleTransformChange('mainImage')}
  showCropControls
/>

// AFTER:
<ImageUploadField
  label="Main Property Photo"
  id="mainImage"
  preview={images.mainImage}
  onChange={handleImageUpload('mainImage')}
/>
```

### Also Remove from Agent Photo:

```tsx
// Agent Photo - Simple display, no crop controls
<div className="space-y-2">
  <Label className="text-xs font-medium uppercase tracking-wide">
    Agent Photo
  </Label>
  <div className="w-20 h-20 mx-auto rounded-full overflow-hidden border-2 border-border">
    {images.agentPhoto ? (
      <img
        src={images.agentPhoto}
        alt="Agent"
        className="w-full h-full object-cover"
      />
    ) : (
      <div className="w-full h-full bg-muted flex items-center justify-center">
        <User className="w-8 h-8 text-muted-foreground" />
      </div>
    )}
  </div>
  {/* NO ZOOM/HORIZONTAL/VERTICAL/RESET */}
</div>
```

---

## ğŸ”§ Fix 6: Ensure Live Preview Syncs Correctly

The Live Preview should use `form.watch()` to get real-time values:

```tsx
// In AdvancedFlyerGenerator/index.tsx

// Watch all form values
const watchedValues = form.watch();

// Pass to FlyerPreview
<FlyerPreview
  data={watchedValues}
  images={images}
/>
```

### In FlyerPreview Component:

Make sure it uses the passed data directly:

```tsx
// In FlyerPreview.tsx

interface FlyerPreviewProps {
  data: {
    price: string;
    address: string;
    bedrooms: string;
    bathrooms: string;
    sqft: string;
    introHeadline: string;
    introDescription: string;
    agentName: string;
    agentTitle: string;
    phone: string;
  };
  images: {
    mainImage: string | null;
    kitchenImage: string | null;
    roomImage: string | null;
    agentPhoto: string | null;
    companyLogo: string | null;
    secondaryLogo: string | null;
    qrCode: string | null;
  };
}

export function FlyerPreview({ data, images }: FlyerPreviewProps) {
  return (
    <div className="bg-white" style={{ width: '816px', height: '1056px' }}>
      {/* Price - Use data.price directly */}
      <div className="...">
        <span className="...">{data.price || '$0'}</span>
      </div>

      {/* Address */}
      <div className="...">
        {data.address || 'PROPERTY ADDRESS'}
      </div>

      {/* Beds/Baths/SqFt */}
      <div className="...">
        <span>{data.bedrooms || '0'}</span>
        <span>bedrooms</span>
      </div>
      <div className="...">
        <span>{data.bathrooms || '0'}</span>
        <span>bathrooms</span>
      </div>
      <div className="...">
        <span>{data.sqft || '0'}</span>
        <span>sq. ft</span>
      </div>

      {/* ... rest of preview */}
    </div>
  );
}
```

---

## ğŸ“Š Before â†’ After

### Before:
```
LEFT PANE                          LIVE PREVIEW
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ $ LISTED PRICE      â”‚            â”‚ LISTED AT           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚ $499,999 â† WRONG    â”‚
â”‚ â”‚ (empty)         â”‚ â”‚            â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚ 268 CHISHOLM TRL    â”‚
â”‚                     â”‚            â”‚                     â”‚
â”‚ BEDS  BATHS  SQ FT  â”‚            â”‚ 4 bedrooms          â”‚
â”‚ [ ]   [ ]    [ ]    â”‚            â”‚ 4 bathrooms         â”‚
â”‚ (all empty)         â”‚            â”‚ 2,671 sq ft         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Crop controls showing:
âŠ™ Zoom         1.0x
â†” Horizontal    0%
â†• Vertical      0%
â†º Reset
```

### After:
```
LEFT PANE                          LIVE PREVIEW (100% default)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ $ LISTED PRICE      â”‚            â”‚ LISTED AT           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚ $499,000 â† SYNCED   â”‚
â”‚ â”‚ $499,000        â”‚ â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚ 268 CHISHOLM TRL    â”‚
â”‚                     â”‚            â”‚                     â”‚
â”‚ BEDS  BATHS  SQ FT  â”‚            â”‚ 4 bedrooms          â”‚
â”‚ [4]   [4]   [2,671] â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4 bathrooms         â”‚
â”‚ (auto-filled)       â”‚            â”‚ 2,671 sq ft         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NO crop controls - removed entirely
```

---

## âœ… Verification Checklist

### Default Scale
- [ ] Live Preview defaults to 100% scale on load
- [ ] Scale dropdown shows "100%" selected

### Property Details Auto-Fill
- [ ] Listed Price field auto-fills from MLS
- [ ] Beds field auto-fills from MLS
- [ ] Baths field auto-fills from MLS
- [ ] Sq Ft field auto-fills from MLS
- [ ] Property Address (under Property Images) auto-fills

### Agent Details Auto-Fill
- [ ] Agent Name auto-fills from Settings
- [ ] Title auto-fills from Settings
- [ ] Phone Number auto-fills from Settings

### Live Preview Sync
- [ ] Price in Live Preview matches left pane
- [ ] Address in Live Preview matches left pane
- [ ] Beds/Baths/SqFt in Live Preview match left pane
- [ ] Changes in left pane update Live Preview immediately

### Crop Controls Removed
- [ ] âŒ No Zoom slider anywhere
- [ ] âŒ No Horizontal slider anywhere
- [ ] âŒ No Vertical slider anywhere
- [ ] âŒ No Reset button anywhere
- [ ] Agent Photo displays without crop controls
- [ ] Property photos display without crop controls

---

## ğŸ“‹ Summary of Changes

| Change | Location | Action |
|--------|----------|--------|
| Default scale 100% | State initialization | Change `'fit'` to `'1'` |
| Auto-fill property details | MLS useEffect | Set form values from mlsData |
| Auto-fill agent details | Settings useEffect | Set form values from settings |
| Property Address sync | Property Images section | Use `form.watch('address')` |
| Remove crop controls | ImageUploadField + all usages | Delete slider/reset JSX |
| Fix price sync | FlyerPreview | Use `data.price` directly |

---

*Apply this fix to resolve all the sync and auto-fill issues in the Advanced Flyer Builder.*