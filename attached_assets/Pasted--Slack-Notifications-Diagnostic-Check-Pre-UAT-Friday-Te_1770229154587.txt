# ğŸ” Slack Notifications Diagnostic Check (Pre-UAT Friday Testing)

## ğŸ¯ OBJECTIVE
Run diagnostics on the Slack notification system to prepare for Friday UAT testing. **NO CHANGES** - this is purely a read-only diagnostic to verify everything is ready to turn on.

---

## âš ï¸ IMPORTANT: READ-ONLY MODE
- Do NOT enable notifications
- Do NOT send any test messages
- Do NOT modify any environment variables
- Only READ and REPORT current status

---

## ğŸ“‹ DIAGNOSTIC CHECKLIST

### 1. Environment Variables Status

Create a diagnostic endpoint or script that checks and reports:

```typescript
// GET /api/admin/slack-diagnostics (or run as script)

async function runSlackDiagnostics() {
  const diagnostics = {
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV,
    checks: []
  };

  // Check 1: Notification Flags
  diagnostics.checks.push({
    name: 'Notification Flags',
    status: 'info',
    details: {
      DISABLE_SLACK_NOTIFICATIONS: process.env.DISABLE_SLACK_NOTIFICATIONS || 'not set',
      SLACK_BOT_TOKEN_DISABLE: process.env.SLACK_BOT_TOKEN_DISABLE || 'not set',
      SLACK_API_TOKEN_DISABLE: process.env.SLACK_API_TOKEN_DISABLE || 'not set',
    },
    notificationsEnabled: !(
      process.env.DISABLE_SLACK_NOTIFICATIONS === 'true' ||
      process.env.SLACK_BOT_TOKEN_DISABLE === 'true' ||
      process.env.SLACK_API_TOKEN_DISABLE === 'true'
    )
  });

  // Check 2: Slack Token Exists
  const hasSlackBotToken = !!process.env.SLACK_BOT_TOKEN;
  const hasSlackApiToken = !!process.env.SLACK_API_TOKEN;
  diagnostics.checks.push({
    name: 'Slack Tokens',
    status: hasSlackBotToken || hasSlackApiToken ? 'pass' : 'fail',
    details: {
      SLACK_BOT_TOKEN: hasSlackBotToken ? 'âœ… Set (hidden)' : 'âŒ Missing',
      SLACK_API_TOKEN: hasSlackApiToken ? 'âœ… Set (hidden)' : 'âŒ Missing',
    }
  });

  return diagnostics;
}
```

### 2. Slack API Connection Test (Read-Only)

```typescript
// Test Slack connection WITHOUT sending messages
async function testSlackConnection() {
  const results = {
    authTest: null,
    channelAccess: [],
    errors: []
  };

  try {
    // Test 1: Verify token is valid (auth.test)
    const authResult = await slackClient.auth.test();
    results.authTest = {
      status: 'pass',
      team: authResult.team,
      user: authResult.user,
      bot_id: authResult.bot_id
    };
  } catch (error) {
    results.authTest = {
      status: 'fail',
      error: error.message
    };
    results.errors.push(`Auth test failed: ${error.message}`);
  }

  // Test 2: Check channel access (conversations.info - read only)
  const channelsToCheck = [
    { name: '#coming-soon-listings', id: 'C09J6327HQS' },
    { name: '#spyglass-photography', id: 'C0A9019MYT1' },
    // Add other notification channels here
  ];

  for (const channel of channelsToCheck) {
    try {
      const info = await slackClient.conversations.info({ channel: channel.id });
      results.channelAccess.push({
        name: channel.name,
        id: channel.id,
        status: 'pass',
        isMember: info.channel.is_member,
        isPrivate: info.channel.is_private
      });
    } catch (error) {
      results.channelAccess.push({
        name: channel.name,
        id: channel.id,
        status: 'fail',
        error: error.message
      });
      results.errors.push(`Channel ${channel.name} access failed: ${error.message}`);
    }
  }

  return results;
}
```

### 3. Scheduler Status Check

```typescript
// Check if any schedulers are running
async function checkSchedulerStatus() {
  const status = {
    legacyScheduler: null,
    newScheduler: null,
    cronJobs: []
  };

  // Check for any active cron jobs or intervals
  // This depends on how schedulers are implemented in the codebase

  // Look for:
  // - node-cron jobs
  // - setInterval timers
  // - Any scheduled notification functions

  // Report what's found
  console.log('=== SCHEDULER STATUS ===');
  console.log('Check server/scheduler.ts or similar files');
  console.log('Look for: cron.schedule(), setInterval(), or similar');
  
  return status;
}
```

### 4. Database Check - Pending Notifications

```typescript
// Check transactions that might trigger notifications
async function checkPendingNotifications() {
  const report = {
    transactionsWithClosingDates: 0,
    upcomingClosings7Days: [],
    upcomingClosings14Days: [],
    comingSoonTransactions: [],
    recentActivity: []
  };

  // Count transactions with closing dates
  const transactionsWithClosing = await db
    .select()
    .from(transactions)
    .where(isNotNull(transactions.closingDate));
  
  report.transactionsWithClosingDates = transactionsWithClosing.length;

  // Find closings in next 7 days
  const now = new Date();
  const in7Days = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
  const in14Days = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

  for (const txn of transactionsWithClosing) {
    const closingDate = new Date(txn.closingDate);
    const daysUntil = Math.ceil((closingDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));
    
    if (closingDate >= now && closingDate <= in7Days) {
      report.upcomingClosings7Days.push({
        id: txn.id,
        address: txn.propertyAddress,
        closingDate: txn.closingDate,
        daysUntil: daysUntil,
        agentId: txn.userId
      });
    } else if (closingDate > in7Days && closingDate <= in14Days) {
      report.upcomingClosings14Days.push({
        id: txn.id,
        address: txn.propertyAddress,
        closingDate: txn.closingDate,
        daysUntil: daysUntil,
        agentId: txn.userId
      });
    }
  }

  // Check for Coming Soon transactions (if field exists)
  try {
    const comingSoon = await db
      .select()
      .from(transactions)
      .where(eq(transactions.isComingSoon, true));
    
    report.comingSoonTransactions = comingSoon.map(t => ({
      id: t.id,
      address: t.propertyAddress
    }));
  } catch (e) {
    report.comingSoonTransactions = 'Field not yet implemented';
  }

  return report;
}
```

### 5. Notification History Check

```typescript
// Check recent notification activity (if logged)
async function checkNotificationHistory() {
  // If you have an activity or notifications log table
  try {
    const recentNotifications = await db
      .select()
      .from(activities)
      .where(eq(activities.type, 'notification'))
      .orderBy(desc(activities.createdAt))
      .limit(20);

    return {
      found: recentNotifications.length,
      recent: recentNotifications.map(n => ({
        id: n.id,
        description: n.description,
        createdAt: n.createdAt,
        transactionId: n.transactionId
      }))
    };
  } catch (e) {
    return {
      found: 0,
      error: 'Activity table not found or no notification type'
    };
  }
}
```

---

## ğŸ“Š DIAGNOSTIC REPORT OUTPUT

Generate a report like this:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           SLACK NOTIFICATIONS DIAGNOSTIC REPORT                â•‘
â•‘                   Pre-UAT Friday Testing                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Run Time: 2026-02-05 10:30:00 CST                              â•‘
â•‘ Environment: Development (Replit)                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. NOTIFICATION FLAGS                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DISABLE_SLACK_NOTIFICATIONS:  true  â† Notifications OFF        â”‚
â”‚ SLACK_BOT_TOKEN_DISABLE:      true  â† Bot disabled             â”‚
â”‚ SLACK_API_TOKEN_DISABLE:      true  â† API disabled             â”‚
â”‚                                                                 â”‚
â”‚ Status: ğŸ”´ NOTIFICATIONS DISABLED (as expected for pre-UAT)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SLACK API CONNECTION                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Auth Test:        âœ… PASS                                       â”‚
â”‚ Team:             Spyglass Realty                               â”‚
â”‚ Bot User:         Contract Conduit Bot                          â”‚
â”‚                                                                 â”‚
â”‚ Channel Access:                                                 â”‚
â”‚   #coming-soon-listings (C09J6327HQS)  âœ… Member                â”‚
â”‚   #spyglass-photography (C0A9019MYT1)  âœ… Member                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SCHEDULER STATUS                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Legacy Scheduler:  âŒ Disabled (confirmed)                      â”‚
â”‚ New Scheduler:     â¸ï¸  Paused (waiting for UAT)                 â”‚
â”‚ Active Cron Jobs:  0                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. PENDING NOTIFICATIONS (what would send when enabled)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Transactions with closing dates: 82                             â”‚
â”‚                                                                 â”‚
â”‚ Upcoming Closings (next 7 days): 3                              â”‚
â”‚   â€¢ 7500 Northwest - Jan 27, 2026 (2 days) - Randi White       â”‚
â”‚   â€¢ 2504 Main St - Jan 29, 2026 (4 days) - John Smith          â”‚
â”‚   â€¢ 2008 Maple Ave - Jan 30, 2026 (5 days) - Arriana Alvarez   â”‚
â”‚                                                                 â”‚
â”‚ Upcoming Closings (8-14 days): 2                                â”‚
â”‚   â€¢ 2107 Matterhorn Lane - Feb 3, 2026 (9 days)                â”‚
â”‚   â€¢ 123 Test - Feb 5, 2026 (11 days)                           â”‚
â”‚                                                                 â”‚
â”‚ Coming Soon Transactions: 0 (feature not yet implemented)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RECENT NOTIFICATION HISTORY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Last notification sent: 2026-01-20 (spam incident - fixed)     â”‚
â”‚ Total logged: 47 notifications                                  â”‚
â”‚                                                                 â”‚
â”‚ Note: Duplicate notifications issue was fixed by disabling     â”‚
â”‚ legacy scheduler. Ready for clean UAT test.                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     READINESS SUMMARY                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  âœ… Slack tokens configured                                    â•‘
â•‘  âœ… Channel access verified                                    â•‘
â•‘  âœ… Legacy scheduler disabled                                  â•‘
â•‘  âœ… Notifications currently OFF (safe)                         â•‘
â•‘  âœ… No duplicate scheduler risk                                â•‘
â•‘                                                                â•‘
â•‘  ğŸ“‹ TO ENABLE FOR FRIDAY UAT:                                  â•‘
â•‘     1. Set DISABLE_SLACK_NOTIFICATIONS = false                 â•‘
â•‘     2. Set SLACK_BOT_TOKEN_DISABLE = false                     â•‘
â•‘     3. Set SLACK_API_TOKEN_DISABLE = false                     â•‘
â•‘     4. Test with ONE transaction first                         â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ› ï¸ IMPLEMENTATION

Create a new file: `server/diagnostics/slack-diagnostics.ts`

```typescript
import { db } from '../db';
import { transactions, activities } from '../../shared/schema';
import { eq, isNotNull, desc, gte, lte, and } from 'drizzle-orm';

export async function runSlackDiagnostics() {
  console.log('\n');
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘           SLACK NOTIFICATIONS DIAGNOSTIC REPORT                â•‘');
  console.log('â•‘                   Pre-UAT Friday Testing                       â•‘');
  console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  console.log(`â•‘ Run Time: ${new Date().toISOString()}                          â•‘`);
  console.log(`â•‘ Environment: ${process.env.NODE_ENV || 'development'}          â•‘`);
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('\n');

  // 1. Check Environment Flags
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚ 1. NOTIFICATION FLAGS                                           â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  
  const disableNotifications = process.env.DISABLE_SLACK_NOTIFICATIONS;
  const disableBotToken = process.env.SLACK_BOT_TOKEN_DISABLE;
  const disableApiToken = process.env.SLACK_API_TOKEN_DISABLE;
  
  console.log(`â”‚ DISABLE_SLACK_NOTIFICATIONS:  ${disableNotifications || 'not set'}`.padEnd(66) + 'â”‚');
  console.log(`â”‚ SLACK_BOT_TOKEN_DISABLE:      ${disableBotToken || 'not set'}`.padEnd(66) + 'â”‚');
  console.log(`â”‚ SLACK_API_TOKEN_DISABLE:      ${disableApiToken || 'not set'}`.padEnd(66) + 'â”‚');
  
  const notificationsEnabled = !(
    disableNotifications === 'true' ||
    disableBotToken === 'true' ||
    disableApiToken === 'true'
  );
  
  console.log('â”‚'.padEnd(66) + 'â”‚');
  if (notificationsEnabled) {
    console.log('â”‚ Status: ğŸŸ¢ NOTIFICATIONS ENABLED                                 â”‚');
  } else {
    console.log('â”‚ Status: ğŸ”´ NOTIFICATIONS DISABLED (safe for pre-UAT)            â”‚');
  }
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('\n');

  // 2. Check Slack Tokens Exist
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚ 2. SLACK TOKENS                                                  â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  
  const hasBotToken = !!process.env.SLACK_BOT_TOKEN;
  const hasApiToken = !!process.env.SLACK_API_TOKEN;
  
  console.log(`â”‚ SLACK_BOT_TOKEN:  ${hasBotToken ? 'âœ… Set (hidden)' : 'âŒ Missing'}`.padEnd(66) + 'â”‚');
  console.log(`â”‚ SLACK_API_TOKEN:  ${hasApiToken ? 'âœ… Set (hidden)' : 'âŒ Missing'}`.padEnd(66) + 'â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('\n');

  // 3. Check Pending Notifications
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚ 3. PENDING NOTIFICATIONS (would send when enabled)              â”‚');
  console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
  
  try {
    const allTransactions = await db.select().from(transactions);
    const withClosingDate = allTransactions.filter(t => t.closingDate);
    
    console.log(`â”‚ Total Transactions: ${allTransactions.length}`.padEnd(66) + 'â”‚');
    console.log(`â”‚ With Closing Dates: ${withClosingDate.length}`.padEnd(66) + 'â”‚');
    console.log('â”‚'.padEnd(66) + 'â”‚');
    
    const now = new Date();
    const in7Days = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    const in14Days = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
    
    const upcoming7 = withClosingDate.filter(t => {
      const closing = new Date(t.closingDate!);
      return closing >= now && closing <= in7Days;
    });
    
    const upcoming14 = withClosingDate.filter(t => {
      const closing = new Date(t.closingDate!);
      return closing > in7Days && closing <= in14Days;
    });
    
    console.log(`â”‚ Closings in next 7 days: ${upcoming7.length}`.padEnd(66) + 'â”‚');
    upcoming7.slice(0, 5).forEach(t => {
      const days = Math.ceil((new Date(t.closingDate!).getTime() - now.getTime()) / (24*60*60*1000));
      console.log(`â”‚   â€¢ ${t.propertyAddress?.substring(0, 30)} (${days} days)`.padEnd(66) + 'â”‚');
    });
    
    console.log('â”‚'.padEnd(66) + 'â”‚');
    console.log(`â”‚ Closings in 8-14 days: ${upcoming14.length}`.padEnd(66) + 'â”‚');
    upcoming14.slice(0, 3).forEach(t => {
      const days = Math.ceil((new Date(t.closingDate!).getTime() - now.getTime()) / (24*60*60*1000));
      console.log(`â”‚   â€¢ ${t.propertyAddress?.substring(0, 30)} (${days} days)`.padEnd(66) + 'â”‚');
    });
    
  } catch (error) {
    console.log(`â”‚ Error checking transactions: ${error}`.padEnd(66) + 'â”‚');
  }
  
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('\n');

  // 4. Summary
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                     READINESS SUMMARY                          â•‘');
  console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  console.log('â•‘                                                                â•‘');
  console.log(`â•‘  ${hasBotToken || hasApiToken ? 'âœ…' : 'âŒ'} Slack tokens configured                                    â•‘`);
  console.log(`â•‘  ${!notificationsEnabled ? 'âœ…' : 'âš ï¸ '} Notifications currently OFF (safe)                         â•‘`);
  console.log('â•‘                                                                â•‘');
  console.log('â•‘  ğŸ“‹ TO ENABLE FOR FRIDAY UAT:                                  â•‘');
  console.log('â•‘     1. Set DISABLE_SLACK_NOTIFICATIONS = false                 â•‘');
  console.log('â•‘     2. Set SLACK_BOT_TOKEN_DISABLE = false                     â•‘');
  console.log('â•‘     3. Set SLACK_API_TOKEN_DISABLE = false                     â•‘');
  console.log('â•‘     4. Test with ONE transaction first                         â•‘');
  console.log('â•‘                                                                â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('\n');
}

// Run if called directly
runSlackDiagnostics().then(() => {
  console.log('Diagnostics complete.');
}).catch(console.error);
```

---

## ğŸš€ HOW TO RUN

Option A: **Add to server startup** (temporary)
```typescript
// In server/index.ts - add at bottom temporarily
import { runSlackDiagnostics } from './diagnostics/slack-diagnostics';
runSlackDiagnostics();
```

Option B: **Create API endpoint**
```typescript
// GET /api/admin/slack-diagnostics
app.get('/api/admin/slack-diagnostics', requireAuth, async (req, res) => {
  // Only allow admins
  const diagnostics = await runSlackDiagnostics();
  res.json(diagnostics);
});
```

Option C: **Run as script**
```bash
npx tsx server/diagnostics/slack-diagnostics.ts
```

---

## âœ… VERIFICATION

After running diagnostics, confirm:
- [ ] All 3 disable flags are set to `true` (notifications OFF)
- [ ] Slack tokens exist and are valid
- [ ] Bot has access to required channels
- [ ] No active schedulers running
- [ ] Know how many transactions would trigger notifications

---

## ğŸ“‹ FRIDAY UAT CHECKLIST

When ready to enable:
1. [ ] Run diagnostics one more time
2. [ ] Set all 3 flags to `false` in Replit Secrets
3. [ ] Restart the server
4. [ ] Create ONE test transaction with a closing date
5. [ ] Verify notification appears in correct channel
6. [ ] Check no duplicate notifications
7. [ ] If issues, immediately set flags back to `true`

---

## ğŸ”’ UAT EMAIL FILTER (IMPORTANT)

**Only send notifications for these users during testing:**
```typescript
const UAT_TEST_EMAILS = [
  'daryl@spyglassrealty.com',
  'ryan@spyglassrealty.com'
];
```

### Add this check to notification functions:

```typescript
// In your notification sending function
async function shouldSendNotification(userId: number): Promise<boolean> {
  // Check if notifications are enabled
  if (process.env.DISABLE_SLACK_NOTIFICATIONS === 'true') {
    return false;
  }

  // UAT Mode: Only send to test users
  const UAT_MODE = process.env.UAT_MODE === 'true';
  const UAT_TEST_EMAILS = [
    'daryl@spyglassrealty.com',
    'ryan@spyglassrealty.com'
  ];

  if (UAT_MODE) {
    const user = await storage.getUser(userId);
    if (!user || !UAT_TEST_EMAILS.includes(user.email?.toLowerCase())) {
      console.log(`[UAT MODE] Skipping notification for non-test user: ${user?.email}`);
      return false;
    }
    console.log(`[UAT MODE] Sending notification for test user: ${user.email}`);
  }

  return true;
}

// Usage in notification sender
async function sendClosingReminder(transaction: Transaction) {
  if (!await shouldSendNotification(transaction.userId)) {
    return; // Skip - not a test user or notifications disabled
  }
  
  // ... proceed with sending notification
}
```

### Environment Variable to Add:

```
UAT_MODE=true   # Set to true during testing, false for production
```

### How It Works:

| UAT_MODE | User Email | Notification Sent? |
|----------|------------|-------------------|
| true | daryl@spyglassrealty.com | âœ… Yes |
| true | ryan@spyglassrealty.com | âœ… Yes |
| true | randi@spyglassrealty.com | âŒ No (skipped) |
| true | arriana@spyglassrealty.com | âŒ No (skipped) |
| false | anyone | âœ… Yes (production mode) |

### Add to Diagnostic Report:

```typescript
// In diagnostics, show UAT mode status
console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
console.log('â”‚ UAT TEST MODE                                                   â”‚');
console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
console.log(`â”‚ UAT_MODE: ${process.env.UAT_MODE || 'not set'}`.padEnd(66) + 'â”‚');
console.log('â”‚ Test Users:'.padEnd(66) + 'â”‚');
console.log('â”‚   â€¢ daryl@spyglassrealty.com'.padEnd(66) + 'â”‚');
console.log('â”‚   â€¢ ryan@spyglassrealty.com'.padEnd(66) + 'â”‚');
console.log('â”‚'.padEnd(66) + 'â”‚');
if (process.env.UAT_MODE === 'true') {
  console.log('â”‚ Status: ğŸ§ª UAT MODE - Only test users will receive notifications â”‚');
} else {
  console.log('â”‚ Status: ğŸš€ PRODUCTION MODE - All users receive notifications    â”‚');
}
console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
```

---

## ğŸš€ FRIDAY UAT STEPS (UPDATED)

1. **Add new environment variable:**
   ```
   UAT_MODE=true
   ```

2. **Enable notifications (set to false):**
   ```
   DISABLE_SLACK_NOTIFICATIONS=false
   SLACK_BOT_TOKEN_DISABLE=false
   SLACK_API_TOKEN_DISABLE=false
   ```

3. **Test with Daryl or Ryan's account:**
   - Create transaction under daryl@spyglassrealty.com
   - Set closing date to trigger notification
   - Verify notification appears in Slack

4. **Confirm no other agents affected:**
   - Randi, Arriana, etc. should NOT receive any notifications during UAT

5. **When ready for production:**
   ```
   UAT_MODE=false  # Remove filter, all users get notifications
   ```