Fix CMA Map Auto-Load Issue

Task: Auto-Display Map Markers and Polygon on CMA Tab Load
When navigating to the CMA tab with Map View, the subject property, comparables, and search area polygon don't appear until the user clicks "Map View" button or switches to satellite view. These should load automatically.
Problem
The map markers (subject property, comparables) and polygon (search area) only render after a user interaction, not on initial load.
Root Cause (Likely)
This is typically caused by:

Mapbox container size issue - Map initializes before container has dimensions
Race condition - Data loads after map initializes but doesn't trigger re-render
Missing resize trigger - Map needs map.resize() after becoming visible

Solution

Trigger map resize when CMA tab becomes active:

typescript// In CMA component or Map component
useEffect(() => {
  if (activeTab === 'cma' && mapRef.current) {
    // Small delay to ensure container is rendered
    setTimeout(() => {
      mapRef.current?.resize();
      
      // Re-fit bounds to show all markers
      if (bounds) {
        mapRef.current?.fitBounds(bounds, { padding: 50 });
      }
    }, 100);
  }
}, [activeTab]);

Ensure markers render after map is fully loaded:

typescript// When initializing the map
map.on('load', () => {
  // Add markers
  addSubjectPropertyMarker();
  addComparableMarkers();
  addSearchAreaPolygon();
  
  // Fit bounds to show all
  fitMapToMarkers();
});

// Also trigger on style load (for satellite switch)
map.on('style.load', () => {
  // Re-add all layers after style change
  addSubjectPropertyMarker();
  addComparableMarkers();
  addSearchAreaPolygon();
});

Add initialization check in Map View component:

typescriptconst CMAMapView = ({ comparables, subjectProperty }) => {
  const mapContainer = useRef(null);
  const map = useRef(null);
  const [mapLoaded, setMapLoaded] = useState(false);

  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    map.current = new mapboxgl.Map({
      container: mapContainer.current,
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [subjectProperty.lng, subjectProperty.lat],
      zoom: 11
    });

    map.current.on('load', () => {
      setMapLoaded(true);
      
      // Force resize after load
      map.current.resize();
      
      // Add all map elements
      renderMapElements();
    });

    return () => map.current?.remove();
  }, []);

  // Re-render elements when data changes
  useEffect(() => {
    if (mapLoaded && map.current) {
      renderMapElements();
    }
  }, [mapLoaded, comparables, subjectProperty]);

  const renderMapElements = () => {
    if (!map.current) return;
    
    // Clear existing markers/layers first
    clearMapElements();
    
    // Add subject property marker (blue)
    addMarker(subjectProperty, 'subject');
    
    // Add comparable markers (colored by status)
    comparables.forEach(comp => {
      addMarker(comp, comp.status);
    });
    
    // Add search area polygon
    addSearchAreaPolygon();
    
    // Fit map to show all markers
    const bounds = new mapboxgl.LngLatBounds();
    bounds.extend([subjectProperty.lng, subjectProperty.lat]);
    comparables.forEach(comp => {
      bounds.extend([comp.lng, comp.lat]);
    });
    
    map.current.fitBounds(bounds, { 
      padding: { top: 50, bottom: 50, left: 50, right: 50 },
      maxZoom: 13
    });
  };

  return <div ref={mapContainer} className="map-container" />;
};

Handle tab visibility changes:

typescript// If using a tab component
const handleTabChange = (newTab) => {
  setActiveTab(newTab);
  
  if (newTab === 'cma') {
    // Delay to allow DOM to update
    requestAnimationFrame(() => {
      if (mapRef.current) {
        mapRef.current.resize();
        mapRef.current.triggerRepaint();
      }
    });
  }
};

CSS fix - ensure map container has dimensions:

css.map-container {
  width: 100%;
  height: 500px; /* or specific height */
  min-height: 400px;
}

/* If map is in a hidden tab initially */
.cma-tab-content {
  display: block; /* not display: none */
  visibility: visible;
}
Files to Check/Update

client/src/components/CMATab.tsx or similar
client/src/components/CMAMapView.tsx or similar
Any component handling the tab switching logic

Acceptance Criteria

 Subject property (blue marker) appears immediately when CMA tab loads
 All comparable markers appear with correct colors (green=active, yellow=pending, red=sold)
 Search area polygon is visible on initial load
 Map automatically fits bounds to show all markers
 Price labels ($407K, $650K, etc.) display on markers
 "10 comparables + Subject" badge is visible
 Works when switching from other tabs to CMA
 Works on page refresh when CMA is the active tab
 Works in both Map View (streets) and Satellite View